<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- Data/Singletons/Single.hs

(c) Richard Eisenberg 2013
rae@cs.brynmawr.edu

This file contains functions to refine constructs to work with singleton
types. It is an internal module to the singletons package.
-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell, TupleSections, ParallelListComp, CPP #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Singletons.Single</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">exp</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">cxt</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Syntax</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NameSpace</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Quasi</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Deriving.Ord.html"><span class="hs-identifier">Data.Singletons.Deriving.Ord</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Deriving.Bounded.html"><span class="hs-identifier">Data.Singletons.Deriving.Bounded</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Deriving.Enum.html"><span class="hs-identifier">Data.Singletons.Deriving.Enum</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Deriving.Show.html"><span class="hs-identifier">Data.Singletons.Deriving.Show</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Deriving.Util.html"><span class="hs-identifier">Data.Singletons.Deriving.Util</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Util.html"><span class="hs-identifier">Data.Singletons.Util</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.html"><span class="hs-identifier">Data.Singletons.Promote</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Defun.html"><span class="hs-identifier">Data.Singletons.Promote.Defun</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html"><span class="hs-identifier">Data.Singletons.Promote.Monad</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#promoteM"><span class="hs-identifier">promoteM</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Type.html"><span class="hs-identifier">Data.Singletons.Promote.Type</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Names.html"><span class="hs-identifier">Data.Singletons.Names</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html"><span class="hs-identifier">Data.Singletons.Single.Monad</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Type.html"><span class="hs-identifier">Data.Singletons.Single.Type</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Data.html"><span class="hs-identifier">Data.Singletons.Single.Data</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Defun.html"><span class="hs-identifier">Data.Singletons.Single.Defun</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Fixity.html"><span class="hs-identifier">Data.Singletons.Single.Fixity</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Eq.html"><span class="hs-identifier">Data.Singletons.Single.Eq</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html"><span class="hs-identifier">Data.Singletons.Syntax</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Partition.html"><span class="hs-identifier">Data.Singletons.Partition</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar.OMap.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">OMap</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar.OMap.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">OMap</span></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar.OSet</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">OSet</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar.OSet</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">OSet</span></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">GHC.LanguageExtensions.Type</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LangExt</span></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-comment">{-
How singletons works
~~~~~~~~~~~~~~~~~~~~

Singling, on the surface, doesn't seem all that complicated. Promote the type,
and singletonize all the terms. That's essentially what was done singletons &lt; 1.0.
But, now we want to deal with higher-order singletons. So, things are a little
more complicated.

The way to understand all of this is that *every* variable maps to something
of type (Sing t), for an appropriately-kinded t. This includes functions, which
use the &quot;SLambda&quot; instance of Sing. To apply singleton functions, we use the
applySing function.

That, in and of itself, wouldn't be too hard, but it's really annoying from
the user standpoint. After dutifully singling `map`, a user doesn't want to
have to use two `applySing`s to actually use it. So, any let-bound identifier
is eta-expanded so that the singled type has the same number of arrows as
the original type. (If there is no original type signature, then it has as
many arrows as the original had patterns.) Then, we store a use of one of the
singFunX functions in the SgM environment so that every use of a let-bound
identifier has a proper type (Sing t).

It would be consistent to avoid this eta-expansion for local lets (as opposed
to top-level lets), but that seemed like more bother than it was worth. It
may also be possible to be cleverer about nested eta-expansions and contractions,
but that also seemed not to be worth it. Though I haven't tested it, my hope
is that the eta-expansions and contractions have no runtime effect, especially
because SLambda is a *newtype* instance, not a *data* instance.

Note that to maintain the desired invariant, we must also be careful to eta-
contract constructors. This is the point of buildDataLets.
-}</span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-comment">-- | Generate singleton definitions from a type that is already defined.</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- For example, the singletons package itself uses</span><span>
</span><span id="line-84"></span><span class="hs-comment">--</span><span>
</span><span id="line-85"></span><span class="hs-comment">-- &gt; $(genSingletons [''Bool, ''Maybe, ''Either, ''[]])</span><span>
</span><span id="line-86"></span><span class="hs-comment">--</span><span>
</span><span id="line-87"></span><span class="hs-comment">-- to generate singletons for Prelude types.</span><span>
</span><span id="line-88"></span><span id="local-6989586621681362142"><span class="annot"><a href="Data.Singletons.Single.html#genSingletons"><span class="hs-identifier hs-type">genSingletons</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362142"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362142"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-89"></span><span id="genSingletons"><span class="annot"><span class="annottext">genSingletons :: [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#genSingletons"><span class="hs-identifier hs-var hs-var">genSingletons</span></a></span></span><span> </span><span id="local-6989586621681362140"><span class="annot"><span class="annottext">names :: [Name]
</span><a href="#local-6989586621681362140"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-90"></span><span>  </span><span class="annot"><span class="annottext">[Name] -&gt; q ()
forall (q :: * -&gt; *). Quasi q =&gt; [Name] -&gt; q ()
</span><a href="Data.Singletons.Util.html#checkForRep"><span class="hs-identifier hs-var">checkForRep</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681362140"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-91"></span><span>  </span><span id="local-6989586621681362138"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681362138"><span class="hs-identifier hs-var">ddecs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; q [DDec]) -&gt; [Name] -&gt; q [DDec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DInfo -&gt; q [DDec]
forall (q :: * -&gt; *). DsMonad q =&gt; DInfo -&gt; q [DDec]
</span><a href="Data.Singletons.Single.html#singInfo"><span class="hs-identifier hs-var">singInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(DInfo -&gt; q [DDec]) -&gt; (Name -&gt; q DInfo) -&gt; Name -&gt; q [DDec]
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">Info -&gt; q DInfo
forall (q :: * -&gt; *). DsMonad q =&gt; Info -&gt; q DInfo
</span><span class="hs-identifier hs-var">dsInfo</span></span><span> </span><span class="annot"><span class="annottext">(Info -&gt; q DInfo) -&gt; (Name -&gt; q Info) -&gt; Name -&gt; q DInfo
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q Info
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q Info
</span><span class="hs-identifier hs-var">reifyWithLocals</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681362140"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-92"></span><span>  </span><span class="annot"><span class="annottext">[Dec] -&gt; q [Dec]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; q [Dec]) -&gt; [Dec] -&gt; q [Dec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [Dec]
</span><span class="hs-identifier hs-var">decsToTH</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681362138"><span class="hs-identifier hs-var">ddecs</span></a></span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="hs-comment">-- | Make promoted and singleton versions of all declarations given, retaining</span><span>
</span><span id="line-95"></span><span class="hs-comment">-- the original declarations.</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- See &lt;https://github.com/goldfirere/singletons/blob/master/README.md&gt; for</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- further explanation.</span><span>
</span><span id="line-98"></span><span id="local-6989586621681362131"><span class="annot"><a href="Data.Singletons.Single.html#singletons"><span class="hs-identifier hs-type">singletons</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362131"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362131"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362131"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-99"></span><span id="singletons"><span class="annot"><span class="annottext">singletons :: q [Dec] -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singletons"><span class="hs-identifier hs-var hs-var">singletons</span></a></span></span><span> </span><span id="local-6989586621681362129"><span class="annot"><span class="annottext">qdecs :: q [Dec]
</span><a href="#local-6989586621681362129"><span class="hs-identifier hs-var">qdecs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-100"></span><span>  </span><span id="local-6989586621681362128"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681362128"><span class="hs-identifier hs-var">decs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">q [Dec]
</span><a href="#local-6989586621681362129"><span class="hs-identifier hs-var">qdecs</span></a></span><span>
</span><span id="line-101"></span><span>  </span><span id="local-6989586621681362127"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681362127"><span class="hs-identifier hs-var">ddecs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; DsM q [DDec] -&gt; q [DDec]
forall (q :: * -&gt; *) a. DsMonad q =&gt; [Dec] -&gt; DsM q a -&gt; q a
</span><span class="hs-identifier hs-var">withLocalDeclarations</span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681362128"><span class="hs-identifier hs-var">decs</span></a></span><span> </span><span class="annot"><span class="annottext">(DsM q [DDec] -&gt; q [DDec]) -&gt; DsM q [DDec] -&gt; q [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; DsM q [DDec]
forall (q :: * -&gt; *). DsMonad q =&gt; [Dec] -&gt; q [DDec]
</span><span class="hs-identifier hs-var">dsDecs</span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681362128"><span class="hs-identifier hs-var">decs</span></a></span><span>
</span><span id="line-102"></span><span>  </span><span id="local-6989586621681362124"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681362124"><span class="hs-identifier hs-var">singDecs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; [DDec] -&gt; q [DDec]
forall (q :: * -&gt; *). DsMonad q =&gt; [Dec] -&gt; [DDec] -&gt; q [DDec]
</span><a href="Data.Singletons.Single.html#singTopLevelDecs"><span class="hs-identifier hs-var">singTopLevelDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681362128"><span class="hs-identifier hs-var">decs</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681362127"><span class="hs-identifier hs-var">ddecs</span></a></span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><span class="annottext">[Dec] -&gt; q [Dec]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681362128"><span class="hs-identifier hs-var">decs</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; [Dec] -&gt; [Dec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [Dec]
</span><span class="hs-identifier hs-var">decsToTH</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681362124"><span class="hs-identifier hs-var">singDecs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-comment">-- | Make promoted and singleton versions of all declarations given, discarding</span><span>
</span><span id="line-106"></span><span class="hs-comment">-- the original declarations. Note that a singleton based on a datatype needs</span><span>
</span><span id="line-107"></span><span class="hs-comment">-- the original datatype, so this will fail if it sees any datatype declarations.</span><span>
</span><span id="line-108"></span><span class="hs-comment">-- Classes, instances, and functions are all fine.</span><span>
</span><span id="line-109"></span><span id="local-6989586621681362122"><span class="annot"><a href="Data.Singletons.Single.html#singletonsOnly"><span class="hs-identifier hs-type">singletonsOnly</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362122"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362122"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362122"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-110"></span><span id="singletonsOnly"><span class="annot"><span class="annottext">singletonsOnly :: q [Dec] -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singletonsOnly"><span class="hs-identifier hs-var hs-var">singletonsOnly</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">q [Dec] -&gt; ([Dec] -&gt; q [Dec]) -&gt; q [Dec]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; [DDec] -&gt; q [DDec]) -&gt; [Dec] -&gt; q [Dec]
forall th ds (q :: * -&gt; *).
(Desugar th ds, DsMonad q) =&gt;
(th -&gt; ds -&gt; q ds) -&gt; th -&gt; q th
</span><a href="Data.Singletons.Util.html#wrapDesugar"><span class="hs-identifier hs-var">wrapDesugar</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; [DDec] -&gt; q [DDec]
forall (q :: * -&gt; *). DsMonad q =&gt; [Dec] -&gt; [DDec] -&gt; q [DDec]
</span><a href="Data.Singletons.Single.html#singTopLevelDecs"><span class="hs-identifier hs-var">singTopLevelDecs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="hs-comment">-- | Create instances of 'SEq' and type-level @(==)@ for each type in the list</span><span>
</span><span id="line-113"></span><span id="local-6989586621681362119"><span class="annot"><a href="Data.Singletons.Single.html#singEqInstances"><span class="hs-identifier hs-type">singEqInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362119"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362119"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-114"></span><span id="singEqInstances"><span class="annot"><span class="annottext">singEqInstances :: [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singEqInstances"><span class="hs-identifier hs-var hs-var">singEqInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; q [Dec]) -&gt; [Name] -&gt; q [Dec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q [Dec]
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singEqInstance"><span class="hs-identifier hs-var">singEqInstance</span></a></span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="hs-comment">-- | Create instance of 'SEq' and type-level @(==)@ for the given type</span><span>
</span><span id="line-117"></span><span id="local-6989586621681362379"><span class="annot"><a href="Data.Singletons.Single.html#singEqInstance"><span class="hs-identifier hs-type">singEqInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362379"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362379"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-118"></span><span id="singEqInstance"><span class="annot"><span class="annottext">singEqInstance :: Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singEqInstance"><span class="hs-identifier hs-var hs-var">singEqInstance</span></a></span></span><span> </span><span id="local-6989586621681362116"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681362116"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-119"></span><span>  </span><span id="local-6989586621681362115"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681362115"><span class="hs-identifier hs-var">promotion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; q [Dec]
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteEqInstance"><span class="hs-identifier hs-var">promoteEqInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362116"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-120"></span><span>  </span><span id="local-6989586621681362113"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681362113"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EqualityClassDesc q -&gt; Name -&gt; q [Dec]
forall (q :: * -&gt; *).
DsMonad q =&gt;
EqualityClassDesc q -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singEqualityInstance"><span class="hs-identifier hs-var">singEqualityInstance</span></a></span><span> </span><span class="annot"><span class="annottext">EqualityClassDesc q
forall (q :: * -&gt; *). Quasi q =&gt; EqualityClassDesc q
</span><a href="Data.Singletons.Single.Eq.html#sEqClassDesc"><span class="hs-identifier hs-var">sEqClassDesc</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362116"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-121"></span><span>  </span><span class="annot"><span class="annottext">[Dec] -&gt; q [Dec]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; q [Dec]) -&gt; [Dec] -&gt; q [Dec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681362113"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; [Dec] -&gt; [Dec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681362115"><span class="hs-identifier hs-var">promotion</span></a></span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span class="hs-comment">-- | Create instances of 'SEq' (only -- no instance for @(==)@, which 'SEq' generally</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- relies on) for each type in the list</span><span>
</span><span id="line-125"></span><span id="local-6989586621681362110"><span class="annot"><a href="Data.Singletons.Single.html#singEqInstancesOnly"><span class="hs-identifier hs-type">singEqInstancesOnly</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362110"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362110"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-126"></span><span id="singEqInstancesOnly"><span class="annot"><span class="annottext">singEqInstancesOnly :: [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singEqInstancesOnly"><span class="hs-identifier hs-var hs-var">singEqInstancesOnly</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; q [Dec]) -&gt; [Name] -&gt; q [Dec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q [Dec]
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singEqInstanceOnly"><span class="hs-identifier hs-var">singEqInstanceOnly</span></a></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span class="hs-comment">-- | Create instances of 'SEq' (only -- no instance for @(==)@, which 'SEq' generally</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- relies on) for the given type</span><span>
</span><span id="line-130"></span><span id="local-6989586621681362107"><span class="annot"><a href="Data.Singletons.Single.html#singEqInstanceOnly"><span class="hs-identifier hs-type">singEqInstanceOnly</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362107"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362107"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-131"></span><span id="singEqInstanceOnly"><span class="annot"><span class="annottext">singEqInstanceOnly :: Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singEqInstanceOnly"><span class="hs-identifier hs-var hs-var">singEqInstanceOnly</span></a></span></span><span> </span><span id="local-6989586621681362106"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681362106"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqualityClassDesc q -&gt; Name -&gt; q [Dec]
forall (q :: * -&gt; *).
DsMonad q =&gt;
EqualityClassDesc q -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singEqualityInstance"><span class="hs-identifier hs-var">singEqualityInstance</span></a></span><span> </span><span class="annot"><span class="annottext">EqualityClassDesc q
forall (q :: * -&gt; *). Quasi q =&gt; EqualityClassDesc q
</span><a href="Data.Singletons.Single.Eq.html#sEqClassDesc"><span class="hs-identifier hs-var">sEqClassDesc</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362106"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="hs-comment">-- | Create instances of 'SDecide', 'TestEquality', and 'TestCoercion' for each</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- type in the list.</span><span>
</span><span id="line-135"></span><span id="local-6989586621681362105"><span class="annot"><a href="Data.Singletons.Single.html#singDecideInstances"><span class="hs-identifier hs-type">singDecideInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362105"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362105"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-136"></span><span id="singDecideInstances"><span class="annot"><span class="annottext">singDecideInstances :: [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singDecideInstances"><span class="hs-identifier hs-var hs-var">singDecideInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; q [Dec]) -&gt; [Name] -&gt; q [Dec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q [Dec]
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singDecideInstance"><span class="hs-identifier hs-var">singDecideInstance</span></a></span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span class="hs-comment">-- | Create instance of 'SDecide', 'TestEquality', and 'TestCoercion' for the</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- given type.</span><span>
</span><span id="line-140"></span><span id="local-6989586621681362102"><span class="annot"><a href="Data.Singletons.Single.html#singDecideInstance"><span class="hs-identifier hs-type">singDecideInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362102"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362102"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-141"></span><span id="singDecideInstance"><span class="annot"><span class="annottext">singDecideInstance :: Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singDecideInstance"><span class="hs-identifier hs-var hs-var">singDecideInstance</span></a></span></span><span> </span><span id="local-6989586621681362101"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681362101"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EqualityClassDesc q -&gt; Name -&gt; q [Dec]
forall (q :: * -&gt; *).
DsMonad q =&gt;
EqualityClassDesc q -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singEqualityInstance"><span class="hs-identifier hs-var">singEqualityInstance</span></a></span><span> </span><span class="annot"><span class="annottext">EqualityClassDesc q
forall (q :: * -&gt; *). Quasi q =&gt; EqualityClassDesc q
</span><a href="Data.Singletons.Single.Eq.html#sDecideClassDesc"><span class="hs-identifier hs-var">sDecideClassDesc</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362101"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span class="hs-comment">-- generalized function for creating equality instances</span><span>
</span><span id="line-144"></span><span id="local-6989586621681362376"><span class="annot"><a href="Data.Singletons.Single.html#singEqualityInstance"><span class="hs-identifier hs-type">singEqualityInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362376"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Eq.html#EqualityClassDesc"><span class="hs-identifier hs-type">EqualityClassDesc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681362376"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362376"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-145"></span><span id="singEqualityInstance"><span class="annot"><span class="annottext">singEqualityInstance :: EqualityClassDesc q -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singEqualityInstance"><span class="hs-identifier hs-var hs-var">singEqualityInstance</span></a></span></span><span> </span><span id="local-6989586621681362099"><span class="annot"><span class="annottext">desc :: EqualityClassDesc q
</span><a href="#local-6989586621681362099"><span class="hs-identifier hs-var">desc</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span id="local-6989586621681362098"><span class="annot"><span class="annottext">className :: Name
</span><a href="#local-6989586621681362098"><span class="hs-identifier hs-var">className</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span id="local-6989586621681362097"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681362097"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681362096"><span class="annot"><span class="annottext">tvbs :: [TyVarBndr]
</span><a href="#local-6989586621681362096"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681362095"><span class="annot"><span class="annottext">cons :: [Con]
</span><a href="#local-6989586621681362095"><span class="hs-identifier hs-var">cons</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name -&gt; q ([TyVarBndr], [Con])
forall (q :: * -&gt; *).
DsMonad q =&gt;
String -&gt; Name -&gt; q ([TyVarBndr], [Con])
</span><span class="hs-identifier hs-var">getDataD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;I cannot make an instance of &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-147"></span><span>                            </span><span class="annot"><span class="annottext">Name -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362098"><span class="hs-identifier hs-var">className</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot; for it.&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362097"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-148"></span><span>  </span><span id="local-6989586621681362092"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681362092"><span class="hs-identifier hs-var">dtvbs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TyVarBndr -&gt; q DTyVarBndr) -&gt; [TyVarBndr] -&gt; q [DTyVarBndr]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">TyVarBndr -&gt; q DTyVarBndr
forall (q :: * -&gt; *). DsMonad q =&gt; TyVarBndr -&gt; q DTyVarBndr
</span><span class="hs-identifier hs-var">dsTvb</span></span><span> </span><span class="annot"><span class="annottext">[TyVarBndr]
</span><a href="#local-6989586621681362096"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681362089"><span class="annot"><span class="annottext">data_ty :: DType
</span><a href="#local-6989586621681362089"><span class="hs-identifier hs-var hs-var">data_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DTyVarBndr] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362097"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681362092"><span class="hs-identifier hs-var">dtvbs</span></a></span><span>
</span><span id="line-150"></span><span>  </span><span id="local-6989586621681362086"><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681362086"><span class="hs-identifier hs-var">dcons</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Con -&gt; q [DCon]) -&gt; [Con] -&gt; q [DCon]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; DType -&gt; Con -&gt; q [DCon]
forall (q :: * -&gt; *).
DsMonad q =&gt;
[DTyVarBndr] -&gt; DType -&gt; Con -&gt; q [DCon]
</span><span class="hs-identifier hs-var">dsCon</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681362092"><span class="hs-identifier hs-var">dtvbs</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681362089"><span class="hs-identifier hs-var">data_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Con]
</span><a href="#local-6989586621681362095"><span class="hs-identifier hs-var">cons</span></a></span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681362084"><span class="annot"><span class="annottext">tyvars :: [DType]
</span><a href="#local-6989586621681362084"><span class="hs-identifier hs-var hs-var">tyvars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; DType) -&gt; [DTyVarBndr] -&gt; [DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; (DTyVarBndr -&gt; Name) -&gt; DTyVarBndr -&gt; DType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; Name
</span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681362092"><span class="hs-identifier hs-var">dtvbs</span></a></span><span>
</span><span id="line-152"></span><span>      </span><span id="local-6989586621681362080"><span class="annot"><span class="annottext">kind :: DType
</span><a href="#local-6989586621681362080"><span class="hs-identifier hs-var hs-var">kind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362097"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681362084"><span class="hs-identifier hs-var">tyvars</span></a></span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681362078"><span class="annot"><span class="annottext">scons :: [DCon]
</span><a href="#local-6989586621681362078"><span class="hs-identifier hs-var">scons</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; SgM [DCon] -&gt; q ([DCon], [DDec])
forall (q :: * -&gt; *) a.
DsMonad q =&gt;
[Dec] -&gt; SgM a -&gt; q (a, [DDec])
</span><a href="Data.Singletons.Single.Monad.html#singM"><span class="hs-identifier hs-var">singM</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(SgM [DCon] -&gt; q ([DCon], [DDec]))
-&gt; SgM [DCon] -&gt; q ([DCon], [DDec])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DCon -&gt; SgM DCon) -&gt; [DCon] -&gt; SgM [DCon]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DCon -&gt; SgM DCon
</span><a href="Data.Singletons.Single.Data.html#singCtor"><span class="hs-identifier hs-var">singCtor</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362097"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681362086"><span class="hs-identifier hs-var">dcons</span></a></span><span>
</span><span id="line-154"></span><span>  </span><span id="local-6989586621681362075"><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681362075"><span class="hs-identifier hs-var">eqInstance</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe [DType]
-&gt; DType -&gt; [DCon] -&gt; [DCon] -&gt; EqualityClassDesc q -&gt; q DDec
forall (q :: * -&gt; *).
DsMonad q =&gt;
Maybe [DType]
-&gt; DType -&gt; [DCon] -&gt; [DCon] -&gt; EqualityClassDesc q -&gt; q DDec
</span><a href="Data.Singletons.Single.Eq.html#mkEqualityInstance"><span class="hs-identifier hs-var">mkEqualityInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [DType]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681362080"><span class="hs-identifier hs-var">kind</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681362086"><span class="hs-identifier hs-var">dcons</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681362078"><span class="hs-identifier hs-var">scons</span></a></span><span> </span><span class="annot"><span class="annottext">EqualityClassDesc q
</span><a href="#local-6989586621681362099"><span class="hs-identifier hs-var">desc</span></a></span><span>
</span><span id="line-155"></span><span>  </span><span id="local-6989586621681362073"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681362073"><span class="hs-identifier hs-var">testInstances</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362098"><span class="hs-identifier hs-var">className</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#sDecideClassName"><span class="hs-identifier hs-var">sDecideClassName</span></a></span><span>
</span><span id="line-157"></span><span>       </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(TestInstance -&gt; q DDec) -&gt; [TestInstance] -&gt; q [DDec]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe [DType] -&gt; DType -&gt; Name -&gt; [DCon] -&gt; TestInstance -&gt; q DDec
forall (q :: * -&gt; *).
DsMonad q =&gt;
Maybe [DType] -&gt; DType -&gt; Name -&gt; [DCon] -&gt; TestInstance -&gt; q DDec
</span><a href="Data.Singletons.Single.Eq.html#mkTestInstance"><span class="hs-identifier hs-var">mkTestInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [DType]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681362080"><span class="hs-identifier hs-var">kind</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362097"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681362086"><span class="hs-identifier hs-var">dcons</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>                     </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TestInstance
</span><a href="Data.Singletons.Single.Eq.html#TestEquality"><span class="hs-identifier hs-var">TestEquality</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TestInstance
</span><a href="Data.Singletons.Single.Eq.html#TestCoercion"><span class="hs-identifier hs-var">TestCoercion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-159"></span><span>       </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; q [DDec]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-160"></span><span>  </span><span class="annot"><span class="annottext">[Dec] -&gt; q [Dec]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; q [Dec]) -&gt; [Dec] -&gt; q [Dec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [Dec]
</span><span class="hs-identifier hs-var">decsToTH</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681362075"><span class="hs-identifier hs-var">eqInstance</span></a></span><span class="annot"><span class="annottext">DDec -&gt; [DDec] -&gt; [DDec]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681362073"><span class="hs-identifier hs-var">testInstances</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span class="hs-comment">-- | Create instances of 'SOrd' for the given types</span><span>
</span><span id="line-163"></span><span id="local-6989586621681362067"><span class="annot"><a href="Data.Singletons.Single.html#singOrdInstances"><span class="hs-identifier hs-type">singOrdInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362067"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362067"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-164"></span><span id="singOrdInstances"><span class="annot"><span class="annottext">singOrdInstances :: [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singOrdInstances"><span class="hs-identifier hs-var hs-var">singOrdInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; q [Dec]) -&gt; [Name] -&gt; q [Dec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q [Dec]
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singOrdInstance"><span class="hs-identifier hs-var">singOrdInstance</span></a></span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span class="hs-comment">-- | Create instance of 'SOrd' for the given type</span><span>
</span><span id="line-167"></span><span id="local-6989586621681362064"><span class="annot"><a href="Data.Singletons.Single.html#singOrdInstance"><span class="hs-identifier hs-type">singOrdInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362064"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362064"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-168"></span><span id="singOrdInstance"><span class="annot"><span class="annottext">singOrdInstance :: Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singOrdInstance"><span class="hs-identifier hs-var hs-var">singOrdInstance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
forall (q :: * -&gt; *).
DsMonad q =&gt;
DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singInstance"><span class="hs-identifier hs-var">singInstance</span></a></span><span> </span><span class="annot"><span class="annottext">DerivDesc q
forall (q :: * -&gt; *). DsMonad q =&gt; DerivDesc q
</span><a href="Data.Singletons.Deriving.Ord.html#mkOrdInstance"><span class="hs-identifier hs-var">mkOrdInstance</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Ord&quot;</span></span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span class="hs-comment">-- | Create instances of 'SBounded' for the given types</span><span>
</span><span id="line-171"></span><span id="local-6989586621681362061"><span class="annot"><a href="Data.Singletons.Single.html#singBoundedInstances"><span class="hs-identifier hs-type">singBoundedInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362061"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362061"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-172"></span><span id="singBoundedInstances"><span class="annot"><span class="annottext">singBoundedInstances :: [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singBoundedInstances"><span class="hs-identifier hs-var hs-var">singBoundedInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; q [Dec]) -&gt; [Name] -&gt; q [Dec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q [Dec]
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singBoundedInstance"><span class="hs-identifier hs-var">singBoundedInstance</span></a></span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span class="hs-comment">-- | Create instance of 'SBounded' for the given type</span><span>
</span><span id="line-175"></span><span id="local-6989586621681362058"><span class="annot"><a href="Data.Singletons.Single.html#singBoundedInstance"><span class="hs-identifier hs-type">singBoundedInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362058"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362058"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-176"></span><span id="singBoundedInstance"><span class="annot"><span class="annottext">singBoundedInstance :: Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singBoundedInstance"><span class="hs-identifier hs-var hs-var">singBoundedInstance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
forall (q :: * -&gt; *).
DsMonad q =&gt;
DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singInstance"><span class="hs-identifier hs-var">singInstance</span></a></span><span> </span><span class="annot"><span class="annottext">DerivDesc q
forall (q :: * -&gt; *). DsMonad q =&gt; DerivDesc q
</span><a href="Data.Singletons.Deriving.Bounded.html#mkBoundedInstance"><span class="hs-identifier hs-var">mkBoundedInstance</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Bounded&quot;</span></span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="hs-comment">-- | Create instances of 'SEnum' for the given types</span><span>
</span><span id="line-179"></span><span id="local-6989586621681362056"><span class="annot"><a href="Data.Singletons.Single.html#singEnumInstances"><span class="hs-identifier hs-type">singEnumInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362056"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362056"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-180"></span><span id="singEnumInstances"><span class="annot"><span class="annottext">singEnumInstances :: [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singEnumInstances"><span class="hs-identifier hs-var hs-var">singEnumInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; q [Dec]) -&gt; [Name] -&gt; q [Dec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q [Dec]
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singEnumInstance"><span class="hs-identifier hs-var">singEnumInstance</span></a></span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="hs-comment">-- | Create instance of 'SEnum' for the given type</span><span>
</span><span id="line-183"></span><span id="local-6989586621681362053"><span class="annot"><a href="Data.Singletons.Single.html#singEnumInstance"><span class="hs-identifier hs-type">singEnumInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362053"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362053"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-184"></span><span id="singEnumInstance"><span class="annot"><span class="annottext">singEnumInstance :: Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singEnumInstance"><span class="hs-identifier hs-var hs-var">singEnumInstance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
forall (q :: * -&gt; *).
DsMonad q =&gt;
DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singInstance"><span class="hs-identifier hs-var">singInstance</span></a></span><span> </span><span class="annot"><span class="annottext">DerivDesc q
forall (q :: * -&gt; *). DsMonad q =&gt; DerivDesc q
</span><a href="Data.Singletons.Deriving.Enum.html#mkEnumInstance"><span class="hs-identifier hs-var">mkEnumInstance</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Enum&quot;</span></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-comment">-- | Create instance of 'SShow' for the given type</span><span>
</span><span id="line-187"></span><span class="hs-comment">--</span><span>
</span><span id="line-188"></span><span class="hs-comment">-- (Not to be confused with 'showShowInstance'.)</span><span>
</span><span id="line-189"></span><span id="local-6989586621681362051"><span class="annot"><a href="Data.Singletons.Single.html#singShowInstance"><span class="hs-identifier hs-type">singShowInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362051"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362051"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-190"></span><span id="singShowInstance"><span class="annot"><span class="annottext">singShowInstance :: Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singShowInstance"><span class="hs-identifier hs-var hs-var">singShowInstance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
forall (q :: * -&gt; *).
DsMonad q =&gt;
DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singInstance"><span class="hs-identifier hs-var">singInstance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShowMode -&gt; DerivDesc q
forall (q :: * -&gt; *). DsMonad q =&gt; ShowMode -&gt; DerivDesc q
</span><a href="Data.Singletons.Deriving.Show.html#mkShowInstance"><span class="hs-identifier hs-var">mkShowInstance</span></a></span><span> </span><span class="annot"><span class="annottext">ShowMode
</span><a href="Data.Singletons.Deriving.Show.html#ForPromotion"><span class="hs-identifier hs-var">ForPromotion</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-string">&quot;Show&quot;</span></span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span class="hs-comment">-- | Create instances of 'SShow' for the given types</span><span>
</span><span id="line-193"></span><span class="hs-comment">--</span><span>
</span><span id="line-194"></span><span class="hs-comment">-- (Not to be confused with 'showSingInstances'.)</span><span>
</span><span id="line-195"></span><span id="local-6989586621681362047"><span class="annot"><a href="Data.Singletons.Single.html#singShowInstances"><span class="hs-identifier hs-type">singShowInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362047"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362047"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-196"></span><span id="singShowInstances"><span class="annot"><span class="annottext">singShowInstances :: [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singShowInstances"><span class="hs-identifier hs-var hs-var">singShowInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; q [Dec]) -&gt; [Name] -&gt; q [Dec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q [Dec]
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singShowInstance"><span class="hs-identifier hs-var">singShowInstance</span></a></span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="hs-comment">-- | Create instance of 'Show' for the given singleton type</span><span>
</span><span id="line-199"></span><span class="hs-comment">--</span><span>
</span><span id="line-200"></span><span class="hs-comment">-- (Not to be confused with 'singShowInstance'.)</span><span>
</span><span id="line-201"></span><span id="local-6989586621681362045"><span class="annot"><a href="Data.Singletons.Single.html#showSingInstance"><span class="hs-identifier hs-type">showSingInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362045"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362045"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-202"></span><span id="showSingInstance"><span class="annot"><span class="annottext">showSingInstance :: Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#showSingInstance"><span class="hs-identifier hs-var hs-var">showSingInstance</span></a></span></span><span> </span><span id="local-6989586621681362043"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681362043"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681362042"><span class="annot"><span class="annottext">tvbs :: [TyVarBndr]
</span><a href="#local-6989586621681362042"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681362041"><span class="annot"><span class="annottext">cons :: [Con]
</span><a href="#local-6989586621681362041"><span class="hs-identifier hs-var">cons</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name -&gt; q ([TyVarBndr], [Con])
forall (q :: * -&gt; *).
DsMonad q =&gt;
String -&gt; Name -&gt; q ([TyVarBndr], [Con])
</span><span class="hs-identifier hs-var">getDataD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;I cannot make an instance of Show for it.&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362043"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-204"></span><span>  </span><span id="local-6989586621681362040"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681362040"><span class="hs-identifier hs-var">dtvbs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TyVarBndr -&gt; q DTyVarBndr) -&gt; [TyVarBndr] -&gt; q [DTyVarBndr]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">TyVarBndr -&gt; q DTyVarBndr
forall (q :: * -&gt; *). DsMonad q =&gt; TyVarBndr -&gt; q DTyVarBndr
</span><span class="hs-identifier hs-var">dsTvb</span></span><span> </span><span class="annot"><span class="annottext">[TyVarBndr]
</span><a href="#local-6989586621681362042"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681362039"><span class="annot"><span class="annottext">data_ty :: DType
</span><a href="#local-6989586621681362039"><span class="hs-identifier hs-var hs-var">data_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DTyVarBndr] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362043"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681362040"><span class="hs-identifier hs-var">dtvbs</span></a></span><span>
</span><span id="line-206"></span><span>  </span><span id="local-6989586621681362038"><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681362038"><span class="hs-identifier hs-var">dcons</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Con -&gt; q [DCon]) -&gt; [Con] -&gt; q [DCon]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; DType -&gt; Con -&gt; q [DCon]
forall (q :: * -&gt; *).
DsMonad q =&gt;
[DTyVarBndr] -&gt; DType -&gt; Con -&gt; q [DCon]
</span><span class="hs-identifier hs-var">dsCon</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681362040"><span class="hs-identifier hs-var">dtvbs</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681362039"><span class="hs-identifier hs-var">data_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Con]
</span><a href="#local-6989586621681362041"><span class="hs-identifier hs-var">cons</span></a></span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681362037"><span class="annot"><span class="annottext">tyvars :: [DType]
</span><a href="#local-6989586621681362037"><span class="hs-identifier hs-var hs-var">tyvars</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; DType) -&gt; [DTyVarBndr] -&gt; [DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; (DTyVarBndr -&gt; Name) -&gt; DTyVarBndr -&gt; DType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; Name
</span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681362040"><span class="hs-identifier hs-var">dtvbs</span></a></span><span>
</span><span id="line-208"></span><span>      </span><span id="local-6989586621681362036"><span class="annot"><span class="annottext">kind :: DType
</span><a href="#local-6989586621681362036"><span class="hs-identifier hs-var hs-var">kind</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362043"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681362037"><span class="hs-identifier hs-var">tyvars</span></a></span><span>
</span><span id="line-209"></span><span>      </span><span id="local-6989586621681362035"><span class="annot"><span class="annottext">data_decl :: DataDecl
</span><a href="#local-6989586621681362035"><span class="hs-identifier hs-var hs-var">data_decl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [DTyVarBndr] -&gt; [DCon] -&gt; DataDecl
</span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362043"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681362040"><span class="hs-identifier hs-var">dtvbs</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681362038"><span class="hs-identifier hs-var">dcons</span></a></span><span>
</span><span id="line-210"></span><span>      </span><span id="local-6989586621681362033"><span class="annot"><span class="annottext">deriv_show_decl :: DerivedDecl cls
</span><a href="#local-6989586621681362033"><span class="hs-identifier hs-var hs-var">deriv_show_decl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DerivedDecl :: forall (cls :: * -&gt; Constraint).
Maybe [DType] -&gt; DType -&gt; Name -&gt; DataDecl -&gt; DerivedDecl cls
</span><a href="Data.Singletons.Syntax.html#DerivedDecl"><span class="hs-identifier hs-type hs-type">DerivedDecl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ded_mb_cxt :: Maybe [DType]
</span><a href="Data.Singletons.Syntax.html#ded_mb_cxt"><span class="hs-identifier hs-var">ded_mb_cxt</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe [DType]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-211"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ded_type :: DType
</span><a href="Data.Singletons.Syntax.html#ded_type"><span class="hs-identifier hs-var">ded_type</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681362036"><span class="hs-identifier hs-var">kind</span></a></span><span>
</span><span id="line-212"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ded_type_tycon :: Name
</span><a href="Data.Singletons.Syntax.html#ded_type_tycon"><span class="hs-identifier hs-var">ded_type_tycon</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362043"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-213"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ded_decl :: DataDecl
</span><a href="Data.Singletons.Syntax.html#ded_decl"><span class="hs-identifier hs-var">ded_decl</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataDecl
</span><a href="#local-6989586621681362035"><span class="hs-identifier hs-var">data_decl</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681362026"><span class="annot"><span class="annottext">show_insts :: [DDec]
</span><a href="#local-6989586621681362026"><span class="hs-identifier hs-var">show_insts</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; SgM [DDec] -&gt; q ([DDec], [DDec])
forall (q :: * -&gt; *) a.
DsMonad q =&gt;
[Dec] -&gt; SgM a -&gt; q (a, [DDec])
</span><a href="Data.Singletons.Single.Monad.html#singM"><span class="hs-identifier hs-var">singM</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(SgM [DDec] -&gt; q ([DDec], [DDec]))
-&gt; SgM [DDec] -&gt; q ([DDec], [DDec])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DerivedShowDecl -&gt; SgM [DDec]
</span><a href="Data.Singletons.Single.html#singDerivedShowDecs"><span class="hs-identifier hs-var">singDerivedShowDecs</span></a></span><span> </span><span class="annot"><span class="annottext">DerivedShowDecl
forall (cls :: * -&gt; Constraint). DerivedDecl cls
</span><a href="#local-6989586621681362033"><span class="hs-identifier hs-var">deriv_show_decl</span></a></span><span>
</span><span id="line-215"></span><span>  </span><span class="annot"><span class="annottext">[Dec] -&gt; q [Dec]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; q [Dec]) -&gt; [Dec] -&gt; q [Dec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [Dec]
</span><span class="hs-identifier hs-var">decsToTH</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681362026"><span class="hs-identifier hs-var">show_insts</span></a></span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="hs-comment">-- | Create instances of 'Show' for the given singleton types</span><span>
</span><span id="line-218"></span><span class="hs-comment">--</span><span>
</span><span id="line-219"></span><span class="hs-comment">-- (Not to be confused with 'singShowInstances'.)</span><span>
</span><span id="line-220"></span><span id="local-6989586621681362024"><span class="annot"><a href="Data.Singletons.Single.html#showSingInstances"><span class="hs-identifier hs-type">showSingInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362024"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362024"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-221"></span><span id="showSingInstances"><span class="annot"><span class="annottext">showSingInstances :: [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#showSingInstances"><span class="hs-identifier hs-var hs-var">showSingInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; q [Dec]) -&gt; [Name] -&gt; q [Dec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q [Dec]
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#showSingInstance"><span class="hs-identifier hs-var">showSingInstance</span></a></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="hs-comment">-- | Create an instance for @'SingI' TyCon{N}@, where @N@ is the positive</span><span>
</span><span id="line-224"></span><span class="hs-comment">-- number provided as an argument.</span><span>
</span><span id="line-225"></span><span class="hs-comment">--</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- Note that the generated code requires the use of the @QuantifiedConstraints@</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- language extension.</span><span>
</span><span id="line-228"></span><span id="local-6989586621681362022"><span class="annot"><a href="Data.Singletons.Single.html#singITyConInstances"><span class="hs-identifier hs-type">singITyConInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362022"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362022"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-229"></span><span id="singITyConInstances"><span class="annot"><span class="annottext">singITyConInstances :: [Int] -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singITyConInstances"><span class="hs-identifier hs-var hs-var">singITyConInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; q [Dec]) -&gt; [Int] -&gt; q [Dec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; q [Dec]
forall (q :: * -&gt; *). DsMonad q =&gt; Int -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singITyConInstance"><span class="hs-identifier hs-var">singITyConInstance</span></a></span><span>
</span><span id="line-230"></span><span>
</span><span id="line-231"></span><span class="hs-comment">-- | Create an instance for @'SingI' TyCon{N}@, where @N@ is the positive</span><span>
</span><span id="line-232"></span><span class="hs-comment">-- number provided as an argument.</span><span>
</span><span id="line-233"></span><span class="hs-comment">--</span><span>
</span><span id="line-234"></span><span class="hs-comment">-- Note that the generated code requires the use of the @QuantifiedConstraints@</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- language extension.</span><span>
</span><span id="line-236"></span><span id="local-6989586621681362316"><span class="annot"><a href="Data.Singletons.Single.html#singITyConInstance"><span class="hs-identifier hs-type">singITyConInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362316"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362316"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-237"></span><span id="singITyConInstance"><span class="annot"><span class="annottext">singITyConInstance :: Int -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singITyConInstance"><span class="hs-identifier hs-var hs-var">singITyConInstance</span></a></span></span><span> </span><span id="local-6989586621681362019"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621681362019"><span class="hs-identifier hs-var">n</span></a></span></span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681362019"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; q [Dec]
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; q [Dec]) -&gt; String -&gt; q [Dec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Argument must be a positive number (given &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681362019"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-241"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621681362017"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681362017"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; q Name -&gt; q [Name]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681362019"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; q Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="hs-string">&quot;a&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>       </span><span id="local-6989586621681362014"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681362014"><span class="hs-identifier hs-var">ks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; q Name -&gt; q [Name]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681362019"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; q Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="hs-string">&quot;k&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>       </span><span id="local-6989586621681362013"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362013"><span class="hs-identifier hs-var">k_last</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; q Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="hs-string">&quot;k_last&quot;</span></span><span>
</span><span id="line-244"></span><span>       </span><span id="local-6989586621681362012"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362012"><span class="hs-identifier hs-var">f</span></a></span></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; q Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="hs-string">&quot;f&quot;</span></span><span>
</span><span id="line-245"></span><span>       </span><span id="local-6989586621681362011"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362011"><span class="hs-identifier hs-var">x</span></a></span></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; q Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="hs-string">&quot;x&quot;</span></span><span>
</span><span id="line-246"></span><span>       </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681362010"><span class="annot"><span class="annottext">k_penult :: Name
</span><a href="#local-6989586621681362010"><span class="hs-identifier hs-var hs-var">k_penult</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; Name
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681362014"><span class="hs-identifier hs-var">ks</span></a></span><span>
</span><span id="line-247"></span><span>           </span><span id="local-6989586621681362008"><span class="annot"><span class="annottext">k_fun :: DType
</span><a href="#local-6989586621681362008"><span class="hs-identifier hs-var hs-var">k_fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DType] -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Util.html#ravel"><span class="hs-identifier hs-var">ravel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; [DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681362014"><span class="hs-identifier hs-var">ks</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362013"><span class="hs-identifier hs-var">k_last</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>           </span><span id="local-6989586621681362006"><span class="annot"><span class="annottext">f_ty :: DType
</span><a href="#local-6989586621681362006"><span class="hs-identifier hs-var hs-var">f_ty</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362012"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-249"></span><span>           </span><span id="local-6989586621681362005"><span class="annot"><span class="annottext">a_tys :: [DType]
</span><a href="#local-6989586621681362005"><span class="hs-identifier hs-var hs-var">a_tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; [DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681362017"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-250"></span><span>           </span><span id="local-6989586621681362004"><span class="annot"><span class="annottext">mk_fun :: DType -&gt; DType -&gt; DType -&gt; DType
</span><a href="#local-6989586621681362004"><span class="hs-identifier hs-var hs-var">mk_fun</span></a></span></span><span> </span><span id="local-6989586621681362003"><span class="annot"><span class="annottext">arrow :: DType
</span><a href="#local-6989586621681362003"><span class="hs-identifier hs-var">arrow</span></a></span></span><span> </span><span id="local-6989586621681362002"><span class="annot"><span class="annottext">t1 :: DType
</span><a href="#local-6989586621681362002"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621681362001"><span class="annot"><span class="annottext">t2 :: DType
</span><a href="#local-6989586621681362001"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681362003"><span class="hs-identifier hs-var">arrow</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681362002"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681362001"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-251"></span><span>           </span><span id="local-6989586621681361999"><span class="annot"><span class="annottext">matchable_apply_fun :: DType
</span><a href="#local-6989586621681361999"><span class="hs-identifier hs-var hs-var">matchable_apply_fun</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType -&gt; DType
</span><a href="#local-6989586621681362004"><span class="hs-identifier hs-var">mk_fun</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><span class="hs-identifier hs-var">DArrowT</span></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362010"><span class="hs-identifier hs-var">k_penult</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362013"><span class="hs-identifier hs-var">k_last</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>           </span><span id="local-6989586621681361997"><span class="annot"><span class="annottext">unmatchable_apply_fun :: DType
</span><a href="#local-6989586621681361997"><span class="hs-identifier hs-var hs-var">unmatchable_apply_fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType -&gt; DType
</span><a href="#local-6989586621681362004"><span class="hs-identifier hs-var">mk_fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#tyFunArrowName"><span class="hs-identifier hs-var">tyFunArrowName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362010"><span class="hs-identifier hs-var">k_penult</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362013"><span class="hs-identifier hs-var">k_last</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>           </span><span id="local-6989586621681361995"><span class="annot"><span class="annottext">ctxt :: [DType]
</span><a href="#local-6989586621681361995"><span class="hs-identifier hs-var hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; [DType] -&gt; DType -&gt; DType
</span><span class="hs-identifier hs-var">DForallT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DTyVarBndr) -&gt; [Name] -&gt; [DTyVarBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DTyVarBndr
</span><span class="hs-identifier hs-var">DPlainTV</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681362017"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DType -&gt; DType) -&gt; [DType] -&gt; [DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-identifier hs-var">DAppT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#singIName"><span class="hs-identifier hs-var">singIName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681362005"><span class="hs-identifier hs-var">a_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#singIName"><span class="hs-identifier hs-var">singIName</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681362006"><span class="hs-identifier hs-var">f_ty</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681362005"><span class="hs-identifier hs-var">a_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#equalityName"><span class="hs-identifier hs-var">equalityName</span></a></span><span>
</span><span id="line-257"></span><span>                      </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#applyTyConName"><span class="hs-identifier hs-var">applyTyConName</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DSigT`</span></span><span>
</span><span id="line-258"></span><span>                                </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType -&gt; DType
</span><a href="#local-6989586621681362004"><span class="hs-identifier hs-var">mk_fun</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><span class="hs-identifier hs-var">DArrowT</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361999"><span class="hs-identifier hs-var">matchable_apply_fun</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361997"><span class="hs-identifier hs-var">unmatchable_apply_fun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>                      </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#applyTyConAux1Name"><span class="hs-identifier hs-var">applyTyConAux1Name</span></a></span><span>
</span><span id="line-260"></span><span>                  </span><span class="hs-special">]</span><span>
</span><span id="line-261"></span><span>       </span><span class="annot"><span class="annottext">[Dec] -&gt; q [Dec]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; q [Dec]) -&gt; [Dec] -&gt; q [Dec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DDec -&gt; [Dec]
</span><span class="hs-identifier hs-var">decToTH</span></span><span>
</span><span id="line-262"></span><span>            </span><span class="annot"><span class="annottext">(DDec -&gt; [Dec]) -&gt; DDec -&gt; [Dec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Overlap
-&gt; Maybe [DTyVarBndr] -&gt; [DType] -&gt; DType -&gt; [DDec] -&gt; DDec
</span><span class="hs-identifier hs-var">DInstanceD</span></span><span>
</span><span id="line-263"></span><span>                </span><span class="annot"><span class="annottext">Maybe Overlap
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe [DTyVarBndr]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361995"><span class="hs-identifier hs-var">ctxt</span></a></span><span>
</span><span id="line-264"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#singIName"><span class="hs-identifier hs-var">singIName</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Name
</span><a href="Data.Singletons.Names.html#mkTyConName"><span class="hs-identifier hs-var">mkTyConName</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681362019"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681362006"><span class="hs-identifier hs-var">f_ty</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DSigT`</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681362008"><span class="hs-identifier hs-var">k_fun</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>                </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DLetDec -&gt; DDec
</span><span class="hs-identifier hs-var">DLetDec</span></span><span> </span><span class="annot"><span class="annottext">(DLetDec -&gt; DDec) -&gt; DLetDec -&gt; DDec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; [DClause] -&gt; DLetDec
</span><span class="hs-identifier hs-var">DFunD</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#singMethName"><span class="hs-identifier hs-var">singMethName</span></a></span><span>
</span><span id="line-266"></span><span>                           </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[DPat] -&gt; DExp -&gt; DClause
</span><span class="hs-identifier hs-var">DClause</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; DClause) -&gt; DExp -&gt; DClause
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-267"></span><span>                            </span><span class="annot"><span class="annottext">Int -&gt; DType -&gt; DExp -&gt; DExp
</span><a href="Data.Singletons.Single.Monad.html#wrapSingFun"><span class="hs-identifier hs-var">wrapSingFun</span></a></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><span class="hs-identifier hs-var">DWildCardT</span></span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; DExp) -&gt; DExp -&gt; DExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-268"></span><span>                            </span><span class="annot"><span class="annottext">[Name] -&gt; DExp -&gt; DExp
</span><span class="hs-identifier hs-var">DLamE</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362011"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; DExp) -&gt; DExp -&gt; DExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-269"></span><span>                            </span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#withSingIName"><span class="hs-identifier hs-var">withSingIName</span></a></span><span> </span><span class="annot"><span class="annottext">DExp -&gt; DExp -&gt; DExp
</span><span class="hs-operator hs-var">`DAppE`</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681362011"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-270"></span><span>                                                </span><span class="annot"><span class="annottext">DExp -&gt; DExp -&gt; DExp
</span><span class="hs-operator hs-var">`DAppE`</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#singMethName"><span class="hs-identifier hs-var">singMethName</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span id="local-6989586621681362334"><span class="annot"><a href="Data.Singletons.Single.html#singInstance"><span class="hs-identifier hs-type">singInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362334"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Deriving.Util.html#DerivDesc"><span class="hs-identifier hs-type">DerivDesc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681362334"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362334"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-273"></span><span id="singInstance"><span class="annot"><span class="annottext">singInstance :: DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Single.html#singInstance"><span class="hs-identifier hs-var hs-var">singInstance</span></a></span></span><span> </span><span id="local-6989586621681361974"><span class="annot"><span class="annottext">mk_inst :: DerivDesc q
</span><a href="#local-6989586621681361974"><span class="hs-identifier hs-var">mk_inst</span></a></span></span><span> </span><span id="local-6989586621681361973"><span class="annot"><span class="annottext">inst_name :: String
</span><a href="#local-6989586621681361973"><span class="hs-identifier hs-var">inst_name</span></a></span></span><span> </span><span id="local-6989586621681361972"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681361972"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-274"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681361971"><span class="annot"><span class="annottext">tvbs :: [TyVarBndr]
</span><a href="#local-6989586621681361971"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361970"><span class="annot"><span class="annottext">cons :: [Con]
</span><a href="#local-6989586621681361970"><span class="hs-identifier hs-var">cons</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name -&gt; q ([TyVarBndr], [Con])
forall (q :: * -&gt; *).
DsMonad q =&gt;
String -&gt; Name -&gt; q ([TyVarBndr], [Con])
</span><span class="hs-identifier hs-var">getDataD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;I cannot make an instance of &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681361973"><span class="hs-identifier hs-var">inst_name</span></a></span><span>
</span><span id="line-275"></span><span>                            </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot; for it.&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361972"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-276"></span><span>  </span><span id="local-6989586621681361969"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361969"><span class="hs-identifier hs-var">dtvbs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TyVarBndr -&gt; q DTyVarBndr) -&gt; [TyVarBndr] -&gt; q [DTyVarBndr]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">TyVarBndr -&gt; q DTyVarBndr
forall (q :: * -&gt; *). DsMonad q =&gt; TyVarBndr -&gt; q DTyVarBndr
</span><span class="hs-identifier hs-var">dsTvb</span></span><span> </span><span class="annot"><span class="annottext">[TyVarBndr]
</span><a href="#local-6989586621681361971"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-277"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361968"><span class="annot"><span class="annottext">data_ty :: DType
</span><a href="#local-6989586621681361968"><span class="hs-identifier hs-var hs-var">data_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DTyVarBndr] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361972"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361969"><span class="hs-identifier hs-var">dtvbs</span></a></span><span>
</span><span id="line-278"></span><span>  </span><span id="local-6989586621681361967"><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681361967"><span class="hs-identifier hs-var">dcons</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Con -&gt; q [DCon]) -&gt; [Con] -&gt; q [DCon]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; DType -&gt; Con -&gt; q [DCon]
forall (q :: * -&gt; *).
DsMonad q =&gt;
[DTyVarBndr] -&gt; DType -&gt; Con -&gt; q [DCon]
</span><span class="hs-identifier hs-var">dsCon</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361969"><span class="hs-identifier hs-var">dtvbs</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361968"><span class="hs-identifier hs-var">data_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Con]
</span><a href="#local-6989586621681361970"><span class="hs-identifier hs-var">cons</span></a></span><span>
</span><span id="line-279"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361966"><span class="annot"><span class="annottext">data_decl :: DataDecl
</span><a href="#local-6989586621681361966"><span class="hs-identifier hs-var hs-var">data_decl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [DTyVarBndr] -&gt; [DCon] -&gt; DataDecl
</span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361972"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361969"><span class="hs-identifier hs-var">dtvbs</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681361967"><span class="hs-identifier hs-var">dcons</span></a></span><span>
</span><span id="line-280"></span><span>  </span><span id="local-6989586621681361965"><span class="annot"><span class="annottext">UInstDecl
</span><a href="#local-6989586621681361965"><span class="hs-identifier hs-var">raw_inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DerivDesc q
</span><a href="#local-6989586621681361974"><span class="hs-identifier hs-var">mk_inst</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [DType]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361968"><span class="hs-identifier hs-var">data_ty</span></a></span><span> </span><span class="annot"><span class="annottext">DataDecl
</span><a href="#local-6989586621681361966"><span class="hs-identifier hs-var">data_decl</span></a></span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681361964"><span class="annot"><span class="annottext">a_inst :: AInstDecl
</span><a href="#local-6989586621681361964"><span class="hs-identifier hs-var">a_inst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361963"><span class="annot"><span class="annottext">decs :: [DDec]
</span><a href="#local-6989586621681361963"><span class="hs-identifier hs-var">decs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; PrM AInstDecl -&gt; q (AInstDecl, [DDec])
forall (q :: * -&gt; *) a.
DsMonad q =&gt;
[Dec] -&gt; PrM a -&gt; q (a, [DDec])
</span><a href="Data.Singletons.Promote.Monad.html#promoteM"><span class="hs-identifier hs-var">promoteM</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(PrM AInstDecl -&gt; q (AInstDecl, [DDec]))
-&gt; PrM AInstDecl -&gt; q (AInstDecl, [DDec])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-282"></span><span>                    </span><span class="annot"><span class="annottext">OMap Name DType -&gt; UInstDecl -&gt; PrM AInstDecl
</span><a href="Data.Singletons.Promote.html#promoteInstanceDec"><span class="hs-identifier hs-var">promoteInstanceDec</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
forall k v. OMap k v
</span><span class="hs-identifier hs-var">OMap.empty</span></span><span> </span><span class="annot"><span class="annottext">UInstDecl
</span><a href="#local-6989586621681361965"><span class="hs-identifier hs-var">raw_inst</span></a></span><span>
</span><span id="line-283"></span><span>  </span><span id="local-6989586621681361960"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361960"><span class="hs-identifier hs-var">decs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; SgM [DDec] -&gt; q [DDec]
forall (q :: * -&gt; *). DsMonad q =&gt; [Dec] -&gt; SgM [DDec] -&gt; q [DDec]
</span><a href="Data.Singletons.Single.Monad.html#singDecsM"><span class="hs-identifier hs-var">singDecsM</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(SgM [DDec] -&gt; q [DDec]) -&gt; SgM [DDec] -&gt; q [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DDec -&gt; [DDec] -&gt; [DDec]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DDec -&gt; [DDec]) -&gt; SgM DDec -&gt; SgM [DDec]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">AInstDecl -&gt; SgM DDec
</span><a href="Data.Singletons.Single.html#singInstD"><span class="hs-identifier hs-var">singInstD</span></a></span><span> </span><span class="annot"><span class="annottext">AInstDecl
</span><a href="#local-6989586621681361964"><span class="hs-identifier hs-var">a_inst</span></a></span><span>
</span><span id="line-284"></span><span>  </span><span class="annot"><span class="annottext">[Dec] -&gt; q [Dec]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; q [Dec]) -&gt; [Dec] -&gt; q [Dec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [Dec]
</span><span class="hs-identifier hs-var">decsToTH</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361963"><span class="hs-identifier hs-var">decs</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [DDec] -&gt; [DDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361960"><span class="hs-identifier hs-var">decs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span id="local-6989586621681362408"><span class="annot"><a href="Data.Singletons.Single.html#singInfo"><span class="hs-identifier hs-type">singInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362408"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DInfo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362408"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-287"></span><span id="singInfo"><span class="annot"><span class="annottext">singInfo :: DInfo -&gt; q [DDec]
</span><a href="Data.Singletons.Single.html#singInfo"><span class="hs-identifier hs-var hs-var">singInfo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTyConI</span></span><span> </span><span id="local-6989586621681361955"><span class="annot"><span class="annottext">dec :: DDec
</span><a href="#local-6989586621681361955"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-288"></span><span>  </span><span class="annot"><span class="annottext">[Dec] -&gt; [DDec] -&gt; q [DDec]
forall (q :: * -&gt; *). DsMonad q =&gt; [Dec] -&gt; [DDec] -&gt; q [DDec]
</span><a href="Data.Singletons.Single.html#singTopLevelDecs"><span class="hs-identifier hs-var">singTopLevelDecs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681361955"><span class="hs-identifier hs-var">dec</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-289"></span><span class="annot"><a href="Data.Singletons.Single.html#singInfo"><span class="hs-identifier hs-var">singInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DPrimTyConI</span></span><span> </span><span id="local-6989586621681361953"><span class="annot"><span class="annottext">_name :: Name
</span><a href="#local-6989586621681361953"><span class="hs-identifier hs-var">_name</span></a></span></span><span> </span><span id="local-6989586621681361952"><span class="annot"><span class="annottext">_numArgs :: Int
</span><a href="#local-6989586621681361952"><span class="hs-identifier hs-var">_numArgs</span></a></span></span><span> </span><span id="local-6989586621681361951"><span class="annot"><span class="annottext">_unlifted :: Bool
</span><a href="#local-6989586621681361951"><span class="hs-identifier hs-var">_unlifted</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-290"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; q [DDec]
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Singling of primitive type constructors not supported&quot;</span></span><span>
</span><span id="line-291"></span><span class="annot"><a href="Data.Singletons.Single.html#singInfo"><span class="hs-identifier hs-var">singInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DVarI</span></span><span> </span><span id="local-6989586621681361949"><span class="annot"><span class="annottext">_name :: Name
</span><a href="#local-6989586621681361949"><span class="hs-identifier hs-var">_name</span></a></span></span><span> </span><span id="local-6989586621681361948"><span class="annot"><span class="annottext">_ty :: DType
</span><a href="#local-6989586621681361948"><span class="hs-identifier hs-var">_ty</span></a></span></span><span> </span><span id="local-6989586621681361947"><span class="annot"><span class="annottext">_mdec :: Maybe Name
</span><a href="#local-6989586621681361947"><span class="hs-identifier hs-var">_mdec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-292"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; q [DDec]
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Singling of value info not supported&quot;</span></span><span>
</span><span id="line-293"></span><span class="annot"><a href="Data.Singletons.Single.html#singInfo"><span class="hs-identifier hs-var">singInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTyVarI</span></span><span> </span><span id="local-6989586621681361945"><span class="annot"><span class="annottext">_name :: Name
</span><a href="#local-6989586621681361945"><span class="hs-identifier hs-var">_name</span></a></span></span><span> </span><span id="local-6989586621681361944"><span class="annot"><span class="annottext">_ty :: DType
</span><a href="#local-6989586621681361944"><span class="hs-identifier hs-var">_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-294"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; q [DDec]
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Singling of type variable info not supported&quot;</span></span><span>
</span><span id="line-295"></span><span class="annot"><a href="Data.Singletons.Single.html#singInfo"><span class="hs-identifier hs-var">singInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DPatSynI</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-296"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; q [DDec]
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Singling of pattern synonym info not supported&quot;</span></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span id="local-6989586621681362389"><span class="annot"><a href="Data.Singletons.Single.html#singTopLevelDecs"><span class="hs-identifier hs-type">singTopLevelDecs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681362389"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681362389"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-299"></span><span id="singTopLevelDecs"><span class="annot"><span class="annottext">singTopLevelDecs :: [Dec] -&gt; [DDec] -&gt; q [DDec]
</span><a href="Data.Singletons.Single.html#singTopLevelDecs"><span class="hs-identifier hs-var hs-var">singTopLevelDecs</span></a></span></span><span> </span><span id="local-6989586621681361942"><span class="annot"><span class="annottext">locals :: [Dec]
</span><a href="#local-6989586621681361942"><span class="hs-identifier hs-var">locals</span></a></span></span><span> </span><span id="local-6989586621681361941"><span class="annot"><span class="annottext">raw_decls :: [DDec]
</span><a href="#local-6989586621681361941"><span class="hs-identifier hs-var">raw_decls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; DsM q [DDec] -&gt; q [DDec]
forall (q :: * -&gt; *) a. DsMonad q =&gt; [Dec] -&gt; DsM q a -&gt; q a
</span><span class="hs-identifier hs-var">withLocalDeclarations</span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681361942"><span class="hs-identifier hs-var">locals</span></a></span><span> </span><span class="annot"><span class="annottext">(DsM q [DDec] -&gt; q [DDec]) -&gt; DsM q [DDec] -&gt; q [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-300"></span><span>  </span><span id="local-6989586621681361940"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361940"><span class="hs-identifier hs-var">decls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; DsM q [DDec]
forall (q :: * -&gt; *) a. (DsMonad q, Data a) =&gt; a -&gt; q a
</span><span class="hs-identifier hs-var">expand</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361941"><span class="hs-identifier hs-var">raw_decls</span></a></span><span>     </span><span class="hs-comment">-- expand type synonyms</span><span>
</span><span id="line-301"></span><span>  </span><span class="annot"><a href="Data.Singletons.Partition.html#PDecs"><span class="hs-identifier hs-type">PDecs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">pd_let_decs :: PartitionedDecs -&gt; [DLetDec]
</span><a href="Data.Singletons.Partition.html#pd_let_decs"><span class="hs-identifier hs-var">pd_let_decs</span></a></span><span>                </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361936"><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361936"><span class="hs-identifier hs-var">letDecls</span></a></span></span><span>
</span><span id="line-302"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_class_decs :: PartitionedDecs -&gt; [UClassDecl]
</span><a href="Data.Singletons.Partition.html#pd_class_decs"><span class="hs-identifier hs-var">pd_class_decs</span></a></span><span>              </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361934"><span class="annot"><span class="annottext">[UClassDecl]
</span><a href="#local-6989586621681361934"><span class="hs-identifier hs-var">classes</span></a></span></span><span>
</span><span id="line-303"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_instance_decs :: PartitionedDecs -&gt; [UInstDecl]
</span><a href="Data.Singletons.Partition.html#pd_instance_decs"><span class="hs-identifier hs-var">pd_instance_decs</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361932"><span class="annot"><span class="annottext">[UInstDecl]
</span><a href="#local-6989586621681361932"><span class="hs-identifier hs-var">insts</span></a></span></span><span>
</span><span id="line-304"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_data_decs :: PartitionedDecs -&gt; [DataDecl]
</span><a href="Data.Singletons.Partition.html#pd_data_decs"><span class="hs-identifier hs-var">pd_data_decs</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361930"><span class="annot"><span class="annottext">[DataDecl]
</span><a href="#local-6989586621681361930"><span class="hs-identifier hs-var">datas</span></a></span></span><span>
</span><span id="line-305"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_ty_syn_decs :: PartitionedDecs -&gt; [TySynDecl]
</span><a href="Data.Singletons.Partition.html#pd_ty_syn_decs"><span class="hs-identifier hs-var">pd_ty_syn_decs</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361928"><span class="annot"><span class="annottext">[TySynDecl]
</span><a href="#local-6989586621681361928"><span class="hs-identifier hs-var">ty_syns</span></a></span></span><span>
</span><span id="line-306"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_open_type_family_decs :: PartitionedDecs -&gt; [OpenTypeFamilyDecl]
</span><a href="Data.Singletons.Partition.html#pd_open_type_family_decs"><span class="hs-identifier hs-var">pd_open_type_family_decs</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361926"><span class="annot"><span class="annottext">[OpenTypeFamilyDecl]
</span><a href="#local-6989586621681361926"><span class="hs-identifier hs-var">o_tyfams</span></a></span></span><span>
</span><span id="line-307"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_closed_type_family_decs :: PartitionedDecs -&gt; [ClosedTypeFamilyDecl]
</span><a href="Data.Singletons.Partition.html#pd_closed_type_family_decs"><span class="hs-identifier hs-var">pd_closed_type_family_decs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361924"><span class="annot"><span class="annottext">[ClosedTypeFamilyDecl]
</span><a href="#local-6989586621681361924"><span class="hs-identifier hs-var">c_tyfams</span></a></span></span><span>
</span><span id="line-308"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_derived_eq_decs :: PartitionedDecs -&gt; [DerivedEqDecl]
</span><a href="Data.Singletons.Partition.html#pd_derived_eq_decs"><span class="hs-identifier hs-var">pd_derived_eq_decs</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361922"><span class="annot"><span class="annottext">[DerivedEqDecl]
</span><a href="#local-6989586621681361922"><span class="hs-identifier hs-var">derivedEqDecs</span></a></span></span><span>
</span><span id="line-309"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_derived_show_decs :: PartitionedDecs -&gt; [DerivedShowDecl]
</span><a href="Data.Singletons.Partition.html#pd_derived_show_decs"><span class="hs-identifier hs-var">pd_derived_show_decs</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361920"><span class="annot"><span class="annottext">[DerivedShowDecl]
</span><a href="#local-6989586621681361920"><span class="hs-identifier hs-var">derivedShowDecs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; DsM q PartitionedDecs
forall (m :: * -&gt; *). DsMonad m =&gt; [DDec] -&gt; m PartitionedDecs
</span><a href="Data.Singletons.Partition.html#partitionDecs"><span class="hs-identifier hs-var">partitionDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361940"><span class="hs-identifier hs-var">decls</span></a></span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621681361918"><span class="annot"><span class="annottext">letDecEnv :: ALetDecEnv
</span><a href="#local-6989586621681361918"><span class="hs-identifier hs-var">letDecEnv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361917"><span class="annot"><span class="annottext">classes' :: [AClassDecl]
</span><a href="#local-6989586621681361917"><span class="hs-identifier hs-var">classes'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361916"><span class="annot"><span class="annottext">insts' :: [AInstDecl]
</span><a href="#local-6989586621681361916"><span class="hs-identifier hs-var">insts'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361915"><span class="annot"><span class="annottext">promDecls :: [DDec]
</span><a href="#local-6989586621681361915"><span class="hs-identifier hs-var">promDecls</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Dec]
-&gt; PrM (ALetDecEnv, [AClassDecl], [AInstDecl])
-&gt; DsM q ((ALetDecEnv, [AClassDecl], [AInstDecl]), [DDec])
forall (q :: * -&gt; *) a.
DsMonad q =&gt;
[Dec] -&gt; PrM a -&gt; q (a, [DDec])
</span><a href="Data.Singletons.Promote.Monad.html#promoteM"><span class="hs-identifier hs-var">promoteM</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681361942"><span class="hs-identifier hs-var">locals</span></a></span><span> </span><span class="annot"><span class="annottext">(PrM (ALetDecEnv, [AClassDecl], [AInstDecl])
 -&gt; DsM q ((ALetDecEnv, [AClassDecl], [AInstDecl]), [DDec]))
-&gt; PrM (ALetDecEnv, [AClassDecl], [AInstDecl])
-&gt; DsM q ((ALetDecEnv, [AClassDecl], [AInstDecl]), [DDec])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-312"></span><span>    </span><span class="annot"><span class="annottext">[TySynDecl]
-&gt; [ClosedTypeFamilyDecl] -&gt; [OpenTypeFamilyDecl] -&gt; PrM ()
</span><a href="Data.Singletons.Promote.Defun.html#defunTypeDecls"><span class="hs-identifier hs-var">defunTypeDecls</span></a></span><span> </span><span class="annot"><span class="annottext">[TySynDecl]
</span><a href="#local-6989586621681361928"><span class="hs-identifier hs-var">ty_syns</span></a></span><span> </span><span class="annot"><span class="annottext">[ClosedTypeFamilyDecl]
</span><a href="#local-6989586621681361924"><span class="hs-identifier hs-var">c_tyfams</span></a></span><span> </span><span class="annot"><span class="annottext">[OpenTypeFamilyDecl]
</span><a href="#local-6989586621681361926"><span class="hs-identifier hs-var">o_tyfams</span></a></span><span>
</span><span id="line-313"></span><span>    </span><span class="annot"><span class="annottext">[DataDecl] -&gt; PrM ()
</span><a href="Data.Singletons.Promote.html#promoteDataDecs"><span class="hs-identifier hs-var">promoteDataDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[DataDecl]
</span><a href="#local-6989586621681361930"><span class="hs-identifier hs-var">datas</span></a></span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361912"><span class="annot"><span class="annottext">letDecEnv :: ALetDecEnv
</span><a href="#local-6989586621681361912"><span class="hs-identifier hs-var">letDecEnv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(String, String) -&gt; [DLetDec] -&gt; PrM ([LetBind], ALetDecEnv)
</span><a href="Data.Singletons.Promote.html#promoteLetDecs"><span class="hs-identifier hs-var">promoteLetDecs</span></a></span><span> </span><span class="annot"><span class="annottext">(String, String)
</span><a href="Data.Singletons.Util.html#noPrefix"><span class="hs-identifier hs-var">noPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361936"><span class="hs-identifier hs-var">letDecls</span></a></span><span>
</span><span id="line-315"></span><span>    </span><span id="local-6989586621681361909"><span class="annot"><span class="annottext">[AClassDecl]
</span><a href="#local-6989586621681361909"><span class="hs-identifier hs-var">classes'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(UClassDecl -&gt; PrM AClassDecl) -&gt; [UClassDecl] -&gt; PrM [AClassDecl]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">UClassDecl -&gt; PrM AClassDecl
</span><a href="Data.Singletons.Promote.html#promoteClassDec"><span class="hs-identifier hs-var">promoteClassDec</span></a></span><span> </span><span class="annot"><span class="annottext">[UClassDecl]
</span><a href="#local-6989586621681361934"><span class="hs-identifier hs-var">classes</span></a></span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361907"><span class="annot"><span class="annottext">meth_sigs :: OMap Name DType
</span><a href="#local-6989586621681361907"><span class="hs-identifier hs-var hs-var">meth_sigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UClassDecl -&gt; OMap Name DType) -&gt; [UClassDecl] -&gt; OMap Name DType
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LetDecEnv Unannotated -&gt; OMap Name DType
forall (ann :: AnnotationFlag). LetDecEnv ann -&gt; OMap Name DType
</span><a href="Data.Singletons.Syntax.html#lde_types"><span class="hs-identifier hs-var hs-var">lde_types</span></a></span><span> </span><span class="annot"><span class="annottext">(LetDecEnv Unannotated -&gt; OMap Name DType)
-&gt; (UClassDecl -&gt; LetDecEnv Unannotated)
-&gt; UClassDecl
-&gt; OMap Name DType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">UClassDecl -&gt; LetDecEnv Unannotated
forall (ann :: AnnotationFlag). ClassDecl ann -&gt; LetDecEnv ann
</span><a href="Data.Singletons.Syntax.html#cd_lde"><span class="hs-identifier hs-var hs-var">cd_lde</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[UClassDecl]
</span><a href="#local-6989586621681361934"><span class="hs-identifier hs-var">classes</span></a></span><span>
</span><span id="line-317"></span><span>    </span><span id="local-6989586621681361903"><span class="annot"><span class="annottext">[AInstDecl]
</span><a href="#local-6989586621681361903"><span class="hs-identifier hs-var">insts'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(UInstDecl -&gt; PrM AInstDecl) -&gt; [UInstDecl] -&gt; PrM [AInstDecl]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OMap Name DType -&gt; UInstDecl -&gt; PrM AInstDecl
</span><a href="Data.Singletons.Promote.html#promoteInstanceDec"><span class="hs-identifier hs-var">promoteInstanceDec</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681361907"><span class="hs-identifier hs-var">meth_sigs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[UInstDecl]
</span><a href="#local-6989586621681361932"><span class="hs-identifier hs-var">insts</span></a></span><span>
</span><span id="line-318"></span><span>    </span><span class="annot"><span class="annottext">(DerivedEqDecl -&gt; PrM ()) -&gt; [DerivedEqDecl] -&gt; PrM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">DerivedEqDecl -&gt; PrM ()
</span><a href="Data.Singletons.Promote.html#promoteDerivedEqDec"><span class="hs-identifier hs-var">promoteDerivedEqDec</span></a></span><span> </span><span class="annot"><span class="annottext">[DerivedEqDecl]
</span><a href="#local-6989586621681361922"><span class="hs-identifier hs-var">derivedEqDecs</span></a></span><span>
</span><span id="line-319"></span><span>    </span><span class="annot"><span class="annottext">(ALetDecEnv, [AClassDecl], [AInstDecl])
-&gt; PrM (ALetDecEnv, [AClassDecl], [AInstDecl])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ALetDecEnv
</span><a href="#local-6989586621681361912"><span class="hs-identifier hs-var">letDecEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[AClassDecl]
</span><a href="#local-6989586621681361909"><span class="hs-identifier hs-var">classes'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[AInstDecl]
</span><a href="#local-6989586621681361903"><span class="hs-identifier hs-var">insts'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span>  </span><span class="annot"><span class="annottext">[Dec] -&gt; SgM [DDec] -&gt; DsM q [DDec]
forall (q :: * -&gt; *). DsMonad q =&gt; [Dec] -&gt; SgM [DDec] -&gt; q [DDec]
</span><a href="Data.Singletons.Single.Monad.html#singDecsM"><span class="hs-identifier hs-var">singDecsM</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681361942"><span class="hs-identifier hs-var">locals</span></a></span><span> </span><span class="annot"><span class="annottext">(SgM [DDec] -&gt; DsM q [DDec]) -&gt; SgM [DDec] -&gt; DsM q [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361900"><span class="annot"><span class="annottext">letBinds :: [(Name, DExp)]
</span><a href="#local-6989586621681361900"><span class="hs-identifier hs-var hs-var">letBinds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DataDecl -&gt; [(Name, DExp)]) -&gt; [DataDecl] -&gt; [(Name, DExp)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">DataDecl -&gt; [(Name, DExp)]
</span><a href="Data.Singletons.Single.html#buildDataLets"><span class="hs-identifier hs-var">buildDataLets</span></a></span><span> </span><span class="annot"><span class="annottext">[DataDecl]
</span><a href="#local-6989586621681361930"><span class="hs-identifier hs-var">datas</span></a></span><span>
</span><span id="line-323"></span><span>                </span><span class="annot"><span class="annottext">[(Name, DExp)] -&gt; [(Name, DExp)] -&gt; [(Name, DExp)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(UClassDecl -&gt; [(Name, DExp)]) -&gt; [UClassDecl] -&gt; [(Name, DExp)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">UClassDecl -&gt; [(Name, DExp)]
</span><a href="Data.Singletons.Single.html#buildMethLets"><span class="hs-identifier hs-var">buildMethLets</span></a></span><span> </span><span class="annot"><span class="annottext">[UClassDecl]
</span><a href="#local-6989586621681361934"><span class="hs-identifier hs-var">classes</span></a></span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681361896"><span class="annot"><span class="annottext">newLetDecls :: [DLetDec]
</span><a href="#local-6989586621681361896"><span class="hs-identifier hs-var">newLetDecls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361895"><span class="annot"><span class="annottext">singIDefunDecls :: [DDec]
</span><a href="#local-6989586621681361895"><span class="hs-identifier hs-var">singIDefunDecls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361894"><span class="annot"><span class="annottext">newDecls :: [DDec]
</span><a href="#local-6989586621681361894"><span class="hs-identifier hs-var">newDecls</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>                            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Name, DExp)]
-&gt; SgM ([DLetDec], [DDec], [DDec])
-&gt; SgM ([DLetDec], [DDec], [DDec])
forall a. [(Name, DExp)] -&gt; SgM a -&gt; SgM a
</span><a href="Data.Singletons.Single.Monad.html#bindLets"><span class="hs-identifier hs-var">bindLets</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, DExp)]
</span><a href="#local-6989586621681361900"><span class="hs-identifier hs-var">letBinds</span></a></span><span> </span><span class="annot"><span class="annottext">(SgM ([DLetDec], [DDec], [DDec])
 -&gt; SgM ([DLetDec], [DDec], [DDec]))
-&gt; SgM ([DLetDec], [DDec], [DDec])
-&gt; SgM ([DLetDec], [DDec], [DDec])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-326"></span><span>                               </span><span class="annot"><span class="annottext">ALetDecEnv -&gt; SgM [DDec] -&gt; SgM ([DLetDec], [DDec], [DDec])
forall a. ALetDecEnv -&gt; SgM a -&gt; SgM ([DLetDec], [DDec], a)
</span><a href="Data.Singletons.Single.html#singLetDecEnv"><span class="hs-identifier hs-var">singLetDecEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ALetDecEnv
</span><a href="#local-6989586621681361918"><span class="hs-identifier hs-var">letDecEnv</span></a></span><span> </span><span class="annot"><span class="annottext">(SgM [DDec] -&gt; SgM ([DLetDec], [DDec], [DDec]))
-&gt; SgM [DDec] -&gt; SgM ([DLetDec], [DDec], [DDec])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-327"></span><span>                                 </span><span id="local-6989586621681361891"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361891"><span class="hs-identifier hs-var">newDataDecls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DataDecl -&gt; SgM [DDec]) -&gt; [DataDecl] -&gt; SgM [DDec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">DataDecl -&gt; SgM [DDec]
</span><a href="Data.Singletons.Single.Data.html#singDataD"><span class="hs-identifier hs-var">singDataD</span></a></span><span> </span><span class="annot"><span class="annottext">[DataDecl]
</span><a href="#local-6989586621681361930"><span class="hs-identifier hs-var">datas</span></a></span><span>
</span><span id="line-328"></span><span>                                 </span><span id="local-6989586621681361889"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361889"><span class="hs-identifier hs-var">newClassDecls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(AClassDecl -&gt; SgM DDec) -&gt; [AClassDecl] -&gt; SgM [DDec]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">AClassDecl -&gt; SgM DDec
</span><a href="Data.Singletons.Single.html#singClassD"><span class="hs-identifier hs-var">singClassD</span></a></span><span> </span><span class="annot"><span class="annottext">[AClassDecl]
</span><a href="#local-6989586621681361917"><span class="hs-identifier hs-var">classes'</span></a></span><span>
</span><span id="line-329"></span><span>                                 </span><span id="local-6989586621681361887"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361887"><span class="hs-identifier hs-var">newInstDecls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(AInstDecl -&gt; SgM DDec) -&gt; [AInstDecl] -&gt; SgM [DDec]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">AInstDecl -&gt; SgM DDec
</span><a href="Data.Singletons.Single.html#singInstD"><span class="hs-identifier hs-var">singInstD</span></a></span><span> </span><span class="annot"><span class="annottext">[AInstDecl]
</span><a href="#local-6989586621681361916"><span class="hs-identifier hs-var">insts'</span></a></span><span>
</span><span id="line-330"></span><span>                                 </span><span id="local-6989586621681361886"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361886"><span class="hs-identifier hs-var">newDerivedEqDecs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DerivedEqDecl -&gt; SgM [DDec]) -&gt; [DerivedEqDecl] -&gt; SgM [DDec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">DerivedEqDecl -&gt; SgM [DDec]
</span><a href="Data.Singletons.Single.html#singDerivedEqDecs"><span class="hs-identifier hs-var">singDerivedEqDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[DerivedEqDecl]
</span><a href="#local-6989586621681361922"><span class="hs-identifier hs-var">derivedEqDecs</span></a></span><span>
</span><span id="line-331"></span><span>                                 </span><span id="local-6989586621681361884"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361884"><span class="hs-identifier hs-var">newDerivedShowDecs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DerivedShowDecl -&gt; SgM [DDec]) -&gt; [DerivedShowDecl] -&gt; SgM [DDec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">DerivedShowDecl -&gt; SgM [DDec]
</span><a href="Data.Singletons.Single.html#singDerivedShowDecs"><span class="hs-identifier hs-var">singDerivedShowDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[DerivedShowDecl]
</span><a href="#local-6989586621681361920"><span class="hs-identifier hs-var">derivedShowDecs</span></a></span><span>
</span><span id="line-332"></span><span>                                 </span><span class="annot"><span class="annottext">[DDec] -&gt; SgM [DDec]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([DDec] -&gt; SgM [DDec]) -&gt; [DDec] -&gt; SgM [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361891"><span class="hs-identifier hs-var">newDataDecls</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [DDec] -&gt; [DDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361889"><span class="hs-identifier hs-var">newClassDecls</span></a></span><span>
</span><span id="line-333"></span><span>                                                       </span><span class="annot"><span class="annottext">[DDec] -&gt; [DDec] -&gt; [DDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361887"><span class="hs-identifier hs-var">newInstDecls</span></a></span><span>
</span><span id="line-334"></span><span>                                                       </span><span class="annot"><span class="annottext">[DDec] -&gt; [DDec] -&gt; [DDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361886"><span class="hs-identifier hs-var">newDerivedEqDecs</span></a></span><span>
</span><span id="line-335"></span><span>                                                       </span><span class="annot"><span class="annottext">[DDec] -&gt; [DDec] -&gt; [DDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361884"><span class="hs-identifier hs-var">newDerivedShowDecs</span></a></span><span>
</span><span id="line-336"></span><span>    </span><span class="annot"><span class="annottext">[DDec] -&gt; SgM [DDec]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([DDec] -&gt; SgM [DDec]) -&gt; [DDec] -&gt; SgM [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361915"><span class="hs-identifier hs-var">promDecls</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [DDec] -&gt; [DDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DLetDec -&gt; DDec) -&gt; [DLetDec] -&gt; [DDec]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DLetDec -&gt; DDec
</span><span class="hs-identifier hs-var">DLetDec</span></span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361896"><span class="hs-identifier hs-var">newLetDecls</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [DDec] -&gt; [DDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361895"><span class="hs-identifier hs-var">singIDefunDecls</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [DDec] -&gt; [DDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361894"><span class="hs-identifier hs-var">newDecls</span></a></span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span class="hs-comment">-- see comment at top of file</span><span>
</span><span id="line-339"></span><span class="annot"><a href="Data.Singletons.Single.html#buildDataLets"><span class="hs-identifier hs-type">buildDataLets</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DExp</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-340"></span><span id="buildDataLets"><span class="annot"><span class="annottext">buildDataLets :: DataDecl -&gt; [(Name, DExp)]
</span><a href="Data.Singletons.Single.html#buildDataLets"><span class="hs-identifier hs-var hs-var">buildDataLets</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a></span><span> </span><span id="local-6989586621681361883"><span class="annot"><span class="annottext">_name :: Name
</span><a href="#local-6989586621681361883"><span class="hs-identifier hs-var">_name</span></a></span></span><span> </span><span id="local-6989586621681361882"><span class="annot"><span class="annottext">_tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681361882"><span class="hs-identifier hs-var">_tvbs</span></a></span></span><span> </span><span id="local-6989586621681361881"><span class="annot"><span class="annottext">cons :: [DCon]
</span><a href="#local-6989586621681361881"><span class="hs-identifier hs-var">cons</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-341"></span><span>  </span><span class="annot"><span class="annottext">(DCon -&gt; [(Name, DExp)]) -&gt; [DCon] -&gt; [(Name, DExp)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">DCon -&gt; [(Name, DExp)]
</span><a href="#local-6989586621681361880"><span class="hs-identifier hs-var">con_num_args</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681361881"><span class="hs-identifier hs-var">cons</span></a></span><span>
</span><span id="line-342"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-343"></span><span>    </span><span class="annot"><a href="#local-6989586621681361880"><span class="hs-identifier hs-type">con_num_args</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DCon</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DExp</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-344"></span><span>    </span><span id="local-6989586621681361880"><span class="annot"><span class="annottext">con_num_args :: DCon -&gt; [(Name, DExp)]
</span><a href="#local-6989586621681361880"><span class="hs-identifier hs-var hs-var">con_num_args</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DCon</span></span><span> </span><span id="local-6989586621681361878"><span class="annot"><span class="annottext">_tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681361878"><span class="hs-identifier hs-var">_tvbs</span></a></span></span><span> </span><span id="local-6989586621681361877"><span class="annot"><span class="annottext">_cxt :: [DType]
</span><a href="#local-6989586621681361877"><span class="hs-identifier hs-var">_cxt</span></a></span></span><span> </span><span id="local-6989586621681361876"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681361876"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681361875"><span class="annot"><span class="annottext">fields :: DConFields
</span><a href="#local-6989586621681361875"><span class="hs-identifier hs-var">fields</span></a></span></span><span> </span><span id="local-6989586621681361874"><span class="annot"><span class="annottext">_rty :: DType
</span><a href="#local-6989586621681361874"><span class="hs-identifier hs-var">_rty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-345"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361876"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; DType -&gt; DExp -&gt; DExp
</span><a href="Data.Singletons.Single.Monad.html#wrapSingFun"><span class="hs-identifier hs-var">wrapSingFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DType] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DConFields -&gt; [DType]
</span><a href="Data.Singletons.Util.html#tysOfConFields"><span class="hs-identifier hs-var">tysOfConFields</span></a></span><span> </span><span class="annot"><span class="annottext">DConFields
</span><a href="#local-6989586621681361875"><span class="hs-identifier hs-var">fields</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361876"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DConE</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DExp) -&gt; Name -&gt; DExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#singDataConName"><span class="hs-identifier hs-var">singDataConName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361876"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>      </span><span class="annot"><span class="annottext">(Name, DExp) -&gt; [(Name, DExp)] -&gt; [(Name, DExp)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">DConFields -&gt; [(Name, DExp)]
</span><a href="#local-6989586621681361868"><span class="hs-identifier hs-var">rec_selectors</span></a></span><span> </span><span class="annot"><span class="annottext">DConFields
</span><a href="#local-6989586621681361875"><span class="hs-identifier hs-var">fields</span></a></span><span>
</span><span id="line-348"></span><span>
</span><span id="line-349"></span><span>    </span><span class="annot"><a href="#local-6989586621681361868"><span class="hs-identifier hs-type">rec_selectors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DConFields</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DExp</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-350"></span><span>    </span><span id="local-6989586621681361868"><span class="annot"><span class="annottext">rec_selectors :: DConFields -&gt; [(Name, DExp)]
</span><a href="#local-6989586621681361868"><span class="hs-identifier hs-var hs-var">rec_selectors</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DNormalC</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-351"></span><span>    </span><span class="annot"><a href="#local-6989586621681361868"><span class="hs-identifier hs-var">rec_selectors</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DRecC</span></span><span> </span><span id="local-6989586621681361865"><span class="annot"><span class="annottext">fields :: [DVarBangType]
</span><a href="#local-6989586621681361865"><span class="hs-identifier hs-var">fields</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-352"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361864"><span class="annot"><span class="annottext">names :: [Name]
</span><a href="#local-6989586621681361864"><span class="hs-identifier hs-var hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DVarBangType -&gt; Name) -&gt; [DVarBangType] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DVarBangType -&gt; Name
forall a b c. (a, b, c) -&gt; a
</span><a href="Data.Singletons.Util.html#fstOf3"><span class="hs-identifier hs-var">fstOf3</span></a></span><span> </span><span class="annot"><span class="annottext">[DVarBangType]
</span><a href="#local-6989586621681361865"><span class="hs-identifier hs-var">fields</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-353"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361862"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; DType -&gt; DExp -&gt; DExp
</span><a href="Data.Singletons.Single.Monad.html#wrapSingFun"><span class="hs-identifier hs-var">wrapSingFun</span></a></span><span> </span><span class="annot"><span class="hs-number">1</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361862"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DExp) -&gt; Name -&gt; DExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361862"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621681361862"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361862"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361864"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span class="hs-comment">-- see comment at top of file</span><span>
</span><span id="line-357"></span><span class="annot"><a href="Data.Singletons.Single.html#buildMethLets"><span class="hs-identifier hs-type">buildMethLets</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#UClassDecl"><span class="hs-identifier hs-type">UClassDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DExp</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-358"></span><span id="buildMethLets"><span class="annot"><span class="annottext">buildMethLets :: UClassDecl -&gt; [(Name, DExp)]
</span><a href="Data.Singletons.Single.html#buildMethLets"><span class="hs-identifier hs-var hs-var">buildMethLets</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ClassDecl"><span class="hs-identifier hs-type">ClassDecl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cd_lde :: forall (ann :: AnnotationFlag). ClassDecl ann -&gt; LetDecEnv ann
</span><a href="Data.Singletons.Syntax.html#cd_lde"><span class="hs-identifier hs-var">cd_lde</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-type">LetDecEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lde_types :: forall (ann :: AnnotationFlag). LetDecEnv ann -&gt; OMap Name DType
</span><a href="Data.Singletons.Syntax.html#lde_types"><span class="hs-identifier hs-var">lde_types</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361858"><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681361858"><span class="hs-identifier hs-var">meth_sigs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-359"></span><span>  </span><span class="annot"><span class="annottext">(LetBind -&gt; (Name, DExp)) -&gt; [LetBind] -&gt; [(Name, DExp)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LetBind -&gt; (Name, DExp)
</span><a href="#local-6989586621681361857"><span class="hs-identifier hs-var">mk_bind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OMap Name DType -&gt; [LetBind]
forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681361858"><span class="hs-identifier hs-var">meth_sigs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-361"></span><span>    </span><span id="local-6989586621681361857"><span class="annot"><span class="annottext">mk_bind :: LetBind -&gt; (Name, DExp)
</span><a href="#local-6989586621681361857"><span class="hs-identifier hs-var hs-var">mk_bind</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681361855"><span class="annot"><span class="annottext">meth_name :: Name
</span><a href="#local-6989586621681361855"><span class="hs-identifier hs-var">meth_name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361854"><span class="annot"><span class="annottext">meth_ty :: DType
</span><a href="#local-6989586621681361854"><span class="hs-identifier hs-var">meth_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-362"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361855"><span class="hs-identifier hs-var">meth_name</span></a></span><span>
</span><span id="line-363"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; DType -&gt; DExp -&gt; DExp
</span><a href="Data.Singletons.Single.Monad.html#wrapSingFun"><span class="hs-identifier hs-var">wrapSingFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; Int
</span><a href="Data.Singletons.Util.html#countArgs"><span class="hs-identifier hs-var">countArgs</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361854"><span class="hs-identifier hs-var">meth_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361855"><span class="hs-identifier hs-var">meth_name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span>                                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DExp) -&gt; Name -&gt; DExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361855"><span class="hs-identifier hs-var">meth_name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span class="annot"><a href="Data.Singletons.Single.html#singClassD"><span class="hs-identifier hs-type">singClassD</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#AClassDecl"><span class="hs-identifier hs-type">AClassDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span>
</span><span id="line-367"></span><span id="singClassD"><span class="annot"><span class="annottext">singClassD :: AClassDecl -&gt; SgM DDec
</span><a href="Data.Singletons.Single.html#singClassD"><span class="hs-identifier hs-var hs-var">singClassD</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ClassDecl"><span class="hs-identifier hs-type">ClassDecl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cd_cxt :: forall (ann :: AnnotationFlag). ClassDecl ann -&gt; [DType]
</span><a href="Data.Singletons.Syntax.html#cd_cxt"><span class="hs-identifier hs-var">cd_cxt</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361851"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361851"><span class="hs-identifier hs-var">cls_cxt</span></a></span></span><span>
</span><span id="line-368"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cd_name :: forall (ann :: AnnotationFlag). ClassDecl ann -&gt; Name
</span><a href="Data.Singletons.Syntax.html#cd_name"><span class="hs-identifier hs-var">cd_name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361849"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361849"><span class="hs-identifier hs-var">cls_name</span></a></span></span><span>
</span><span id="line-369"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cd_tvbs :: forall (ann :: AnnotationFlag). ClassDecl ann -&gt; [DTyVarBndr]
</span><a href="Data.Singletons.Syntax.html#cd_tvbs"><span class="hs-identifier hs-var">cd_tvbs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361847"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361847"><span class="hs-identifier hs-var">cls_tvbs</span></a></span></span><span>
</span><span id="line-370"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cd_fds :: forall (ann :: AnnotationFlag). ClassDecl ann -&gt; [FunDep]
</span><a href="Data.Singletons.Syntax.html#cd_fds"><span class="hs-identifier hs-var">cd_fds</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361845"><span class="annot"><span class="annottext">[FunDep]
</span><a href="#local-6989586621681361845"><span class="hs-identifier hs-var">cls_fundeps</span></a></span></span><span>
</span><span id="line-371"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cd_lde :: forall (ann :: AnnotationFlag). ClassDecl ann -&gt; LetDecEnv ann
</span><a href="Data.Singletons.Syntax.html#cd_lde"><span class="hs-identifier hs-var">cd_lde</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-type">LetDecEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lde_defns :: forall (ann :: AnnotationFlag).
LetDecEnv ann -&gt; OMap Name (LetDecRHS ann)
</span><a href="Data.Singletons.Syntax.html#lde_defns"><span class="hs-identifier hs-var">lde_defns</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361843"><span class="annot"><span class="annottext">OMap Name (LetDecRHS Annotated)
</span><a href="#local-6989586621681361843"><span class="hs-identifier hs-var">default_defns</span></a></span></span><span>
</span><span id="line-372"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_types :: forall (ann :: AnnotationFlag). LetDecEnv ann -&gt; OMap Name DType
</span><a href="Data.Singletons.Syntax.html#lde_types"><span class="hs-identifier hs-var">lde_types</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361842"><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681361842"><span class="hs-identifier hs-var">meth_sigs</span></a></span></span><span>
</span><span id="line-373"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_infix :: forall (ann :: AnnotationFlag). LetDecEnv ann -&gt; OMap Name Fixity
</span><a href="Data.Singletons.Syntax.html#lde_infix"><span class="hs-identifier hs-var">lde_infix</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361840"><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621681361840"><span class="hs-identifier hs-var">fixities</span></a></span></span><span>
</span><span id="line-374"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_proms :: forall (ann :: AnnotationFlag).
LetDecEnv ann -&gt; IfAnn ann (OMap Name DType) ()
</span><a href="Data.Singletons.Syntax.html#lde_proms"><span class="hs-identifier hs-var">lde_proms</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361838"><span class="annot"><span class="annottext">IfAnn Annotated (OMap Name DType) ()
</span><a href="#local-6989586621681361838"><span class="hs-identifier hs-var">promoted_defaults</span></a></span></span><span>
</span><span id="line-375"></span><span>                                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_bound_kvs :: forall (ann :: AnnotationFlag).
LetDecEnv ann -&gt; IfAnn ann (OMap Name (OSet Name)) ()
</span><a href="Data.Singletons.Syntax.html#lde_bound_kvs"><span class="hs-identifier hs-var">lde_bound_kvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361836"><span class="annot"><span class="annottext">IfAnn Annotated (OMap Name (OSet Name)) ()
</span><a href="#local-6989586621681361836"><span class="hs-identifier hs-var">meth_bound_kvs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-376"></span><span>  </span><span class="annot"><span class="annottext">[DType] -&gt; SgM DDec -&gt; SgM DDec
forall a. [DType] -&gt; SgM a -&gt; SgM a
</span><a href="Data.Singletons.Single.Monad.html#bindContext"><span class="hs-identifier hs-var">bindContext</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DType -&gt; [DTyVarBndr] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361849"><span class="hs-identifier hs-var">cls_name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361847"><span class="hs-identifier hs-var">cls_tvbs</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(SgM DDec -&gt; SgM DDec) -&gt; SgM DDec -&gt; SgM DDec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-377"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681361834"><span class="annot"><span class="annottext">sing_sigs :: [DLetDec]
</span><a href="#local-6989586621681361834"><span class="hs-identifier hs-var">sing_sigs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361833"><span class="annot"><span class="annottext">tyvar_names :: [(Name, [Name])]
</span><a href="#local-6989586621681361833"><span class="hs-identifier hs-var">tyvar_names</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361832"><span class="annot"><span class="annottext">cxts :: [(Name, [DType])]
</span><a href="#local-6989586621681361832"><span class="hs-identifier hs-var">cxts</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361831"><span class="annot"><span class="annottext">res_kis :: [Maybe DType]
</span><a href="#local-6989586621681361831"><span class="hs-identifier hs-var">res_kis</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361830"><span class="annot"><span class="annottext">singIDefunss :: [[DDec]]
</span><a href="#local-6989586621681361830"><span class="hs-identifier hs-var">singIDefunss</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-378"></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
  Maybe DType, [DDec])]
-&gt; ([DLetDec], [(Name, DExp)], [(Name, [Name])], [(Name, [DType])],
    [Maybe DType], [[DDec]])
forall a b c d e f.
[(a, b, c, d, e, f)] -&gt; ([a], [b], [c], [d], [e], [f])
</span><span class="hs-identifier hs-var">unzip6</span></span><span> </span><span class="annot"><span class="annottext">([(DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
   Maybe DType, [DDec])]
 -&gt; ([DLetDec], [(Name, DExp)], [(Name, [Name])], [(Name, [DType])],
     [Maybe DType], [[DDec]]))
-&gt; SgM
     [(DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
       Maybe DType, [DDec])]
-&gt; SgM
     ([DLetDec], [(Name, DExp)], [(Name, [Name])], [(Name, [DType])],
      [Maybe DType], [[DDec]])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Name
 -&gt; DType
 -&gt; SgM
      (DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
       Maybe DType, [DDec]))
-&gt; [Name]
-&gt; [DType]
-&gt; SgM
     [(DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
       Maybe DType, [DDec])]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OMap Name (LetDecRHS Annotated)
-&gt; OMap Name DType
-&gt; OMap Name (OSet Name)
-&gt; Name
-&gt; DType
-&gt; SgM
     (DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
      Maybe DType, [DDec])
</span><a href="Data.Singletons.Single.html#singTySig"><span class="hs-identifier hs-var">singTySig</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name (LetDecRHS Annotated)
forall a. a
</span><a href="#local-6989586621681361826"><span class="hs-identifier hs-var">no_meth_defns</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681361842"><span class="hs-identifier hs-var">meth_sigs</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name (OSet Name)
IfAnn Annotated (OMap Name (OSet Name)) ()
</span><a href="#local-6989586621681361836"><span class="hs-identifier hs-var">meth_bound_kvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-379"></span><span>                             </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361825"><span class="hs-identifier hs-var">meth_names</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; [DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361825"><span class="hs-identifier hs-var">meth_names</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>    </span><span class="annot"><span class="annottext">[DDec] -&gt; SgM ()
forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="annot"><span class="annottext">([DDec] -&gt; SgM ()) -&gt; [DDec] -&gt; SgM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[[DDec]] -&gt; [DDec]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[DDec]]
</span><a href="#local-6989586621681361830"><span class="hs-identifier hs-var">singIDefunss</span></a></span><span>
</span><span id="line-381"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361822"><span class="annot"><span class="annottext">default_sigs :: [DDec]
</span><a href="#local-6989586621681361822"><span class="hs-identifier hs-var hs-var">default_sigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe DDec] -&gt; [DDec]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">([Maybe DDec] -&gt; [DDec]) -&gt; [Maybe DDec] -&gt; [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-382"></span><span>                       </span><span class="annot"><span class="annottext">(Name -&gt; DLetDec -&gt; (Name, [Name]) -&gt; Maybe DType -&gt; Maybe DDec)
-&gt; [Name]
-&gt; [DLetDec]
-&gt; [(Name, [Name])]
-&gt; [Maybe DType]
-&gt; [Maybe DDec]
forall a b c d e.
(a -&gt; b -&gt; c -&gt; d -&gt; e) -&gt; [a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; [e]
</span><span class="hs-identifier hs-var">zipWith4</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DLetDec -&gt; (Name, [Name]) -&gt; Maybe DType -&gt; Maybe DDec
forall a.
Name -&gt; DLetDec -&gt; (a, [Name]) -&gt; Maybe DType -&gt; Maybe DDec
</span><a href="#local-6989586621681361819"><span class="hs-identifier hs-var">mk_default_sig</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361825"><span class="hs-identifier hs-var">meth_names</span></a></span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361834"><span class="hs-identifier hs-var">sing_sigs</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, [Name])]
</span><a href="#local-6989586621681361833"><span class="hs-identifier hs-var">tyvar_names</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe DType]
</span><a href="#local-6989586621681361831"><span class="hs-identifier hs-var">res_kis</span></a></span><span>
</span><span id="line-383"></span><span>        </span><span id="local-6989586621681361818"><span class="annot"><span class="annottext">res_ki_map :: Map Name DType
</span><a href="#local-6989586621681361818"><span class="hs-identifier hs-var hs-var">res_ki_map</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LetBind] -&gt; Map Name DType
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Name] -&gt; [DType] -&gt; [LetBind]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361825"><span class="hs-identifier hs-var">meth_names</span></a></span><span>
</span><span id="line-384"></span><span>                                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Maybe DType -&gt; DType) -&gt; [Maybe DType] -&gt; [DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; Maybe DType -&gt; DType
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">DType
forall a. a
</span><a href="#local-6989586621681361815"><span class="hs-identifier hs-var">always_sig</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Maybe DType]
</span><a href="#local-6989586621681361831"><span class="hs-identifier hs-var">res_kis</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span>    </span><span id="local-6989586621681361814"><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361814"><span class="hs-identifier hs-var">sing_meths</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Name, LetDecRHS Annotated) -&gt; SgM DLetDec)
-&gt; [(Name, LetDecRHS Annotated)] -&gt; SgM [DLetDec]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; LetDecRHS Annotated -&gt; SgM DLetDec)
-&gt; (Name, LetDecRHS Annotated) -&gt; SgM DLetDec
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name [Name]
-&gt; Map Name [DType]
-&gt; Map Name DType
-&gt; Name
-&gt; LetDecRHS Annotated
-&gt; SgM DLetDec
</span><a href="Data.Singletons.Single.html#singLetDecRHS"><span class="hs-identifier hs-var">singLetDecRHS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Name, [Name])] -&gt; Map Name [Name]
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, [Name])]
</span><a href="#local-6989586621681361833"><span class="hs-identifier hs-var">tyvar_names</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>                                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Name, [DType])] -&gt; Map Name [DType]
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, [DType])]
</span><a href="#local-6989586621681361832"><span class="hs-identifier hs-var">cxts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-387"></span><span>                                               </span><span class="annot"><span class="annottext">Map Name DType
</span><a href="#local-6989586621681361818"><span class="hs-identifier hs-var">res_ki_map</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OMap Name (LetDecRHS Annotated) -&gt; [(Name, LetDecRHS Annotated)]
forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name (LetDecRHS Annotated)
</span><a href="#local-6989586621681361843"><span class="hs-identifier hs-var">default_defns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-389"></span><span>    </span><span id="local-6989586621681361811"><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361811"><span class="hs-identifier hs-var">fixities'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Name, Fixity) -&gt; SgM DLetDec)
-&gt; [(Name, Fixity)] -&gt; SgM [DLetDec]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; Fixity -&gt; SgM DLetDec) -&gt; (Name, Fixity) -&gt; SgM DLetDec
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Fixity -&gt; SgM DLetDec
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; Fixity -&gt; q DLetDec
</span><a href="Data.Singletons.Single.Fixity.html#singInfixDecl"><span class="hs-identifier hs-var">singInfixDecl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Name, Fixity)] -&gt; SgM [DLetDec])
-&gt; [(Name, Fixity)] -&gt; SgM [DLetDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity -&gt; [(Name, Fixity)]
forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621681361840"><span class="hs-identifier hs-var">fixities</span></a></span><span>
</span><span id="line-390"></span><span>    </span><span id="local-6989586621681361809"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361809"><span class="hs-identifier hs-var">cls_cxt'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; SgM DType) -&gt; [DType] -&gt; SgM [DType]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; SgM DType
</span><a href="Data.Singletons.Single.Type.html#singPred"><span class="hs-identifier hs-var">singPred</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361851"><span class="hs-identifier hs-var">cls_cxt</span></a></span><span>
</span><span id="line-391"></span><span>    </span><span class="annot"><span class="annottext">DDec -&gt; SgM DDec
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DDec -&gt; SgM DDec) -&gt; DDec -&gt; SgM DDec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DType] -&gt; Name -&gt; [DTyVarBndr] -&gt; [FunDep] -&gt; [DDec] -&gt; DDec
</span><span class="hs-identifier hs-var">DClassD</span></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361809"><span class="hs-identifier hs-var">cls_cxt'</span></a></span><span>
</span><span id="line-392"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#singClassName"><span class="hs-identifier hs-var">singClassName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361849"><span class="hs-identifier hs-var">cls_name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-393"></span><span>                     </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361847"><span class="hs-identifier hs-var">cls_tvbs</span></a></span><span>
</span><span id="line-394"></span><span>                     </span><span class="annot"><span class="annottext">[FunDep]
</span><a href="#local-6989586621681361845"><span class="hs-identifier hs-var">cls_fundeps</span></a></span><span>   </span><span class="hs-comment">-- they are fine without modification</span><span>
</span><span id="line-395"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DLetDec -&gt; DDec) -&gt; [DLetDec] -&gt; [DDec]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DLetDec -&gt; DDec
</span><span class="hs-identifier hs-var">DLetDec</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361834"><span class="hs-identifier hs-var">sing_sigs</span></a></span><span> </span><span class="annot"><span class="annottext">[DLetDec] -&gt; [DLetDec] -&gt; [DLetDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361814"><span class="hs-identifier hs-var">sing_meths</span></a></span><span> </span><span class="annot"><span class="annottext">[DLetDec] -&gt; [DLetDec] -&gt; [DLetDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361811"><span class="hs-identifier hs-var">fixities'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [DDec] -&gt; [DDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361822"><span class="hs-identifier hs-var">default_sigs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-396"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-397"></span><span>    </span><span id="local-6989586621681361826"><span class="annot"><span class="annottext">no_meth_defns :: a
</span><a href="#local-6989586621681361826"><span class="hs-identifier hs-var hs-var">no_meth_defns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; a
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Internal error: can't find declared method type&quot;</span></span><span>
</span><span id="line-398"></span><span>    </span><span id="local-6989586621681361815"><span class="annot"><span class="annottext">always_sig :: a
</span><a href="#local-6989586621681361815"><span class="hs-identifier hs-var hs-var">always_sig</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; a
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Internal error: no signature for default method&quot;</span></span><span>
</span><span id="line-399"></span><span>    </span><span id="local-6989586621681361825"><span class="annot"><span class="annottext">meth_names :: [Name]
</span><a href="#local-6989586621681361825"><span class="hs-identifier hs-var hs-var">meth_names</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LetBind -&gt; Name) -&gt; [LetBind] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LetBind -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([LetBind] -&gt; [Name]) -&gt; [LetBind] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OMap Name DType -&gt; [LetBind]
forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681361842"><span class="hs-identifier hs-var">meth_sigs</span></a></span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span>    </span><span id="local-6989586621681361819"><span class="annot"><span class="annottext">mk_default_sig :: Name -&gt; DLetDec -&gt; (a, [Name]) -&gt; Maybe DType -&gt; Maybe DDec
</span><a href="#local-6989586621681361819"><span class="hs-identifier hs-var hs-var">mk_default_sig</span></a></span></span><span> </span><span id="local-6989586621681361804"><span class="annot"><span class="annottext">meth_name :: Name
</span><a href="#local-6989586621681361804"><span class="hs-identifier hs-var">meth_name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DSigD</span></span><span> </span><span id="local-6989586621681361802"><span class="annot"><span class="annottext">s_name :: Name
</span><a href="#local-6989586621681361802"><span class="hs-identifier hs-var">s_name</span></a></span></span><span> </span><span id="local-6989586621681361801"><span class="annot"><span class="annottext">sty :: DType
</span><a href="#local-6989586621681361801"><span class="hs-identifier hs-var">sty</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681361800"><span class="annot"><span class="annottext">bound_kvs :: (a, [Name])
</span><a href="#local-6989586621681361800"><span class="hs-identifier hs-var">bound_kvs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681361799"><span class="annot"><span class="annottext">res_ki :: DType
</span><a href="#local-6989586621681361799"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-402"></span><span>      </span><span class="annot"><span class="annottext">Name -&gt; DType -&gt; DDec
</span><span class="hs-identifier hs-var">DDefaultSigD</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361802"><span class="hs-identifier hs-var">s_name</span></a></span><span> </span><span class="annot"><span class="annottext">(DType -&gt; DDec) -&gt; Maybe DType -&gt; Maybe DDec
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType -&gt; (a, [Name]) -&gt; DType -&gt; Maybe DType
forall a. Name -&gt; DType -&gt; (a, [Name]) -&gt; DType -&gt; Maybe DType
</span><a href="#local-6989586621681361797"><span class="hs-identifier hs-var">add_constraints</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361804"><span class="hs-identifier hs-var">meth_name</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361801"><span class="hs-identifier hs-var">sty</span></a></span><span> </span><span class="annot"><span class="annottext">(a, [Name])
</span><a href="#local-6989586621681361800"><span class="hs-identifier hs-var">bound_kvs</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361799"><span class="hs-identifier hs-var">res_ki</span></a></span><span>
</span><span id="line-403"></span><span>    </span><span class="annot"><a href="#local-6989586621681361819"><span class="hs-identifier hs-var">mk_default_sig</span></a></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe DDec
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Internal error: a singled signature isn't a signature.&quot;</span></span><span>
</span><span id="line-404"></span><span>
</span><span id="line-405"></span><span>    </span><span id="local-6989586621681361797"><span class="annot"><span class="annottext">add_constraints :: Name -&gt; DType -&gt; (a, [Name]) -&gt; DType -&gt; Maybe DType
</span><a href="#local-6989586621681361797"><span class="hs-identifier hs-var hs-var">add_constraints</span></a></span></span><span> </span><span id="local-6989586621681361796"><span class="annot"><span class="annottext">meth_name :: Name
</span><a href="#local-6989586621681361796"><span class="hs-identifier hs-var">meth_name</span></a></span></span><span> </span><span id="local-6989586621681361795"><span class="annot"><span class="annottext">sty :: DType
</span><a href="#local-6989586621681361795"><span class="hs-identifier hs-var">sty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361794"><span class="annot"><span class="annottext">bound_kvs :: [Name]
</span><a href="#local-6989586621681361794"><span class="hs-identifier hs-var">bound_kvs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681361793"><span class="annot"><span class="annottext">res_ki :: DType
</span><a href="#local-6989586621681361793"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-comment">-- Maybe monad</span><span>
</span><span id="line-406"></span><span>      </span><span id="local-6989586621681361792"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361792"><span class="hs-identifier hs-var">prom_dflt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; OMap Name DType -&gt; Maybe DType
forall k v. Ord k =&gt; k -&gt; OMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361796"><span class="hs-identifier hs-var">meth_name</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
IfAnn Annotated (OMap Name DType) ()
</span><a href="#local-6989586621681361838"><span class="hs-identifier hs-var">promoted_defaults</span></a></span><span>
</span><span id="line-407"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361790"><span class="annot"><span class="annottext">default_pred :: DType
</span><a href="#local-6989586621681361790"><span class="hs-identifier hs-var hs-var">default_pred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#equalityName"><span class="hs-identifier hs-var">equalityName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>                                </span><span class="hs-comment">-- NB: Need the res_ki here to prevent ambiguous</span><span>
</span><span id="line-409"></span><span>                                </span><span class="hs-comment">-- kinds in result-inferred default methods.</span><span>
</span><span id="line-410"></span><span>                                </span><span class="hs-comment">-- See #175</span><span>
</span><span id="line-411"></span><span>                               </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.Names.html#foldApply"><span class="hs-identifier hs-var">foldApply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361796"><span class="hs-identifier hs-var">meth_name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361788"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DSigT`</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361793"><span class="hs-identifier hs-var">res_ki</span></a></span><span>
</span><span id="line-412"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.Names.html#foldApply"><span class="hs-identifier hs-var">foldApply</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361792"><span class="hs-identifier hs-var">prom_dflt</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361788"><span class="hs-identifier hs-var">tvs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-413"></span><span>      </span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DType -&gt; Maybe DType) -&gt; DType -&gt; Maybe DType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; [DType] -&gt; DType -&gt; DType
</span><span class="hs-identifier hs-var">DForallT</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361787"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361790"><span class="hs-identifier hs-var">default_pred</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; [DType]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361786"><span class="hs-identifier hs-var">cxt</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DType] -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Util.html#ravel"><span class="hs-identifier hs-var">ravel</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361785"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361784"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-414"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-415"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681361787"><span class="annot"><span class="annottext">tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681361787"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361786"><span class="annot"><span class="annottext">cxt :: [DType]
</span><a href="#local-6989586621681361786"><span class="hs-identifier hs-var">cxt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361785"><span class="annot"><span class="annottext">args :: [DType]
</span><a href="#local-6989586621681361785"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361784"><span class="annot"><span class="annottext">res :: DType
</span><a href="#local-6989586621681361784"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; ([DTyVarBndr], [DType], [DType], DType)
</span><span class="hs-identifier hs-var">unravel</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361795"><span class="hs-identifier hs-var">sty</span></a></span><span>
</span><span id="line-416"></span><span>        </span><span id="local-6989586621681361782"><span class="annot"><span class="annottext">bound_kv_set :: Set Name
</span><a href="#local-6989586621681361782"><span class="hs-identifier hs-var hs-var">bound_kv_set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; Set Name
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361794"><span class="hs-identifier hs-var">bound_kvs</span></a></span><span>
</span><span id="line-417"></span><span>        </span><span class="hs-comment">-- Filter out explicitly bound kind variables. Otherwise, if you had</span><span>
</span><span id="line-418"></span><span>        </span><span class="hs-comment">-- the following class (#312):</span><span>
</span><span id="line-419"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-420"></span><span>        </span><span class="hs-comment">--  class Foo a where</span><span>
</span><span id="line-421"></span><span>        </span><span class="hs-comment">--    bar :: a -&gt; b -&gt; b</span><span>
</span><span id="line-422"></span><span>        </span><span class="hs-comment">--    bar _ x = x</span><span>
</span><span id="line-423"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-424"></span><span>        </span><span class="hs-comment">-- Then it would be singled to:</span><span>
</span><span id="line-425"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-426"></span><span>        </span><span class="hs-comment">--  class SFoo a where</span><span>
</span><span id="line-427"></span><span>        </span><span class="hs-comment">--    sBar :: forall b (x :: a) (y :: b). Sing x -&gt; Sing y -&gt; Sing (sBar x y)</span><span>
</span><span id="line-428"></span><span>        </span><span class="hs-comment">--    default :: forall b (x :: a) (y :: b).</span><span>
</span><span id="line-429"></span><span>        </span><span class="hs-comment">--               (Bar b x y) ~ (BarDefault b x y) =&gt; ...</span><span>
</span><span id="line-430"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-431"></span><span>        </span><span class="hs-comment">-- Which applies Bar/BarDefault to b, which shouldn't happen.</span><span>
</span><span id="line-432"></span><span>        </span><span id="local-6989586621681361788"><span class="annot"><span class="annottext">tvs :: [DType]
</span><a href="#local-6989586621681361788"><span class="hs-identifier hs-var hs-var">tvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; DType) -&gt; [DTyVarBndr] -&gt; [DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; DType
</span><a href="Data.Singletons.Util.html#tvbToType"><span class="hs-identifier hs-var">tvbToType</span></a></span><span> </span><span class="annot"><span class="annottext">([DTyVarBndr] -&gt; [DType]) -&gt; [DTyVarBndr] -&gt; [DType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-433"></span><span>              </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; Bool) -&gt; [DTyVarBndr] -&gt; [DTyVarBndr]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681361779"><span class="annot"><span class="annottext">tvb :: DTyVarBndr
</span><a href="#local-6989586621681361779"><span class="hs-identifier hs-var">tvb</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; Name
</span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr
</span><a href="#local-6989586621681361779"><span class="hs-identifier hs-var">tvb</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Set Name -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`Set.member`</span></span><span> </span><span class="annot"><span class="annottext">Set Name
</span><a href="#local-6989586621681361782"><span class="hs-identifier hs-var">bound_kv_set</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361787"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-434"></span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span class="annot"><a href="Data.Singletons.Single.html#singInstD"><span class="hs-identifier hs-type">singInstD</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#AInstDecl"><span class="hs-identifier hs-type">AInstDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span>
</span><span id="line-437"></span><span id="singInstD"><span class="annot"><span class="annottext">singInstD :: AInstDecl -&gt; SgM DDec
</span><a href="Data.Singletons.Single.html#singInstD"><span class="hs-identifier hs-var hs-var">singInstD</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#InstDecl"><span class="hs-identifier hs-type">InstDecl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">id_cxt :: forall (ann :: AnnotationFlag). InstDecl ann -&gt; [DType]
</span><a href="Data.Singletons.Syntax.html#id_cxt"><span class="hs-identifier hs-var">id_cxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361775"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361775"><span class="hs-identifier hs-var">cxt</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">id_name :: forall (ann :: AnnotationFlag). InstDecl ann -&gt; Name
</span><a href="Data.Singletons.Syntax.html#id_name"><span class="hs-identifier hs-var">id_name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361773"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361773"><span class="hs-identifier hs-var">inst_name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">id_arg_tys :: forall (ann :: AnnotationFlag). InstDecl ann -&gt; [DType]
</span><a href="Data.Singletons.Syntax.html#id_arg_tys"><span class="hs-identifier hs-var">id_arg_tys</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361771"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361771"><span class="hs-identifier hs-var">inst_tys</span></a></span></span><span>
</span><span id="line-438"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">id_sigs :: forall (ann :: AnnotationFlag). InstDecl ann -&gt; OMap Name DType
</span><a href="Data.Singletons.Syntax.html#id_sigs"><span class="hs-identifier hs-var">id_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361769"><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681361769"><span class="hs-identifier hs-var">inst_sigs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">id_meths :: forall (ann :: AnnotationFlag).
InstDecl ann -&gt; [(Name, LetDecRHS ann)]
</span><a href="Data.Singletons.Syntax.html#id_meths"><span class="hs-identifier hs-var">id_meths</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361767"><span class="annot"><span class="annottext">[(Name, LetDecRHS Annotated)]
</span><a href="#local-6989586621681361767"><span class="hs-identifier hs-var">ann_meths</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-439"></span><span>  </span><span class="annot"><span class="annottext">[DType] -&gt; SgM DDec -&gt; SgM DDec
forall a. [DType] -&gt; SgM a -&gt; SgM a
</span><a href="Data.Singletons.Single.Monad.html#bindContext"><span class="hs-identifier hs-var">bindContext</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361775"><span class="hs-identifier hs-var">cxt</span></a></span><span> </span><span class="annot"><span class="annottext">(SgM DDec -&gt; SgM DDec) -&gt; SgM DDec -&gt; SgM DDec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-440"></span><span>    </span><span id="local-6989586621681361766"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361766"><span class="hs-identifier hs-var">cxt'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; SgM DType) -&gt; [DType] -&gt; SgM [DType]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; SgM DType
</span><a href="Data.Singletons.Single.Type.html#singPred"><span class="hs-identifier hs-var">singPred</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361775"><span class="hs-identifier hs-var">cxt</span></a></span><span>
</span><span id="line-441"></span><span>    </span><span id="local-6989586621681361765"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361765"><span class="hs-identifier hs-var">inst_kis</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; SgM DType) -&gt; [DType] -&gt; SgM [DType]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; SgM DType
forall (m :: * -&gt; *). MonadFail m =&gt; DType -&gt; m DType
</span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361771"><span class="hs-identifier hs-var">inst_tys</span></a></span><span>
</span><span id="line-442"></span><span>    </span><span id="local-6989586621681361763"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361763"><span class="hs-identifier hs-var">meths</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Name, LetDecRHS Annotated) -&gt; SgM [DDec])
-&gt; [(Name, LetDecRHS Annotated)] -&gt; SgM [DDec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; LetDecRHS Annotated -&gt; SgM [DDec])
-&gt; (Name, LetDecRHS Annotated) -&gt; SgM [DDec]
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; LetDecRHS Annotated -&gt; SgM [DDec]
</span><a href="#local-6989586621681361762"><span class="hs-identifier hs-var">sing_meth</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, LetDecRHS Annotated)]
</span><a href="#local-6989586621681361767"><span class="hs-identifier hs-var">ann_meths</span></a></span><span>
</span><span id="line-443"></span><span>    </span><span class="annot"><span class="annottext">DDec -&gt; SgM DDec
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Overlap
-&gt; Maybe [DTyVarBndr] -&gt; [DType] -&gt; DType -&gt; [DDec] -&gt; DDec
</span><span class="hs-identifier hs-var">DInstanceD</span></span><span> </span><span class="annot"><span class="annottext">Maybe Overlap
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-444"></span><span>                       </span><span class="annot"><span class="annottext">Maybe [DTyVarBndr]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-445"></span><span>                       </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361766"><span class="hs-identifier hs-var">cxt'</span></a></span><span>
</span><span id="line-446"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DType -&gt; DType -&gt; DType) -&gt; DType -&gt; [DType] -&gt; DType
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-identifier hs-var">DAppT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361760"><span class="hs-identifier hs-var">s_inst_name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361765"><span class="hs-identifier hs-var">inst_kis</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>                       </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361763"><span class="hs-identifier hs-var">meths</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-448"></span><span>
</span><span id="line-449"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-450"></span><span>    </span><span id="local-6989586621681361760"><span class="annot"><span class="annottext">s_inst_name :: Name
</span><a href="#local-6989586621681361760"><span class="hs-identifier hs-var hs-var">s_inst_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#singClassName"><span class="hs-identifier hs-var">singClassName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361773"><span class="hs-identifier hs-var">inst_name</span></a></span><span>
</span><span id="line-451"></span><span>
</span><span id="line-452"></span><span>    </span><span class="annot"><a href="#local-6989586621681361762"><span class="hs-identifier hs-type">sing_meth</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ALetDecRHS"><span class="hs-identifier hs-type">ALetDecRHS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-453"></span><span>    </span><span id="local-6989586621681361762"><span class="annot"><span class="annottext">sing_meth :: Name -&gt; LetDecRHS Annotated -&gt; SgM [DDec]
</span><a href="#local-6989586621681361762"><span class="hs-identifier hs-var hs-var">sing_meth</span></a></span></span><span> </span><span id="local-6989586621681361758"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681361758"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681361757"><span class="annot"><span class="annottext">rhs :: LetDecRHS Annotated
</span><a href="#local-6989586621681361757"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-454"></span><span>      </span><span id="local-6989586621681361756"><span class="annot"><span class="annottext">Maybe DInfo
</span><a href="#local-6989586621681361756"><span class="hs-identifier hs-var">mb_s_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; SgM (Maybe DInfo)
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe DInfo)
</span><span class="hs-identifier hs-var">dsReify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361758"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-455"></span><span>      </span><span id="local-6989586621681361754"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361754"><span class="hs-identifier hs-var">inst_kis</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; SgM DType) -&gt; [DType] -&gt; SgM [DType]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; SgM DType
forall (m :: * -&gt; *). MonadFail m =&gt; DType -&gt; m DType
</span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361771"><span class="hs-identifier hs-var">inst_tys</span></a></span><span>
</span><span id="line-456"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361753"><span class="annot"><span class="annottext">mk_subst :: [DTyVarBndr] -&gt; Map Name DType
</span><a href="#local-6989586621681361753"><span class="hs-identifier hs-var hs-var">mk_subst</span></a></span></span><span> </span><span id="local-6989586621681361752"><span class="annot"><span class="annottext">cls_tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681361752"><span class="hs-identifier hs-var">cls_tvbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LetBind] -&gt; Map Name DType
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">([LetBind] -&gt; Map Name DType) -&gt; [LetBind] -&gt; Map Name DType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [DType] -&gt; [LetBind]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; Name) -&gt; [DTyVarBndr] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; Name
</span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361751"><span class="hs-identifier hs-var">vis_cls_tvbs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361754"><span class="hs-identifier hs-var">inst_kis</span></a></span><span>
</span><span id="line-457"></span><span>            </span><span class="hs-keyword">where</span><span>
</span><span id="line-458"></span><span>              </span><span class="hs-comment">-- This is a half-hearted attempt to address the underlying problem</span><span>
</span><span id="line-459"></span><span>              </span><span class="hs-comment">-- in #358, where we can sometimes have more class type variables</span><span>
</span><span id="line-460"></span><span>              </span><span class="hs-comment">-- (due to implicit kind arguments) than class arguments. This just</span><span>
</span><span id="line-461"></span><span>              </span><span class="hs-comment">-- ensures that the explicit type variables are properly mapped</span><span>
</span><span id="line-462"></span><span>              </span><span class="hs-comment">-- to the class arguments, leaving the implicit kind variables</span><span>
</span><span id="line-463"></span><span>              </span><span class="hs-comment">-- unmapped. That could potentially cause *other* problems, but</span><span>
</span><span id="line-464"></span><span>              </span><span class="hs-comment">-- those are perhaps best avoided by using InstanceSigs. At the</span><span>
</span><span id="line-465"></span><span>              </span><span class="hs-comment">-- very least, this workaround will make error messages slightly</span><span>
</span><span id="line-466"></span><span>              </span><span class="hs-comment">-- less confusing.</span><span>
</span><span id="line-467"></span><span>              </span><span id="local-6989586621681361751"><span class="annot"><span class="annottext">vis_cls_tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681361751"><span class="hs-identifier hs-var hs-var">vis_cls_tvbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [DTyVarBndr] -&gt; [DTyVarBndr]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361752"><span class="hs-identifier hs-var">cls_tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[DType] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361754"><span class="hs-identifier hs-var">inst_kis</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361752"><span class="hs-identifier hs-var">cls_tvbs</span></a></span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span>          </span><span class="annot"><a href="#local-6989586621681361749"><span class="hs-identifier hs-type">sing_meth_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OSet</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span>
</span><span id="line-470"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DCxt</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">)</span><span>
</span><span id="line-471"></span><span>          </span><span id="local-6989586621681361749"><span class="annot"><span class="annottext">sing_meth_ty :: OSet Name -&gt; DType -&gt; SgM (DType, [Name], [DType], DType)
</span><a href="#local-6989586621681361749"><span class="hs-identifier hs-var hs-var">sing_meth_ty</span></a></span></span><span> </span><span id="local-6989586621681361746"><span class="annot"><span class="annottext">bound_kvs :: OSet Name
</span><a href="#local-6989586621681361746"><span class="hs-identifier hs-var">bound_kvs</span></a></span></span><span> </span><span id="local-6989586621681361745"><span class="annot"><span class="annottext">inner_ty :: DType
</span><a href="#local-6989586621681361745"><span class="hs-identifier hs-var">inner_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-472"></span><span>            </span><span class="hs-comment">-- Make sure to expand through type synonyms here! Not doing so</span><span>
</span><span id="line-473"></span><span>            </span><span class="hs-comment">-- resulted in #167.</span><span>
</span><span id="line-474"></span><span>            </span><span id="local-6989586621681361744"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361744"><span class="hs-identifier hs-var">raw_ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DType -&gt; SgM DType
forall (q :: * -&gt; *) a. (DsMonad q, Data a) =&gt; a -&gt; q a
</span><span class="hs-identifier hs-var">expand</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361745"><span class="hs-identifier hs-var">inner_ty</span></a></span><span>
</span><span id="line-475"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621681361743"><span class="annot"><span class="annottext">s_ty :: DType
</span><a href="#local-6989586621681361743"><span class="hs-identifier hs-var">s_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361742"><span class="annot"><span class="annottext">_num_args :: Int
</span><a href="#local-6989586621681361742"><span class="hs-identifier hs-var">_num_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361741"><span class="annot"><span class="annottext">tyvar_names :: [Name]
</span><a href="#local-6989586621681361741"><span class="hs-identifier hs-var">tyvar_names</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361740"><span class="annot"><span class="annottext">ctxt :: [DType]
</span><a href="#local-6989586621681361740"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361739"><span class="annot"><span class="annottext">_arg_kis :: [DType]
</span><a href="#local-6989586621681361739"><span class="hs-identifier hs-var">_arg_kis</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361738"><span class="annot"><span class="annottext">res_ki :: DType
</span><a href="#local-6989586621681361738"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OSet Name
-&gt; DType
-&gt; DType
-&gt; SgM (DType, Int, [Name], [DType], [DType], DType)
</span><a href="Data.Singletons.Single.Type.html#singType"><span class="hs-identifier hs-var">singType</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681361746"><span class="hs-identifier hs-var">bound_kvs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361758"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361744"><span class="hs-identifier hs-var">raw_ty</span></a></span><span>
</span><span id="line-477"></span><span>            </span><span class="annot"><span class="annottext">(DType, [Name], [DType], DType)
-&gt; SgM (DType, [Name], [DType], DType)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361743"><span class="hs-identifier hs-var">s_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361741"><span class="hs-identifier hs-var">tyvar_names</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361740"><span class="hs-identifier hs-var">ctxt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361738"><span class="hs-identifier hs-var">res_ki</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621681361736"><span class="annot"><span class="annottext">s_ty :: DType
</span><a href="#local-6989586621681361736"><span class="hs-identifier hs-var">s_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361735"><span class="annot"><span class="annottext">tyvar_names :: [Name]
</span><a href="#local-6989586621681361735"><span class="hs-identifier hs-var">tyvar_names</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361734"><span class="annot"><span class="annottext">ctxt :: [DType]
</span><a href="#local-6989586621681361734"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361733"><span class="annot"><span class="annottext">m_res_ki :: Maybe DType
</span><a href="#local-6989586621681361733"><span class="hs-identifier hs-var">m_res_ki</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; OMap Name DType -&gt; Maybe DType
forall k v. Ord k =&gt; k -&gt; OMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361758"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681361769"><span class="hs-identifier hs-var">inst_sigs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-480"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681361732"><span class="annot"><span class="annottext">inst_sig :: DType
</span><a href="#local-6989586621681361732"><span class="hs-identifier hs-var">inst_sig</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-481"></span><span>          </span><span class="hs-comment">-- We have an InstanceSig, so just single that type. Take care to</span><span>
</span><span id="line-482"></span><span>          </span><span class="hs-comment">-- avoid binding the variables bound by the instance head as well.</span><span>
</span><span id="line-483"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361731"><span class="annot"><span class="annottext">inst_bound :: OSet Name
</span><a href="#local-6989586621681361731"><span class="hs-identifier hs-var hs-var">inst_bound</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; OSet Name) -&gt; [DType] -&gt; OSet Name
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; OSet Name
</span><span class="hs-identifier hs-var">fvDType</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361775"><span class="hs-identifier hs-var">cxt</span></a></span><span> </span><span class="annot"><span class="annottext">[DType] -&gt; [DType] -&gt; [DType]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361754"><span class="hs-identifier hs-var">inst_kis</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621681361729"><span class="annot"><span class="annottext">s_ty :: DType
</span><a href="#local-6989586621681361729"><span class="hs-identifier hs-var">s_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361728"><span class="annot"><span class="annottext">tyvar_names :: [Name]
</span><a href="#local-6989586621681361728"><span class="hs-identifier hs-var">tyvar_names</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361727"><span class="annot"><span class="annottext">ctxt :: [DType]
</span><a href="#local-6989586621681361727"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361726"><span class="annot"><span class="annottext">res_ki :: DType
</span><a href="#local-6989586621681361726"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OSet Name -&gt; DType -&gt; SgM (DType, [Name], [DType], DType)
</span><a href="#local-6989586621681361749"><span class="hs-identifier hs-var">sing_meth_ty</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681361731"><span class="hs-identifier hs-var">inst_bound</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361732"><span class="hs-identifier hs-var">inst_sig</span></a></span><span>
</span><span id="line-485"></span><span>          </span><span class="annot"><span class="annottext">(DType, [Name], [DType], Maybe DType)
-&gt; SgM (DType, [Name], [DType], Maybe DType)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361729"><span class="hs-identifier hs-var">s_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361728"><span class="hs-identifier hs-var">tyvar_names</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361727"><span class="hs-identifier hs-var">ctxt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361726"><span class="hs-identifier hs-var">res_ki</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe DInfo
</span><a href="#local-6989586621681361756"><span class="hs-identifier hs-var">mb_s_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-487"></span><span>          </span><span class="hs-comment">-- We don't have an InstanceSig, so we must compute the type to use</span><span>
</span><span id="line-488"></span><span>          </span><span class="hs-comment">-- in the singled instance ourselves through reification.</span><span>
</span><span id="line-489"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DVarI</span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DForallT</span></span><span> </span><span id="local-6989586621681361725"><span class="annot"><span class="annottext">cls_tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681361725"><span class="hs-identifier hs-var">cls_tvbs</span></a></span></span><span> </span><span id="local-6989586621681361724"><span class="annot"><span class="annottext">_cls_pred :: [DType]
</span><a href="#local-6989586621681361724"><span class="hs-identifier hs-var">_cls_pred</span></a></span></span><span> </span><span id="local-6989586621681361723"><span class="annot"><span class="annottext">s_ty :: DType
</span><a href="#local-6989586621681361723"><span class="hs-identifier hs-var">s_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-490"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361722"><span class="annot"><span class="annottext">subst :: Map Name DType
</span><a href="#local-6989586621681361722"><span class="hs-identifier hs-var hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; Map Name DType
</span><a href="#local-6989586621681361753"><span class="hs-identifier hs-var">mk_subst</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361725"><span class="hs-identifier hs-var">cls_tvbs</span></a></span><span>
</span><span id="line-491"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621681361721"><span class="annot"><span class="annottext">sing_tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681361721"><span class="hs-identifier hs-var">sing_tvbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361720"><span class="annot"><span class="annottext">ctxt :: [DType]
</span><a href="#local-6989586621681361720"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361719"><span class="annot"><span class="annottext">_args :: [DType]
</span><a href="#local-6989586621681361719"><span class="hs-identifier hs-var">_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361718"><span class="annot"><span class="annottext">res_ty :: DType
</span><a href="#local-6989586621681361718"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; ([DTyVarBndr], [DType], [DType], DType)
</span><span class="hs-identifier hs-var">unravel</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361723"><span class="hs-identifier hs-var">s_ty</span></a></span><span>
</span><span id="line-492"></span><span>                </span><span id="local-6989586621681361717"><span class="annot"><span class="annottext">m_res_ki :: Maybe DType
</span><a href="#local-6989586621681361717"><span class="hs-identifier hs-var hs-var">m_res_ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361718"><span class="hs-identifier hs-var">res_ty</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-493"></span><span>                  </span><span id="local-6989586621681361716"><span class="annot"><span class="annottext">_sing :: DType
</span><a href="#local-6989586621681361716"><span class="hs-identifier hs-var">_sing</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">`DAppT`</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681361715"><span class="annot"><span class="annottext">_prom_func :: DType
</span><a href="#local-6989586621681361715"><span class="hs-identifier hs-var">_prom_func</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">`DSigT`</span></span><span> </span><span id="local-6989586621681361714"><span class="annot"><span class="annottext">res_ki :: DType
</span><a href="#local-6989586621681361714"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Util.html#substKind"><span class="hs-identifier hs-var">substKind</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name DType
</span><a href="#local-6989586621681361722"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361714"><span class="hs-identifier hs-var">res_ki</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-494"></span><span>                  </span><span class="hs-identifier">_</span><span>                                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe DType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-495"></span><span>
</span><span id="line-496"></span><span>            </span><span class="annot"><span class="annottext">(DType, [Name], [DType], Maybe DType)
-&gt; SgM (DType, [Name], [DType], Maybe DType)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Map Name DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Util.html#substType"><span class="hs-identifier hs-var">substType</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name DType
</span><a href="#local-6989586621681361722"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361723"><span class="hs-identifier hs-var">s_ty</span></a></span><span>
</span><span id="line-497"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; Name) -&gt; [DTyVarBndr] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; Name
</span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361721"><span class="hs-identifier hs-var">sing_tvbs</span></a></span><span>
</span><span id="line-498"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; DType) -&gt; [DType] -&gt; [DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Util.html#substType"><span class="hs-identifier hs-var">substType</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name DType
</span><a href="#local-6989586621681361722"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361720"><span class="hs-identifier hs-var">ctxt</span></a></span><span>
</span><span id="line-499"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681361717"><span class="hs-identifier hs-var">m_res_ki</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-500"></span><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-501"></span><span>            </span><span id="local-6989586621681361711"><span class="annot"><span class="annottext">Maybe DInfo
</span><a href="#local-6989586621681361711"><span class="hs-identifier hs-var">mb_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; SgM (Maybe DInfo)
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe DInfo)
</span><span class="hs-identifier hs-var">dsReify</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361758"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-502"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe DInfo
</span><a href="#local-6989586621681361711"><span class="hs-identifier hs-var">mb_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-503"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DVarI</span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DForallT</span></span><span> </span><span id="local-6989586621681361710"><span class="annot"><span class="annottext">cls_tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681361710"><span class="hs-identifier hs-var">cls_tvbs</span></a></span></span><span> </span><span id="local-6989586621681361709"><span class="annot"><span class="annottext">_cls_pred :: [DType]
</span><a href="#local-6989586621681361709"><span class="hs-identifier hs-var">_cls_pred</span></a></span></span><span> </span><span id="local-6989586621681361708"><span class="annot"><span class="annottext">inner_ty :: DType
</span><a href="#local-6989586621681361708"><span class="hs-identifier hs-var">inner_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-504"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361707"><span class="annot"><span class="annottext">subst :: Map Name DType
</span><a href="#local-6989586621681361707"><span class="hs-identifier hs-var hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; Map Name DType
</span><a href="#local-6989586621681361753"><span class="hs-identifier hs-var">mk_subst</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361710"><span class="hs-identifier hs-var">cls_tvbs</span></a></span><span>
</span><span id="line-505"></span><span>                    </span><span id="local-6989586621681361706"><span class="annot"><span class="annottext">cls_kvb_names :: OSet Name
</span><a href="#local-6989586621681361706"><span class="hs-identifier hs-var hs-var">cls_kvb_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; OSet Name) -&gt; [DTyVarBndr] -&gt; OSet Name
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DType -&gt; OSet Name) -&gt; Maybe DType -&gt; OSet Name
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; OSet Name
</span><span class="hs-identifier hs-var">fvDType</span></span><span> </span><span class="annot"><span class="annottext">(Maybe DType -&gt; OSet Name)
-&gt; (DTyVarBndr -&gt; Maybe DType) -&gt; DTyVarBndr -&gt; OSet Name
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; Maybe DType
</span><a href="Data.Singletons.Util.html#extractTvbKind"><span class="hs-identifier hs-var">extractTvbKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361710"><span class="hs-identifier hs-var">cls_tvbs</span></a></span><span>
</span><span id="line-506"></span><span>                    </span><span id="local-6989586621681361704"><span class="annot"><span class="annottext">cls_tvb_names :: OSet Name
</span><a href="#local-6989586621681361704"><span class="hs-identifier hs-var hs-var">cls_tvb_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; OSet Name
forall a. Ord a =&gt; [a] -&gt; OSet a
</span><span class="hs-identifier hs-var">OSet.fromList</span></span><span> </span><span class="annot"><span class="annottext">([Name] -&gt; OSet Name) -&gt; [Name] -&gt; OSet Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; Name) -&gt; [DTyVarBndr] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; Name
</span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361710"><span class="hs-identifier hs-var">cls_tvbs</span></a></span><span>
</span><span id="line-507"></span><span>                    </span><span id="local-6989586621681361702"><span class="annot"><span class="annottext">cls_bound :: OSet Name
</span><a href="#local-6989586621681361702"><span class="hs-identifier hs-var hs-var">cls_bound</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681361706"><span class="hs-identifier hs-var">cls_kvb_names</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name -&gt; OSet Name -&gt; OSet Name
forall a. Ord a =&gt; OSet a -&gt; OSet a -&gt; OSet a
</span><span class="hs-operator hs-var">`OSet.union`</span></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681361704"><span class="hs-identifier hs-var">cls_tvb_names</span></a></span><span>
</span><span id="line-508"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621681361700"><span class="annot"><span class="annottext">s_ty :: DType
</span><a href="#local-6989586621681361700"><span class="hs-identifier hs-var">s_ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361699"><span class="annot"><span class="annottext">tyvar_names :: [Name]
</span><a href="#local-6989586621681361699"><span class="hs-identifier hs-var">tyvar_names</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361698"><span class="annot"><span class="annottext">ctxt :: [DType]
</span><a href="#local-6989586621681361698"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361697"><span class="annot"><span class="annottext">res_ki :: DType
</span><a href="#local-6989586621681361697"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OSet Name -&gt; DType -&gt; SgM (DType, [Name], [DType], DType)
</span><a href="#local-6989586621681361749"><span class="hs-identifier hs-var">sing_meth_ty</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681361702"><span class="hs-identifier hs-var">cls_bound</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361708"><span class="hs-identifier hs-var">inner_ty</span></a></span><span>
</span><span id="line-509"></span><span>                </span><span class="annot"><span class="annottext">(DType, [Name], [DType], Maybe DType)
-&gt; SgM (DType, [Name], [DType], Maybe DType)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Map Name DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Util.html#substType"><span class="hs-identifier hs-var">substType</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name DType
</span><a href="#local-6989586621681361707"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361700"><span class="hs-identifier hs-var">s_ty</span></a></span><span>
</span><span id="line-510"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361699"><span class="hs-identifier hs-var">tyvar_names</span></a></span><span>
</span><span id="line-511"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361698"><span class="hs-identifier hs-var">ctxt</span></a></span><span>
</span><span id="line-512"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Util.html#substKind"><span class="hs-identifier hs-var">substKind</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name DType
</span><a href="#local-6989586621681361707"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361697"><span class="hs-identifier hs-var">res_ki</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-513"></span><span>              </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SgM (DType, [Name], [DType], Maybe DType)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; SgM (DType, [Name], [DType], Maybe DType))
-&gt; String -&gt; SgM (DType, [Name], [DType], Maybe DType)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Cannot find type of method &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361758"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-514"></span><span>
</span><span id="line-515"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361696"><span class="annot"><span class="annottext">kind_map :: Map Name DType
</span><a href="#local-6989586621681361696"><span class="hs-identifier hs-var hs-var">kind_map</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Name DType
-&gt; (DType -&gt; Map Name DType) -&gt; Maybe DType -&gt; Map Name DType
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Map Name DType
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType -&gt; Map Name DType
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.singleton</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361758"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681361733"><span class="hs-identifier hs-var">m_res_ki</span></a></span><span>
</span><span id="line-516"></span><span>      </span><span id="local-6989586621681361692"><span class="annot"><span class="annottext">DLetDec
</span><a href="#local-6989586621681361692"><span class="hs-identifier hs-var">meth'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map Name [Name]
-&gt; Map Name [DType]
-&gt; Map Name DType
-&gt; Name
-&gt; LetDecRHS Annotated
-&gt; SgM DLetDec
</span><a href="Data.Singletons.Single.html#singLetDecRHS"><span class="hs-identifier hs-var">singLetDecRHS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; [Name] -&gt; Map Name [Name]
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.singleton</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361758"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361735"><span class="hs-identifier hs-var">tyvar_names</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-517"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; [DType] -&gt; Map Name [DType]
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.singleton</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361758"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361734"><span class="hs-identifier hs-var">ctxt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-518"></span><span>                             </span><span class="annot"><span class="annottext">Map Name DType
</span><a href="#local-6989586621681361696"><span class="hs-identifier hs-var">kind_map</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361758"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">LetDecRHS Annotated
</span><a href="#local-6989586621681361757"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-519"></span><span>      </span><span class="annot"><span class="annottext">[DDec] -&gt; SgM [DDec]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([DDec] -&gt; SgM [DDec]) -&gt; [DDec] -&gt; SgM [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DLetDec -&gt; DDec) -&gt; [DLetDec] -&gt; [DDec]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DLetDec -&gt; DDec
</span><span class="hs-identifier hs-var">DLetDec</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Name -&gt; DType -&gt; DLetDec
</span><span class="hs-identifier hs-var">DSigD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361758"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361736"><span class="hs-identifier hs-var">s_ty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DLetDec
</span><a href="#local-6989586621681361692"><span class="hs-identifier hs-var">meth'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-520"></span><span>
</span><span id="line-521"></span><span id="local-6989586621681362259"><span class="annot"><a href="Data.Singletons.Single.html#singLetDecEnv"><span class="hs-identifier hs-type">singLetDecEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ALetDecEnv"><span class="hs-identifier hs-type">ALetDecEnv</span></a></span><span>
</span><span id="line-522"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681362259"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-523"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DLetDec</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681362259"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-524"></span><span>                 </span><span class="hs-comment">-- Return:</span><span>
</span><span id="line-525"></span><span>                 </span><span class="hs-comment">--</span><span>
</span><span id="line-526"></span><span>                 </span><span class="hs-comment">-- 1. The singled let-decs</span><span>
</span><span id="line-527"></span><span>                 </span><span class="hs-comment">-- 2. SingI instances for any defunctionalization symbols</span><span>
</span><span id="line-528"></span><span>                 </span><span class="hs-comment">--    (see Data.Singletons.Single.Defun)</span><span>
</span><span id="line-529"></span><span>                 </span><span class="hs-comment">-- 3. The result of running the `SgM a` action</span><span>
</span><span id="line-530"></span><span id="singLetDecEnv"><span class="annot"><span class="annottext">singLetDecEnv :: ALetDecEnv -&gt; SgM a -&gt; SgM ([DLetDec], [DDec], a)
</span><a href="Data.Singletons.Single.html#singLetDecEnv"><span class="hs-identifier hs-var hs-var">singLetDecEnv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-type">LetDecEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lde_defns :: forall (ann :: AnnotationFlag).
LetDecEnv ann -&gt; OMap Name (LetDecRHS ann)
</span><a href="Data.Singletons.Syntax.html#lde_defns"><span class="hs-identifier hs-var">lde_defns</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361691"><span class="annot"><span class="annottext">OMap Name (LetDecRHS Annotated)
</span><a href="#local-6989586621681361691"><span class="hs-identifier hs-var">defns</span></a></span></span><span>
</span><span id="line-531"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_types :: forall (ann :: AnnotationFlag). LetDecEnv ann -&gt; OMap Name DType
</span><a href="Data.Singletons.Syntax.html#lde_types"><span class="hs-identifier hs-var">lde_types</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361690"><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681361690"><span class="hs-identifier hs-var">types</span></a></span></span><span>
</span><span id="line-532"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_infix :: forall (ann :: AnnotationFlag). LetDecEnv ann -&gt; OMap Name Fixity
</span><a href="Data.Singletons.Syntax.html#lde_infix"><span class="hs-identifier hs-var">lde_infix</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361689"><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621681361689"><span class="hs-identifier hs-var">infix_decls</span></a></span></span><span>
</span><span id="line-533"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_proms :: forall (ann :: AnnotationFlag).
LetDecEnv ann -&gt; IfAnn ann (OMap Name DType) ()
</span><a href="Data.Singletons.Syntax.html#lde_proms"><span class="hs-identifier hs-var">lde_proms</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361688"><span class="annot"><span class="annottext">IfAnn Annotated (OMap Name DType) ()
</span><a href="#local-6989586621681361688"><span class="hs-identifier hs-var">proms</span></a></span></span><span>
</span><span id="line-534"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_bound_kvs :: forall (ann :: AnnotationFlag).
LetDecEnv ann -&gt; IfAnn ann (OMap Name (OSet Name)) ()
</span><a href="Data.Singletons.Syntax.html#lde_bound_kvs"><span class="hs-identifier hs-var">lde_bound_kvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361687"><span class="annot"><span class="annottext">IfAnn Annotated (OMap Name (OSet Name)) ()
</span><a href="#local-6989586621681361687"><span class="hs-identifier hs-var">bound_kvs</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-535"></span><span>              </span><span id="local-6989586621681361686"><span class="annot"><span class="annottext">thing_inside :: SgM a
</span><a href="#local-6989586621681361686"><span class="hs-identifier hs-var">thing_inside</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-536"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361685"><span class="annot"><span class="annottext">prom_list :: [LetBind]
</span><a href="#local-6989586621681361685"><span class="hs-identifier hs-var hs-var">prom_list</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OMap Name DType -&gt; [LetBind]
forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
IfAnn Annotated (OMap Name DType) ()
</span><a href="#local-6989586621681361688"><span class="hs-identifier hs-var">proms</span></a></span><span>
</span><span id="line-537"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681361684"><span class="annot"><span class="annottext">typeSigs :: [DLetDec]
</span><a href="#local-6989586621681361684"><span class="hs-identifier hs-var">typeSigs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361683"><span class="annot"><span class="annottext">letBinds :: [(Name, DExp)]
</span><a href="#local-6989586621681361683"><span class="hs-identifier hs-var">letBinds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361682"><span class="annot"><span class="annottext">tyvarNames :: [(Name, [Name])]
</span><a href="#local-6989586621681361682"><span class="hs-identifier hs-var">tyvarNames</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361681"><span class="annot"><span class="annottext">cxts :: [(Name, [DType])]
</span><a href="#local-6989586621681361681"><span class="hs-identifier hs-var">cxts</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361680"><span class="annot"><span class="annottext">res_kis :: [Maybe DType]
</span><a href="#local-6989586621681361680"><span class="hs-identifier hs-var">res_kis</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361679"><span class="annot"><span class="annottext">singIDefunss :: [[DDec]]
</span><a href="#local-6989586621681361679"><span class="hs-identifier hs-var">singIDefunss</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-538"></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
  Maybe DType, [DDec])]
-&gt; ([DLetDec], [(Name, DExp)], [(Name, [Name])], [(Name, [DType])],
    [Maybe DType], [[DDec]])
forall a b c d e f.
[(a, b, c, d, e, f)] -&gt; ([a], [b], [c], [d], [e], [f])
</span><span class="hs-identifier hs-var">unzip6</span></span><span> </span><span class="annot"><span class="annottext">([(DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
   Maybe DType, [DDec])]
 -&gt; ([DLetDec], [(Name, DExp)], [(Name, [Name])], [(Name, [DType])],
     [Maybe DType], [[DDec]]))
-&gt; SgM
     [(DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
       Maybe DType, [DDec])]
-&gt; SgM
     ([DLetDec], [(Name, DExp)], [(Name, [Name])], [(Name, [DType])],
      [Maybe DType], [[DDec]])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LetBind
 -&gt; SgM
      (DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
       Maybe DType, [DDec]))
-&gt; [LetBind]
-&gt; SgM
     [(DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
       Maybe DType, [DDec])]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name
 -&gt; DType
 -&gt; SgM
      (DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
       Maybe DType, [DDec]))
-&gt; LetBind
-&gt; SgM
     (DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
      Maybe DType, [DDec])
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OMap Name (LetDecRHS Annotated)
-&gt; OMap Name DType
-&gt; OMap Name (OSet Name)
-&gt; Name
-&gt; DType
-&gt; SgM
     (DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
      Maybe DType, [DDec])
</span><a href="Data.Singletons.Single.html#singTySig"><span class="hs-identifier hs-var">singTySig</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name (LetDecRHS Annotated)
</span><a href="#local-6989586621681361691"><span class="hs-identifier hs-var">defns</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681361690"><span class="hs-identifier hs-var">types</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name (OSet Name)
IfAnn Annotated (OMap Name (OSet Name)) ()
</span><a href="#local-6989586621681361687"><span class="hs-identifier hs-var">bound_kvs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LetBind]
</span><a href="#local-6989586621681361685"><span class="hs-identifier hs-var">prom_list</span></a></span><span>
</span><span id="line-539"></span><span>  </span><span id="local-6989586621681361678"><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361678"><span class="hs-identifier hs-var">infix_decls'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Name, Fixity) -&gt; SgM DLetDec)
-&gt; [(Name, Fixity)] -&gt; SgM [DLetDec]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; Fixity -&gt; SgM DLetDec) -&gt; (Name, Fixity) -&gt; SgM DLetDec
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Fixity -&gt; SgM DLetDec
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; Fixity -&gt; q DLetDec
</span><a href="Data.Singletons.Single.Fixity.html#singInfixDecl"><span class="hs-identifier hs-var">singInfixDecl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Name, Fixity)] -&gt; SgM [DLetDec])
-&gt; [(Name, Fixity)] -&gt; SgM [DLetDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity -&gt; [(Name, Fixity)]
forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621681361689"><span class="hs-identifier hs-var">infix_decls</span></a></span><span>
</span><span id="line-540"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361677"><span class="annot"><span class="annottext">res_ki_map :: Map Name DType
</span><a href="#local-6989586621681361677"><span class="hs-identifier hs-var hs-var">res_ki_map</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LetBind] -&gt; Map Name DType
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361676"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361675"><span class="hs-identifier hs-var">res_ki</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621681361676"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681361676"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681361675"><span class="annot"><span class="annottext">res_ki :: DType
</span><a href="#local-6989586621681361675"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-541"></span><span>                                                     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LetBind] -&gt; [Maybe DType] -&gt; [(LetBind, Maybe DType)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[LetBind]
</span><a href="#local-6989586621681361685"><span class="hs-identifier hs-var">prom_list</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe DType]
</span><a href="#local-6989586621681361680"><span class="hs-identifier hs-var">res_kis</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-542"></span><span>  </span><span class="annot"><span class="annottext">[(Name, DExp)]
-&gt; SgM ([DLetDec], [DDec], a) -&gt; SgM ([DLetDec], [DDec], a)
forall a. [(Name, DExp)] -&gt; SgM a -&gt; SgM a
</span><a href="Data.Singletons.Single.Monad.html#bindLets"><span class="hs-identifier hs-var">bindLets</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, DExp)]
</span><a href="#local-6989586621681361683"><span class="hs-identifier hs-var">letBinds</span></a></span><span> </span><span class="annot"><span class="annottext">(SgM ([DLetDec], [DDec], a) -&gt; SgM ([DLetDec], [DDec], a))
-&gt; SgM ([DLetDec], [DDec], a) -&gt; SgM ([DLetDec], [DDec], a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-543"></span><span>    </span><span id="local-6989586621681361674"><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361674"><span class="hs-identifier hs-var">let_decs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Name, LetDecRHS Annotated) -&gt; SgM DLetDec)
-&gt; [(Name, LetDecRHS Annotated)] -&gt; SgM [DLetDec]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; LetDecRHS Annotated -&gt; SgM DLetDec)
-&gt; (Name, LetDecRHS Annotated) -&gt; SgM DLetDec
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name [Name]
-&gt; Map Name [DType]
-&gt; Map Name DType
-&gt; Name
-&gt; LetDecRHS Annotated
-&gt; SgM DLetDec
</span><a href="Data.Singletons.Single.html#singLetDecRHS"><span class="hs-identifier hs-var">singLetDecRHS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Name, [Name])] -&gt; Map Name [Name]
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, [Name])]
</span><a href="#local-6989586621681361682"><span class="hs-identifier hs-var">tyvarNames</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-544"></span><span>                                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Name, [DType])] -&gt; Map Name [DType]
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, [DType])]
</span><a href="#local-6989586621681361681"><span class="hs-identifier hs-var">cxts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-545"></span><span>                                             </span><span class="annot"><span class="annottext">Map Name DType
</span><a href="#local-6989586621681361677"><span class="hs-identifier hs-var">res_ki_map</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-546"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OMap Name (LetDecRHS Annotated) -&gt; [(Name, LetDecRHS Annotated)]
forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name (LetDecRHS Annotated)
</span><a href="#local-6989586621681361691"><span class="hs-identifier hs-var">defns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-547"></span><span>    </span><span id="local-6989586621681361673"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681361673"><span class="hs-identifier hs-var">thing</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SgM a
</span><a href="#local-6989586621681361686"><span class="hs-identifier hs-var">thing_inside</span></a></span><span>
</span><span id="line-548"></span><span>    </span><span class="annot"><span class="annottext">([DLetDec], [DDec], a) -&gt; SgM ([DLetDec], [DDec], a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361678"><span class="hs-identifier hs-var">infix_decls'</span></a></span><span> </span><span class="annot"><span class="annottext">[DLetDec] -&gt; [DLetDec] -&gt; [DLetDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361684"><span class="hs-identifier hs-var">typeSigs</span></a></span><span> </span><span class="annot"><span class="annottext">[DLetDec] -&gt; [DLetDec] -&gt; [DLetDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361674"><span class="hs-identifier hs-var">let_decs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[[DDec]] -&gt; [DDec]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[DDec]]
</span><a href="#local-6989586621681361679"><span class="hs-identifier hs-var">singIDefunss</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681361673"><span class="hs-identifier hs-var">thing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-549"></span><span>
</span><span id="line-550"></span><span class="annot"><a href="Data.Singletons.Single.html#singTySig"><span class="hs-identifier hs-type">singTySig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ALetDecRHS"><span class="hs-identifier hs-type">ALetDecRHS</span></a></span><span>  </span><span class="hs-comment">-- definitions</span><span>
</span><span id="line-551"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span>       </span><span class="hs-comment">-- type signatures</span><span>
</span><span id="line-552"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">OSet</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- bound kind variables</span><span>
</span><span id="line-553"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span>   </span><span class="hs-comment">-- the type is the promoted type, not the type sig!</span><span>
</span><span id="line-554"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DLetDec</span></span><span>               </span><span class="hs-comment">-- the new type signature</span><span>
</span><span id="line-555"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DExp</span></span><span class="hs-special">)</span><span>          </span><span class="hs-comment">-- the let-bind entry</span><span>
</span><span id="line-556"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- the scoped tyvar names in the tysig</span><span>
</span><span id="line-557"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DCxt</span></span><span class="hs-special">)</span><span>          </span><span class="hs-comment">-- the context of the type signature</span><span>
</span><span id="line-558"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span>           </span><span class="hs-comment">-- the result kind in the tysig</span><span>
</span><span id="line-559"></span><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>                </span><span class="hs-comment">-- SingI instances for defun symbols</span><span>
</span><span id="line-560"></span><span>                 </span><span class="hs-special">)</span><span>
</span><span id="line-561"></span><span id="singTySig"><span class="annot"><span class="annottext">singTySig :: OMap Name (LetDecRHS Annotated)
-&gt; OMap Name DType
-&gt; OMap Name (OSet Name)
-&gt; Name
-&gt; DType
-&gt; SgM
     (DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
      Maybe DType, [DDec])
</span><a href="Data.Singletons.Single.html#singTySig"><span class="hs-identifier hs-var hs-var">singTySig</span></a></span></span><span> </span><span id="local-6989586621681361672"><span class="annot"><span class="annottext">defns :: OMap Name (LetDecRHS Annotated)
</span><a href="#local-6989586621681361672"><span class="hs-identifier hs-var">defns</span></a></span></span><span> </span><span id="local-6989586621681361671"><span class="annot"><span class="annottext">types :: OMap Name DType
</span><a href="#local-6989586621681361671"><span class="hs-identifier hs-var">types</span></a></span></span><span> </span><span id="local-6989586621681361670"><span class="annot"><span class="annottext">bound_kvs :: OMap Name (OSet Name)
</span><a href="#local-6989586621681361670"><span class="hs-identifier hs-var">bound_kvs</span></a></span></span><span> </span><span id="local-6989586621681361669"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681361669"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681361668"><span class="annot"><span class="annottext">prom_ty :: DType
</span><a href="#local-6989586621681361668"><span class="hs-identifier hs-var">prom_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-562"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361667"><span class="annot"><span class="annottext">sName :: Name
</span><a href="#local-6989586621681361667"><span class="hs-identifier hs-var hs-var">sName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361669"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-563"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; OMap Name DType -&gt; Maybe DType
forall k v. Ord k =&gt; k -&gt; OMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361669"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681361671"><span class="hs-identifier hs-var">types</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-564"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-565"></span><span>      </span><span id="local-6989586621681361666"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681361666"><span class="hs-identifier hs-var">num_args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SgM Int
</span><a href="#local-6989586621681361665"><span class="hs-identifier hs-var">guess_num_args</span></a></span><span>
</span><span id="line-566"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621681361664"><span class="annot"><span class="annottext">sty :: DType
</span><a href="#local-6989586621681361664"><span class="hs-identifier hs-var">sty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361663"><span class="annot"><span class="annottext">tyvar_names :: [Name]
</span><a href="#local-6989586621681361663"><span class="hs-identifier hs-var">tyvar_names</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SgM (DType, [Name])
</span><a href="#local-6989586621681361662"><span class="hs-identifier hs-var">mk_sing_ty</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681361666"><span class="hs-identifier hs-var">num_args</span></a></span><span>
</span><span id="line-567"></span><span>      </span><span id="local-6989586621681361661"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361661"><span class="hs-identifier hs-var">singIDefuns</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name
-&gt; NameSpace
-&gt; [DType]
-&gt; [Maybe DType]
-&gt; Maybe DType
-&gt; SgM [DDec]
</span><a href="Data.Singletons.Single.Defun.html#singDefuns"><span class="hs-identifier hs-var">singDefuns</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361669"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">NameSpace
</span><span class="hs-identifier hs-var">VarName</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-568"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; Maybe DType) -&gt; [Name] -&gt; [Maybe DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DType -&gt; Name -&gt; Maybe DType
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Maybe DType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361663"><span class="hs-identifier hs-var">tyvar_names</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe DType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-569"></span><span>      </span><span class="annot"><span class="annottext">(DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
 Maybe DType, [DDec])
-&gt; SgM
     (DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
      Maybe DType, [DDec])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType -&gt; DLetDec
</span><span class="hs-identifier hs-var">DSigD</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361667"><span class="hs-identifier hs-var">sName</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361664"><span class="hs-identifier hs-var">sty</span></a></span><span>
</span><span id="line-570"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361669"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; DType -&gt; DExp -&gt; DExp
</span><a href="Data.Singletons.Single.Monad.html#wrapSingFun"><span class="hs-identifier hs-var">wrapSingFun</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681361666"><span class="hs-identifier hs-var">num_args</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361668"><span class="hs-identifier hs-var">prom_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361667"><span class="hs-identifier hs-var">sName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-571"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361669"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361663"><span class="hs-identifier hs-var">tyvar_names</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-572"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361669"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-573"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe DType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-574"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361661"><span class="hs-identifier hs-var">singIDefuns</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-575"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681361657"><span class="annot"><span class="annottext">ty :: DType
</span><a href="#local-6989586621681361657"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-576"></span><span>      </span><span id="local-6989586621681361656"><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681361656"><span class="hs-identifier hs-var">all_bound_kvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SgM (OSet Name)
</span><a href="#local-6989586621681361655"><span class="hs-identifier hs-var">lookup_bound_kvs</span></a></span><span>
</span><span id="line-577"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621681361654"><span class="annot"><span class="annottext">sty :: DType
</span><a href="#local-6989586621681361654"><span class="hs-identifier hs-var">sty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361653"><span class="annot"><span class="annottext">num_args :: Int
</span><a href="#local-6989586621681361653"><span class="hs-identifier hs-var">num_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361652"><span class="annot"><span class="annottext">tyvar_names :: [Name]
</span><a href="#local-6989586621681361652"><span class="hs-identifier hs-var">tyvar_names</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361651"><span class="annot"><span class="annottext">ctxt :: [DType]
</span><a href="#local-6989586621681361651"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361650"><span class="annot"><span class="annottext">arg_kis :: [DType]
</span><a href="#local-6989586621681361650"><span class="hs-identifier hs-var">arg_kis</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361649"><span class="annot"><span class="annottext">res_ki :: DType
</span><a href="#local-6989586621681361649"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-578"></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OSet Name
-&gt; DType
-&gt; DType
-&gt; SgM (DType, Int, [Name], [DType], [DType], DType)
</span><a href="Data.Singletons.Single.Type.html#singType"><span class="hs-identifier hs-var">singType</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681361656"><span class="hs-identifier hs-var">all_bound_kvs</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361668"><span class="hs-identifier hs-var">prom_ty</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361657"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-579"></span><span>      </span><span id="local-6989586621681361648"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361648"><span class="hs-identifier hs-var">bound_cxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SgM [DType]
</span><a href="Data.Singletons.Single.Monad.html#askContext"><span class="hs-identifier hs-var">askContext</span></a></span><span>
</span><span id="line-580"></span><span>      </span><span id="local-6989586621681361646"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361646"><span class="hs-identifier hs-var">singIDefuns</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name
-&gt; NameSpace
-&gt; [DType]
-&gt; [Maybe DType]
-&gt; Maybe DType
-&gt; SgM [DDec]
</span><a href="Data.Singletons.Single.Defun.html#singDefuns"><span class="hs-identifier hs-var">singDefuns</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361669"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">NameSpace
</span><span class="hs-identifier hs-var">VarName</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361648"><span class="hs-identifier hs-var">bound_cxt</span></a></span><span> </span><span class="annot"><span class="annottext">[DType] -&gt; [DType] -&gt; [DType]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361651"><span class="hs-identifier hs-var">ctxt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-581"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DType -&gt; Maybe DType) -&gt; [DType] -&gt; [Maybe DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361650"><span class="hs-identifier hs-var">arg_kis</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361649"><span class="hs-identifier hs-var">res_ki</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-582"></span><span>      </span><span class="annot"><span class="annottext">(DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
 Maybe DType, [DDec])
-&gt; SgM
     (DLetDec, (Name, DExp), (Name, [Name]), (Name, [DType]),
      Maybe DType, [DDec])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType -&gt; DLetDec
</span><span class="hs-identifier hs-var">DSigD</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361667"><span class="hs-identifier hs-var">sName</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361654"><span class="hs-identifier hs-var">sty</span></a></span><span>
</span><span id="line-583"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361669"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; DType -&gt; DExp -&gt; DExp
</span><a href="Data.Singletons.Single.Monad.html#wrapSingFun"><span class="hs-identifier hs-var">wrapSingFun</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681361653"><span class="hs-identifier hs-var">num_args</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361668"><span class="hs-identifier hs-var">prom_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361667"><span class="hs-identifier hs-var">sName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-584"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361669"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361652"><span class="hs-identifier hs-var">tyvar_names</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-585"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361669"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361651"><span class="hs-identifier hs-var">ctxt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-586"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361649"><span class="hs-identifier hs-var">res_ki</span></a></span><span>
</span><span id="line-587"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361646"><span class="hs-identifier hs-var">singIDefuns</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-588"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-589"></span><span>    </span><span class="annot"><a href="#local-6989586621681361665"><span class="hs-identifier hs-type">guess_num_args</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-590"></span><span>    </span><span id="local-6989586621681361665"><span class="annot"><span class="annottext">guess_num_args :: SgM Int
</span><a href="#local-6989586621681361665"><span class="hs-identifier hs-var hs-var">guess_num_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-591"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name
-&gt; OMap Name (LetDecRHS Annotated) -&gt; Maybe (LetDecRHS Annotated)
forall k v. Ord k =&gt; k -&gt; OMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361669"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name (LetDecRHS Annotated)
</span><a href="#local-6989586621681361672"><span class="hs-identifier hs-var">defns</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-592"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SgM Int
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Internal error: promotion known for something not let-bound.&quot;</span></span><span>
</span><span id="line-593"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#AValue"><span class="hs-identifier hs-type">AValue</span></a></span><span> </span><span class="hs-identifier">_</span><span> </span><span id="local-6989586621681361644"><span class="annot"><a href="#local-6989586621681361644"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SgM Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681361644"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-594"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#AFunction"><span class="hs-identifier hs-type">AFunction</span></a></span><span> </span><span class="hs-identifier">_</span><span> </span><span id="local-6989586621681361642"><span class="annot"><a href="#local-6989586621681361642"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SgM Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681361642"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-595"></span><span>
</span><span id="line-596"></span><span>    </span><span class="annot"><a href="#local-6989586621681361655"><span class="hs-identifier hs-type">lookup_bound_kvs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">OSet</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span>
</span><span id="line-597"></span><span>    </span><span id="local-6989586621681361655"><span class="annot"><span class="annottext">lookup_bound_kvs :: SgM (OSet Name)
</span><a href="#local-6989586621681361655"><span class="hs-identifier hs-var hs-var">lookup_bound_kvs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-598"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; OMap Name (OSet Name) -&gt; Maybe (OSet Name)
forall k v. Ord k =&gt; k -&gt; OMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361669"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name (OSet Name)
</span><a href="#local-6989586621681361670"><span class="hs-identifier hs-var">bound_kvs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-599"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; SgM (OSet Name)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; SgM (OSet Name)) -&gt; String -&gt; SgM (OSet Name)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Internal error: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
</span><span class="hs-identifier hs-var">nameBase</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361669"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot; has no type variable &quot;</span></span><span>
</span><span id="line-600"></span><span>                          </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot;bindings, despite having a type signature&quot;</span></span><span>
</span><span id="line-601"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681361640"><span class="annot"><span class="annottext">kvs :: OSet Name
</span><a href="#local-6989586621681361640"><span class="hs-identifier hs-var">kvs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OSet Name -&gt; SgM (OSet Name)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681361640"><span class="hs-identifier hs-var">kvs</span></a></span><span>
</span><span id="line-602"></span><span>
</span><span id="line-603"></span><span>      </span><span class="hs-comment">-- create a Sing t1 -&gt; Sing t2 -&gt; ... type of a given arity and result type</span><span>
</span><span id="line-604"></span><span>    </span><span class="annot"><a href="#local-6989586621681361662"><span class="hs-identifier hs-type">mk_sing_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-605"></span><span>    </span><span id="local-6989586621681361662"><span class="annot"><span class="annottext">mk_sing_ty :: Int -&gt; SgM (DType, [Name])
</span><a href="#local-6989586621681361662"><span class="hs-identifier hs-var hs-var">mk_sing_ty</span></a></span></span><span> </span><span id="local-6989586621681361639"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621681361639"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-606"></span><span>      </span><span id="local-6989586621681361638"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361638"><span class="hs-identifier hs-var">arg_names</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SgM Name -&gt; SgM [Name]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681361639"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; SgM Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="hs-string">&quot;arg&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-607"></span><span>      </span><span class="annot"><span class="annottext">(DType, [Name]) -&gt; SgM (DType, [Name])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; [DType] -&gt; DType -&gt; DType
</span><span class="hs-identifier hs-var">DForallT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DTyVarBndr) -&gt; [Name] -&gt; [DTyVarBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DTyVarBndr
</span><span class="hs-identifier hs-var">DPlainTV</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361638"><span class="hs-identifier hs-var">arg_names</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-608"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DType] -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Util.html#ravel"><span class="hs-identifier hs-var">ravel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; [DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681361637"><span class="annot"><span class="annottext">nm :: Name
</span><a href="#local-6989586621681361637"><span class="hs-identifier hs-var">nm</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="Data.Singletons.Names.html#singFamily"><span class="hs-identifier hs-var">singFamily</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361637"><span class="hs-identifier hs-var">nm</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361638"><span class="hs-identifier hs-var">arg_names</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-609"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="Data.Singletons.Names.html#singFamily"><span class="hs-identifier hs-var">singFamily</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span>
</span><span id="line-610"></span><span>                                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DType -&gt; DType -&gt; DType) -&gt; DType -&gt; [DType] -&gt; DType
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Names.html#apply"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361668"><span class="hs-identifier hs-var">prom_ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; [DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361638"><span class="hs-identifier hs-var">arg_names</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-611"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361638"><span class="hs-identifier hs-var">arg_names</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-612"></span><span>
</span><span id="line-613"></span><span class="annot"><a href="Data.Singletons.Single.html#singLetDecRHS"><span class="hs-identifier hs-type">singLetDecRHS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span>
</span><span id="line-614"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DCxt</span></span><span>    </span><span class="hs-comment">-- the context of the type signature</span><span>
</span><span id="line-615"></span><span>                                  </span><span class="hs-comment">-- (might not be known)</span><span>
</span><span id="line-616"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span>   </span><span class="hs-comment">-- result kind (might not be known)</span><span>
</span><span id="line-617"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ALetDecRHS"><span class="hs-identifier hs-type">ALetDecRHS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DLetDec</span></span><span>
</span><span id="line-618"></span><span id="singLetDecRHS"><span class="annot"><span class="annottext">singLetDecRHS :: Map Name [Name]
-&gt; Map Name [DType]
-&gt; Map Name DType
-&gt; Name
-&gt; LetDecRHS Annotated
-&gt; SgM DLetDec
</span><a href="Data.Singletons.Single.html#singLetDecRHS"><span class="hs-identifier hs-var hs-var">singLetDecRHS</span></a></span></span><span> </span><span id="local-6989586621681361634"><span class="annot"><span class="annottext">bound_names :: Map Name [Name]
</span><a href="#local-6989586621681361634"><span class="hs-identifier hs-var">bound_names</span></a></span></span><span> </span><span id="local-6989586621681361633"><span class="annot"><span class="annottext">cxts :: Map Name [DType]
</span><a href="#local-6989586621681361633"><span class="hs-identifier hs-var">cxts</span></a></span></span><span> </span><span id="local-6989586621681361632"><span class="annot"><span class="annottext">res_kis :: Map Name DType
</span><a href="#local-6989586621681361632"><span class="hs-identifier hs-var">res_kis</span></a></span></span><span> </span><span id="local-6989586621681361631"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681361631"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681361630"><span class="annot"><span class="annottext">ld_rhs :: LetDecRHS Annotated
</span><a href="#local-6989586621681361630"><span class="hs-identifier hs-var">ld_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-619"></span><span>  </span><span class="annot"><span class="annottext">[DType] -&gt; SgM DLetDec -&gt; SgM DLetDec
forall a. [DType] -&gt; SgM a -&gt; SgM a
</span><a href="Data.Singletons.Single.Monad.html#bindContext"><span class="hs-identifier hs-var">bindContext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DType] -&gt; Name -&gt; Map Name [DType] -&gt; [DType]
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">Map.findWithDefault</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361631"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name [DType]
</span><a href="#local-6989586621681361633"><span class="hs-identifier hs-var">cxts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SgM DLetDec -&gt; SgM DLetDec) -&gt; SgM DLetDec -&gt; SgM DLetDec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-620"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LetDecRHS Annotated
</span><a href="#local-6989586621681361630"><span class="hs-identifier hs-var">ld_rhs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-621"></span><span>      </span><span class="annot"><a href="Data.Singletons.Syntax.html#AValue"><span class="hs-identifier hs-type">AValue</span></a></span><span> </span><span id="local-6989586621681361628"><span class="annot"><a href="#local-6989586621681361628"><span class="hs-identifier hs-var">prom</span></a></span></span><span> </span><span id="local-6989586621681361627"><span class="annot"><a href="#local-6989586621681361627"><span class="hs-identifier hs-var">num_arrows</span></a></span></span><span> </span><span id="local-6989586621681361626"><span class="annot"><a href="#local-6989586621681361626"><span class="hs-identifier hs-var">exp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-622"></span><span>        </span><span class="annot"><span class="annottext">DPat -&gt; DExp -&gt; DLetDec
</span><span class="hs-identifier hs-var">DValD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DPat
</span><span class="hs-identifier hs-var">DVarP</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361631"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; DLetDec) -&gt; SgM DExp -&gt; SgM DLetDec
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span>
</span><span id="line-623"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; DType -&gt; DExp -&gt; DExp
</span><a href="Data.Singletons.Single.Monad.html#wrapUnSingFun"><span class="hs-identifier hs-var">wrapUnSingFun</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681361627"><span class="hs-identifier hs-var">num_arrows</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361628"><span class="hs-identifier hs-var">prom</span></a></span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; DExp) -&gt; SgM DExp -&gt; SgM DExp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ADExp -&gt; Maybe DType -&gt; SgM DExp
</span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681361626"><span class="hs-identifier hs-var">exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Map Name DType -&gt; Maybe DType
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361631"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name DType
</span><a href="#local-6989586621681361632"><span class="hs-identifier hs-var">res_kis</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-624"></span><span>      </span><span class="annot"><a href="Data.Singletons.Syntax.html#AFunction"><span class="hs-identifier hs-type">AFunction</span></a></span><span> </span><span id="local-6989586621681361620"><span class="annot"><a href="#local-6989586621681361620"><span class="hs-identifier hs-var">prom_fun</span></a></span></span><span> </span><span id="local-6989586621681361619"><span class="annot"><a href="#local-6989586621681361619"><span class="hs-identifier hs-var">num_arrows</span></a></span></span><span> </span><span id="local-6989586621681361618"><span class="annot"><a href="#local-6989586621681361618"><span class="hs-identifier hs-var">clauses</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-625"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361617"><span class="annot"><span class="annottext">tyvar_names :: [Name]
</span><a href="#local-6989586621681361617"><span class="hs-identifier hs-var hs-var">tyvar_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Map Name [Name] -&gt; Maybe [Name]
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361631"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name [Name]
</span><a href="#local-6989586621681361634"><span class="hs-identifier hs-var">bound_names</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-626"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-627"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681361616"><span class="annot"><span class="annottext">ns :: [Name]
</span><a href="#local-6989586621681361616"><span class="hs-identifier hs-var">ns</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361616"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-628"></span><span>            </span><span id="local-6989586621681361615"><span class="annot"><span class="annottext">res_ki :: Maybe DType
</span><a href="#local-6989586621681361615"><span class="hs-identifier hs-var hs-var">res_ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Map Name DType -&gt; Maybe DType
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361631"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name DType
</span><a href="#local-6989586621681361632"><span class="hs-identifier hs-var">res_kis</span></a></span><span>
</span><span id="line-629"></span><span>        </span><span class="hs-keyword">in</span><span>
</span><span id="line-630"></span><span>        </span><span class="annot"><span class="annottext">Name -&gt; [DClause] -&gt; DLetDec
</span><span class="hs-identifier hs-var">DFunD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361631"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([DClause] -&gt; DLetDec) -&gt; SgM [DClause] -&gt; SgM DLetDec
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span>
</span><span id="line-631"></span><span>              </span><span class="annot"><span class="annottext">(ADClause -&gt; SgM DClause) -&gt; [ADClause] -&gt; SgM [DClause]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; Int -&gt; [Name] -&gt; Maybe DType -&gt; ADClause -&gt; SgM DClause
</span><a href="Data.Singletons.Single.html#singClause"><span class="hs-identifier hs-var">singClause</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361620"><span class="hs-identifier hs-var">prom_fun</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681361619"><span class="hs-identifier hs-var">num_arrows</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361617"><span class="hs-identifier hs-var">tyvar_names</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681361615"><span class="hs-identifier hs-var">res_ki</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ADClause]
</span><a href="#local-6989586621681361618"><span class="hs-identifier hs-var">clauses</span></a></span><span>
</span><span id="line-632"></span><span>
</span><span id="line-633"></span><span class="annot"><a href="Data.Singletons.Single.html#singClause"><span class="hs-identifier hs-type">singClause</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span>   </span><span class="hs-comment">-- the promoted function</span><span>
</span><span id="line-634"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>     </span><span class="hs-comment">-- the number of arrows in the type. If this is more</span><span>
</span><span id="line-635"></span><span>                      </span><span class="hs-comment">-- than the number of patterns, we need to eta-expand</span><span>
</span><span id="line-636"></span><span>                      </span><span class="hs-comment">-- with unSingFun.</span><span>
</span><span id="line-637"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- the names of the forall'd vars in the type sig of this</span><span>
</span><span id="line-638"></span><span>                      </span><span class="hs-comment">-- function. This list should have at least the length as the</span><span>
</span><span id="line-639"></span><span>                      </span><span class="hs-comment">-- number of patterns in the clause</span><span>
</span><span id="line-640"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span>   </span><span class="hs-comment">-- result kind, if known</span><span>
</span><span id="line-641"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ADClause"><span class="hs-identifier hs-type">ADClause</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DClause</span></span><span>
</span><span id="line-642"></span><span id="singClause"><span class="annot"><span class="annottext">singClause :: DType -&gt; Int -&gt; [Name] -&gt; Maybe DType -&gt; ADClause -&gt; SgM DClause
</span><a href="Data.Singletons.Single.html#singClause"><span class="hs-identifier hs-var hs-var">singClause</span></a></span></span><span> </span><span id="local-6989586621681361613"><span class="annot"><span class="annottext">prom_fun :: DType
</span><a href="#local-6989586621681361613"><span class="hs-identifier hs-var">prom_fun</span></a></span></span><span> </span><span id="local-6989586621681361612"><span class="annot"><span class="annottext">num_arrows :: Int
</span><a href="#local-6989586621681361612"><span class="hs-identifier hs-var">num_arrows</span></a></span></span><span> </span><span id="local-6989586621681361611"><span class="annot"><span class="annottext">bound_names :: [Name]
</span><a href="#local-6989586621681361611"><span class="hs-identifier hs-var">bound_names</span></a></span></span><span> </span><span id="local-6989586621681361610"><span class="annot"><span class="annottext">res_ki :: Maybe DType
</span><a href="#local-6989586621681361610"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span>
</span><span id="line-643"></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADClause"><span class="hs-identifier hs-type">ADClause</span></a></span><span> </span><span id="local-6989586621681361608"><span class="annot"><span class="annottext">var_proms :: VarPromotions
</span><a href="#local-6989586621681361608"><span class="hs-identifier hs-var">var_proms</span></a></span></span><span> </span><span id="local-6989586621681361607"><span class="annot"><span class="annottext">pats :: [ADPat]
</span><a href="#local-6989586621681361607"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span id="local-6989586621681361606"><span class="annot"><span class="annottext">exp :: ADExp
</span><a href="#local-6989586621681361606"><span class="hs-identifier hs-var">exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-644"></span><span>
</span><span id="line-645"></span><span>  </span><span class="hs-comment">-- Fix #166:</span><span>
</span><span id="line-646"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; SgM () -&gt; SgM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681361612"><span class="hs-identifier hs-var">num_arrows</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[ADPat] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[ADPat]
</span><a href="#local-6989586621681361607"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SgM () -&gt; SgM ()) -&gt; SgM () -&gt; SgM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-647"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; SgM ()
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; SgM ()) -&gt; String -&gt; SgM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Function being promoted to &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; String
forall a. Ppr a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">pprint</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; Type
</span><span class="hs-identifier hs-var">typeToTH</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361613"><span class="hs-identifier hs-var">prom_fun</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-648"></span><span>           </span><span class="annot"><span class="hs-string">&quot; has too many arguments.&quot;</span></span><span>
</span><span id="line-649"></span><span>
</span><span id="line-650"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681361601"><span class="annot"><span class="annottext">sPats :: [DPat]
</span><a href="#local-6989586621681361601"><span class="hs-identifier hs-var">sPats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361600"><span class="annot"><span class="annottext">sigPaExpsSigs :: SingDSigPaInfos
</span><a href="#local-6989586621681361600"><span class="hs-identifier hs-var">sigPaExpsSigs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">QWithAux SingDSigPaInfos SgM [DPat]
-&gt; SgM ([DPat], SingDSigPaInfos)
forall m (q :: * -&gt; *) a. QWithAux m q a -&gt; q (a, m)
</span><a href="Data.Singletons.Util.html#evalForPair"><span class="hs-identifier hs-var">evalForPair</span></a></span><span> </span><span class="annot"><span class="annottext">(QWithAux SingDSigPaInfos SgM [DPat]
 -&gt; SgM ([DPat], SingDSigPaInfos))
-&gt; QWithAux SingDSigPaInfos SgM [DPat]
-&gt; SgM ([DPat], SingDSigPaInfos)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ADPat -&gt; QWithAux SingDSigPaInfos SgM DPat)
-&gt; [ADPat] -&gt; QWithAux SingDSigPaInfos SgM [DPat]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name Name -&gt; ADPat -&gt; QWithAux SingDSigPaInfos SgM DPat
</span><a href="Data.Singletons.Single.html#singPat"><span class="hs-identifier hs-var">singPat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarPromotions -&gt; Map Name Name
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">VarPromotions
</span><a href="#local-6989586621681361608"><span class="hs-identifier hs-var">var_proms</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ADPat]
</span><a href="#local-6989586621681361607"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-651"></span><span>  </span><span id="local-6989586621681361597"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361597"><span class="hs-identifier hs-var">sBody</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ADExp -&gt; Maybe DType -&gt; SgM DExp
</span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681361606"><span class="hs-identifier hs-var">exp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681361610"><span class="hs-identifier hs-var">res_ki</span></a></span><span>
</span><span id="line-652"></span><span>    </span><span class="hs-comment">-- when calling unSingFun, the promoted pats aren't in scope, so we use the</span><span>
</span><span id="line-653"></span><span>    </span><span class="hs-comment">-- bound_names instead</span><span>
</span><span id="line-654"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361596"><span class="annot"><span class="annottext">pattern_bound_names :: [Name]
</span><a href="#local-6989586621681361596"><span class="hs-identifier hs-var hs-var">pattern_bound_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; ADPat -&gt; Name) -&gt; [Name] -&gt; [ADPat] -&gt; [Name]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; ADPat -&gt; Name
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361611"><span class="hs-identifier hs-var">bound_names</span></a></span><span> </span><span class="annot"><span class="annottext">[ADPat]
</span><a href="#local-6989586621681361607"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-655"></span><span>       </span><span class="hs-comment">-- this does eta-expansion. See comment at top of file.</span><span>
</span><span id="line-656"></span><span>      </span><span id="local-6989586621681361594"><span class="annot"><span class="annottext">sBody' :: DExp
</span><a href="#local-6989586621681361594"><span class="hs-identifier hs-var hs-var">sBody'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; DType -&gt; DExp -&gt; DExp
</span><a href="Data.Singletons.Single.Monad.html#wrapUnSingFun"><span class="hs-identifier hs-var">wrapUnSingFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681361612"><span class="hs-identifier hs-var">num_arrows</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[ADPat] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[ADPat]
</span><a href="#local-6989586621681361607"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-657"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DType -&gt; DType -&gt; DType) -&gt; DType -&gt; [DType] -&gt; DType
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Names.html#apply"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361613"><span class="hs-identifier hs-var">prom_fun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; [DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361596"><span class="hs-identifier hs-var">pattern_bound_names</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361597"><span class="hs-identifier hs-var">sBody</span></a></span><span>
</span><span id="line-658"></span><span>  </span><span class="annot"><span class="annottext">DClause -&gt; SgM DClause
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DClause -&gt; SgM DClause) -&gt; DClause -&gt; SgM DClause
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DPat] -&gt; DExp -&gt; DClause
</span><span class="hs-identifier hs-var">DClause</span></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621681361601"><span class="hs-identifier hs-var">sPats</span></a></span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; DClause) -&gt; DExp -&gt; DClause
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SingDSigPaInfos -&gt; DExp -&gt; DExp
</span><a href="Data.Singletons.Single.html#mkSigPaCaseE"><span class="hs-identifier hs-var">mkSigPaCaseE</span></a></span><span> </span><span class="annot"><span class="annottext">SingDSigPaInfos
</span><a href="#local-6989586621681361600"><span class="hs-identifier hs-var">sigPaExpsSigs</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361594"><span class="hs-identifier hs-var">sBody'</span></a></span><span>
</span><span id="line-659"></span><span>
</span><span id="line-660"></span><span class="annot"><a href="Data.Singletons.Single.html#singPat"><span class="hs-identifier hs-type">singPat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span>   </span><span class="hs-comment">-- from term-level names to type-level names</span><span>
</span><span id="line-661"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ADPat"><span class="hs-identifier hs-type">ADPat</span></a></span><span>
</span><span id="line-662"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Util.html#QWithAux"><span class="hs-identifier hs-type">QWithAux</span></a></span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#SingDSigPaInfos"><span class="hs-identifier hs-type">SingDSigPaInfos</span></a></span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DPat</span></span><span>
</span><span id="line-663"></span><span id="singPat"><span class="annot"><span class="annottext">singPat :: Map Name Name -&gt; ADPat -&gt; QWithAux SingDSigPaInfos SgM DPat
</span><a href="Data.Singletons.Single.html#singPat"><span class="hs-identifier hs-var hs-var">singPat</span></a></span></span><span> </span><span id="local-6989586621681361592"><span class="annot"><span class="annottext">var_proms :: Map Name Name
</span><a href="#local-6989586621681361592"><span class="hs-identifier hs-var">var_proms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ADPat -&gt; QWithAux SingDSigPaInfos SgM DPat
</span><a href="#local-6989586621681361591"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-664"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-665"></span><span>    </span><span class="annot"><a href="#local-6989586621681361591"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ADPat"><span class="hs-identifier hs-type">ADPat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Util.html#QWithAux"><span class="hs-identifier hs-type">QWithAux</span></a></span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#SingDSigPaInfos"><span class="hs-identifier hs-type">SingDSigPaInfos</span></a></span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DPat</span></span><span>
</span><span id="line-666"></span><span>    </span><span id="local-6989586621681361591"><span class="annot"><span class="annottext">go :: ADPat -&gt; QWithAux SingDSigPaInfos SgM DPat
</span><a href="#local-6989586621681361591"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADLitP"><span class="hs-identifier hs-type">ADLitP</span></a></span><span> </span><span id="local-6989586621681361589"><span class="annot"><span class="annottext">_lit :: Lit
</span><a href="#local-6989586621681361589"><span class="hs-identifier hs-var">_lit</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-667"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; QWithAux SingDSigPaInfos SgM DPat
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Singling of literal patterns not yet supported&quot;</span></span><span>
</span><span id="line-668"></span><span>    </span><span class="annot"><a href="#local-6989586621681361591"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADVarP"><span class="hs-identifier hs-type">ADVarP</span></a></span><span> </span><span id="local-6989586621681361587"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681361587"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-669"></span><span>      </span><span id="local-6989586621681361586"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361586"><span class="hs-identifier hs-var">tyname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Map Name Name -&gt; Maybe Name
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361587"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name Name
</span><a href="#local-6989586621681361592"><span class="hs-identifier hs-var">var_proms</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-670"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-671"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; QWithAux SingDSigPaInfos SgM Name
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Internal error: unknown variable when singling pattern&quot;</span></span><span>
</span><span id="line-672"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681361585"><span class="annot"><span class="annottext">tyname :: Name
</span><a href="#local-6989586621681361585"><span class="hs-identifier hs-var">tyname</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; QWithAux SingDSigPaInfos SgM Name
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361585"><span class="hs-identifier hs-var">tyname</span></a></span><span>
</span><span id="line-673"></span><span>      </span><span class="annot"><span class="annottext">DPat -&gt; QWithAux SingDSigPaInfos SgM DPat
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DPat -&gt; QWithAux SingDSigPaInfos SgM DPat)
-&gt; DPat -&gt; QWithAux SingDSigPaInfos SgM DPat
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DPat
</span><span class="hs-identifier hs-var">DVarP</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361587"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DPat -&gt; DType -&gt; DPat
</span><span class="hs-operator hs-var">`DSigP`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="Data.Singletons.Names.html#singFamily"><span class="hs-identifier hs-var">singFamily</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361586"><span class="hs-identifier hs-var">tyname</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-674"></span><span>    </span><span class="annot"><a href="#local-6989586621681361591"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADConP"><span class="hs-identifier hs-type">ADConP</span></a></span><span> </span><span id="local-6989586621681361582"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681361582"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681361581"><span class="annot"><span class="annottext">pats :: [ADPat]
</span><a href="#local-6989586621681361581"><span class="hs-identifier hs-var">pats</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [DPat] -&gt; DPat
</span><span class="hs-identifier hs-var">DConP</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#singDataConName"><span class="hs-identifier hs-var">singDataConName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361582"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([DPat] -&gt; DPat)
-&gt; QWithAux SingDSigPaInfos SgM [DPat]
-&gt; QWithAux SingDSigPaInfos SgM DPat
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(ADPat -&gt; QWithAux SingDSigPaInfos SgM DPat)
-&gt; [ADPat] -&gt; QWithAux SingDSigPaInfos SgM [DPat]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">ADPat -&gt; QWithAux SingDSigPaInfos SgM DPat
</span><a href="#local-6989586621681361591"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[ADPat]
</span><a href="#local-6989586621681361581"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-675"></span><span>    </span><span class="annot"><a href="#local-6989586621681361591"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADTildeP"><span class="hs-identifier hs-type">ADTildeP</span></a></span><span> </span><span id="local-6989586621681361578"><span class="annot"><span class="annottext">pat :: ADPat
</span><a href="#local-6989586621681361578"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-676"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; QWithAux SingDSigPaInfos SgM ()
forall (q :: * -&gt; *). Quasi q =&gt; String -&gt; q ()
</span><a href="Data.Singletons.Util.html#qReportWarning"><span class="hs-identifier hs-var">qReportWarning</span></a></span><span>
</span><span id="line-677"></span><span>        </span><span class="annot"><span class="hs-string">&quot;Lazy pattern converted into regular pattern during singleton generation.&quot;</span></span><span>
</span><span id="line-678"></span><span>      </span><span class="annot"><span class="annottext">ADPat -&gt; QWithAux SingDSigPaInfos SgM DPat
</span><a href="#local-6989586621681361591"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">ADPat
</span><a href="#local-6989586621681361578"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-679"></span><span>    </span><span class="annot"><a href="#local-6989586621681361591"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADBangP"><span class="hs-identifier hs-type">ADBangP</span></a></span><span> </span><span id="local-6989586621681361575"><span class="annot"><span class="annottext">pat :: ADPat
</span><a href="#local-6989586621681361575"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DPat -&gt; DPat
</span><span class="hs-identifier hs-var">DBangP</span></span><span> </span><span class="annot"><span class="annottext">(DPat -&gt; DPat)
-&gt; QWithAux SingDSigPaInfos SgM DPat
-&gt; QWithAux SingDSigPaInfos SgM DPat
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ADPat -&gt; QWithAux SingDSigPaInfos SgM DPat
</span><a href="#local-6989586621681361591"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">ADPat
</span><a href="#local-6989586621681361575"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-680"></span><span>    </span><span class="annot"><a href="#local-6989586621681361591"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADSigP"><span class="hs-identifier hs-type">ADSigP</span></a></span><span> </span><span id="local-6989586621681361572"><span class="annot"><span class="annottext">prom_pat :: DType
</span><a href="#local-6989586621681361572"><span class="hs-identifier hs-var">prom_pat</span></a></span></span><span> </span><span id="local-6989586621681361571"><span class="annot"><span class="annottext">pat :: ADPat
</span><a href="#local-6989586621681361571"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621681361570"><span class="annot"><span class="annottext">ty :: DType
</span><a href="#local-6989586621681361570"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-681"></span><span>      </span><span id="local-6989586621681361569"><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621681361569"><span class="hs-identifier hs-var">pat'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ADPat -&gt; QWithAux SingDSigPaInfos SgM DPat
</span><a href="#local-6989586621681361591"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">ADPat
</span><a href="#local-6989586621681361571"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-682"></span><span>      </span><span class="hs-comment">-- Normally, calling dPatToDExp would be dangerous, since it fails if the</span><span>
</span><span id="line-683"></span><span>      </span><span class="hs-comment">-- supplied pattern contains any wildcard patterns. However, promotePat</span><span>
</span><span id="line-684"></span><span>      </span><span class="hs-comment">-- (which produced the pattern we're passing into dPatToDExp) maintains</span><span>
</span><span id="line-685"></span><span>      </span><span class="hs-comment">-- an invariant that any promoted pattern signatures will be free of</span><span>
</span><span id="line-686"></span><span>      </span><span class="hs-comment">-- wildcard patterns in the underlying pattern.</span><span>
</span><span id="line-687"></span><span>      </span><span class="hs-comment">-- See Note [Singling pattern signatures].</span><span>
</span><span id="line-688"></span><span>      </span><span class="annot"><span class="annottext">(DExp, DType) -&gt; QWithAux SingDSigPaInfos SgM ()
forall (q :: * -&gt; *) elt. Quasi q =&gt; elt -&gt; QWithAux [elt] q ()
</span><a href="Data.Singletons.Util.html#addElement"><span class="hs-identifier hs-var">addElement</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DPat -&gt; DExp
</span><span class="hs-identifier hs-var">dPatToDExp</span></span><span> </span><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621681361569"><span class="hs-identifier hs-var">pat'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-identifier hs-var">DSigT</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361572"><span class="hs-identifier hs-var">prom_pat</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361570"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-689"></span><span>      </span><span class="annot"><span class="annottext">DPat -&gt; QWithAux SingDSigPaInfos SgM DPat
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621681361569"><span class="hs-identifier hs-var">pat'</span></a></span><span>
</span><span id="line-690"></span><span>    </span><span class="annot"><a href="#local-6989586621681361591"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ADWildP"><span class="hs-identifier hs-type">ADWildP</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DPat -&gt; QWithAux SingDSigPaInfos SgM DPat
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">DPat
</span><span class="hs-identifier hs-var">DWildP</span></span><span>
</span><span id="line-691"></span><span>
</span><span id="line-692"></span><span class="hs-comment">-- | If given a non-empty list of 'SingDSigPaInfos', construct a case expression</span><span>
</span><span id="line-693"></span><span class="hs-comment">-- that brings singleton equality constraints into scope via pattern-matching.</span><span>
</span><span id="line-694"></span><span class="hs-comment">-- See @Note [Singling pattern signatures]@.</span><span>
</span><span id="line-695"></span><span class="annot"><a href="Data.Singletons.Single.html#mkSigPaCaseE"><span class="hs-identifier hs-type">mkSigPaCaseE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#SingDSigPaInfos"><span class="hs-identifier hs-type">SingDSigPaInfos</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DExp</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DExp</span></span><span>
</span><span id="line-696"></span><span id="mkSigPaCaseE"><span class="annot"><span class="annottext">mkSigPaCaseE :: SingDSigPaInfos -&gt; DExp -&gt; DExp
</span><a href="Data.Singletons.Single.html#mkSigPaCaseE"><span class="hs-identifier hs-var hs-var">mkSigPaCaseE</span></a></span></span><span> </span><span id="local-6989586621681361564"><span class="annot"><span class="annottext">exps_with_sigs :: SingDSigPaInfos
</span><a href="#local-6989586621681361564"><span class="hs-identifier hs-var">exps_with_sigs</span></a></span></span><span> </span><span id="local-6989586621681361563"><span class="annot"><span class="annottext">exp :: DExp
</span><a href="#local-6989586621681361563"><span class="hs-identifier hs-var">exp</span></a></span></span><span>
</span><span id="line-697"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SingDSigPaInfos -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">SingDSigPaInfos
</span><a href="#local-6989586621681361564"><span class="hs-identifier hs-var">exps_with_sigs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361563"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-698"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-699"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681361561"><span class="annot"><span class="annottext">exps :: [DExp]
</span><a href="#local-6989586621681361561"><span class="hs-identifier hs-var">exps</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361560"><span class="annot"><span class="annottext">sigs :: [DType]
</span><a href="#local-6989586621681361560"><span class="hs-identifier hs-var">sigs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SingDSigPaInfos -&gt; ([DExp], [DType])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">SingDSigPaInfos
</span><a href="#local-6989586621681361564"><span class="hs-identifier hs-var">exps_with_sigs</span></a></span><span>
</span><span id="line-700"></span><span>          </span><span id="local-6989586621681361558"><span class="annot"><span class="annottext">scrutinee :: DExp
</span><a href="#local-6989586621681361558"><span class="hs-identifier hs-var hs-var">scrutinee</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DExp] -&gt; DExp
</span><span class="hs-identifier hs-var">mkTupleDExp</span></span><span> </span><span class="annot"><span class="annottext">[DExp]
</span><a href="#local-6989586621681361561"><span class="hs-identifier hs-var">exps</span></a></span><span>
</span><span id="line-701"></span><span>          </span><span id="local-6989586621681361556"><span class="annot"><span class="annottext">pats :: [DPat]
</span><a href="#local-6989586621681361556"><span class="hs-identifier hs-var hs-var">pats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; DPat) -&gt; [DType] -&gt; [DPat]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DPat -&gt; DType -&gt; DPat
</span><span class="hs-identifier hs-var">DSigP</span></span><span> </span><span class="annot"><span class="annottext">DPat
</span><span class="hs-identifier hs-var">DWildP</span></span><span> </span><span class="annot"><span class="annottext">(DType -&gt; DPat) -&gt; (DType -&gt; DType) -&gt; DType -&gt; DPat
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-identifier hs-var">DAppT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#singFamilyName"><span class="hs-identifier hs-var">singFamilyName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361560"><span class="hs-identifier hs-var">sigs</span></a></span><span>
</span><span id="line-702"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; [DMatch] -&gt; DExp
</span><span class="hs-identifier hs-var">DCaseE</span></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361558"><span class="hs-identifier hs-var">scrutinee</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DPat -&gt; DExp -&gt; DMatch
</span><span class="hs-identifier hs-var">DMatch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DPat] -&gt; DPat
</span><span class="hs-identifier hs-var">mkTupleDPat</span></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621681361556"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361563"><span class="hs-identifier hs-var">exp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-703"></span><span>
</span><span id="line-704"></span><span class="hs-comment">-- Note [Annotate case return type]</span><span>
</span><span id="line-705"></span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-706"></span><span class="hs-comment">--</span><span>
</span><span id="line-707"></span><span class="hs-comment">-- We're straining GHC's type inference here. One particular trouble area</span><span>
</span><span id="line-708"></span><span class="hs-comment">-- is determining the return type of a GADT pattern match. In general, GHC</span><span>
</span><span id="line-709"></span><span class="hs-comment">-- cannot infer return types of GADT pattern matches because the return type</span><span>
</span><span id="line-710"></span><span class="hs-comment">-- becomes &quot;untouchable&quot; in the case matches. See the OutsideIn paper. But,</span><span>
</span><span id="line-711"></span><span class="hs-comment">-- during singletonization, we *know* the return type. So, just add a type</span><span>
</span><span id="line-712"></span><span class="hs-comment">-- annotation. See #54.</span><span>
</span><span id="line-713"></span><span class="hs-comment">--</span><span>
</span><span id="line-714"></span><span class="hs-comment">-- In particular, we add a type annotation in a somewhat unorthodox fashion.</span><span>
</span><span id="line-715"></span><span class="hs-comment">-- Instead of the usual `(x :: t)`, we use `id @t x`. See</span><span>
</span><span id="line-716"></span><span class="hs-comment">-- Note [The id hack; or, how singletons learned to stop worrying and avoid</span><span>
</span><span id="line-717"></span><span class="hs-comment">-- kind generalization] for an explanation of why we do this.</span><span>
</span><span id="line-718"></span><span>
</span><span id="line-719"></span><span class="hs-comment">-- Note [Why error is so special]</span><span>
</span><span id="line-720"></span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-721"></span><span class="hs-comment">-- Some of the transformations that happen before this point produce impossible</span><span>
</span><span id="line-722"></span><span class="hs-comment">-- case matches. We must be careful when processing these so as not to make</span><span>
</span><span id="line-723"></span><span class="hs-comment">-- an error GHC will complain about. When binding the case-match variables, we</span><span>
</span><span id="line-724"></span><span class="hs-comment">-- normally include an equality constraint saying that the scrutinee is equal</span><span>
</span><span id="line-725"></span><span class="hs-comment">-- to the matched pattern. But, we can't do this in inaccessible matches, because</span><span>
</span><span id="line-726"></span><span class="hs-comment">-- equality is bogus, and GHC (rightly) complains. However, we then have another</span><span>
</span><span id="line-727"></span><span class="hs-comment">-- problem, because GHC doesn't have enough information when type-checking the</span><span>
</span><span id="line-728"></span><span class="hs-comment">-- RHS of the inaccessible match to deem it type-safe. The solution: treat error</span><span>
</span><span id="line-729"></span><span class="hs-comment">-- as super-special, so that GHC doesn't look too hard at singletonized error</span><span>
</span><span id="line-730"></span><span class="hs-comment">-- calls. Specifically, DON'T do the applySing stuff. Just use sError, which</span><span>
</span><span id="line-731"></span><span class="hs-comment">-- has a custom type (Sing x -&gt; a) anyway.</span><span>
</span><span id="line-732"></span><span>
</span><span id="line-733"></span><span class="hs-comment">-- Note [Singling pattern signatures]</span><span>
</span><span id="line-734"></span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-735"></span><span class="hs-comment">-- We want to single a pattern signature, like so:</span><span>
</span><span id="line-736"></span><span class="hs-comment">--</span><span>
</span><span id="line-737"></span><span class="hs-comment">--   f :: Maybe a -&gt; a</span><span>
</span><span id="line-738"></span><span class="hs-comment">--   f (Just x :: Maybe a) = x</span><span>
</span><span id="line-739"></span><span class="hs-comment">--</span><span>
</span><span id="line-740"></span><span class="hs-comment">-- Na&#239;vely, one might expect this to single straightfowardly as:</span><span>
</span><span id="line-741"></span><span class="hs-comment">--</span><span>
</span><span id="line-742"></span><span class="hs-comment">--   sF :: forall (z :: Maybe a). Sing z -&gt; Sing (F z)</span><span>
</span><span id="line-743"></span><span class="hs-comment">--   sF (SJust sX :: Sing (Just x :: Maybe a)) = sX</span><span>
</span><span id="line-744"></span><span class="hs-comment">--</span><span>
</span><span id="line-745"></span><span class="hs-comment">-- But the way GHC typechecks patterns prevents this from working, as GHC won't</span><span>
</span><span id="line-746"></span><span class="hs-comment">-- know that the type `z` is actually `Just x` until /after/ the entirety of</span><span>
</span><span id="line-747"></span><span class="hs-comment">-- the `SJust sX` pattern has been typechecked. (See Trac #12018 for an</span><span>
</span><span id="line-748"></span><span class="hs-comment">-- extended discussion on this topic.)</span><span>
</span><span id="line-749"></span><span class="hs-comment">--</span><span>
</span><span id="line-750"></span><span class="hs-comment">-- To work around this design, we resort to a somewhat unsightly trick:</span><span>
</span><span id="line-751"></span><span class="hs-comment">-- immediately after matching on all the patterns, we perform a case on every</span><span>
</span><span id="line-752"></span><span class="hs-comment">-- pattern with a pattern signature, like so:</span><span>
</span><span id="line-753"></span><span class="hs-comment">--</span><span>
</span><span id="line-754"></span><span class="hs-comment">--   sF :: forall (z :: Maybe a). Sing z -&gt; Sing (F z)</span><span>
</span><span id="line-755"></span><span class="hs-comment">--   sF (SJust sX :: Sing z)</span><span>
</span><span id="line-756"></span><span class="hs-comment">--     = case (SJust sX :: Sing z) of</span><span>
</span><span id="line-757"></span><span class="hs-comment">--         (_ :: Sing (Just x :: Maybe a)) -&gt; sX</span><span>
</span><span id="line-758"></span><span class="hs-comment">--</span><span>
</span><span id="line-759"></span><span class="hs-comment">-- Now GHC accepts the fact that `z` is `Just x`, and all is well. In order</span><span>
</span><span id="line-760"></span><span class="hs-comment">-- to support this construction, the type of singPat is augmented with some</span><span>
</span><span id="line-761"></span><span class="hs-comment">-- extra information in the form of SingDSigPaInfos:</span><span>
</span><span id="line-762"></span><span class="hs-comment">--</span><span>
</span><span id="line-763"></span><span class="hs-comment">--   type SingDSigPaInfos = [(DExp, DType)]</span><span>
</span><span id="line-764"></span><span class="hs-comment">--</span><span>
</span><span id="line-765"></span><span class="hs-comment">-- Where the DExps corresponds to the expressions we case on just after the</span><span>
</span><span id="line-766"></span><span class="hs-comment">-- patterns (`SJust sX :: Sing x`, in the example above), and the DTypes</span><span>
</span><span id="line-767"></span><span class="hs-comment">-- correspond to the singled pattern signatures to use in the case alternative</span><span>
</span><span id="line-768"></span><span class="hs-comment">-- (`Sing (Just x :: Maybe a)` in the example above). singPat appends to the</span><span>
</span><span id="line-769"></span><span class="hs-comment">-- list of SingDSigPaInfos whenever it processes a DSigPa (pattern signature),</span><span>
</span><span id="line-770"></span><span class="hs-comment">-- and call sites can pass these SingDSigPaInfos to mkSigPaCaseE to construct a</span><span>
</span><span id="line-771"></span><span class="hs-comment">-- case expression like the one featured above.</span><span>
</span><span id="line-772"></span><span class="hs-comment">--</span><span>
</span><span id="line-773"></span><span class="hs-comment">-- Some interesting consequences of this design:</span><span>
</span><span id="line-774"></span><span class="hs-comment">--</span><span>
</span><span id="line-775"></span><span class="hs-comment">-- 1. We must promote DPats to ADPats, a variation of DPat where the annotated</span><span>
</span><span id="line-776"></span><span class="hs-comment">--    DSigPa counterpart, ADSigPa, stores the type that the original DPat was</span><span>
</span><span id="line-777"></span><span class="hs-comment">--    promoted to. This is necessary since promoting the type might have</span><span>
</span><span id="line-778"></span><span class="hs-comment">--    generated fresh variable names, so we need to be able to use the same</span><span>
</span><span id="line-779"></span><span class="hs-comment">--    names when singling.</span><span>
</span><span id="line-780"></span><span class="hs-comment">--</span><span>
</span><span id="line-781"></span><span class="hs-comment">-- 2. Also when promoting a DSigPa to an ADSigPa, we remove any wildcards from</span><span>
</span><span id="line-782"></span><span class="hs-comment">--    the underlying pattern. To see why this is necessary, consider singling</span><span>
</span><span id="line-783"></span><span class="hs-comment">--    this example:</span><span>
</span><span id="line-784"></span><span class="hs-comment">--</span><span>
</span><span id="line-785"></span><span class="hs-comment">--      g (Just _ :: Maybe a) = &quot;hi&quot;</span><span>
</span><span id="line-786"></span><span class="hs-comment">--</span><span>
</span><span id="line-787"></span><span class="hs-comment">--    This must single to something like this:</span><span>
</span><span id="line-788"></span><span class="hs-comment">--</span><span>
</span><span id="line-789"></span><span class="hs-comment">--      sG (SJust _ :: Sing z)</span><span>
</span><span id="line-790"></span><span class="hs-comment">--        = case (SJust _ :: Sing z) of</span><span>
</span><span id="line-791"></span><span class="hs-comment">--            (_ :: Sing (Just _ :: Maybe a)) -&gt; &quot;hi&quot;</span><span>
</span><span id="line-792"></span><span class="hs-comment">--</span><span>
</span><span id="line-793"></span><span class="hs-comment">--    But `SJust _` is not a valid expression, and since the minimal th-desugar</span><span>
</span><span id="line-794"></span><span class="hs-comment">--    AST lacks as-patterns, we can't replace it with something like</span><span>
</span><span id="line-795"></span><span class="hs-comment">--    `sG x@(SJust _ :: Sing z) = case x of ...`. But even if the th-desugar</span><span>
</span><span id="line-796"></span><span class="hs-comment">--    AST /did/ have as-patterns, we'd still be in trouble, as `Just _` isn't</span><span>
</span><span id="line-797"></span><span class="hs-comment">--    a valid type without the use of -XPartialTypeSignatures, which isn't a</span><span>
</span><span id="line-798"></span><span class="hs-comment">--    design we want to force upon others.</span><span>
</span><span id="line-799"></span><span class="hs-comment">--</span><span>
</span><span id="line-800"></span><span class="hs-comment">--    We work around both issues by simply converting all wildcard patterns</span><span>
</span><span id="line-801"></span><span class="hs-comment">--    from the pattern that has a signature. That means our example becomes:</span><span>
</span><span id="line-802"></span><span class="hs-comment">--</span><span>
</span><span id="line-803"></span><span class="hs-comment">--      sG (SJust sWild :: Sing z)</span><span>
</span><span id="line-804"></span><span class="hs-comment">--        = case (SJust sWild :: Sing z) of</span><span>
</span><span id="line-805"></span><span class="hs-comment">--            (_ :: Sing (Just wild :: Maybe a)) -&gt; &quot;hi&quot;</span><span>
</span><span id="line-806"></span><span class="hs-comment">--</span><span>
</span><span id="line-807"></span><span class="hs-comment">--    And now everything is hunky-dory.</span><span>
</span><span id="line-808"></span><span>
</span><span id="line-809"></span><span class="annot"><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-type">singExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ADExp"><span class="hs-identifier hs-type">ADExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span>   </span><span class="hs-comment">-- the kind of the expression, if known</span><span>
</span><span id="line-810"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DExp</span></span><span>
</span><span id="line-811"></span><span>  </span><span class="hs-comment">-- See Note [Why error is so special]</span><span>
</span><span id="line-812"></span><span id="singExp"><span class="annot"><span class="annottext">singExp :: ADExp -&gt; Maybe DType -&gt; SgM DExp
</span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var hs-var">singExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADVarE"><span class="hs-identifier hs-type">ADVarE</span></a></span><span> </span><span id="local-6989586621681361550"><span class="annot"><span class="annottext">err :: Name
</span><a href="#local-6989586621681361550"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ADAppE"><span class="hs-operator hs-type">`ADAppE`</span></a></span><span> </span><span id="local-6989586621681361548"><span class="annot"><span class="annottext">arg :: ADExp
</span><a href="#local-6989586621681361548"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681361547"><span class="annot"><span class="annottext">_res_ki :: Maybe DType
</span><a href="#local-6989586621681361547"><span class="hs-identifier hs-var">_res_ki</span></a></span></span><span>
</span><span id="line-813"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361550"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#errorName"><span class="hs-identifier hs-var">errorName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; DExp -&gt; DExp
</span><span class="hs-identifier hs-var">DAppE</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361550"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; DExp) -&gt; SgM DExp -&gt; SgM DExp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span>
</span><span id="line-814"></span><span>                       </span><span class="annot"><span class="annottext">ADExp -&gt; Maybe DType -&gt; SgM DExp
</span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681361548"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#symbolName"><span class="hs-identifier hs-var">symbolName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-815"></span><span class="annot"><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADVarE"><span class="hs-identifier hs-type">ADVarE</span></a></span><span> </span><span id="local-6989586621681361544"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681361544"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681361543"><span class="annot"><span class="annottext">_res_ki :: Maybe DType
</span><a href="#local-6989586621681361543"><span class="hs-identifier hs-var">_res_ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; SgM DExp
</span><a href="Data.Singletons.Single.Monad.html#lookupVarE"><span class="hs-identifier hs-var">lookupVarE</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361544"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-816"></span><span class="annot"><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADConE"><span class="hs-identifier hs-type">ADConE</span></a></span><span> </span><span id="local-6989586621681361540"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681361540"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681361539"><span class="annot"><span class="annottext">_res_ki :: Maybe DType
</span><a href="#local-6989586621681361539"><span class="hs-identifier hs-var">_res_ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; SgM DExp
</span><a href="Data.Singletons.Single.Monad.html#lookupConE"><span class="hs-identifier hs-var">lookupConE</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361540"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-817"></span><span class="annot"><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADLitE"><span class="hs-identifier hs-type">ADLitE</span></a></span><span> </span><span id="local-6989586621681361536"><span class="annot"><span class="annottext">lit :: Lit
</span><a href="#local-6989586621681361536"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span>  </span><span id="local-6989586621681361535"><span class="annot"><span class="annottext">_res_ki :: Maybe DType
</span><a href="#local-6989586621681361535"><span class="hs-identifier hs-var">_res_ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lit -&gt; SgM DExp
</span><a href="Data.Singletons.Single.html#singLit"><span class="hs-identifier hs-var">singLit</span></a></span><span> </span><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621681361536"><span class="hs-identifier hs-var">lit</span></a></span><span>
</span><span id="line-818"></span><span class="annot"><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADAppE"><span class="hs-identifier hs-type">ADAppE</span></a></span><span> </span><span id="local-6989586621681361533"><span class="annot"><span class="annottext">e1 :: ADExp
</span><a href="#local-6989586621681361533"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621681361532"><span class="annot"><span class="annottext">e2 :: ADExp
</span><a href="#local-6989586621681361532"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681361531"><span class="annot"><span class="annottext">_res_ki :: Maybe DType
</span><a href="#local-6989586621681361531"><span class="hs-identifier hs-var">_res_ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-819"></span><span>  </span><span id="local-6989586621681361530"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361530"><span class="hs-identifier hs-var">e1'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ADExp -&gt; Maybe DType -&gt; SgM DExp
</span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681361533"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-820"></span><span>  </span><span id="local-6989586621681361529"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361529"><span class="hs-identifier hs-var">e2'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ADExp -&gt; Maybe DType -&gt; SgM DExp
</span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681361532"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-821"></span><span>  </span><span class="hs-comment">-- `applySing undefined x` kills type inference, because GHC can't figure</span><span>
</span><span id="line-822"></span><span>  </span><span class="hs-comment">-- out the type of `undefined`. So we don't emit `applySing` there.</span><span>
</span><span id="line-823"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; Bool
</span><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361530"><span class="hs-identifier hs-var">e1'</span></a></span><span>
</span><span id="line-824"></span><span>  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; SgM DExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; SgM DExp) -&gt; DExp -&gt; SgM DExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361530"><span class="hs-identifier hs-var">e1'</span></a></span><span> </span><span class="annot"><span class="annottext">DExp -&gt; DExp -&gt; DExp
</span><span class="hs-operator hs-var">`DAppE`</span></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361529"><span class="hs-identifier hs-var">e2'</span></a></span><span>
</span><span id="line-825"></span><span>  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; SgM DExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; SgM DExp) -&gt; DExp -&gt; SgM DExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#applySingName"><span class="hs-identifier hs-var">applySingName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; DExp -&gt; DExp
</span><span class="hs-operator hs-var">`DAppE`</span></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361530"><span class="hs-identifier hs-var">e1'</span></a></span><span> </span><span class="annot"><span class="annottext">DExp -&gt; DExp -&gt; DExp
</span><span class="hs-operator hs-var">`DAppE`</span></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361529"><span class="hs-identifier hs-var">e2'</span></a></span><span>
</span><span id="line-826"></span><span class="annot"><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADLamE"><span class="hs-identifier hs-type">ADLamE</span></a></span><span> </span><span id="local-6989586621681361525"><span class="annot"><span class="annottext">ty_names :: [Name]
</span><a href="#local-6989586621681361525"><span class="hs-identifier hs-var">ty_names</span></a></span></span><span> </span><span id="local-6989586621681361524"><span class="annot"><span class="annottext">prom_lam :: DType
</span><a href="#local-6989586621681361524"><span class="hs-identifier hs-var">prom_lam</span></a></span></span><span> </span><span id="local-6989586621681361523"><span class="annot"><span class="annottext">names :: [Name]
</span><a href="#local-6989586621681361523"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span id="local-6989586621681361522"><span class="annot"><span class="annottext">exp :: ADExp
</span><a href="#local-6989586621681361522"><span class="hs-identifier hs-var">exp</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681361521"><span class="annot"><span class="annottext">_res_ki :: Maybe DType
</span><a href="#local-6989586621681361521"><span class="hs-identifier hs-var">_res_ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-827"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361520"><span class="annot"><span class="annottext">sNames :: [Name]
</span><a href="#local-6989586621681361520"><span class="hs-identifier hs-var hs-var">sNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Name) -&gt; [Name] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#singValName"><span class="hs-identifier hs-var">singValName</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361523"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-828"></span><span>  </span><span id="local-6989586621681361519"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361519"><span class="hs-identifier hs-var">exp'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ADExp -&gt; Maybe DType -&gt; SgM DExp
</span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681361522"><span class="hs-identifier hs-var">exp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-829"></span><span>  </span><span class="hs-comment">-- we need to bind the type variables... but DLamE doesn't allow SigT patterns.</span><span>
</span><span id="line-830"></span><span>  </span><span class="hs-comment">-- So: build a case</span><span>
</span><span id="line-831"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361518"><span class="annot"><span class="annottext">caseExp :: DExp
</span><a href="#local-6989586621681361518"><span class="hs-identifier hs-var hs-var">caseExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; [DMatch] -&gt; DExp
</span><span class="hs-identifier hs-var">DCaseE</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DExp] -&gt; DExp
</span><span class="hs-identifier hs-var">mkTupleDExp</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DExp) -&gt; [Name] -&gt; [DExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361520"><span class="hs-identifier hs-var">sNames</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-832"></span><span>                       </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DPat -&gt; DExp -&gt; DMatch
</span><span class="hs-identifier hs-var">DMatch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DPat] -&gt; DPat
</span><span class="hs-identifier hs-var">mkTupleDPat</span></span><span>
</span><span id="line-833"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DPat) -&gt; [Name] -&gt; [DPat]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">DPat
</span><span class="hs-identifier hs-var">DWildP</span></span><span> </span><span class="annot"><span class="annottext">DPat -&gt; DType -&gt; DPat
</span><span class="hs-operator hs-var">`DSigP`</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; DPat) -&gt; (Name -&gt; DType) -&gt; Name -&gt; DPat
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span>
</span><span id="line-834"></span><span>                                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="Data.Singletons.Names.html#singFamily"><span class="hs-identifier hs-var">singFamily</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; DType) -&gt; (Name -&gt; DType) -&gt; Name -&gt; DType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span>
</span><span id="line-835"></span><span>                                      </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361525"><span class="hs-identifier hs-var">ty_names</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361519"><span class="hs-identifier hs-var">exp'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-836"></span><span>  </span><span class="annot"><span class="annottext">DExp -&gt; SgM DExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; SgM DExp) -&gt; DExp -&gt; SgM DExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; DType -&gt; DExp -&gt; DExp
</span><a href="Data.Singletons.Single.Monad.html#wrapSingFun"><span class="hs-identifier hs-var">wrapSingFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Name] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361523"><span class="hs-identifier hs-var">names</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361524"><span class="hs-identifier hs-var">prom_lam</span></a></span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; DExp) -&gt; DExp -&gt; DExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; DExp -&gt; DExp
</span><span class="hs-identifier hs-var">DLamE</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361520"><span class="hs-identifier hs-var">sNames</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361518"><span class="hs-identifier hs-var">caseExp</span></a></span><span>
</span><span id="line-837"></span><span class="annot"><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADCaseE"><span class="hs-identifier hs-type">ADCaseE</span></a></span><span> </span><span id="local-6989586621681361516"><span class="annot"><span class="annottext">exp :: ADExp
</span><a href="#local-6989586621681361516"><span class="hs-identifier hs-var">exp</span></a></span></span><span> </span><span id="local-6989586621681361515"><span class="annot"><span class="annottext">matches :: [ADMatch]
</span><a href="#local-6989586621681361515"><span class="hs-identifier hs-var">matches</span></a></span></span><span> </span><span id="local-6989586621681361514"><span class="annot"><span class="annottext">ret_ty :: DType
</span><a href="#local-6989586621681361514"><span class="hs-identifier hs-var">ret_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681361513"><span class="annot"><span class="annottext">res_ki :: Maybe DType
</span><a href="#local-6989586621681361513"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-838"></span><span>    </span><span class="hs-comment">-- See Note [Annotate case return type] and</span><span>
</span><span id="line-839"></span><span>    </span><span class="hs-comment">--     Note [The id hack; or, how singletons learned to stop worrying and</span><span>
</span><span id="line-840"></span><span>    </span><span class="hs-comment">--           avoid kind generalization]</span><span>
</span><span id="line-841"></span><span>  </span><span class="annot"><span class="annottext">DExp -&gt; DExp -&gt; DExp
</span><span class="hs-identifier hs-var">DAppE</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DExp -&gt; DType -&gt; DExp
</span><span class="hs-identifier hs-var">DAppTypeE</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="hs-special">'</span><span class="hs-identifier">id</span><span class="hs-special">)</span><span>
</span><span id="line-842"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="Data.Singletons.Names.html#singFamily"><span class="hs-identifier hs-var">singFamily</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361514"><span class="hs-identifier hs-var">ret_ty</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; Maybe DType -&gt; DType
</span><a href="Data.Singletons.Single.html#maybeSigT"><span class="hs-operator hs-var">`maybeSigT`</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681361513"><span class="hs-identifier hs-var">res_ki</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-843"></span><span>    </span><span class="annot"><span class="annottext">(DExp -&gt; DExp) -&gt; SgM DExp -&gt; SgM DExp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DExp -&gt; [DMatch] -&gt; DExp
</span><span class="hs-identifier hs-var">DCaseE</span></span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; [DMatch] -&gt; DExp) -&gt; SgM DExp -&gt; SgM ([DMatch] -&gt; DExp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ADExp -&gt; Maybe DType -&gt; SgM DExp
</span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681361516"><span class="hs-identifier hs-var">exp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">SgM ([DMatch] -&gt; DExp) -&gt; SgM [DMatch] -&gt; SgM DExp
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(ADMatch -&gt; SgM DMatch) -&gt; [ADMatch] -&gt; SgM [DMatch]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DType -&gt; ADMatch -&gt; SgM DMatch
</span><a href="Data.Singletons.Single.html#singMatch"><span class="hs-identifier hs-var">singMatch</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681361513"><span class="hs-identifier hs-var">res_ki</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ADMatch]
</span><a href="#local-6989586621681361515"><span class="hs-identifier hs-var">matches</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-844"></span><span class="annot"><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADLetE"><span class="hs-identifier hs-type">ADLetE</span></a></span><span> </span><span id="local-6989586621681361508"><span class="annot"><span class="annottext">env :: ALetDecEnv
</span><a href="#local-6989586621681361508"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681361507"><span class="annot"><span class="annottext">exp :: ADExp
</span><a href="#local-6989586621681361507"><span class="hs-identifier hs-var">exp</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681361506"><span class="annot"><span class="annottext">res_ki :: Maybe DType
</span><a href="#local-6989586621681361506"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-845"></span><span>  </span><span class="hs-comment">-- We intentionally discard the SingI instances for exp's defunctionalization</span><span>
</span><span id="line-846"></span><span>  </span><span class="hs-comment">-- symbols, as we also do not generate the declarations for the</span><span>
</span><span id="line-847"></span><span>  </span><span class="hs-comment">-- defunctionalization symbols in the first place during promotion.</span><span>
</span><span id="line-848"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681361505"><span class="annot"><span class="annottext">let_decs :: [DLetDec]
</span><a href="#local-6989586621681361505"><span class="hs-identifier hs-var">let_decs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361504"><span class="annot"><span class="annottext">exp' :: DExp
</span><a href="#local-6989586621681361504"><span class="hs-identifier hs-var">exp'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ALetDecEnv -&gt; SgM DExp -&gt; SgM ([DLetDec], [DDec], DExp)
forall a. ALetDecEnv -&gt; SgM a -&gt; SgM ([DLetDec], [DDec], a)
</span><a href="Data.Singletons.Single.html#singLetDecEnv"><span class="hs-identifier hs-var">singLetDecEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ALetDecEnv
</span><a href="#local-6989586621681361508"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(SgM DExp -&gt; SgM ([DLetDec], [DDec], DExp))
-&gt; SgM DExp -&gt; SgM ([DLetDec], [DDec], DExp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ADExp -&gt; Maybe DType -&gt; SgM DExp
</span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681361507"><span class="hs-identifier hs-var">exp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681361506"><span class="hs-identifier hs-var">res_ki</span></a></span><span>
</span><span id="line-849"></span><span>  </span><span class="annot"><span class="annottext">DExp -&gt; SgM DExp
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; SgM DExp) -&gt; DExp -&gt; SgM DExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DLetDec] -&gt; DExp -&gt; DExp
</span><span class="hs-identifier hs-var">DLetE</span></span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361505"><span class="hs-identifier hs-var">let_decs</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361504"><span class="hs-identifier hs-var">exp'</span></a></span><span>
</span><span id="line-850"></span><span class="annot"><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADSigE"><span class="hs-identifier hs-type">ADSigE</span></a></span><span> </span><span id="local-6989586621681361501"><span class="annot"><span class="annottext">prom_exp :: DType
</span><a href="#local-6989586621681361501"><span class="hs-identifier hs-var">prom_exp</span></a></span></span><span> </span><span id="local-6989586621681361500"><span class="annot"><span class="annottext">exp :: ADExp
</span><a href="#local-6989586621681361500"><span class="hs-identifier hs-var">exp</span></a></span></span><span> </span><span id="local-6989586621681361499"><span class="annot"><span class="annottext">ty :: DType
</span><a href="#local-6989586621681361499"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-851"></span><span>  </span><span id="local-6989586621681361498"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361498"><span class="hs-identifier hs-var">exp'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ADExp -&gt; Maybe DType -&gt; SgM DExp
</span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681361500"><span class="hs-identifier hs-var">exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361499"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-852"></span><span>  </span><span class="annot"><span class="annottext">DExp -&gt; SgM DExp
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; SgM DExp) -&gt; DExp -&gt; SgM DExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DExp -&gt; DType -&gt; DExp
</span><span class="hs-identifier hs-var">DSigE</span></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361498"><span class="hs-identifier hs-var">exp'</span></a></span><span> </span><span class="annot"><span class="annottext">(DType -&gt; DExp) -&gt; DType -&gt; DExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#singFamilyName"><span class="hs-identifier hs-var">singFamilyName</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-identifier hs-var">DSigT</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361501"><span class="hs-identifier hs-var">prom_exp</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361499"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-853"></span><span>
</span><span id="line-854"></span><span class="hs-comment">-- See Note [DerivedDecl] in Data.Singletons.Syntax</span><span>
</span><span id="line-855"></span><span class="annot"><a href="Data.Singletons.Single.html#singDerivedEqDecs"><span class="hs-identifier hs-type">singDerivedEqDecs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#DerivedEqDecl"><span class="hs-identifier hs-type">DerivedEqDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-856"></span><span id="singDerivedEqDecs"><span class="annot"><span class="annottext">singDerivedEqDecs :: DerivedEqDecl -&gt; SgM [DDec]
</span><a href="Data.Singletons.Single.html#singDerivedEqDecs"><span class="hs-identifier hs-var hs-var">singDerivedEqDecs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#DerivedDecl"><span class="hs-identifier hs-type">DerivedDecl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ded_mb_cxt :: forall (cls :: * -&gt; Constraint). DerivedDecl cls -&gt; Maybe [DType]
</span><a href="Data.Singletons.Syntax.html#ded_mb_cxt"><span class="hs-identifier hs-var">ded_mb_cxt</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361496"><span class="annot"><span class="annottext">Maybe [DType]
</span><a href="#local-6989586621681361496"><span class="hs-identifier hs-var">mb_ctxt</span></a></span></span><span>
</span><span id="line-857"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ded_type :: forall (cls :: * -&gt; Constraint). DerivedDecl cls -&gt; DType
</span><a href="Data.Singletons.Syntax.html#ded_type"><span class="hs-identifier hs-var">ded_type</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361495"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361495"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-858"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ded_type_tycon :: forall (cls :: * -&gt; Constraint). DerivedDecl cls -&gt; Name
</span><a href="Data.Singletons.Syntax.html#ded_type_tycon"><span class="hs-identifier hs-var">ded_type_tycon</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361494"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361494"><span class="hs-identifier hs-var">ty_tycon</span></a></span></span><span>
</span><span id="line-859"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ded_decl :: forall (cls :: * -&gt; Constraint). DerivedDecl cls -&gt; DataDecl
</span><a href="Data.Singletons.Syntax.html#ded_decl"><span class="hs-identifier hs-var">ded_decl</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span id="local-6989586621681361493"><span class="annot"><span class="annottext">cons :: [DCon]
</span><a href="#local-6989586621681361493"><span class="hs-identifier hs-var">cons</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-860"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681361492"><span class="annot"><span class="annottext">scons :: [DCon]
</span><a href="#local-6989586621681361492"><span class="hs-identifier hs-var">scons</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; SgM [DCon] -&gt; SgM ([DCon], [DDec])
forall (q :: * -&gt; *) a.
DsMonad q =&gt;
[Dec] -&gt; SgM a -&gt; q (a, [DDec])
</span><a href="Data.Singletons.Single.Monad.html#singM"><span class="hs-identifier hs-var">singM</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(SgM [DCon] -&gt; SgM ([DCon], [DDec]))
-&gt; SgM [DCon] -&gt; SgM ([DCon], [DDec])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DCon -&gt; SgM DCon) -&gt; [DCon] -&gt; SgM [DCon]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DCon -&gt; SgM DCon
</span><a href="Data.Singletons.Single.Data.html#singCtor"><span class="hs-identifier hs-var">singCtor</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361494"><span class="hs-identifier hs-var">ty_tycon</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681361493"><span class="hs-identifier hs-var">cons</span></a></span><span>
</span><span id="line-861"></span><span>  </span><span id="local-6989586621681361491"><span class="annot"><span class="annottext">Maybe [DType]
</span><a href="#local-6989586621681361491"><span class="hs-identifier hs-var">mb_sctxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([DType] -&gt; SgM [DType]) -&gt; Maybe [DType] -&gt; SgM (Maybe [DType])
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DType -&gt; SgM DType) -&gt; [DType] -&gt; SgM [DType]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; SgM DType
</span><a href="Data.Singletons.Single.Type.html#singPred"><span class="hs-identifier hs-var">singPred</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe [DType]
</span><a href="#local-6989586621681361496"><span class="hs-identifier hs-var">mb_ctxt</span></a></span><span>
</span><span id="line-862"></span><span>  </span><span id="local-6989586621681361490"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361490"><span class="hs-identifier hs-var">kind</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DType -&gt; SgM DType
forall (m :: * -&gt; *). MonadFail m =&gt; DType -&gt; m DType
</span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361495"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-863"></span><span>  </span><span id="local-6989586621681361489"><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681361489"><span class="hs-identifier hs-var">sEqInst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe [DType]
-&gt; DType -&gt; [DCon] -&gt; [DCon] -&gt; EqualityClassDesc SgM -&gt; SgM DDec
forall (q :: * -&gt; *).
DsMonad q =&gt;
Maybe [DType]
-&gt; DType -&gt; [DCon] -&gt; [DCon] -&gt; EqualityClassDesc q -&gt; q DDec
</span><a href="Data.Singletons.Single.Eq.html#mkEqualityInstance"><span class="hs-identifier hs-var">mkEqualityInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [DType]
</span><a href="#local-6989586621681361491"><span class="hs-identifier hs-var">mb_sctxt</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361490"><span class="hs-identifier hs-var">kind</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681361493"><span class="hs-identifier hs-var">cons</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681361492"><span class="hs-identifier hs-var">scons</span></a></span><span> </span><span class="annot"><span class="annottext">EqualityClassDesc SgM
forall (q :: * -&gt; *). Quasi q =&gt; EqualityClassDesc q
</span><a href="Data.Singletons.Single.Eq.html#sEqClassDesc"><span class="hs-identifier hs-var">sEqClassDesc</span></a></span><span>
</span><span id="line-864"></span><span>  </span><span class="hs-comment">-- Beware! The user might have specified an instance context like this:</span><span>
</span><span id="line-865"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-866"></span><span>  </span><span class="hs-comment">--   deriving instance Eq a =&gt; Eq (T a Int)</span><span>
</span><span id="line-867"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-868"></span><span>  </span><span class="hs-comment">-- When we single the context, it will become (SEq a). But we do *not* want</span><span>
</span><span id="line-869"></span><span>  </span><span class="hs-comment">-- this for the SDecide instance! The simplest solution is to simply replace</span><span>
</span><span id="line-870"></span><span>  </span><span class="hs-comment">-- all occurrences of SEq with SDecide in the context.</span><span>
</span><span id="line-871"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361488"><span class="annot"><span class="annottext">mb_sctxtDecide :: Maybe [DType]
</span><a href="#local-6989586621681361488"><span class="hs-identifier hs-var hs-var">mb_sctxtDecide</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([DType] -&gt; [DType]) -&gt; Maybe [DType] -&gt; Maybe [DType]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DType -&gt; DType) -&gt; [DType] -&gt; [DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType
</span><a href="Data.Singletons.Single.html#sEqToSDecide"><span class="hs-identifier hs-var">sEqToSDecide</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe [DType]
</span><a href="#local-6989586621681361491"><span class="hs-identifier hs-var">mb_sctxt</span></a></span><span>
</span><span id="line-872"></span><span>  </span><span id="local-6989586621681361486"><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681361486"><span class="hs-identifier hs-var">sDecideInst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe [DType]
-&gt; DType -&gt; [DCon] -&gt; [DCon] -&gt; EqualityClassDesc SgM -&gt; SgM DDec
forall (q :: * -&gt; *).
DsMonad q =&gt;
Maybe [DType]
-&gt; DType -&gt; [DCon] -&gt; [DCon] -&gt; EqualityClassDesc q -&gt; q DDec
</span><a href="Data.Singletons.Single.Eq.html#mkEqualityInstance"><span class="hs-identifier hs-var">mkEqualityInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [DType]
</span><a href="#local-6989586621681361488"><span class="hs-identifier hs-var">mb_sctxtDecide</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361490"><span class="hs-identifier hs-var">kind</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681361493"><span class="hs-identifier hs-var">cons</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681361492"><span class="hs-identifier hs-var">scons</span></a></span><span> </span><span class="annot"><span class="annottext">EqualityClassDesc SgM
forall (q :: * -&gt; *). Quasi q =&gt; EqualityClassDesc q
</span><a href="Data.Singletons.Single.Eq.html#sDecideClassDesc"><span class="hs-identifier hs-var">sDecideClassDesc</span></a></span><span>
</span><span id="line-873"></span><span>  </span><span id="local-6989586621681361485"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361485"><span class="hs-identifier hs-var">testInsts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TestInstance -&gt; SgM DDec) -&gt; [TestInstance] -&gt; SgM [DDec]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe [DType]
-&gt; DType -&gt; Name -&gt; [DCon] -&gt; TestInstance -&gt; SgM DDec
forall (q :: * -&gt; *).
DsMonad q =&gt;
Maybe [DType] -&gt; DType -&gt; Name -&gt; [DCon] -&gt; TestInstance -&gt; q DDec
</span><a href="Data.Singletons.Single.Eq.html#mkTestInstance"><span class="hs-identifier hs-var">mkTestInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [DType]
</span><a href="#local-6989586621681361488"><span class="hs-identifier hs-var">mb_sctxtDecide</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361490"><span class="hs-identifier hs-var">kind</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361494"><span class="hs-identifier hs-var">ty_tycon</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681361493"><span class="hs-identifier hs-var">cons</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-874"></span><span>                        </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TestInstance
</span><a href="Data.Singletons.Single.Eq.html#TestEquality"><span class="hs-identifier hs-var">TestEquality</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TestInstance
</span><a href="Data.Singletons.Single.Eq.html#TestCoercion"><span class="hs-identifier hs-var">TestCoercion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-875"></span><span>  </span><span class="annot"><span class="annottext">[DDec] -&gt; SgM [DDec]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681361489"><span class="hs-identifier hs-var">sEqInst</span></a></span><span class="annot"><span class="annottext">DDec -&gt; [DDec] -&gt; [DDec]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681361486"><span class="hs-identifier hs-var">sDecideInst</span></a></span><span class="annot"><span class="annottext">DDec -&gt; [DDec] -&gt; [DDec]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361485"><span class="hs-identifier hs-var">testInsts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-876"></span><span>
</span><span id="line-877"></span><span class="hs-comment">-- Walk a DPred, replacing all occurrences of SEq with SDecide.</span><span>
</span><span id="line-878"></span><span class="annot"><a href="Data.Singletons.Single.html#sEqToSDecide"><span class="hs-identifier hs-type">sEqToSDecide</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DPred</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DPred</span></span><span>
</span><span id="line-879"></span><span id="sEqToSDecide"><span class="annot"><span class="annottext">sEqToSDecide :: DType -&gt; DType
</span><a href="Data.Singletons.Single.html#sEqToSDecide"><span class="hs-identifier hs-var hs-var">sEqToSDecide</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Name) -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Names.html#modifyConNameDType"><span class="hs-identifier hs-var">modifyConNameDType</span></a></span><span> </span><span class="annot"><span class="annottext">((Name -&gt; Name) -&gt; DType -&gt; DType)
-&gt; (Name -&gt; Name) -&gt; DType -&gt; DType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681361482"><span class="annot"><span class="annottext">n :: Name
</span><a href="#local-6989586621681361482"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-880"></span><span>  </span><span class="hs-comment">-- Why don't we directly compare n to sEqClassName? Because n is almost certainly</span><span>
</span><span id="line-881"></span><span>  </span><span class="hs-comment">-- produced from a call to singClassName, which uses unqualified Names. Ugh.</span><span>
</span><span id="line-882"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
</span><span class="hs-identifier hs-var">nameBase</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361482"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
</span><span class="hs-identifier hs-var">nameBase</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#sEqClassName"><span class="hs-identifier hs-var">sEqClassName</span></a></span><span>
</span><span id="line-883"></span><span>     </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#sDecideClassName"><span class="hs-identifier hs-var">sDecideClassName</span></a></span><span>
</span><span id="line-884"></span><span>     </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361482"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-885"></span><span>
</span><span id="line-886"></span><span class="hs-comment">-- See Note [DerivedDecl] in Data.Singletons.Syntax</span><span>
</span><span id="line-887"></span><span class="annot"><a href="Data.Singletons.Single.html#singDerivedShowDecs"><span class="hs-identifier hs-type">singDerivedShowDecs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#DerivedShowDecl"><span class="hs-identifier hs-type">DerivedShowDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-888"></span><span id="singDerivedShowDecs"><span class="annot"><span class="annottext">singDerivedShowDecs :: DerivedShowDecl -&gt; SgM [DDec]
</span><a href="Data.Singletons.Single.html#singDerivedShowDecs"><span class="hs-identifier hs-var hs-var">singDerivedShowDecs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#DerivedDecl"><span class="hs-identifier hs-type">DerivedDecl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ded_mb_cxt :: forall (cls :: * -&gt; Constraint). DerivedDecl cls -&gt; Maybe [DType]
</span><a href="Data.Singletons.Syntax.html#ded_mb_cxt"><span class="hs-identifier hs-var">ded_mb_cxt</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361480"><span class="annot"><span class="annottext">Maybe [DType]
</span><a href="#local-6989586621681361480"><span class="hs-identifier hs-var">mb_cxt</span></a></span></span><span>
</span><span id="line-889"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ded_type :: forall (cls :: * -&gt; Constraint). DerivedDecl cls -&gt; DType
</span><a href="Data.Singletons.Syntax.html#ded_type"><span class="hs-identifier hs-var">ded_type</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361479"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361479"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-890"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ded_type_tycon :: forall (cls :: * -&gt; Constraint). DerivedDecl cls -&gt; Name
</span><a href="Data.Singletons.Syntax.html#ded_type_tycon"><span class="hs-identifier hs-var">ded_type_tycon</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361478"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361478"><span class="hs-identifier hs-var">ty_tycon</span></a></span></span><span>
</span><span id="line-891"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ded_decl :: forall (cls :: * -&gt; Constraint). DerivedDecl cls -&gt; DataDecl
</span><a href="Data.Singletons.Syntax.html#ded_decl"><span class="hs-identifier hs-var">ded_decl</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361477"><span class="annot"><span class="annottext">DataDecl
</span><a href="#local-6989586621681361477"><span class="hs-identifier hs-var">data_decl</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-892"></span><span>    </span><span class="hs-comment">-- Generate a Show instance for a singleton type, like this:</span><span>
</span><span id="line-893"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-894"></span><span>    </span><span class="hs-comment">--   instance (ShowSing a, ShowSing b) =&gt; Show (SEither (z :: Either a b)) where</span><span>
</span><span id="line-895"></span><span>    </span><span class="hs-comment">--     showsPrec p (SLeft (sl :: Sing l)) =</span><span>
</span><span id="line-896"></span><span>    </span><span class="hs-comment">--       showParen (p &gt; 10) $ showString &quot;SLeft &quot; . showsPrec 11 sl</span><span>
</span><span id="line-897"></span><span>    </span><span class="hs-comment">--         :: ShowSing' l =&gt; ShowS</span><span>
</span><span id="line-898"></span><span>    </span><span class="hs-comment">--     showsPrec p (SRight (sr :: Sing r)) =</span><span>
</span><span id="line-899"></span><span>    </span><span class="hs-comment">--       showParen (p &gt; 10) $ showString &quot;SRight &quot; . showsPrec 11 sr</span><span>
</span><span id="line-900"></span><span>    </span><span class="hs-comment">--         :: ShowSing' r =&gt; ShowS</span><span>
</span><span id="line-901"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-902"></span><span>    </span><span class="hs-comment">-- Be careful: we want to generate an instance context that uses ShowSing,</span><span>
</span><span id="line-903"></span><span>    </span><span class="hs-comment">-- not SShow.</span><span>
</span><span id="line-904"></span><span>    </span><span id="local-6989586621681361476"><span class="annot"><span class="annottext">UInstDecl
</span><a href="#local-6989586621681361476"><span class="hs-identifier hs-var">show_sing_inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ShowMode -&gt; DerivDesc SgM
forall (q :: * -&gt; *). DsMonad q =&gt; ShowMode -&gt; DerivDesc q
</span><a href="Data.Singletons.Deriving.Show.html#mkShowInstance"><span class="hs-identifier hs-var">mkShowInstance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; ShowMode
</span><a href="Data.Singletons.Deriving.Show.html#ForShowSing"><span class="hs-identifier hs-var">ForShowSing</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361478"><span class="hs-identifier hs-var">ty_tycon</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe [DType]
</span><a href="#local-6989586621681361480"><span class="hs-identifier hs-var">mb_cxt</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361479"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">DataDecl
</span><a href="#local-6989586621681361477"><span class="hs-identifier hs-var">data_decl</span></a></span><span>
</span><span id="line-905"></span><span>    </span><span class="annot"><span class="annottext">[DDec] -&gt; SgM [DDec]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">UInstDecl -&gt; DDec
</span><a href="#local-6989586621681361474"><span class="hs-identifier hs-var">toInstanceD</span></a></span><span> </span><span class="annot"><span class="annottext">UInstDecl
</span><a href="#local-6989586621681361476"><span class="hs-identifier hs-var">show_sing_inst</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-906"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-907"></span><span>    </span><span class="annot"><a href="#local-6989586621681361474"><span class="hs-identifier hs-type">toInstanceD</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#UInstDecl"><span class="hs-identifier hs-type">UInstDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span>
</span><span id="line-908"></span><span>    </span><span id="local-6989586621681361474"><span class="annot"><span class="annottext">toInstanceD :: UInstDecl -&gt; DDec
</span><a href="#local-6989586621681361474"><span class="hs-identifier hs-var hs-var">toInstanceD</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#InstDecl"><span class="hs-identifier hs-type">InstDecl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">id_cxt :: forall (ann :: AnnotationFlag). InstDecl ann -&gt; [DType]
</span><a href="Data.Singletons.Syntax.html#id_cxt"><span class="hs-identifier hs-var">id_cxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361473"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361473"><span class="hs-identifier hs-var">cxt</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">id_name :: forall (ann :: AnnotationFlag). InstDecl ann -&gt; Name
</span><a href="Data.Singletons.Syntax.html#id_name"><span class="hs-identifier hs-var">id_name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361472"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361472"><span class="hs-identifier hs-var">inst_name</span></a></span></span><span>
</span><span id="line-909"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">id_arg_tys :: forall (ann :: AnnotationFlag). InstDecl ann -&gt; [DType]
</span><a href="Data.Singletons.Syntax.html#id_arg_tys"><span class="hs-identifier hs-var">id_arg_tys</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361471"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361471"><span class="hs-identifier hs-var">inst_tys</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">id_meths :: forall (ann :: AnnotationFlag).
InstDecl ann -&gt; [(Name, LetDecRHS ann)]
</span><a href="Data.Singletons.Syntax.html#id_meths"><span class="hs-identifier hs-var">id_meths</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361470"><span class="annot"><span class="annottext">[(Name, LetDecRHS Unannotated)]
</span><a href="#local-6989586621681361470"><span class="hs-identifier hs-var">ann_meths</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-910"></span><span>      </span><span class="annot"><span class="annottext">Maybe Overlap
-&gt; Maybe [DTyVarBndr] -&gt; [DType] -&gt; DType -&gt; [DDec] -&gt; DDec
</span><span class="hs-identifier hs-var">DInstanceD</span></span><span> </span><span class="annot"><span class="annottext">Maybe Overlap
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe [DTyVarBndr]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361473"><span class="hs-identifier hs-var">cxt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361472"><span class="hs-identifier hs-var">inst_name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621681361471"><span class="hs-identifier hs-var">inst_tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-911"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, LetDecRHS Unannotated) -&gt; DDec)
-&gt; [(Name, LetDecRHS Unannotated)] -&gt; [DDec]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DLetDec -&gt; DDec
</span><span class="hs-identifier hs-var">DLetDec</span></span><span> </span><span class="annot"><span class="annottext">(DLetDec -&gt; DDec)
-&gt; ((Name, LetDecRHS Unannotated) -&gt; DLetDec)
-&gt; (Name, LetDecRHS Unannotated)
-&gt; DDec
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Name, LetDecRHS Unannotated) -&gt; DLetDec
</span><a href="#local-6989586621681361469"><span class="hs-identifier hs-var">toFunD</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, LetDecRHS Unannotated)]
</span><a href="#local-6989586621681361470"><span class="hs-identifier hs-var">ann_meths</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-912"></span><span>
</span><span id="line-913"></span><span>    </span><span class="annot"><a href="#local-6989586621681361469"><span class="hs-identifier hs-type">toFunD</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ULetDecRHS"><span class="hs-identifier hs-type">ULetDecRHS</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DLetDec</span></span><span>
</span><span id="line-914"></span><span>    </span><span id="local-6989586621681361469"><span class="annot"><span class="annottext">toFunD :: (Name, LetDecRHS Unannotated) -&gt; DLetDec
</span><a href="#local-6989586621681361469"><span class="hs-identifier hs-var hs-var">toFunD</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681361467"><span class="annot"><span class="annottext">fun_name :: Name
</span><a href="#local-6989586621681361467"><span class="hs-identifier hs-var">fun_name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#UFunction"><span class="hs-identifier hs-type">UFunction</span></a></span><span> </span><span id="local-6989586621681361465"><span class="annot"><a href="#local-6989586621681361465"><span class="hs-identifier hs-var">clauses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [DClause] -&gt; DLetDec
</span><span class="hs-identifier hs-var">DFunD</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361467"><span class="hs-identifier hs-var">fun_name</span></a></span><span> </span><span class="annot"><span class="annottext">[DClause]
</span><a href="#local-6989586621681361465"><span class="hs-identifier hs-var">clauses</span></a></span><span>
</span><span id="line-915"></span><span>    </span><span class="annot"><a href="#local-6989586621681361469"><span class="hs-identifier hs-var">toFunD</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681361464"><span class="annot"><span class="annottext">val_name :: Name
</span><a href="#local-6989586621681361464"><span class="hs-identifier hs-var">val_name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#UValue"><span class="hs-identifier hs-type">UValue</span></a></span><span> </span><span id="local-6989586621681361462"><span class="annot"><a href="#local-6989586621681361462"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DPat -&gt; DExp -&gt; DLetDec
</span><span class="hs-identifier hs-var">DValD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DPat
</span><span class="hs-identifier hs-var">DVarP</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361464"><span class="hs-identifier hs-var">val_name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361462"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-916"></span><span>
</span><span id="line-917"></span><span class="annot"><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-type">isException</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DExp</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-918"></span><span id="isException"><span class="annot"><span class="annottext">isException :: DExp -&gt; Bool
</span><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var hs-var">isException</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DVarE</span></span><span> </span><span id="local-6989586621681361461"><span class="annot"><span class="annottext">n :: Name
</span><a href="#local-6989586621681361461"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
</span><span class="hs-identifier hs-var">nameBase</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361461"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="hs-string">&quot;sUndefined&quot;</span></span><span>
</span><span id="line-919"></span><span class="annot"><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DConE</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-920"></span><span class="annot"><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DLitE</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-921"></span><span class="annot"><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DAppE</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DVarE</span></span><span> </span><span id="local-6989586621681361459"><span class="annot"><span class="annottext">fun :: Name
</span><a href="#local-6989586621681361459"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
</span><span class="hs-identifier hs-var">nameBase</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361459"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="hs-string">&quot;sError&quot;</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-922"></span><span class="annot"><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DAppE</span></span><span> </span><span id="local-6989586621681361458"><span class="annot"><span class="annottext">fun :: DExp
</span><a href="#local-6989586621681361458"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; Bool
</span><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361458"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-923"></span><span class="annot"><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DAppTypeE</span></span><span> </span><span id="local-6989586621681361457"><span class="annot"><span class="annottext">e :: DExp
</span><a href="#local-6989586621681361457"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; Bool
</span><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361457"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-924"></span><span class="annot"><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DLamE</span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-925"></span><span class="annot"><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DCaseE</span></span><span> </span><span id="local-6989586621681361456"><span class="annot"><span class="annottext">e :: DExp
</span><a href="#local-6989586621681361456"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; Bool
</span><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361456"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-926"></span><span class="annot"><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DLetE</span></span><span> </span><span class="hs-identifier">_</span><span> </span><span id="local-6989586621681361455"><span class="annot"><span class="annottext">e :: DExp
</span><a href="#local-6989586621681361455"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; Bool
</span><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361455"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-927"></span><span class="annot"><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DSigE</span></span><span> </span><span id="local-6989586621681361454"><span class="annot"><span class="annottext">e :: DExp
</span><a href="#local-6989586621681361454"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; Bool
</span><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361454"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-928"></span><span class="annot"><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DStaticE</span></span><span> </span><span id="local-6989586621681361452"><span class="annot"><span class="annottext">e :: DExp
</span><a href="#local-6989586621681361452"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; Bool
</span><a href="Data.Singletons.Single.html#isException"><span class="hs-identifier hs-var">isException</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361452"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-929"></span><span>
</span><span id="line-930"></span><span class="annot"><a href="Data.Singletons.Single.html#singMatch"><span class="hs-identifier hs-type">singMatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span>  </span><span class="hs-comment">-- ^ the result kind, if known</span><span>
</span><span id="line-931"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ADMatch"><span class="hs-identifier hs-type">ADMatch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DMatch</span></span><span>
</span><span id="line-932"></span><span id="singMatch"><span class="annot"><span class="annottext">singMatch :: Maybe DType -&gt; ADMatch -&gt; SgM DMatch
</span><a href="Data.Singletons.Single.html#singMatch"><span class="hs-identifier hs-var hs-var">singMatch</span></a></span></span><span> </span><span id="local-6989586621681361451"><span class="annot"><span class="annottext">res_ki :: Maybe DType
</span><a href="#local-6989586621681361451"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ADMatch"><span class="hs-identifier hs-type">ADMatch</span></a></span><span> </span><span id="local-6989586621681361449"><span class="annot"><span class="annottext">var_proms :: VarPromotions
</span><a href="#local-6989586621681361449"><span class="hs-identifier hs-var">var_proms</span></a></span></span><span> </span><span id="local-6989586621681361448"><span class="annot"><span class="annottext">pat :: ADPat
</span><a href="#local-6989586621681361448"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621681361447"><span class="annot"><span class="annottext">exp :: ADExp
</span><a href="#local-6989586621681361447"><span class="hs-identifier hs-var">exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-933"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681361446"><span class="annot"><span class="annottext">sPat :: DPat
</span><a href="#local-6989586621681361446"><span class="hs-identifier hs-var">sPat</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361445"><span class="annot"><span class="annottext">sigPaExpsSigs :: SingDSigPaInfos
</span><a href="#local-6989586621681361445"><span class="hs-identifier hs-var">sigPaExpsSigs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">QWithAux SingDSigPaInfos SgM DPat -&gt; SgM (DPat, SingDSigPaInfos)
forall m (q :: * -&gt; *) a. QWithAux m q a -&gt; q (a, m)
</span><a href="Data.Singletons.Util.html#evalForPair"><span class="hs-identifier hs-var">evalForPair</span></a></span><span> </span><span class="annot"><span class="annottext">(QWithAux SingDSigPaInfos SgM DPat -&gt; SgM (DPat, SingDSigPaInfos))
-&gt; QWithAux SingDSigPaInfos SgM DPat -&gt; SgM (DPat, SingDSigPaInfos)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map Name Name -&gt; ADPat -&gt; QWithAux SingDSigPaInfos SgM DPat
</span><a href="Data.Singletons.Single.html#singPat"><span class="hs-identifier hs-var">singPat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarPromotions -&gt; Map Name Name
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">VarPromotions
</span><a href="#local-6989586621681361449"><span class="hs-identifier hs-var">var_proms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ADPat
</span><a href="#local-6989586621681361448"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-934"></span><span>  </span><span id="local-6989586621681361444"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361444"><span class="hs-identifier hs-var">sExp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ADExp -&gt; Maybe DType -&gt; SgM DExp
</span><a href="Data.Singletons.Single.html#singExp"><span class="hs-identifier hs-var">singExp</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681361447"><span class="hs-identifier hs-var">exp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681361451"><span class="hs-identifier hs-var">res_ki</span></a></span><span>
</span><span id="line-935"></span><span>  </span><span class="annot"><span class="annottext">DMatch -&gt; SgM DMatch
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DMatch -&gt; SgM DMatch) -&gt; DMatch -&gt; SgM DMatch
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DPat -&gt; DExp -&gt; DMatch
</span><span class="hs-identifier hs-var">DMatch</span></span><span> </span><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621681361446"><span class="hs-identifier hs-var">sPat</span></a></span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; DMatch) -&gt; DExp -&gt; DMatch
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SingDSigPaInfos -&gt; DExp -&gt; DExp
</span><a href="Data.Singletons.Single.html#mkSigPaCaseE"><span class="hs-identifier hs-var">mkSigPaCaseE</span></a></span><span> </span><span class="annot"><span class="annottext">SingDSigPaInfos
</span><a href="#local-6989586621681361445"><span class="hs-identifier hs-var">sigPaExpsSigs</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361444"><span class="hs-identifier hs-var">sExp</span></a></span><span>
</span><span id="line-936"></span><span>
</span><span id="line-937"></span><span class="annot"><a href="Data.Singletons.Single.html#singLit"><span class="hs-identifier hs-type">singLit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Lit</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Single.Monad.html#SgM"><span class="hs-identifier hs-type">SgM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DExp</span></span><span>
</span><span id="line-938"></span><span id="singLit"><span class="annot"><span class="annottext">singLit :: Lit -&gt; SgM DExp
</span><a href="Data.Singletons.Single.html#singLit"><span class="hs-identifier hs-var hs-var">singLit</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IntegerL</span></span><span> </span><span id="local-6989586621681361442"><span class="annot"><span class="annottext">n :: Integer
</span><a href="#local-6989586621681361442"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-939"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681361442"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; SgM DExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; SgM DExp) -&gt; DExp -&gt; SgM DExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-940"></span><span>                </span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#sFromIntegerName"><span class="hs-identifier hs-var">sFromIntegerName</span></a></span><span> </span><span class="annot"><span class="annottext">DExp -&gt; DExp -&gt; DExp
</span><span class="hs-operator hs-var">`DAppE`</span></span><span>
</span><span id="line-941"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#singMethName"><span class="hs-identifier hs-var">singMethName</span></a></span><span> </span><span class="annot"><span class="annottext">DExp -&gt; DType -&gt; DExp
</span><span class="hs-operator hs-var">`DSigE`</span></span><span>
</span><span id="line-942"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="Data.Singletons.Names.html#singFamily"><span class="hs-identifier hs-var">singFamily</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; DType
</span><span class="hs-identifier hs-var">DLitT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; TyLit
</span><span class="hs-identifier hs-var">NumTyLit</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681361442"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-943"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621681361438"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361438"><span class="hs-identifier hs-var">sLit</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lit -&gt; SgM DExp
</span><a href="Data.Singletons.Single.html#singLit"><span class="hs-identifier hs-var">singLit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Lit
</span><span class="hs-identifier hs-var">IntegerL</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681361442"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-944"></span><span>                   </span><span class="annot"><span class="annottext">DExp -&gt; SgM DExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; SgM DExp) -&gt; DExp -&gt; SgM DExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#sNegateName"><span class="hs-identifier hs-var">sNegateName</span></a></span><span> </span><span class="annot"><span class="annottext">DExp -&gt; DExp -&gt; DExp
</span><span class="hs-operator hs-var">`DAppE`</span></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361438"><span class="hs-identifier hs-var">sLit</span></a></span><span>
</span><span id="line-945"></span><span class="annot"><a href="Data.Singletons.Single.html#singLit"><span class="hs-identifier hs-var">singLit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StringL</span></span><span> </span><span id="local-6989586621681361435"><span class="annot"><span class="annottext">str :: String
</span><a href="#local-6989586621681361435"><span class="hs-identifier hs-var">str</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-946"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361434"><span class="annot"><span class="annottext">sing_str_lit :: DExp
</span><a href="#local-6989586621681361434"><span class="hs-identifier hs-var hs-var">sing_str_lit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#singMethName"><span class="hs-identifier hs-var">singMethName</span></a></span><span> </span><span class="annot"><span class="annottext">DExp -&gt; DType -&gt; DExp
</span><span class="hs-operator hs-var">`DSigE`</span></span><span>
</span><span id="line-947"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="Data.Singletons.Names.html#singFamily"><span class="hs-identifier hs-var">singFamily</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; DType
</span><span class="hs-identifier hs-var">DLitT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; TyLit
</span><span class="hs-identifier hs-var">StrTyLit</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681361435"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-948"></span><span>  </span><span id="local-6989586621681361432"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681361432"><span class="hs-identifier hs-var">os_enabled</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; SgM Bool
forall (m :: * -&gt; *). Quasi m =&gt; Extension -&gt; m Bool
</span><span class="hs-identifier hs-var">qIsExtEnabled</span></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.OverloadedStrings</span></span><span>
</span><span id="line-949"></span><span>  </span><span class="annot"><span class="annottext">DExp -&gt; SgM DExp
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DExp -&gt; SgM DExp) -&gt; DExp -&gt; SgM DExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681361432"><span class="hs-identifier hs-var">os_enabled</span></a></span><span>
</span><span id="line-950"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#sFromStringName"><span class="hs-identifier hs-var">sFromStringName</span></a></span><span> </span><span class="annot"><span class="annottext">DExp -&gt; DExp -&gt; DExp
</span><span class="hs-operator hs-var">`DAppE`</span></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361434"><span class="hs-identifier hs-var">sing_str_lit</span></a></span><span>
</span><span id="line-951"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681361434"><span class="hs-identifier hs-var">sing_str_lit</span></a></span><span>
</span><span id="line-952"></span><span class="annot"><a href="Data.Singletons.Single.html#singLit"><span class="hs-identifier hs-var">singLit</span></a></span><span> </span><span id="local-6989586621681361428"><span class="annot"><span class="annottext">lit :: Lit
</span><a href="#local-6989586621681361428"><span class="hs-identifier hs-var">lit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-953"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; SgM DExp
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;Only string and natural number literals can be singled: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Lit -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621681361428"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-954"></span><span>
</span><span id="line-955"></span><span class="annot"><a href="Data.Singletons.Single.html#maybeSigT"><span class="hs-identifier hs-type">maybeSigT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span>
</span><span id="line-956"></span><span id="maybeSigT"><span class="annot"><span class="annottext">maybeSigT :: DType -&gt; Maybe DType -&gt; DType
</span><a href="Data.Singletons.Single.html#maybeSigT"><span class="hs-identifier hs-var hs-var">maybeSigT</span></a></span></span><span> </span><span id="local-6989586621681361427"><span class="annot"><span class="annottext">ty :: DType
</span><a href="#local-6989586621681361427"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361427"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-957"></span><span class="annot"><a href="Data.Singletons.Single.html#maybeSigT"><span class="hs-identifier hs-var">maybeSigT</span></a></span><span> </span><span id="local-6989586621681361426"><span class="annot"><span class="annottext">ty :: DType
</span><a href="#local-6989586621681361426"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681361425"><span class="annot"><span class="annottext">ki :: DType
</span><a href="#local-6989586621681361425"><span class="hs-identifier hs-var">ki</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361426"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DSigT`</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361425"><span class="hs-identifier hs-var">ki</span></a></span><span>
</span><span id="line-958"></span><span>
</span><span id="line-959"></span><span class="hs-comment">{-
Note [The id hack; or, how singletons learned to stop worrying and avoid kind generalization]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
GHC 8.8 was a time of great change. In particular, 8.8 debuted a fix for
Trac #15141 (decideKindGeneralisationPlan is too complicated). To fix this, a
wily GHC developer&#8212;who shall remain unnamed, but whose username rhymes with
schmoldfire&#8212;decided to make decideKindGeneralisationPlan less complicated by,
well, removing the whole thing. One consequence of this is that local
definitions are now kind-generalized (whereas they would not have been
previously).

While schmoldfire had the noblest of intentions when authoring his fix, he
unintentionally made life much harder for singletons. Why? Consider the
following program:

  class Foo a where
    bar :: a -&gt; (a -&gt; b) -&gt; b
    baz :: a

  quux :: Foo a =&gt; a -&gt; a
  quux x = x `bar` \_ -&gt; baz

When singled, this program will turn into something like this:

  type family Quux (x :: a) :: a where
    Quux x = Bar x (LambdaSym1 x)

  sQuux :: forall a (x :: a). SFoo a =&gt; Sing x -&gt; Sing (Quux x :: a)
  sQuux (sX :: Sing x)
    = sBar sX
        ((singFun1 @(LambdaSym1 x))
           (\ sArg
              -&gt; case sArg of {
                   (_ :: Sing arg)
                     -&gt; (case sArg of { _ -&gt; sBaz }) ::
                          Sing (Case x arg arg) }))

  type family Case x arg t where
    Case x arg _ = Baz
  type family Lambda x t where
    Lambda x arg = Case x arg arg
  data LambdaSym1 x t
  type instance Apply (LambdaSym1 x) t = Lambda x t

The high-level bit is the explicit `Sing (Case x arg arg)` signature. Question:
what is the kind of `Case x arg arg`? The answer depends on whether local
definitions are kind-generalized or not!

1. If local definitions are *not* kind-generalized (i.e., the status quo before
   GHC 8.8), then `Case x arg arg :: a`.
2. If local definitions *are* kind-generalized (i.e., the status quo in GHC 8.8
   and later), then `Case x arg arg :: k` for some fresh kind variable `k`.

Unfortunately, the kind of `Case x arg arg` *must* be `a` in order for `sQuux`
to type-check. This means that the code above suddenly stopped working in GHC
8.8. What's more, we can't just remove these explicit signatures, as there is
code elsewhere in `singletons` that crucially relies on them to guide type
inference along (e.g., `sShowParen` in `Data.Singletons.Prelude.Show`).

Luckily, there is an ingenious hack that lets us the benefits of explicit
signatures without the pain of kind generalization: our old friend, the `id`
function. The plan is as follows: instead of generating this code:

  (case sArg of ...) :: Sing (Case x arg arg)

We instead generate this code:

  id @(Sing (Case x arg arg)) (case sArg of ...)

That's it! This works because visible type arguments in terms do not get kind-
generalized, unlike top-level or local signatures. Now `Case x arg arg`'s kind
is not generalized, and all is well. We dub this: the `id` hack.

One might wonder: will we need the `id` hack around forever? Perhaps not. While
GHC 8.8 removed the decideKindGeneralisationPlan function, there have been
rumblings that a future version of GHC may bring it back (in a limited form).
If this happens, it is possibly that GHC's attitude towards kind-generalizing
local definitons may change *again*, which could conceivably render the `id`
hack unnecessary. This is all speculation, of course, so all we can do now is
wait and revisit this design at a later date.
-}</span><span>
</span><span id="line-1040"></span></pre></body></html>