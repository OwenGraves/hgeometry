<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- Data/Singletons/Promote.hs

(c) Richard Eisenberg 2013
rae@cs.brynmawr.edu

This file contains functions to promote term-level constructs to the
type level. It is an internal module to the singletons package.
-}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell, MultiWayIf, LambdaCase, TupleSections #-}</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Singletons.Promote</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Q</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">cxt</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Syntax</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Quasi</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar.OMap.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">OMap</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar.OMap.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">OMap</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar.OSet</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">OSet</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar.OSet</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">OSet</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Names.html"><span class="hs-identifier">Data.Singletons.Names</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html"><span class="hs-identifier">Data.Singletons.Promote.Monad</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Eq.html"><span class="hs-identifier">Data.Singletons.Promote.Eq</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Defun.html"><span class="hs-identifier">Data.Singletons.Promote.Defun</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Type.html"><span class="hs-identifier">Data.Singletons.Promote.Type</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Deriving.Ord.html"><span class="hs-identifier">Data.Singletons.Deriving.Ord</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Deriving.Bounded.html"><span class="hs-identifier">Data.Singletons.Deriving.Bounded</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Deriving.Enum.html"><span class="hs-identifier">Data.Singletons.Deriving.Enum</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Deriving.Show.html"><span class="hs-identifier">Data.Singletons.Deriving.Show</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Deriving.Util.html"><span class="hs-identifier">Data.Singletons.Deriving.Util</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Partition.html"><span class="hs-identifier">Data.Singletons.Partition</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Util.html"><span class="hs-identifier">Data.Singletons.Util</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html"><span class="hs-identifier">Data.Singletons.Syntax</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">exp</span></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Alternative</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Arrow</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">second</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Maybe</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Writer</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">GHC.LanguageExtensions.Type</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LangExt</span></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-comment">-- | Generate promoted definitions from a type that is already defined.</span><span>
</span><span id="line-46"></span><span class="hs-comment">-- This is generally only useful with classes.</span><span>
</span><span id="line-47"></span><span id="local-6989586621681361171"><span class="annot"><a href="Data.Singletons.Promote.html#genPromotions"><span class="hs-identifier hs-type">genPromotions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681361171"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361171"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-48"></span><span id="genPromotions"><span class="annot"><span class="annottext">genPromotions :: [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#genPromotions"><span class="hs-identifier hs-var hs-var">genPromotions</span></a></span></span><span> </span><span id="local-6989586621681361169"><span class="annot"><span class="annottext">names :: [Name]
</span><a href="#local-6989586621681361169"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-49"></span><span>  </span><span class="annot"><span class="annottext">[Name] -&gt; q ()
forall (q :: * -&gt; *). Quasi q =&gt; [Name] -&gt; q ()
</span><a href="Data.Singletons.Util.html#checkForRep"><span class="hs-identifier hs-var">checkForRep</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361169"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-50"></span><span>  </span><span id="local-6989586621681361167"><span class="annot"><span class="annottext">[Info]
</span><a href="#local-6989586621681361167"><span class="hs-identifier hs-var">infos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; q Info) -&gt; [Name] -&gt; q [Info]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q Info
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q Info
</span><span class="hs-identifier hs-var">reifyWithLocals</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361169"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-51"></span><span>  </span><span id="local-6989586621681361164"><span class="annot"><span class="annottext">[DInfo]
</span><a href="#local-6989586621681361164"><span class="hs-identifier hs-var">dinfos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Info -&gt; q DInfo) -&gt; [Info] -&gt; q [DInfo]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Info -&gt; q DInfo
forall (q :: * -&gt; *). DsMonad q =&gt; Info -&gt; q DInfo
</span><span class="hs-identifier hs-var">dsInfo</span></span><span> </span><span class="annot"><span class="annottext">[Info]
</span><a href="#local-6989586621681361167"><span class="hs-identifier hs-var">infos</span></a></span><span>
</span><span id="line-52"></span><span>  </span><span id="local-6989586621681361162"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361162"><span class="hs-identifier hs-var">ddecs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; PrM () -&gt; q [DDec]
forall (q :: * -&gt; *). DsMonad q =&gt; [Dec] -&gt; PrM () -&gt; q [DDec]
</span><a href="Data.Singletons.Promote.Monad.html#promoteM_"><span class="hs-identifier hs-var">promoteM_</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(PrM () -&gt; q [DDec]) -&gt; PrM () -&gt; q [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DInfo -&gt; PrM ()) -&gt; [DInfo] -&gt; PrM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">DInfo -&gt; PrM ()
</span><a href="Data.Singletons.Promote.html#promoteInfo"><span class="hs-identifier hs-var">promoteInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[DInfo]
</span><a href="#local-6989586621681361164"><span class="hs-identifier hs-var">dinfos</span></a></span><span>
</span><span id="line-53"></span><span>  </span><span class="annot"><span class="annottext">[Dec] -&gt; q [Dec]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; q [Dec]) -&gt; [Dec] -&gt; q [Dec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [Dec]
</span><span class="hs-identifier hs-var">decsToTH</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361162"><span class="hs-identifier hs-var">ddecs</span></a></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-comment">-- | Promote every declaration given to the type level, retaining the originals.</span><span>
</span><span id="line-56"></span><span id="local-6989586621681361157"><span class="annot"><a href="Data.Singletons.Promote.html#promote"><span class="hs-identifier hs-type">promote</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681361157"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361157"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361157"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-57"></span><span id="promote"><span class="annot"><span class="annottext">promote :: q [Dec] -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promote"><span class="hs-identifier hs-var hs-var">promote</span></a></span></span><span> </span><span id="local-6989586621681361155"><span class="annot"><span class="annottext">qdec :: q [Dec]
</span><a href="#local-6989586621681361155"><span class="hs-identifier hs-var">qdec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-58"></span><span>  </span><span id="local-6989586621681361154"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681361154"><span class="hs-identifier hs-var">decls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">q [Dec]
</span><a href="#local-6989586621681361155"><span class="hs-identifier hs-var">qdec</span></a></span><span>
</span><span id="line-59"></span><span>  </span><span id="local-6989586621681361153"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361153"><span class="hs-identifier hs-var">ddecls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; DsM q [DDec] -&gt; q [DDec]
forall (q :: * -&gt; *) a. DsMonad q =&gt; [Dec] -&gt; DsM q a -&gt; q a
</span><span class="hs-identifier hs-var">withLocalDeclarations</span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681361154"><span class="hs-identifier hs-var">decls</span></a></span><span> </span><span class="annot"><span class="annottext">(DsM q [DDec] -&gt; q [DDec]) -&gt; DsM q [DDec] -&gt; q [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; DsM q [DDec]
forall (q :: * -&gt; *). DsMonad q =&gt; [Dec] -&gt; q [DDec]
</span><span class="hs-identifier hs-var">dsDecs</span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681361154"><span class="hs-identifier hs-var">decls</span></a></span><span>
</span><span id="line-60"></span><span>  </span><span id="local-6989586621681361150"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361150"><span class="hs-identifier hs-var">promDecls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; PrM () -&gt; q [DDec]
forall (q :: * -&gt; *). DsMonad q =&gt; [Dec] -&gt; PrM () -&gt; q [DDec]
</span><a href="Data.Singletons.Promote.Monad.html#promoteM_"><span class="hs-identifier hs-var">promoteM_</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681361154"><span class="hs-identifier hs-var">decls</span></a></span><span> </span><span class="annot"><span class="annottext">(PrM () -&gt; q [DDec]) -&gt; PrM () -&gt; q [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
</span><a href="Data.Singletons.Promote.html#promoteDecs"><span class="hs-identifier hs-var">promoteDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361153"><span class="hs-identifier hs-var">ddecls</span></a></span><span>
</span><span id="line-61"></span><span>  </span><span class="annot"><span class="annottext">[Dec] -&gt; q [Dec]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; q [Dec]) -&gt; [Dec] -&gt; q [Dec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681361154"><span class="hs-identifier hs-var">decls</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; [Dec] -&gt; [Dec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [Dec]
</span><span class="hs-identifier hs-var">decsToTH</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361150"><span class="hs-identifier hs-var">promDecls</span></a></span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="hs-comment">-- | Promote each declaration, discarding the originals. Note that a promoted</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- datatype uses the same definition as an original datatype, so this will</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- not work with datatypes. Classes, instances, and functions are all fine.</span><span>
</span><span id="line-66"></span><span id="local-6989586621681361148"><span class="annot"><a href="Data.Singletons.Promote.html#promoteOnly"><span class="hs-identifier hs-type">promoteOnly</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681361148"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361148"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361148"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-67"></span><span id="promoteOnly"><span class="annot"><span class="annottext">promoteOnly :: q [Dec] -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteOnly"><span class="hs-identifier hs-var hs-var">promoteOnly</span></a></span></span><span> </span><span id="local-6989586621681361146"><span class="annot"><span class="annottext">qdec :: q [Dec]
</span><a href="#local-6989586621681361146"><span class="hs-identifier hs-var">qdec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-68"></span><span>  </span><span id="local-6989586621681361145"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681361145"><span class="hs-identifier hs-var">decls</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">q [Dec]
</span><a href="#local-6989586621681361146"><span class="hs-identifier hs-var">qdec</span></a></span><span>
</span><span id="line-69"></span><span>  </span><span id="local-6989586621681361144"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361144"><span class="hs-identifier hs-var">ddecls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; q [DDec]
forall (q :: * -&gt; *). DsMonad q =&gt; [Dec] -&gt; q [DDec]
</span><span class="hs-identifier hs-var">dsDecs</span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681361145"><span class="hs-identifier hs-var">decls</span></a></span><span>
</span><span id="line-70"></span><span>  </span><span id="local-6989586621681361143"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361143"><span class="hs-identifier hs-var">promDecls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; PrM () -&gt; q [DDec]
forall (q :: * -&gt; *). DsMonad q =&gt; [Dec] -&gt; PrM () -&gt; q [DDec]
</span><a href="Data.Singletons.Promote.Monad.html#promoteM_"><span class="hs-identifier hs-var">promoteM_</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621681361145"><span class="hs-identifier hs-var">decls</span></a></span><span> </span><span class="annot"><span class="annottext">(PrM () -&gt; q [DDec]) -&gt; PrM () -&gt; q [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
</span><a href="Data.Singletons.Promote.html#promoteDecs"><span class="hs-identifier hs-var">promoteDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361144"><span class="hs-identifier hs-var">ddecls</span></a></span><span>
</span><span id="line-71"></span><span>  </span><span class="annot"><span class="annottext">[Dec] -&gt; q [Dec]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; q [Dec]) -&gt; [Dec] -&gt; q [Dec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [Dec]
</span><span class="hs-identifier hs-var">decsToTH</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361143"><span class="hs-identifier hs-var">promDecls</span></a></span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="hs-comment">-- | Generate defunctionalization symbols for existing type families.</span><span>
</span><span id="line-74"></span><span class="hs-comment">--</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- 'genDefunSymbols' has reasonable support for type families that use</span><span>
</span><span id="line-76"></span><span class="hs-comment">-- dependent quantification. For instance, this:</span><span>
</span><span id="line-77"></span><span class="hs-comment">--</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- type family MyProxy k (a :: k) :: Type where</span><span>
</span><span id="line-80"></span><span class="hs-comment">--   MyProxy k (a :: k) = Proxy a</span><span>
</span><span id="line-81"></span><span class="hs-comment">--</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- $('genDefunSymbols' [''MyProxy])</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-84"></span><span class="hs-comment">--</span><span>
</span><span id="line-85"></span><span class="hs-comment">-- Will generate the following defunctionalization symbols:</span><span>
</span><span id="line-86"></span><span class="hs-comment">--</span><span>
</span><span id="line-87"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-88"></span><span class="hs-comment">-- data MyProxySym0     :: Type  ~&gt; k ~&gt; Type</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- data MyProxySym1 (k  :: Type) :: k ~&gt; Type</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-91"></span><span class="hs-comment">--</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- Note that @MyProxySym0@ is a bit more general than it ought to be, since</span><span>
</span><span id="line-93"></span><span class="hs-comment">-- there is no dependency between the first kind (@Type@) and the second kind</span><span>
</span><span id="line-94"></span><span class="hs-comment">-- (@k@). But this would require the ability to write something like:</span><span>
</span><span id="line-95"></span><span class="hs-comment">--</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- data MyProxySym0 :: forall (k :: Type) ~&gt; k ~&gt; Type</span><span>
</span><span id="line-98"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-99"></span><span class="hs-comment">--</span><span>
</span><span id="line-100"></span><span class="hs-comment">-- Which currently isn't possible. So for the time being, the kind of</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- @MyProxySym0@ will be slightly more general, which means that under rare</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- circumstances, you may have to provide extra type signatures if you write</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- code which exploits the dependency in @MyProxy@'s kind.</span><span>
</span><span id="line-104"></span><span id="local-6989586621681361142"><span class="annot"><a href="Data.Singletons.Promote.html#genDefunSymbols"><span class="hs-identifier hs-type">genDefunSymbols</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681361142"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361142"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-105"></span><span id="genDefunSymbols"><span class="annot"><span class="annottext">genDefunSymbols :: [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#genDefunSymbols"><span class="hs-identifier hs-var hs-var">genDefunSymbols</span></a></span></span><span> </span><span id="local-6989586621681361140"><span class="annot"><span class="annottext">names :: [Name]
</span><a href="#local-6989586621681361140"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-106"></span><span>  </span><span class="annot"><span class="annottext">[Name] -&gt; q ()
forall (q :: * -&gt; *). Quasi q =&gt; [Name] -&gt; q ()
</span><a href="Data.Singletons.Util.html#checkForRep"><span class="hs-identifier hs-var">checkForRep</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361140"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-107"></span><span>  </span><span id="local-6989586621681361139"><span class="annot"><span class="annottext">[DInfo]
</span><a href="#local-6989586621681361139"><span class="hs-identifier hs-var">infos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; q DInfo) -&gt; [Name] -&gt; q [DInfo]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Info -&gt; q DInfo
forall (q :: * -&gt; *). DsMonad q =&gt; Info -&gt; q DInfo
</span><span class="hs-identifier hs-var">dsInfo</span></span><span> </span><span class="annot"><span class="annottext">(Info -&gt; q DInfo) -&gt; (Name -&gt; q Info) -&gt; Name -&gt; q DInfo
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q Info
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q Info
</span><span class="hs-identifier hs-var">reifyWithLocals</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361140"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-108"></span><span>  </span><span id="local-6989586621681361137"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361137"><span class="hs-identifier hs-var">decs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; PrM [DDec] -&gt; q [DDec]
forall (q :: * -&gt; *). DsMonad q =&gt; [Dec] -&gt; PrM [DDec] -&gt; q [DDec]
</span><a href="Data.Singletons.Promote.Monad.html#promoteMDecs"><span class="hs-identifier hs-var">promoteMDecs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(PrM [DDec] -&gt; q [DDec]) -&gt; PrM [DDec] -&gt; q [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DInfo -&gt; PrM [DDec]) -&gt; [DInfo] -&gt; PrM [DDec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">DInfo -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#defunInfo"><span class="hs-identifier hs-var">defunInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[DInfo]
</span><a href="#local-6989586621681361139"><span class="hs-identifier hs-var">infos</span></a></span><span>
</span><span id="line-109"></span><span>  </span><span class="annot"><span class="annottext">[Dec] -&gt; q [Dec]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; q [Dec]) -&gt; [Dec] -&gt; q [Dec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [Dec]
</span><span class="hs-identifier hs-var">decsToTH</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361137"><span class="hs-identifier hs-var">decs</span></a></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-comment">-- | Produce instances for @(==)@ (type-level equality) from the given types</span><span>
</span><span id="line-112"></span><span id="local-6989586621681361133"><span class="annot"><a href="Data.Singletons.Promote.html#promoteEqInstances"><span class="hs-identifier hs-type">promoteEqInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681361133"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361133"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-113"></span><span id="promoteEqInstances"><span class="annot"><span class="annottext">promoteEqInstances :: [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteEqInstances"><span class="hs-identifier hs-var hs-var">promoteEqInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; q [Dec]) -&gt; [Name] -&gt; q [Dec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q [Dec]
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteEqInstance"><span class="hs-identifier hs-var">promoteEqInstance</span></a></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="hs-comment">-- | Produce instances for 'POrd' from the given types</span><span>
</span><span id="line-116"></span><span id="local-6989586621681361130"><span class="annot"><a href="Data.Singletons.Promote.html#promoteOrdInstances"><span class="hs-identifier hs-type">promoteOrdInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681361130"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361130"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-117"></span><span id="promoteOrdInstances"><span class="annot"><span class="annottext">promoteOrdInstances :: [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteOrdInstances"><span class="hs-identifier hs-var hs-var">promoteOrdInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; q [Dec]) -&gt; [Name] -&gt; q [Dec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q [Dec]
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteOrdInstance"><span class="hs-identifier hs-var">promoteOrdInstance</span></a></span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span class="hs-comment">-- | Produce an instance for 'POrd' from the given type</span><span>
</span><span id="line-120"></span><span id="local-6989586621681361127"><span class="annot"><a href="Data.Singletons.Promote.html#promoteOrdInstance"><span class="hs-identifier hs-type">promoteOrdInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681361127"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361127"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-121"></span><span id="promoteOrdInstance"><span class="annot"><span class="annottext">promoteOrdInstance :: Name -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteOrdInstance"><span class="hs-identifier hs-var hs-var">promoteOrdInstance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
forall (q :: * -&gt; *).
DsMonad q =&gt;
DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteInstance"><span class="hs-identifier hs-var">promoteInstance</span></a></span><span> </span><span class="annot"><span class="annottext">DerivDesc q
forall (q :: * -&gt; *). DsMonad q =&gt; DerivDesc q
</span><a href="Data.Singletons.Deriving.Ord.html#mkOrdInstance"><span class="hs-identifier hs-var">mkOrdInstance</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Ord&quot;</span></span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span class="hs-comment">-- | Produce instances for 'PBounded' from the given types</span><span>
</span><span id="line-124"></span><span id="local-6989586621681361124"><span class="annot"><a href="Data.Singletons.Promote.html#promoteBoundedInstances"><span class="hs-identifier hs-type">promoteBoundedInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681361124"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361124"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-125"></span><span id="promoteBoundedInstances"><span class="annot"><span class="annottext">promoteBoundedInstances :: [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteBoundedInstances"><span class="hs-identifier hs-var hs-var">promoteBoundedInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; q [Dec]) -&gt; [Name] -&gt; q [Dec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q [Dec]
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteBoundedInstance"><span class="hs-identifier hs-var">promoteBoundedInstance</span></a></span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-comment">-- | Produce an instance for 'PBounded' from the given type</span><span>
</span><span id="line-128"></span><span id="local-6989586621681361121"><span class="annot"><a href="Data.Singletons.Promote.html#promoteBoundedInstance"><span class="hs-identifier hs-type">promoteBoundedInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681361121"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361121"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-129"></span><span id="promoteBoundedInstance"><span class="annot"><span class="annottext">promoteBoundedInstance :: Name -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteBoundedInstance"><span class="hs-identifier hs-var hs-var">promoteBoundedInstance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
forall (q :: * -&gt; *).
DsMonad q =&gt;
DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteInstance"><span class="hs-identifier hs-var">promoteInstance</span></a></span><span> </span><span class="annot"><span class="annottext">DerivDesc q
forall (q :: * -&gt; *). DsMonad q =&gt; DerivDesc q
</span><a href="Data.Singletons.Deriving.Bounded.html#mkBoundedInstance"><span class="hs-identifier hs-var">mkBoundedInstance</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Bounded&quot;</span></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="hs-comment">-- | Produce instances for 'PEnum' from the given types</span><span>
</span><span id="line-132"></span><span id="local-6989586621681361119"><span class="annot"><a href="Data.Singletons.Promote.html#promoteEnumInstances"><span class="hs-identifier hs-type">promoteEnumInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681361119"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361119"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-133"></span><span id="promoteEnumInstances"><span class="annot"><span class="annottext">promoteEnumInstances :: [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteEnumInstances"><span class="hs-identifier hs-var hs-var">promoteEnumInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; q [Dec]) -&gt; [Name] -&gt; q [Dec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q [Dec]
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteEnumInstance"><span class="hs-identifier hs-var">promoteEnumInstance</span></a></span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span class="hs-comment">-- | Produce an instance for 'PEnum' from the given type</span><span>
</span><span id="line-136"></span><span id="local-6989586621681361116"><span class="annot"><a href="Data.Singletons.Promote.html#promoteEnumInstance"><span class="hs-identifier hs-type">promoteEnumInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681361116"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361116"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-137"></span><span id="promoteEnumInstance"><span class="annot"><span class="annottext">promoteEnumInstance :: Name -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteEnumInstance"><span class="hs-identifier hs-var hs-var">promoteEnumInstance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
forall (q :: * -&gt; *).
DsMonad q =&gt;
DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteInstance"><span class="hs-identifier hs-var">promoteInstance</span></a></span><span> </span><span class="annot"><span class="annottext">DerivDesc q
forall (q :: * -&gt; *). DsMonad q =&gt; DerivDesc q
</span><a href="Data.Singletons.Deriving.Enum.html#mkEnumInstance"><span class="hs-identifier hs-var">mkEnumInstance</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Enum&quot;</span></span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span class="hs-comment">-- | Produce instances for 'PShow' from the given types</span><span>
</span><span id="line-140"></span><span id="local-6989586621681361114"><span class="annot"><a href="Data.Singletons.Promote.html#promoteShowInstances"><span class="hs-identifier hs-type">promoteShowInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681361114"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361114"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-141"></span><span id="promoteShowInstances"><span class="annot"><span class="annottext">promoteShowInstances :: [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteShowInstances"><span class="hs-identifier hs-var hs-var">promoteShowInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; q [Dec]) -&gt; [Name] -&gt; q [Dec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q [Dec]
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteShowInstance"><span class="hs-identifier hs-var">promoteShowInstance</span></a></span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span class="hs-comment">-- | Produce an instance for 'PShow' from the given type</span><span>
</span><span id="line-144"></span><span id="local-6989586621681361111"><span class="annot"><a href="Data.Singletons.Promote.html#promoteShowInstance"><span class="hs-identifier hs-type">promoteShowInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681361111"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361111"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-145"></span><span id="promoteShowInstance"><span class="annot"><span class="annottext">promoteShowInstance :: Name -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteShowInstance"><span class="hs-identifier hs-var hs-var">promoteShowInstance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
forall (q :: * -&gt; *).
DsMonad q =&gt;
DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteInstance"><span class="hs-identifier hs-var">promoteInstance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShowMode -&gt; DerivDesc q
forall (q :: * -&gt; *). DsMonad q =&gt; ShowMode -&gt; DerivDesc q
</span><a href="Data.Singletons.Deriving.Show.html#mkShowInstance"><span class="hs-identifier hs-var">mkShowInstance</span></a></span><span> </span><span class="annot"><span class="annottext">ShowMode
</span><a href="Data.Singletons.Deriving.Show.html#ForPromotion"><span class="hs-identifier hs-var">ForPromotion</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-string">&quot;Show&quot;</span></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span class="hs-comment">-- | Produce an instance for @(==)@ (type-level equality) from the given type</span><span>
</span><span id="line-148"></span><span id="local-6989586621681361382"><span class="annot"><a href="Data.Singletons.Promote.html#promoteEqInstance"><span class="hs-identifier hs-type">promoteEqInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681361382"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361382"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-149"></span><span id="promoteEqInstance"><span class="annot"><span class="annottext">promoteEqInstance :: Name -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteEqInstance"><span class="hs-identifier hs-var hs-var">promoteEqInstance</span></a></span></span><span> </span><span id="local-6989586621681361108"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681361108"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681361107"><span class="annot"><span class="annottext">tvbs :: [TyVarBndr]
</span><a href="#local-6989586621681361107"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361106"><span class="annot"><span class="annottext">cons :: [Con]
</span><a href="#local-6989586621681361106"><span class="hs-identifier hs-var">cons</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name -&gt; q ([TyVarBndr], [Con])
forall (q :: * -&gt; *).
DsMonad q =&gt;
String -&gt; Name -&gt; q ([TyVarBndr], [Con])
</span><span class="hs-identifier hs-var">getDataD</span></span><span> </span><span class="annot"><span class="hs-string">&quot;I cannot make an instance of (==) for it.&quot;</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361108"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-151"></span><span>  </span><span id="local-6989586621681361104"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361104"><span class="hs-identifier hs-var">tvbs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TyVarBndr -&gt; q DTyVarBndr) -&gt; [TyVarBndr] -&gt; q [DTyVarBndr]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">TyVarBndr -&gt; q DTyVarBndr
forall (q :: * -&gt; *). DsMonad q =&gt; TyVarBndr -&gt; q DTyVarBndr
</span><span class="hs-identifier hs-var">dsTvb</span></span><span> </span><span class="annot"><span class="annottext">[TyVarBndr]
</span><a href="#local-6989586621681361107"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361102"><span class="annot"><span class="annottext">data_ty :: DType
</span><a href="#local-6989586621681361102"><span class="hs-identifier hs-var hs-var">data_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DTyVarBndr] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361108"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361104"><span class="hs-identifier hs-var">tvbs'</span></a></span><span>
</span><span id="line-153"></span><span>  </span><span id="local-6989586621681361099"><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681361099"><span class="hs-identifier hs-var">cons'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Con -&gt; q [DCon]) -&gt; [Con] -&gt; q [DCon]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; DType -&gt; Con -&gt; q [DCon]
forall (q :: * -&gt; *).
DsMonad q =&gt;
[DTyVarBndr] -&gt; DType -&gt; Con -&gt; q [DCon]
</span><span class="hs-identifier hs-var">dsCon</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361104"><span class="hs-identifier hs-var">tvbs'</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361102"><span class="hs-identifier hs-var">data_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Con]
</span><a href="#local-6989586621681361106"><span class="hs-identifier hs-var">cons</span></a></span><span>
</span><span id="line-154"></span><span>  </span><span id="local-6989586621681361097"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361097"><span class="hs-identifier hs-var">kind</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DType -&gt; q DType
forall (m :: * -&gt; *). MonadFail m =&gt; DType -&gt; m DType
</span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; [DTyVarBndr] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361108"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361104"><span class="hs-identifier hs-var">tvbs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>  </span><span id="local-6989586621681361095"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361095"><span class="hs-identifier hs-var">inst_decs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DCon] -&gt; q [DDec]
forall (q :: * -&gt; *). Quasi q =&gt; DType -&gt; [DCon] -&gt; q [DDec]
</span><a href="Data.Singletons.Promote.Eq.html#mkEqTypeInstance"><span class="hs-identifier hs-var">mkEqTypeInstance</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361097"><span class="hs-identifier hs-var">kind</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681361099"><span class="hs-identifier hs-var">cons'</span></a></span><span>
</span><span id="line-156"></span><span>  </span><span class="annot"><span class="annottext">[Dec] -&gt; q [Dec]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; q [Dec]) -&gt; [Dec] -&gt; q [Dec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [Dec]
</span><span class="hs-identifier hs-var">decsToTH</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361095"><span class="hs-identifier hs-var">inst_decs</span></a></span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span id="local-6989586621681361377"><span class="annot"><a href="Data.Singletons.Promote.html#promoteInstance"><span class="hs-identifier hs-type">promoteInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DsMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621681361377"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Deriving.Util.html#DerivDesc"><span class="hs-identifier hs-type">DerivDesc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681361377"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361377"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-159"></span><span id="promoteInstance"><span class="annot"><span class="annottext">promoteInstance :: DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.Promote.html#promoteInstance"><span class="hs-identifier hs-var hs-var">promoteInstance</span></a></span></span><span> </span><span id="local-6989586621681361093"><span class="annot"><span class="annottext">mk_inst :: DerivDesc q
</span><a href="#local-6989586621681361093"><span class="hs-identifier hs-var">mk_inst</span></a></span></span><span> </span><span id="local-6989586621681361092"><span class="annot"><span class="annottext">class_name :: String
</span><a href="#local-6989586621681361092"><span class="hs-identifier hs-var">class_name</span></a></span></span><span> </span><span id="local-6989586621681361091"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681361091"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681361090"><span class="annot"><span class="annottext">tvbs :: [TyVarBndr]
</span><a href="#local-6989586621681361090"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361089"><span class="annot"><span class="annottext">cons :: [Con]
</span><a href="#local-6989586621681361089"><span class="hs-identifier hs-var">cons</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name -&gt; q ([TyVarBndr], [Con])
forall (q :: * -&gt; *).
DsMonad q =&gt;
String -&gt; Name -&gt; q ([TyVarBndr], [Con])
</span><span class="hs-identifier hs-var">getDataD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;I cannot make an instance of &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681361092"><span class="hs-identifier hs-var">class_name</span></a></span><span>
</span><span id="line-161"></span><span>                            </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="hs-string">&quot; for it.&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361091"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-162"></span><span>  </span><span id="local-6989586621681361088"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361088"><span class="hs-identifier hs-var">tvbs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TyVarBndr -&gt; q DTyVarBndr) -&gt; [TyVarBndr] -&gt; q [DTyVarBndr]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">TyVarBndr -&gt; q DTyVarBndr
forall (q :: * -&gt; *). DsMonad q =&gt; TyVarBndr -&gt; q DTyVarBndr
</span><span class="hs-identifier hs-var">dsTvb</span></span><span> </span><span class="annot"><span class="annottext">[TyVarBndr]
</span><a href="#local-6989586621681361090"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361087"><span class="annot"><span class="annottext">data_ty :: DType
</span><a href="#local-6989586621681361087"><span class="hs-identifier hs-var hs-var">data_ty</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DTyVarBndr] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361091"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361088"><span class="hs-identifier hs-var">tvbs'</span></a></span><span>
</span><span id="line-164"></span><span>  </span><span id="local-6989586621681361086"><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681361086"><span class="hs-identifier hs-var">cons'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Con -&gt; q [DCon]) -&gt; [Con] -&gt; q [DCon]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; DType -&gt; Con -&gt; q [DCon]
forall (q :: * -&gt; *).
DsMonad q =&gt;
[DTyVarBndr] -&gt; DType -&gt; Con -&gt; q [DCon]
</span><span class="hs-identifier hs-var">dsCon</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361088"><span class="hs-identifier hs-var">tvbs'</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361087"><span class="hs-identifier hs-var">data_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Con]
</span><a href="#local-6989586621681361089"><span class="hs-identifier hs-var">cons</span></a></span><span>
</span><span id="line-165"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361085"><span class="annot"><span class="annottext">data_decl :: DataDecl
</span><a href="#local-6989586621681361085"><span class="hs-identifier hs-var hs-var">data_decl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [DTyVarBndr] -&gt; [DCon] -&gt; DataDecl
</span><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361091"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361088"><span class="hs-identifier hs-var">tvbs'</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681361086"><span class="hs-identifier hs-var">cons'</span></a></span><span>
</span><span id="line-166"></span><span>  </span><span id="local-6989586621681361083"><span class="annot"><span class="annottext">UInstDecl
</span><a href="#local-6989586621681361083"><span class="hs-identifier hs-var">raw_inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DerivDesc q
</span><a href="#local-6989586621681361093"><span class="hs-identifier hs-var">mk_inst</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DCxt
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361087"><span class="hs-identifier hs-var">data_ty</span></a></span><span> </span><span class="annot"><span class="annottext">DataDecl
</span><a href="#local-6989586621681361085"><span class="hs-identifier hs-var">data_decl</span></a></span><span>
</span><span id="line-167"></span><span>  </span><span id="local-6989586621681361082"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361082"><span class="hs-identifier hs-var">decs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; PrM () -&gt; q [DDec]
forall (q :: * -&gt; *). DsMonad q =&gt; [Dec] -&gt; PrM () -&gt; q [DDec]
</span><a href="Data.Singletons.Promote.Monad.html#promoteM_"><span class="hs-identifier hs-var">promoteM_</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(PrM () -&gt; q [DDec]) -&gt; PrM () -&gt; q [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrM AInstDecl -&gt; PrM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(PrM AInstDecl -&gt; PrM ()) -&gt; PrM AInstDecl -&gt; PrM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OMap Name DType -&gt; UInstDecl -&gt; PrM AInstDecl
</span><a href="Data.Singletons.Promote.html#promoteInstanceDec"><span class="hs-identifier hs-var">promoteInstanceDec</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
forall k v. OMap k v
</span><span class="hs-identifier hs-var">OMap.empty</span></span><span> </span><span class="annot"><span class="annottext">UInstDecl
</span><a href="#local-6989586621681361083"><span class="hs-identifier hs-var">raw_inst</span></a></span><span>
</span><span id="line-168"></span><span>  </span><span class="annot"><span class="annottext">[Dec] -&gt; q [Dec]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; q [Dec]) -&gt; [Dec] -&gt; q [Dec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [Dec]
</span><span class="hs-identifier hs-var">decsToTH</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361082"><span class="hs-identifier hs-var">decs</span></a></span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteInfo"><span class="hs-identifier hs-type">promoteInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DInfo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span id="promoteInfo"><span class="annot"><span class="annottext">promoteInfo :: DInfo -&gt; PrM ()
</span><a href="Data.Singletons.Promote.html#promoteInfo"><span class="hs-identifier hs-var hs-var">promoteInfo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTyConI</span></span><span> </span><span id="local-6989586621681361077"><span class="annot"><span class="annottext">dec :: DDec
</span><a href="#local-6989586621681361077"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span id="local-6989586621681361076"><span class="annot"><span class="annottext">_instances :: Maybe [DDec]
</span><a href="#local-6989586621681361076"><span class="hs-identifier hs-var">_instances</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
</span><a href="Data.Singletons.Promote.html#promoteDecs"><span class="hs-identifier hs-var">promoteDecs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681361077"><span class="hs-identifier hs-var">dec</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-172"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteInfo"><span class="hs-identifier hs-var">promoteInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DPrimTyConI</span></span><span> </span><span id="local-6989586621681361074"><span class="annot"><span class="annottext">_name :: Name
</span><a href="#local-6989586621681361074"><span class="hs-identifier hs-var">_name</span></a></span></span><span> </span><span id="local-6989586621681361073"><span class="annot"><span class="annottext">_numArgs :: Int
</span><a href="#local-6989586621681361073"><span class="hs-identifier hs-var">_numArgs</span></a></span></span><span> </span><span id="local-6989586621681361072"><span class="annot"><span class="annottext">_unlifted :: Bool
</span><a href="#local-6989586621681361072"><span class="hs-identifier hs-var">_unlifted</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-173"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; PrM ()
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Promotion of primitive type constructors not supported&quot;</span></span><span>
</span><span id="line-174"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteInfo"><span class="hs-identifier hs-var">promoteInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DVarI</span></span><span> </span><span id="local-6989586621681361070"><span class="annot"><span class="annottext">_name :: Name
</span><a href="#local-6989586621681361070"><span class="hs-identifier hs-var">_name</span></a></span></span><span> </span><span id="local-6989586621681361069"><span class="annot"><span class="annottext">_ty :: DType
</span><a href="#local-6989586621681361069"><span class="hs-identifier hs-var">_ty</span></a></span></span><span> </span><span id="local-6989586621681361068"><span class="annot"><span class="annottext">_mdec :: Maybe Name
</span><a href="#local-6989586621681361068"><span class="hs-identifier hs-var">_mdec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-175"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; PrM ()
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Promotion of individual values not supported&quot;</span></span><span>
</span><span id="line-176"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteInfo"><span class="hs-identifier hs-var">promoteInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTyVarI</span></span><span> </span><span id="local-6989586621681361066"><span class="annot"><span class="annottext">_name :: Name
</span><a href="#local-6989586621681361066"><span class="hs-identifier hs-var">_name</span></a></span></span><span> </span><span id="local-6989586621681361065"><span class="annot"><span class="annottext">_ty :: DType
</span><a href="#local-6989586621681361065"><span class="hs-identifier hs-var">_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-177"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; PrM ()
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Promotion of individual type variables not supported&quot;</span></span><span>
</span><span id="line-178"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteInfo"><span class="hs-identifier hs-var">promoteInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DPatSynI</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; PrM ()
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Promotion of pattern synonyms not supported&quot;</span></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span class="hs-comment">-- Note [Promoting declarations in two stages]</span><span>
</span><span id="line-182"></span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-183"></span><span class="hs-comment">--</span><span>
</span><span id="line-184"></span><span class="hs-comment">-- It is necessary to know the types of things when promoting. So,</span><span>
</span><span id="line-185"></span><span class="hs-comment">-- we promote in two stages: first, we build a LetDecEnv, which allows</span><span>
</span><span id="line-186"></span><span class="hs-comment">-- for easy lookup. Then, we go through the actual elements of the LetDecEnv,</span><span>
</span><span id="line-187"></span><span class="hs-comment">-- performing the promotion.</span><span>
</span><span id="line-188"></span><span class="hs-comment">--</span><span>
</span><span id="line-189"></span><span class="hs-comment">-- Why do we need the types? For kind annotations on the type family. We also</span><span>
</span><span id="line-190"></span><span class="hs-comment">-- need to have both the types and the actual function definition at the same</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- time, because the function definition tells us how many patterns are</span><span>
</span><span id="line-192"></span><span class="hs-comment">-- matched. Note that an eta-contracted function needs to return a TyFun,</span><span>
</span><span id="line-193"></span><span class="hs-comment">-- not a proper type-level function.</span><span>
</span><span id="line-194"></span><span class="hs-comment">--</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- Consider this example:</span><span>
</span><span id="line-196"></span><span class="hs-comment">--</span><span>
</span><span id="line-197"></span><span class="hs-comment">--   foo :: Nat -&gt; Bool -&gt; Bool</span><span>
</span><span id="line-198"></span><span class="hs-comment">--   foo Zero = id</span><span>
</span><span id="line-199"></span><span class="hs-comment">--   foo _    = not</span><span>
</span><span id="line-200"></span><span class="hs-comment">--</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- Here the first parameter to foo is non-uniform, because it is</span><span>
</span><span id="line-202"></span><span class="hs-comment">-- inspected in a pattern and can be different in each defining</span><span>
</span><span id="line-203"></span><span class="hs-comment">-- equation of foo. The second parameter to foo, specified in the type</span><span>
</span><span id="line-204"></span><span class="hs-comment">-- signature as Bool, is a uniform parameter - it is not inspected and</span><span>
</span><span id="line-205"></span><span class="hs-comment">-- each defining equation of foo uses it the same way. The foo</span><span>
</span><span id="line-206"></span><span class="hs-comment">-- function will be promoted to a type familty Foo like this:</span><span>
</span><span id="line-207"></span><span class="hs-comment">--</span><span>
</span><span id="line-208"></span><span class="hs-comment">--   type family Foo (n :: Nat) :: Bool ~&gt; Bool where</span><span>
</span><span id="line-209"></span><span class="hs-comment">--      Foo Zero = Id</span><span>
</span><span id="line-210"></span><span class="hs-comment">--      Foo a    = Not</span><span>
</span><span id="line-211"></span><span class="hs-comment">--</span><span>
</span><span id="line-212"></span><span class="hs-comment">-- To generate type signature for Foo type family we must first learn</span><span>
</span><span id="line-213"></span><span class="hs-comment">-- what is the actual number of patterns used in defining cequations</span><span>
</span><span id="line-214"></span><span class="hs-comment">-- of foo. In this case there is only one so we declare Foo to take</span><span>
</span><span id="line-215"></span><span class="hs-comment">-- one argument and have return type of Bool -&gt; Bool.</span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="hs-comment">-- Promote a list of top-level declarations.</span><span>
</span><span id="line-218"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteDecs"><span class="hs-identifier hs-type">promoteDecs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span id="promoteDecs"><span class="annot"><span class="annottext">promoteDecs :: [DDec] -&gt; PrM ()
</span><a href="Data.Singletons.Promote.html#promoteDecs"><span class="hs-identifier hs-var hs-var">promoteDecs</span></a></span></span><span> </span><span id="local-6989586621681361063"><span class="annot"><span class="annottext">raw_decls :: [DDec]
</span><a href="#local-6989586621681361063"><span class="hs-identifier hs-var">raw_decls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-220"></span><span>  </span><span id="local-6989586621681361062"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361062"><span class="hs-identifier hs-var">decls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM [DDec]
forall (q :: * -&gt; *) a. (DsMonad q, Data a) =&gt; a -&gt; q a
</span><span class="hs-identifier hs-var">expand</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361063"><span class="hs-identifier hs-var">raw_decls</span></a></span><span>     </span><span class="hs-comment">-- expand type synonyms</span><span>
</span><span id="line-221"></span><span>  </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
forall (q :: * -&gt; *). Quasi q =&gt; [DDec] -&gt; q ()
</span><a href="Data.Singletons.Util.html#checkForRepInDecls"><span class="hs-identifier hs-var">checkForRepInDecls</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361062"><span class="hs-identifier hs-var">decls</span></a></span><span>
</span><span id="line-222"></span><span>  </span><span class="annot"><a href="Data.Singletons.Partition.html#PDecs"><span class="hs-identifier hs-type">PDecs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">pd_let_decs :: PartitionedDecs -&gt; [DLetDec]
</span><a href="Data.Singletons.Partition.html#pd_let_decs"><span class="hs-identifier hs-var">pd_let_decs</span></a></span><span>                </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361057"><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361057"><span class="hs-identifier hs-var">let_decs</span></a></span></span><span>
</span><span id="line-223"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_class_decs :: PartitionedDecs -&gt; [UClassDecl]
</span><a href="Data.Singletons.Partition.html#pd_class_decs"><span class="hs-identifier hs-var">pd_class_decs</span></a></span><span>              </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361055"><span class="annot"><span class="annottext">[UClassDecl]
</span><a href="#local-6989586621681361055"><span class="hs-identifier hs-var">classes</span></a></span></span><span>
</span><span id="line-224"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_instance_decs :: PartitionedDecs -&gt; [UInstDecl]
</span><a href="Data.Singletons.Partition.html#pd_instance_decs"><span class="hs-identifier hs-var">pd_instance_decs</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361053"><span class="annot"><span class="annottext">[UInstDecl]
</span><a href="#local-6989586621681361053"><span class="hs-identifier hs-var">insts</span></a></span></span><span>
</span><span id="line-225"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_data_decs :: PartitionedDecs -&gt; [DataDecl]
</span><a href="Data.Singletons.Partition.html#pd_data_decs"><span class="hs-identifier hs-var">pd_data_decs</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361051"><span class="annot"><span class="annottext">[DataDecl]
</span><a href="#local-6989586621681361051"><span class="hs-identifier hs-var">datas</span></a></span></span><span>
</span><span id="line-226"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_ty_syn_decs :: PartitionedDecs -&gt; [TySynDecl]
</span><a href="Data.Singletons.Partition.html#pd_ty_syn_decs"><span class="hs-identifier hs-var">pd_ty_syn_decs</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361049"><span class="annot"><span class="annottext">[TySynDecl]
</span><a href="#local-6989586621681361049"><span class="hs-identifier hs-var">ty_syns</span></a></span></span><span>
</span><span id="line-227"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_open_type_family_decs :: PartitionedDecs -&gt; [OpenTypeFamilyDecl]
</span><a href="Data.Singletons.Partition.html#pd_open_type_family_decs"><span class="hs-identifier hs-var">pd_open_type_family_decs</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361047"><span class="annot"><span class="annottext">[OpenTypeFamilyDecl]
</span><a href="#local-6989586621681361047"><span class="hs-identifier hs-var">o_tyfams</span></a></span></span><span>
</span><span id="line-228"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_closed_type_family_decs :: PartitionedDecs -&gt; [ClosedTypeFamilyDecl]
</span><a href="Data.Singletons.Partition.html#pd_closed_type_family_decs"><span class="hs-identifier hs-var">pd_closed_type_family_decs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361045"><span class="annot"><span class="annottext">[ClosedTypeFamilyDecl]
</span><a href="#local-6989586621681361045"><span class="hs-identifier hs-var">c_tyfams</span></a></span></span><span>
</span><span id="line-229"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_derived_eq_decs :: PartitionedDecs -&gt; [DerivedEqDecl]
</span><a href="Data.Singletons.Partition.html#pd_derived_eq_decs"><span class="hs-identifier hs-var">pd_derived_eq_decs</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681361043"><span class="annot"><span class="annottext">[DerivedEqDecl]
</span><a href="#local-6989586621681361043"><span class="hs-identifier hs-var">derived_eq_decs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM PartitionedDecs
forall (m :: * -&gt; *). DsMonad m =&gt; [DDec] -&gt; m PartitionedDecs
</span><a href="Data.Singletons.Partition.html#partitionDecs"><span class="hs-identifier hs-var">partitionDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361062"><span class="hs-identifier hs-var">decls</span></a></span><span>
</span><span id="line-230"></span><span>
</span><span id="line-231"></span><span>  </span><span class="annot"><span class="annottext">[TySynDecl]
-&gt; [ClosedTypeFamilyDecl] -&gt; [OpenTypeFamilyDecl] -&gt; PrM ()
</span><a href="Data.Singletons.Promote.Defun.html#defunTypeDecls"><span class="hs-identifier hs-var">defunTypeDecls</span></a></span><span> </span><span class="annot"><span class="annottext">[TySynDecl]
</span><a href="#local-6989586621681361049"><span class="hs-identifier hs-var">ty_syns</span></a></span><span> </span><span class="annot"><span class="annottext">[ClosedTypeFamilyDecl]
</span><a href="#local-6989586621681361045"><span class="hs-identifier hs-var">c_tyfams</span></a></span><span> </span><span class="annot"><span class="annottext">[OpenTypeFamilyDecl]
</span><a href="#local-6989586621681361047"><span class="hs-identifier hs-var">o_tyfams</span></a></span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-comment">-- promoteLetDecs returns LetBinds, which we don't need at top level</span><span>
</span><span id="line-233"></span><span>  </span><span class="annot"><span class="annottext">([LetBind], ALetDecEnv)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(String, String) -&gt; [DLetDec] -&gt; PrM ([LetBind], ALetDecEnv)
</span><a href="Data.Singletons.Promote.html#promoteLetDecs"><span class="hs-identifier hs-var">promoteLetDecs</span></a></span><span> </span><span class="annot"><span class="annottext">(String, String)
</span><a href="Data.Singletons.Util.html#noPrefix"><span class="hs-identifier hs-var">noPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361057"><span class="hs-identifier hs-var">let_decs</span></a></span><span>
</span><span id="line-234"></span><span>  </span><span class="annot"><span class="annottext">(UClassDecl -&gt; PrM AClassDecl) -&gt; [UClassDecl] -&gt; PrM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">UClassDecl -&gt; PrM AClassDecl
</span><a href="Data.Singletons.Promote.html#promoteClassDec"><span class="hs-identifier hs-var">promoteClassDec</span></a></span><span> </span><span class="annot"><span class="annottext">[UClassDecl]
</span><a href="#local-6989586621681361055"><span class="hs-identifier hs-var">classes</span></a></span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361037"><span class="annot"><span class="annottext">orig_meth_sigs :: OMap Name DType
</span><a href="#local-6989586621681361037"><span class="hs-identifier hs-var hs-var">orig_meth_sigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UClassDecl -&gt; OMap Name DType) -&gt; [UClassDecl] -&gt; OMap Name DType
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LetDecEnv Unannotated -&gt; OMap Name DType
forall (ann :: AnnotationFlag). LetDecEnv ann -&gt; OMap Name DType
</span><a href="Data.Singletons.Syntax.html#lde_types"><span class="hs-identifier hs-var hs-var">lde_types</span></a></span><span> </span><span class="annot"><span class="annottext">(LetDecEnv Unannotated -&gt; OMap Name DType)
-&gt; (UClassDecl -&gt; LetDecEnv Unannotated)
-&gt; UClassDecl
-&gt; OMap Name DType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">UClassDecl -&gt; LetDecEnv Unannotated
forall (ann :: AnnotationFlag). ClassDecl ann -&gt; LetDecEnv ann
</span><a href="Data.Singletons.Syntax.html#cd_lde"><span class="hs-identifier hs-var hs-var">cd_lde</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[UClassDecl]
</span><a href="#local-6989586621681361055"><span class="hs-identifier hs-var">classes</span></a></span><span>
</span><span id="line-236"></span><span>  </span><span class="annot"><span class="annottext">(UInstDecl -&gt; PrM AInstDecl) -&gt; [UInstDecl] -&gt; PrM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OMap Name DType -&gt; UInstDecl -&gt; PrM AInstDecl
</span><a href="Data.Singletons.Promote.html#promoteInstanceDec"><span class="hs-identifier hs-var">promoteInstanceDec</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681361037"><span class="hs-identifier hs-var">orig_meth_sigs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[UInstDecl]
</span><a href="#local-6989586621681361053"><span class="hs-identifier hs-var">insts</span></a></span><span>
</span><span id="line-237"></span><span>  </span><span class="annot"><span class="annottext">(DerivedEqDecl -&gt; PrM ()) -&gt; [DerivedEqDecl] -&gt; PrM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">DerivedEqDecl -&gt; PrM ()
</span><a href="Data.Singletons.Promote.html#promoteDerivedEqDec"><span class="hs-identifier hs-var">promoteDerivedEqDec</span></a></span><span>   </span><span class="annot"><span class="annottext">[DerivedEqDecl]
</span><a href="#local-6989586621681361043"><span class="hs-identifier hs-var">derived_eq_decs</span></a></span><span>
</span><span id="line-238"></span><span>  </span><span class="annot"><span class="annottext">[DataDecl] -&gt; PrM ()
</span><a href="Data.Singletons.Promote.html#promoteDataDecs"><span class="hs-identifier hs-var">promoteDataDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[DataDecl]
</span><a href="#local-6989586621681361051"><span class="hs-identifier hs-var">datas</span></a></span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteDataDecs"><span class="hs-identifier hs-type">promoteDataDecs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span id="promoteDataDecs"><span class="annot"><span class="annottext">promoteDataDecs :: [DataDecl] -&gt; PrM ()
</span><a href="Data.Singletons.Promote.html#promoteDataDecs"><span class="hs-identifier hs-var hs-var">promoteDataDecs</span></a></span></span><span> </span><span id="local-6989586621681361030"><span class="annot"><span class="annottext">data_decs :: [DataDecl]
</span><a href="#local-6989586621681361030"><span class="hs-identifier hs-var">data_decs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-242"></span><span>  </span><span id="local-6989586621681361029"><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361029"><span class="hs-identifier hs-var">rec_selectors</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DataDecl -&gt; PrM [DLetDec]) -&gt; [DataDecl] -&gt; PrM [DLetDec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">DataDecl -&gt; PrM [DLetDec]
</span><a href="#local-6989586621681361028"><span class="hs-identifier hs-var">extract_rec_selectors</span></a></span><span> </span><span class="annot"><span class="annottext">[DataDecl]
</span><a href="#local-6989586621681361030"><span class="hs-identifier hs-var">data_decs</span></a></span><span>
</span><span id="line-243"></span><span>  </span><span class="annot"><span class="annottext">([LetBind], ALetDecEnv)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(String, String) -&gt; [DLetDec] -&gt; PrM ([LetBind], ALetDecEnv)
</span><a href="Data.Singletons.Promote.html#promoteLetDecs"><span class="hs-identifier hs-var">promoteLetDecs</span></a></span><span> </span><span class="annot"><span class="annottext">(String, String)
</span><a href="Data.Singletons.Util.html#noPrefix"><span class="hs-identifier hs-var">noPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361029"><span class="hs-identifier hs-var">rec_selectors</span></a></span><span>
</span><span id="line-244"></span><span>  </span><span class="annot"><span class="annottext">(DataDecl -&gt; PrM ()) -&gt; [DataDecl] -&gt; PrM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">DataDecl -&gt; PrM ()
</span><a href="Data.Singletons.Promote.html#promoteDataDec"><span class="hs-identifier hs-var">promoteDataDec</span></a></span><span> </span><span class="annot"><span class="annottext">[DataDecl]
</span><a href="#local-6989586621681361030"><span class="hs-identifier hs-var">data_decs</span></a></span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-246"></span><span>    </span><span class="annot"><a href="#local-6989586621681361028"><span class="hs-identifier hs-type">extract_rec_selectors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DLetDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-247"></span><span>    </span><span id="local-6989586621681361028"><span class="annot"><span class="annottext">extract_rec_selectors :: DataDecl -&gt; PrM [DLetDec]
</span><a href="#local-6989586621681361028"><span class="hs-identifier hs-var hs-var">extract_rec_selectors</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a></span><span> </span><span id="local-6989586621681361026"><span class="annot"><span class="annottext">data_name :: Name
</span><a href="#local-6989586621681361026"><span class="hs-identifier hs-var">data_name</span></a></span></span><span> </span><span id="local-6989586621681361025"><span class="annot"><span class="annottext">tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681361025"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span id="local-6989586621681361024"><span class="annot"><span class="annottext">cons :: [DCon]
</span><a href="#local-6989586621681361024"><span class="hs-identifier hs-var">cons</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-248"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361023"><span class="annot"><span class="annottext">arg_ty :: DType
</span><a href="#local-6989586621681361023"><span class="hs-identifier hs-var hs-var">arg_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DTyVarBndr] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361026"><span class="hs-identifier hs-var">data_name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681361025"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-249"></span><span>      </span><span class="hs-keyword">in</span><span>
</span><span id="line-250"></span><span>      </span><span class="annot"><span class="annottext">DType -&gt; [DCon] -&gt; PrM [DLetDec]
forall (q :: * -&gt; *). DsMonad q =&gt; DType -&gt; [DCon] -&gt; q [DLetDec]
</span><span class="hs-identifier hs-var">getRecordSelectors</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681361023"><span class="hs-identifier hs-var">arg_ty</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681361024"><span class="hs-identifier hs-var">cons</span></a></span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span class="hs-comment">-- curious about ALetDecEnv? See the LetDecEnv module for an explanation.</span><span>
</span><span id="line-253"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteLetDecs"><span class="hs-identifier hs-type">promoteLetDecs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- (alpha, symb) prefixes to use</span><span>
</span><span id="line-254"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DLetDec</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#LetBind"><span class="hs-identifier hs-type">LetBind</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ALetDecEnv"><span class="hs-identifier hs-type">ALetDecEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-comment">-- See Note [Promoting declarations in two stages]</span><span>
</span><span id="line-256"></span><span id="promoteLetDecs"><span class="annot"><span class="annottext">promoteLetDecs :: (String, String) -&gt; [DLetDec] -&gt; PrM ([LetBind], ALetDecEnv)
</span><a href="Data.Singletons.Promote.html#promoteLetDecs"><span class="hs-identifier hs-var hs-var">promoteLetDecs</span></a></span></span><span> </span><span id="local-6989586621681361021"><span class="annot"><span class="annottext">prefixes :: (String, String)
</span><a href="#local-6989586621681361021"><span class="hs-identifier hs-var">prefixes</span></a></span></span><span> </span><span id="local-6989586621681361020"><span class="annot"><span class="annottext">decls :: [DLetDec]
</span><a href="#local-6989586621681361020"><span class="hs-identifier hs-var">decls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-257"></span><span>  </span><span id="local-6989586621681361019"><span class="annot"><span class="annottext">LetDecEnv Unannotated
</span><a href="#local-6989586621681361019"><span class="hs-identifier hs-var">let_dec_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DLetDec] -&gt; PrM (LetDecEnv Unannotated)
forall (q :: * -&gt; *).
Quasi q =&gt;
[DLetDec] -&gt; q (LetDecEnv Unannotated)
</span><a href="Data.Singletons.Syntax.html#buildLetDecEnv"><span class="hs-identifier hs-var">buildLetDecEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681361020"><span class="hs-identifier hs-var">decls</span></a></span><span>
</span><span id="line-258"></span><span>  </span><span id="local-6989586621681361017"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361017"><span class="hs-identifier hs-var">all_locals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM [Name]
forall (m :: * -&gt; *). MonadReader PrEnv m =&gt; m [Name]
</span><a href="Data.Singletons.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a></span><span>
</span><span id="line-259"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361015"><span class="annot"><span class="annottext">binds :: [LetBind]
</span><a href="#local-6989586621681361015"><span class="hs-identifier hs-var hs-var">binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361014"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; DCxt -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361012"><span class="hs-identifier hs-var">sym</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; DCxt
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361017"><span class="hs-identifier hs-var">all_locals</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681361014"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681361014"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OMap Name (LetDecRHS Unannotated)
-&gt; [(Name, LetDecRHS Unannotated)]
forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">(OMap Name (LetDecRHS Unannotated)
 -&gt; [(Name, LetDecRHS Unannotated)])
-&gt; OMap Name (LetDecRHS Unannotated)
-&gt; [(Name, LetDecRHS Unannotated)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LetDecEnv Unannotated -&gt; OMap Name (LetDecRHS Unannotated)
forall (ann :: AnnotationFlag).
LetDecEnv ann -&gt; OMap Name (LetDecRHS ann)
</span><a href="Data.Singletons.Syntax.html#lde_defns"><span class="hs-identifier hs-var hs-var">lde_defns</span></a></span><span> </span><span class="annot"><span class="annottext">LetDecEnv Unannotated
</span><a href="#local-6989586621681361019"><span class="hs-identifier hs-var">let_dec_env</span></a></span><span>
</span><span id="line-261"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681361008"><span class="annot"><span class="annottext">proName :: Name
</span><a href="#local-6989586621681361008"><span class="hs-identifier hs-var hs-var">proName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String, String) -&gt; Name -&gt; Name
</span><a href="Data.Singletons.Names.html#promoteValNameLhsPrefix"><span class="hs-identifier hs-var">promoteValNameLhsPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">(String, String)
</span><a href="#local-6989586621681361021"><span class="hs-identifier hs-var">prefixes</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361014"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-262"></span><span>                    </span><span id="local-6989586621681361012"><span class="annot"><span class="annottext">sym :: Name
</span><a href="#local-6989586621681361012"><span class="hs-identifier hs-var hs-var">sym</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Int -&gt; Name
</span><a href="Data.Singletons.Names.html#promoteTySym"><span class="hs-identifier hs-var">promoteTySym</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681361008"><span class="hs-identifier hs-var">proName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Name] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681361017"><span class="hs-identifier hs-var">all_locals</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681361004"><span class="annot"><span class="annottext">decs :: [DDec]
</span><a href="#local-6989586621681361004"><span class="hs-identifier hs-var">decs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681361003"><span class="annot"><span class="annottext">let_dec_env' :: ALetDecEnv
</span><a href="#local-6989586621681361003"><span class="hs-identifier hs-var">let_dec_env'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LetBind] -&gt; PrM ([DDec], ALetDecEnv) -&gt; PrM ([DDec], ALetDecEnv)
forall a. [LetBind] -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.Promote.Monad.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">[LetBind]
</span><a href="#local-6989586621681361015"><span class="hs-identifier hs-var">binds</span></a></span><span> </span><span class="annot"><span class="annottext">(PrM ([DDec], ALetDecEnv) -&gt; PrM ([DDec], ALetDecEnv))
-&gt; PrM ([DDec], ALetDecEnv) -&gt; PrM ([DDec], ALetDecEnv)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, String)
-&gt; LetDecEnv Unannotated -&gt; PrM ([DDec], ALetDecEnv)
</span><a href="Data.Singletons.Promote.html#promoteLetDecEnv"><span class="hs-identifier hs-var">promoteLetDecEnv</span></a></span><span> </span><span class="annot"><span class="annottext">(String, String)
</span><a href="#local-6989586621681361021"><span class="hs-identifier hs-var">prefixes</span></a></span><span> </span><span class="annot"><span class="annottext">LetDecEnv Unannotated
</span><a href="#local-6989586621681361019"><span class="hs-identifier hs-var">let_dec_env</span></a></span><span>
</span><span id="line-264"></span><span>  </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681361004"><span class="hs-identifier hs-var">decs</span></a></span><span>
</span><span id="line-265"></span><span>  </span><span class="annot"><span class="annottext">([LetBind], ALetDecEnv) -&gt; PrM ([LetBind], ALetDecEnv)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LetBind]
</span><a href="#local-6989586621681361015"><span class="hs-identifier hs-var">binds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ALetDecEnv
</span><a href="#local-6989586621681361003"><span class="hs-identifier hs-var">let_dec_env'</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lde_proms :: IfAnn Annotated (OMap Name DType) ()
</span><a href="Data.Singletons.Syntax.html#lde_proms"><span class="hs-identifier hs-var">lde_proms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LetBind] -&gt; OMap Name DType
forall k v. Ord k =&gt; [(k, v)] -&gt; OMap k v
</span><span class="hs-identifier hs-var">OMap.fromList</span></span><span> </span><span class="annot"><span class="annottext">[LetBind]
</span><a href="#local-6989586621681361015"><span class="hs-identifier hs-var">binds</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span class="hs-comment">-- Promotion of data types to kinds is automatic (see &quot;Giving Haskell a</span><span>
</span><span id="line-268"></span><span class="hs-comment">-- Promotion&quot; paper for more details). Here we &quot;plug into&quot; the promotion</span><span>
</span><span id="line-269"></span><span class="hs-comment">-- mechanism to add some extra stuff to the promotion:</span><span>
</span><span id="line-270"></span><span class="hs-comment">--</span><span>
</span><span id="line-271"></span><span class="hs-comment">--  * if data type derives Eq we generate a type family that implements the</span><span>
</span><span id="line-272"></span><span class="hs-comment">--    equality test for the data type.</span><span>
</span><span id="line-273"></span><span class="hs-comment">--</span><span>
</span><span id="line-274"></span><span class="hs-comment">--  * for each data constructor with arity greater than 0 we generate type level</span><span>
</span><span id="line-275"></span><span class="hs-comment">--    symbols for use with Apply type family. In this way promoted data</span><span>
</span><span id="line-276"></span><span class="hs-comment">--    constructors and promoted functions can be used in a uniform way at the</span><span>
</span><span id="line-277"></span><span class="hs-comment">--    type level in the same way they can be used uniformly at the type level.</span><span>
</span><span id="line-278"></span><span class="hs-comment">--</span><span>
</span><span id="line-279"></span><span class="hs-comment">--  * for each nullary data constructor we generate a type synonym</span><span>
</span><span id="line-280"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteDataDec"><span class="hs-identifier hs-type">promoteDataDec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span id="promoteDataDec"><span class="annot"><span class="annottext">promoteDataDec :: DataDecl -&gt; PrM ()
</span><a href="Data.Singletons.Promote.html#promoteDataDec"><span class="hs-identifier hs-var hs-var">promoteDataDec</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a></span><span> </span><span id="local-6989586621681360997"><span class="annot"><span class="annottext">_name :: Name
</span><a href="#local-6989586621681360997"><span class="hs-identifier hs-var">_name</span></a></span></span><span> </span><span id="local-6989586621681360996"><span class="annot"><span class="annottext">_tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681360996"><span class="hs-identifier hs-var">_tvbs</span></a></span></span><span> </span><span id="local-6989586621681360995"><span class="annot"><span class="annottext">ctors :: [DCon]
</span><a href="#local-6989586621681360995"><span class="hs-identifier hs-var">ctors</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-282"></span><span>  </span><span id="local-6989586621681360994"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681360994"><span class="hs-identifier hs-var">ctorSyms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DCon] -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsDataD"><span class="hs-identifier hs-var">buildDefunSymsDataD</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681360995"><span class="hs-identifier hs-var">ctors</span></a></span><span>
</span><span id="line-283"></span><span>  </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681360994"><span class="hs-identifier hs-var">ctorSyms</span></a></span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span class="hs-comment">-- Note [CUSKification]</span><span>
</span><span id="line-286"></span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-287"></span><span class="hs-comment">-- GHC #12928 means that sometimes, this TH code will produce a declaration</span><span>
</span><span id="line-288"></span><span class="hs-comment">-- that has a kind signature even when we want kind inference to work. There</span><span>
</span><span id="line-289"></span><span class="hs-comment">-- seems to be no way to avoid this, so we embrace it:</span><span>
</span><span id="line-290"></span><span class="hs-comment">--</span><span>
</span><span id="line-291"></span><span class="hs-comment">--   * If a class type variable has no explicit kind, we make no effort to</span><span>
</span><span id="line-292"></span><span class="hs-comment">--     guess it and default to *. This is OK because before GHC 8.0, we were</span><span>
</span><span id="line-293"></span><span class="hs-comment">--     limited by KProxy anyway.</span><span>
</span><span id="line-294"></span><span class="hs-comment">--</span><span>
</span><span id="line-295"></span><span class="hs-comment">--   * If a class type variable has an explicit kind, it is preserved.</span><span>
</span><span id="line-296"></span><span class="hs-comment">--</span><span>
</span><span id="line-297"></span><span class="hs-comment">-- This way, we always get proper CUSKs where we need them.</span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteClassDec"><span class="hs-identifier hs-type">promoteClassDec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#UClassDecl"><span class="hs-identifier hs-type">UClassDecl</span></a></span><span>
</span><span id="line-300"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#AClassDecl"><span class="hs-identifier hs-type">AClassDecl</span></a></span><span>
</span><span id="line-301"></span><span id="promoteClassDec"><span class="annot"><span class="annottext">promoteClassDec :: UClassDecl -&gt; PrM AClassDecl
</span><a href="Data.Singletons.Promote.html#promoteClassDec"><span class="hs-identifier hs-var hs-var">promoteClassDec</span></a></span></span><span> </span><span id="local-6989586621681360992"><span class="annot"><span class="annottext">decl :: UClassDecl
</span><a href="#local-6989586621681360992"><span class="hs-identifier hs-var">decl</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#ClassDecl"><span class="hs-identifier hs-type">ClassDecl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cd_name :: forall (ann :: AnnotationFlag). ClassDecl ann -&gt; Name
</span><a href="Data.Singletons.Syntax.html#cd_name"><span class="hs-identifier hs-var">cd_name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360989"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360989"><span class="hs-identifier hs-var">cls_name</span></a></span></span><span>
</span><span id="line-302"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cd_tvbs :: forall (ann :: AnnotationFlag). ClassDecl ann -&gt; [DTyVarBndr]
</span><a href="Data.Singletons.Syntax.html#cd_tvbs"><span class="hs-identifier hs-var">cd_tvbs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360987"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360987"><span class="hs-identifier hs-var">tvbs'</span></a></span></span><span>
</span><span id="line-303"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cd_fds :: forall (ann :: AnnotationFlag). ClassDecl ann -&gt; [FunDep]
</span><a href="Data.Singletons.Syntax.html#cd_fds"><span class="hs-identifier hs-var">cd_fds</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360985"><span class="annot"><span class="annottext">[FunDep]
</span><a href="#local-6989586621681360985"><span class="hs-identifier hs-var">fundeps</span></a></span></span><span>
</span><span id="line-304"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cd_lde :: forall (ann :: AnnotationFlag). ClassDecl ann -&gt; LetDecEnv ann
</span><a href="Data.Singletons.Syntax.html#cd_lde"><span class="hs-identifier hs-var">cd_lde</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360984"><span class="annot"><span class="annottext">lde :: LetDecEnv Unannotated
</span><a href="#local-6989586621681360984"><span class="hs-identifier hs-var">lde</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-type">LetDecEnv</span></a></span><span>
</span><span id="line-305"></span><span>                                    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lde_defns :: forall (ann :: AnnotationFlag).
LetDecEnv ann -&gt; OMap Name (LetDecRHS ann)
</span><a href="Data.Singletons.Syntax.html#lde_defns"><span class="hs-identifier hs-var">lde_defns</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360982"><span class="annot"><span class="annottext">OMap Name (LetDecRHS Unannotated)
</span><a href="#local-6989586621681360982"><span class="hs-identifier hs-var">defaults</span></a></span></span><span>
</span><span id="line-306"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_types :: forall (ann :: AnnotationFlag). LetDecEnv ann -&gt; OMap Name DType
</span><a href="Data.Singletons.Syntax.html#lde_types"><span class="hs-identifier hs-var">lde_types</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360981"><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681360981"><span class="hs-identifier hs-var">meth_sigs</span></a></span></span><span>
</span><span id="line-307"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_infix :: forall (ann :: AnnotationFlag). LetDecEnv ann -&gt; OMap Name Fixity
</span><a href="Data.Singletons.Syntax.html#lde_infix"><span class="hs-identifier hs-var">lde_infix</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360979"><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621681360979"><span class="hs-identifier hs-var">infix_decls</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-308"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-comment">-- a workaround for GHC Trac #12928; see Note [CUSKification]</span><span>
</span><span id="line-310"></span><span>    </span><span id="local-6989586621681360978"><span class="annot"><span class="annottext">tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681360978"><span class="hs-identifier hs-var hs-var">tvbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; DTyVarBndr) -&gt; [DTyVarBndr] -&gt; [DTyVarBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; DTyVarBndr
</span><a href="Data.Singletons.Util.html#cuskify"><span class="hs-identifier hs-var">cuskify</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360987"><span class="hs-identifier hs-var">tvbs'</span></a></span><span>
</span><span id="line-311"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360976"><span class="annot"><span class="annottext">pClsName :: Name
</span><a href="#local-6989586621681360976"><span class="hs-identifier hs-var hs-var">pClsName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#promoteClassName"><span class="hs-identifier hs-var">promoteClassName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360989"><span class="hs-identifier hs-var">cls_name</span></a></span><span>
</span><span id="line-312"></span><span>  </span><span class="annot"><span class="annottext">OSet Name -&gt; PrM AClassDecl -&gt; PrM AClassDecl
forall a. OSet Name -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681360973"><span class="hs-identifier hs-var">cls_kvs_to_bind</span></a></span><span> </span><span class="annot"><span class="annottext">(PrM AClassDecl -&gt; PrM AClassDecl)
-&gt; PrM AClassDecl -&gt; PrM AClassDecl
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-313"></span><span>    </span><span id="local-6989586621681360972"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681360972"><span class="hs-identifier hs-var">sig_decs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(LetBind -&gt; PrM DDec) -&gt; [LetBind] -&gt; PrM [DDec]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DType -&gt; PrM DDec) -&gt; LetBind -&gt; PrM DDec
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType -&gt; PrM DDec
</span><a href="#local-6989586621681360970"><span class="hs-identifier hs-var">promote_sig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OMap Name DType -&gt; [LetBind]
forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681360981"><span class="hs-identifier hs-var">meth_sigs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360969"><span class="annot"><span class="annottext">defaults_list :: [(Name, LetDecRHS Unannotated)]
</span><a href="#local-6989586621681360969"><span class="hs-identifier hs-var hs-var">defaults_list</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OMap Name (LetDecRHS Unannotated)
-&gt; [(Name, LetDecRHS Unannotated)]
forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name (LetDecRHS Unannotated)
</span><a href="#local-6989586621681360982"><span class="hs-identifier hs-var">defaults</span></a></span><span>
</span><span id="line-315"></span><span>        </span><span id="local-6989586621681360968"><span class="annot"><span class="annottext">defaults_names :: [Name]
</span><a href="#local-6989586621681360968"><span class="hs-identifier hs-var hs-var">defaults_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Name, LetDecRHS Unannotated) -&gt; Name)
-&gt; [(Name, LetDecRHS Unannotated)] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, LetDecRHS Unannotated) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Name, LetDecRHS Unannotated)]
</span><a href="#local-6989586621681360969"><span class="hs-identifier hs-var">defaults_list</span></a></span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681360967"><span class="annot"><span class="annottext">default_decs :: [DDec]
</span><a href="#local-6989586621681360967"><span class="hs-identifier hs-var">default_decs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360966"><span class="annot"><span class="annottext">ann_rhss :: [ALetDecRHS]
</span><a href="#local-6989586621681360966"><span class="hs-identifier hs-var">ann_rhss</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360965"><span class="annot"><span class="annottext">prom_rhss :: DCxt
</span><a href="#local-6989586621681360965"><span class="hs-identifier hs-var">prom_rhss</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Name, LetDecRHS Unannotated) -&gt; PrM (DDec, ALetDecRHS, DType))
-&gt; [(Name, LetDecRHS Unannotated)]
-&gt; PrM ([DDec], [ALetDecRHS], DCxt)
forall (m :: * -&gt; *) a b c d.
Monad m =&gt;
(a -&gt; m (b, c, d)) -&gt; [a] -&gt; m ([b], [c], [d])
</span><a href="Data.Singletons.Util.html#mapAndUnzip3M"><span class="hs-identifier hs-var">mapAndUnzip3M</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OMap Name DType
-&gt; Maybe (Map Name DType)
-&gt; OMap Name DType
-&gt; (Name, LetDecRHS Unannotated)
-&gt; PrM (DDec, ALetDecRHS, DType)
</span><a href="Data.Singletons.Promote.html#promoteMethod"><span class="hs-identifier hs-var">promoteMethod</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
forall k v. OMap k v
</span><span class="hs-identifier hs-var">OMap.empty</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Map Name DType)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681360981"><span class="hs-identifier hs-var">meth_sigs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, LetDecRHS Unannotated)]
</span><a href="#local-6989586621681360969"><span class="hs-identifier hs-var">defaults_list</span></a></span><span>
</span><span id="line-318"></span><span>
</span><span id="line-319"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360962"><span class="annot"><span class="annottext">infix_decls' :: [DDec]
</span><a href="#local-6989586621681360962"><span class="hs-identifier hs-var hs-var">infix_decls'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe DDec] -&gt; [DDec]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">([Maybe DDec] -&gt; [DDec]) -&gt; [Maybe DDec] -&gt; [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Name, Fixity) -&gt; Maybe DDec) -&gt; [(Name, Fixity)] -&gt; [Maybe DDec]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; Fixity -&gt; Maybe DDec) -&gt; (Name, Fixity) -&gt; Maybe DDec
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Fixity -&gt; Maybe DDec
</span><a href="Data.Singletons.Promote.html#promoteInfixDecl"><span class="hs-identifier hs-var">promoteInfixDecl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>                                 </span><span class="annot"><span class="annottext">([(Name, Fixity)] -&gt; [Maybe DDec])
-&gt; [(Name, Fixity)] -&gt; [Maybe DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity -&gt; [(Name, Fixity)]
forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621681360979"><span class="hs-identifier hs-var">infix_decls</span></a></span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-comment">-- no need to do anything to the fundeps. They work as is!</span><span>
</span><span id="line-323"></span><span>    </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DCxt -&gt; Name -&gt; [DTyVarBndr] -&gt; [FunDep] -&gt; [DDec] -&gt; DDec
</span><span class="hs-identifier hs-var">DClassD</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360976"><span class="hs-identifier hs-var">pClsName</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360978"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">[FunDep]
</span><a href="#local-6989586621681360985"><span class="hs-identifier hs-var">fundeps</span></a></span><span>
</span><span id="line-324"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681360972"><span class="hs-identifier hs-var">sig_decs</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [DDec] -&gt; [DDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681360967"><span class="hs-identifier hs-var">default_decs</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [DDec] -&gt; [DDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681360962"><span class="hs-identifier hs-var">infix_decls'</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360958"><span class="annot"><span class="annottext">defaults_list' :: [(Name, ALetDecRHS)]
</span><a href="#local-6989586621681360958"><span class="hs-identifier hs-var hs-var">defaults_list'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [ALetDecRHS] -&gt; [(Name, ALetDecRHS)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360968"><span class="hs-identifier hs-var">defaults_names</span></a></span><span> </span><span class="annot"><span class="annottext">[ALetDecRHS]
</span><a href="#local-6989586621681360966"><span class="hs-identifier hs-var">ann_rhss</span></a></span><span>
</span><span id="line-326"></span><span>        </span><span id="local-6989586621681360957"><span class="annot"><span class="annottext">proms :: [LetBind]
</span><a href="#local-6989586621681360957"><span class="hs-identifier hs-var hs-var">proms</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; DCxt -&gt; [LetBind]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360968"><span class="hs-identifier hs-var">defaults_names</span></a></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360965"><span class="hs-identifier hs-var">prom_rhss</span></a></span><span>
</span><span id="line-327"></span><span>        </span><span id="local-6989586621681360956"><span class="annot"><span class="annottext">cls_kvs_to_bind' :: OMap Name (OSet Name)
</span><a href="#local-6989586621681360956"><span class="hs-identifier hs-var hs-var">cls_kvs_to_bind'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681360973"><span class="hs-identifier hs-var">cls_kvs_to_bind</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name -&gt; OMap Name DType -&gt; OMap Name (OSet Name)
forall (f :: * -&gt; *) a b. Functor f =&gt; a -&gt; f b -&gt; f a
</span><span class="hs-operator hs-var">&lt;$</span></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681360981"><span class="hs-identifier hs-var">meth_sigs</span></a></span><span>
</span><span id="line-328"></span><span>    </span><span class="annot"><span class="annottext">AClassDecl -&gt; PrM AClassDecl
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UClassDecl
</span><a href="#local-6989586621681360992"><span class="hs-identifier hs-var">decl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cd_lde :: ALetDecEnv
</span><a href="Data.Singletons.Syntax.html#cd_lde"><span class="hs-identifier hs-var">cd_lde</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LetDecEnv Unannotated
</span><a href="#local-6989586621681360984"><span class="hs-identifier hs-var">lde</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lde_defns :: OMap Name ALetDecRHS
</span><a href="Data.Singletons.Syntax.html#lde_defns"><span class="hs-identifier hs-var">lde_defns</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, ALetDecRHS)] -&gt; OMap Name ALetDecRHS
forall k v. Ord k =&gt; [(k, v)] -&gt; OMap k v
</span><span class="hs-identifier hs-var">OMap.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, ALetDecRHS)]
</span><a href="#local-6989586621681360958"><span class="hs-identifier hs-var">defaults_list'</span></a></span><span>
</span><span id="line-329"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_proms :: IfAnn Annotated (OMap Name DType) ()
</span><a href="Data.Singletons.Syntax.html#lde_proms"><span class="hs-identifier hs-var">lde_proms</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LetBind] -&gt; OMap Name DType
forall k v. Ord k =&gt; [(k, v)] -&gt; OMap k v
</span><span class="hs-identifier hs-var">OMap.fromList</span></span><span> </span><span class="annot"><span class="annottext">[LetBind]
</span><a href="#local-6989586621681360957"><span class="hs-identifier hs-var">proms</span></a></span><span>
</span><span id="line-330"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_bound_kvs :: IfAnn Annotated (OMap Name (OSet Name)) ()
</span><a href="Data.Singletons.Syntax.html#lde_bound_kvs"><span class="hs-identifier hs-var">lde_bound_kvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OMap Name (OSet Name)
IfAnn Annotated (OMap Name (OSet Name)) ()
</span><a href="#local-6989586621681360956"><span class="hs-identifier hs-var">cls_kvs_to_bind'</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-332"></span><span>    </span><span class="annot"><a href="#local-6989586621681360953"><span class="hs-identifier hs-type">cls_kvb_names</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681360952"><span class="hs-identifier hs-type">cls_tvb_names</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681360973"><span class="hs-identifier hs-type">cls_kvs_to_bind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OSet</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span>
</span><span id="line-333"></span><span>    </span><span id="local-6989586621681360953"><span class="annot"><span class="annottext">cls_kvb_names :: OSet Name
</span><a href="#local-6989586621681360953"><span class="hs-identifier hs-var hs-var">cls_kvb_names</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; OSet Name) -&gt; [DTyVarBndr] -&gt; OSet Name
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DType -&gt; OSet Name) -&gt; Maybe DType -&gt; OSet Name
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; OSet Name
</span><span class="hs-identifier hs-var">fvDType</span></span><span> </span><span class="annot"><span class="annottext">(Maybe DType -&gt; OSet Name)
-&gt; (DTyVarBndr -&gt; Maybe DType) -&gt; DTyVarBndr -&gt; OSet Name
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; Maybe DType
</span><a href="Data.Singletons.Util.html#extractTvbKind"><span class="hs-identifier hs-var">extractTvbKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360987"><span class="hs-identifier hs-var">tvbs'</span></a></span><span>
</span><span id="line-334"></span><span>    </span><span id="local-6989586621681360952"><span class="annot"><span class="annottext">cls_tvb_names :: OSet Name
</span><a href="#local-6989586621681360952"><span class="hs-identifier hs-var hs-var">cls_tvb_names</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; OSet Name
forall a. Ord a =&gt; [a] -&gt; OSet a
</span><span class="hs-identifier hs-var">OSet.fromList</span></span><span> </span><span class="annot"><span class="annottext">([Name] -&gt; OSet Name) -&gt; [Name] -&gt; OSet Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; Name) -&gt; [DTyVarBndr] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; Name
</span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360987"><span class="hs-identifier hs-var">tvbs'</span></a></span><span>
</span><span id="line-335"></span><span>    </span><span id="local-6989586621681360973"><span class="annot"><span class="annottext">cls_kvs_to_bind :: OSet Name
</span><a href="#local-6989586621681360973"><span class="hs-identifier hs-var hs-var">cls_kvs_to_bind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681360953"><span class="hs-identifier hs-var">cls_kvb_names</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name -&gt; OSet Name -&gt; OSet Name
forall a. Ord a =&gt; OSet a -&gt; OSet a -&gt; OSet a
</span><span class="hs-operator hs-var">`OSet.union`</span></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681360952"><span class="hs-identifier hs-var">cls_tvb_names</span></a></span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span>    </span><span class="annot"><a href="#local-6989586621681360970"><span class="hs-identifier hs-type">promote_sig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span>
</span><span id="line-338"></span><span>    </span><span id="local-6989586621681360970"><span class="annot"><span class="annottext">promote_sig :: Name -&gt; DType -&gt; PrM DDec
</span><a href="#local-6989586621681360970"><span class="hs-identifier hs-var hs-var">promote_sig</span></a></span></span><span> </span><span id="local-6989586621681360946"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681360946"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681360945"><span class="annot"><span class="annottext">ty :: DType
</span><a href="#local-6989586621681360945"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-339"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360944"><span class="annot"><span class="annottext">proName :: Name
</span><a href="#local-6989586621681360944"><span class="hs-identifier hs-var hs-var">proName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#promoteValNameLhs"><span class="hs-identifier hs-var">promoteValNameLhs</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360946"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-340"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621681360942"><span class="annot"><span class="annottext">argKs :: DCxt
</span><a href="#local-6989586621681360942"><span class="hs-identifier hs-var">argKs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360941"><span class="annot"><span class="annottext">resK :: DType
</span><a href="#local-6989586621681360941"><span class="hs-identifier hs-var">resK</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DType -&gt; PrM (DCxt, DType)
forall (m :: * -&gt; *). MonadFail m =&gt; DType -&gt; m (DCxt, DType)
</span><a href="Data.Singletons.Promote.Type.html#promoteUnraveled"><span class="hs-identifier hs-var">promoteUnraveled</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360945"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-341"></span><span>      </span><span id="local-6989586621681360939"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360939"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; PrM Name) -&gt; DCxt -&gt; PrM [Name]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrM Name -&gt; DType -&gt; PrM Name
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(PrM Name -&gt; DType -&gt; PrM Name) -&gt; PrM Name -&gt; DType -&gt; PrM Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; PrM Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="hs-string">&quot;arg&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360942"><span class="hs-identifier hs-var">argKs</span></a></span><span>
</span><span id="line-342"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360936"><span class="annot"><span class="annottext">tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681360936"><span class="hs-identifier hs-var hs-var">tvbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DType -&gt; DTyVarBndr) -&gt; [Name] -&gt; DCxt -&gt; [DTyVarBndr]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType -&gt; DTyVarBndr
</span><span class="hs-identifier hs-var">DKindedTV</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360939"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360942"><span class="hs-identifier hs-var">argKs</span></a></span><span>
</span><span id="line-343"></span><span>      </span><span class="annot"><span class="annottext">PrM [DDec] -&gt; PrM ()
forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; m [DDec] -&gt; m ()
</span><a href="Data.Singletons.Promote.Monad.html#emitDecsM"><span class="hs-identifier hs-var">emitDecsM</span></a></span><span> </span><span class="annot"><span class="annottext">(PrM [DDec] -&gt; PrM ()) -&gt; PrM [DDec] -&gt; PrM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; [DTyVarBndr] -&gt; Maybe DType -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#defunReifyFixity"><span class="hs-identifier hs-var">defunReifyFixity</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360944"><span class="hs-identifier hs-var">proName</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360936"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360941"><span class="hs-identifier hs-var">resK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span>      </span><span class="annot"><span class="annottext">DDec -&gt; PrM DDec
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DDec -&gt; PrM DDec) -&gt; DDec -&gt; PrM DDec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DTypeFamilyHead -&gt; DDec
</span><span class="hs-identifier hs-var">DOpenTypeFamilyD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
-&gt; [DTyVarBndr]
-&gt; DFamilyResultSig
-&gt; Maybe InjectivityAnn
-&gt; DTypeFamilyHead
</span><span class="hs-identifier hs-var">DTypeFamilyHead</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360944"><span class="hs-identifier hs-var">proName</span></a></span><span>
</span><span id="line-346"></span><span>                                                 </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360936"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-347"></span><span>                                                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DFamilyResultSig
</span><span class="hs-identifier hs-var">DKindSig</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360941"><span class="hs-identifier hs-var">resK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>                                                 </span><span class="annot"><span class="annottext">Maybe InjectivityAnn
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span class="hs-comment">-- returns (unpromoted method name, ALetDecRHS) pairs</span><span>
</span><span id="line-351"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteInstanceDec"><span class="hs-identifier hs-type">promoteInstanceDec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#UInstDecl"><span class="hs-identifier hs-type">UInstDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#AInstDecl"><span class="hs-identifier hs-type">AInstDecl</span></a></span><span>
</span><span id="line-352"></span><span id="promoteInstanceDec"><span class="annot"><span class="annottext">promoteInstanceDec :: OMap Name DType -&gt; UInstDecl -&gt; PrM AInstDecl
</span><a href="Data.Singletons.Promote.html#promoteInstanceDec"><span class="hs-identifier hs-var hs-var">promoteInstanceDec</span></a></span></span><span> </span><span id="local-6989586621681360928"><span class="annot"><span class="annottext">orig_meth_sigs :: OMap Name DType
</span><a href="#local-6989586621681360928"><span class="hs-identifier hs-var">orig_meth_sigs</span></a></span></span><span>
</span><span id="line-353"></span><span>                   </span><span id="local-6989586621681360927"><span class="annot"><span class="annottext">decl :: UInstDecl
</span><a href="#local-6989586621681360927"><span class="hs-identifier hs-var">decl</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#InstDecl"><span class="hs-identifier hs-type">InstDecl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">id_name :: forall (ann :: AnnotationFlag). InstDecl ann -&gt; Name
</span><a href="Data.Singletons.Syntax.html#id_name"><span class="hs-identifier hs-var">id_name</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360924"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360924"><span class="hs-identifier hs-var">cls_name</span></a></span></span><span>
</span><span id="line-354"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">id_arg_tys :: forall (ann :: AnnotationFlag). InstDecl ann -&gt; DCxt
</span><a href="Data.Singletons.Syntax.html#id_arg_tys"><span class="hs-identifier hs-var">id_arg_tys</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360922"><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360922"><span class="hs-identifier hs-var">inst_tys</span></a></span></span><span>
</span><span id="line-355"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">id_sigs :: forall (ann :: AnnotationFlag). InstDecl ann -&gt; OMap Name DType
</span><a href="Data.Singletons.Syntax.html#id_sigs"><span class="hs-identifier hs-var">id_sigs</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360920"><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681360920"><span class="hs-identifier hs-var">inst_sigs</span></a></span></span><span>
</span><span id="line-356"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">id_meths :: forall (ann :: AnnotationFlag).
InstDecl ann -&gt; [(Name, LetDecRHS ann)]
</span><a href="Data.Singletons.Syntax.html#id_meths"><span class="hs-identifier hs-var">id_meths</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360918"><span class="annot"><span class="annottext">[(Name, LetDecRHS Unannotated)]
</span><a href="#local-6989586621681360918"><span class="hs-identifier hs-var">meths</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-357"></span><span>  </span><span id="local-6989586621681360917"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360917"><span class="hs-identifier hs-var">cls_tvb_names</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM [Name]
</span><a href="#local-6989586621681360916"><span class="hs-identifier hs-var">lookup_cls_tvb_names</span></a></span><span>
</span><span id="line-358"></span><span>  </span><span id="local-6989586621681360915"><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360915"><span class="hs-identifier hs-var">inst_kis</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; PrM DType) -&gt; DCxt -&gt; PrM DCxt
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; PrM DType
forall (m :: * -&gt; *). MonadFail m =&gt; DType -&gt; m DType
</span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360922"><span class="hs-identifier hs-var">inst_tys</span></a></span><span>
</span><span id="line-359"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360914"><span class="annot"><span class="annottext">kvs_to_bind :: OSet Name
</span><a href="#local-6989586621681360914"><span class="hs-identifier hs-var hs-var">kvs_to_bind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; OSet Name) -&gt; DCxt -&gt; OSet Name
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; OSet Name
</span><span class="hs-identifier hs-var">fvDType</span></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360915"><span class="hs-identifier hs-var">inst_kis</span></a></span><span>
</span><span id="line-360"></span><span>  </span><span class="annot"><span class="annottext">OSet Name -&gt; PrM AInstDecl -&gt; PrM AInstDecl
forall a. OSet Name -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681360914"><span class="hs-identifier hs-var">kvs_to_bind</span></a></span><span> </span><span class="annot"><span class="annottext">(PrM AInstDecl -&gt; PrM AInstDecl) -&gt; PrM AInstDecl -&gt; PrM AInstDecl
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-361"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360913"><span class="annot"><span class="annottext">subst :: Map Name DType
</span><a href="#local-6989586621681360913"><span class="hs-identifier hs-var hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LetBind] -&gt; Map Name DType
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">([LetBind] -&gt; Map Name DType) -&gt; [LetBind] -&gt; Map Name DType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; DCxt -&gt; [LetBind]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360917"><span class="hs-identifier hs-var">cls_tvb_names</span></a></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360915"><span class="hs-identifier hs-var">inst_kis</span></a></span><span>
</span><span id="line-362"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681360911"><span class="annot"><span class="annottext">meths' :: [DDec]
</span><a href="#local-6989586621681360911"><span class="hs-identifier hs-var">meths'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360910"><span class="annot"><span class="annottext">ann_rhss :: [ALetDecRHS]
</span><a href="#local-6989586621681360910"><span class="hs-identifier hs-var">ann_rhss</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Name, LetDecRHS Unannotated) -&gt; PrM (DDec, ALetDecRHS, DType))
-&gt; [(Name, LetDecRHS Unannotated)]
-&gt; PrM ([DDec], [ALetDecRHS], DCxt)
forall (m :: * -&gt; *) a b c d.
Monad m =&gt;
(a -&gt; m (b, c, d)) -&gt; [a] -&gt; m ([b], [c], [d])
</span><a href="Data.Singletons.Util.html#mapAndUnzip3M"><span class="hs-identifier hs-var">mapAndUnzip3M</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OMap Name DType
-&gt; Maybe (Map Name DType)
-&gt; OMap Name DType
-&gt; (Name, LetDecRHS Unannotated)
-&gt; PrM (DDec, ALetDecRHS, DType)
</span><a href="Data.Singletons.Promote.html#promoteMethod"><span class="hs-identifier hs-var">promoteMethod</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681360920"><span class="hs-identifier hs-var">inst_sigs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name DType -&gt; Maybe (Map Name DType)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Map Name DType
</span><a href="#local-6989586621681360913"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681360928"><span class="hs-identifier hs-var">orig_meth_sigs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, LetDecRHS Unannotated)]
</span><a href="#local-6989586621681360918"><span class="hs-identifier hs-var">meths</span></a></span><span>
</span><span id="line-363"></span><span>    </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Maybe Overlap
-&gt; Maybe [DTyVarBndr] -&gt; DCxt -&gt; DType -&gt; [DDec] -&gt; DDec
</span><span class="hs-identifier hs-var">DInstanceD</span></span><span> </span><span class="annot"><span class="annottext">Maybe Overlap
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe [DTyVarBndr]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DCxt -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360908"><span class="hs-identifier hs-var">pClsName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span>                                              </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360915"><span class="hs-identifier hs-var">inst_kis</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681360911"><span class="hs-identifier hs-var">meths'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-365"></span><span>    </span><span class="annot"><span class="annottext">AInstDecl -&gt; PrM AInstDecl
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInstDecl
</span><a href="#local-6989586621681360927"><span class="hs-identifier hs-var">decl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">id_meths :: [(Name, ALetDecRHS)]
</span><a href="Data.Singletons.Syntax.html#id_meths"><span class="hs-identifier hs-var">id_meths</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [ALetDecRHS] -&gt; [(Name, ALetDecRHS)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, LetDecRHS Unannotated) -&gt; Name)
-&gt; [(Name, LetDecRHS Unannotated)] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, LetDecRHS Unannotated) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Name, LetDecRHS Unannotated)]
</span><a href="#local-6989586621681360918"><span class="hs-identifier hs-var">meths</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ALetDecRHS]
</span><a href="#local-6989586621681360910"><span class="hs-identifier hs-var">ann_rhss</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-367"></span><span>    </span><span id="local-6989586621681360908"><span class="annot"><span class="annottext">pClsName :: Name
</span><a href="#local-6989586621681360908"><span class="hs-identifier hs-var hs-var">pClsName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#promoteClassName"><span class="hs-identifier hs-var">promoteClassName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360924"><span class="hs-identifier hs-var">cls_name</span></a></span><span>
</span><span id="line-368"></span><span>
</span><span id="line-369"></span><span>    </span><span class="annot"><a href="#local-6989586621681360916"><span class="hs-identifier hs-type">lookup_cls_tvb_names</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span>
</span><span id="line-370"></span><span>    </span><span id="local-6989586621681360916"><span class="annot"><span class="annottext">lookup_cls_tvb_names :: PrM [Name]
</span><a href="#local-6989586621681360916"><span class="hs-identifier hs-var hs-var">lookup_cls_tvb_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-371"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360907"><span class="annot"><span class="annottext">mk_tvb_names :: MaybeT PrM [Name]
</span><a href="#local-6989586621681360907"><span class="hs-identifier hs-var hs-var">mk_tvb_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrM (Maybe DInfo) -&gt; MaybeT PrM [Name]
</span><a href="#local-6989586621681360906"><span class="hs-identifier hs-var">extract_tvb_names</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; PrM (Maybe DInfo)
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe DInfo)
</span><a href="Data.Singletons.Util.html#dsReifyTypeNameInfo"><span class="hs-identifier hs-var">dsReifyTypeNameInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360908"><span class="hs-identifier hs-var">pClsName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>                     </span><span class="annot"><span class="annottext">MaybeT PrM [Name] -&gt; MaybeT PrM [Name] -&gt; MaybeT PrM [Name]
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">PrM (Maybe DInfo) -&gt; MaybeT PrM [Name]
</span><a href="#local-6989586621681360906"><span class="hs-identifier hs-var">extract_tvb_names</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; PrM (Maybe DInfo)
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe DInfo)
</span><a href="Data.Singletons.Util.html#dsReifyTypeNameInfo"><span class="hs-identifier hs-var">dsReifyTypeNameInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360924"><span class="hs-identifier hs-var">cls_name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span>                      </span><span class="hs-comment">-- See Note [Using dsReifyTypeNameInfo when promoting instances]</span><span>
</span><span id="line-374"></span><span>      </span><span id="local-6989586621681360903"><span class="annot"><span class="annottext">Maybe [Name]
</span><a href="#local-6989586621681360903"><span class="hs-identifier hs-var">mb_tvb_names</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MaybeT PrM [Name] -&gt; PrM (Maybe [Name])
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var hs-var">runMaybeT</span></span><span> </span><span class="annot"><span class="annottext">MaybeT PrM [Name]
</span><a href="#local-6989586621681360907"><span class="hs-identifier hs-var">mk_tvb_names</span></a></span><span>
</span><span id="line-375"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe [Name]
</span><a href="#local-6989586621681360903"><span class="hs-identifier hs-var">mb_tvb_names</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-376"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681360901"><span class="annot"><span class="annottext">tvb_names :: [Name]
</span><a href="#local-6989586621681360901"><span class="hs-identifier hs-var">tvb_names</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; PrM [Name]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360901"><span class="hs-identifier hs-var">tvb_names</span></a></span><span>
</span><span id="line-377"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrM [Name]
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; PrM [Name]) -&gt; String -&gt; PrM [Name]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Cannot find class declaration annotation for &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360924"><span class="hs-identifier hs-var">cls_name</span></a></span><span>
</span><span id="line-378"></span><span>
</span><span id="line-379"></span><span>    </span><span class="annot"><a href="#local-6989586621681360906"><span class="hs-identifier hs-type">extract_tvb_names</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DInfo</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaybeT</span></span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span>
</span><span id="line-380"></span><span>    </span><span id="local-6989586621681360906"><span class="annot"><span class="annottext">extract_tvb_names :: PrM (Maybe DInfo) -&gt; MaybeT PrM [Name]
</span><a href="#local-6989586621681360906"><span class="hs-identifier hs-var hs-var">extract_tvb_names</span></a></span></span><span> </span><span id="local-6989586621681360899"><span class="annot"><span class="annottext">reify_info :: PrM (Maybe DInfo)
</span><a href="#local-6989586621681360899"><span class="hs-identifier hs-var">reify_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-381"></span><span>      </span><span id="local-6989586621681360898"><span class="annot"><span class="annottext">Maybe DInfo
</span><a href="#local-6989586621681360898"><span class="hs-identifier hs-var">mb_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM (Maybe DInfo) -&gt; MaybeT PrM (Maybe DInfo)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">PrM (Maybe DInfo)
</span><a href="#local-6989586621681360899"><span class="hs-identifier hs-var">reify_info</span></a></span><span>
</span><span id="line-382"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe DInfo
</span><a href="#local-6989586621681360898"><span class="hs-identifier hs-var">mb_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-383"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTyConI</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DClassD</span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span id="local-6989586621681360896"><span class="annot"><span class="annottext">tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681360896"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; MaybeT PrM [Name]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([Name] -&gt; MaybeT PrM [Name]) -&gt; [Name] -&gt; MaybeT PrM [Name]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; Name) -&gt; [DTyVarBndr] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; Name
</span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360896"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-385"></span><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MaybeT PrM [Name]
forall (f :: * -&gt; *) a. Alternative f =&gt; f a
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span class="hs-comment">{-
Note [Using dsReifyTypeNameInfo when promoting instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
During the promotion of a class instance, it becomes necessary to reify the
original promoted class's info to learn various things. It's tempting to think
that just calling dsReify on the class name will be sufficient, but it's not.
Consider this class and its promotion:

  class Eq a where
    (==) :: a -&gt; a -&gt; Bool

  class PEq a where
    type (==) (x :: a) (y :: a) :: Bool

Notice how both of these classes have an identifier named (==), one at the
value level, and one at the type level. Now imagine what happens when you
attempt to promote this Template Haskell declaration:

   [d| f :: Bool
       f = () == () |]

When promoting ==, singletons will come up with its promoted equivalent (which also
happens to be ==). However, this promoted name is a raw Name, since it is created
with mkName. This becomes an issue when we call dsReify the raw &quot;==&quot; Name, as
Template Haskell has to arbitrarily choose between reifying the info for the
value-level (==) and the type-level (==), and in this case, it happens to pick the
value-level (==) info. We want the type-level (==) info, however, because we care
about the promoted version of (==).

Fortunately, there's a serviceable workaround. Instead of dsReify, we can use
dsReifyTypeNameInfo, which first calls lookupTypeName (to ensure we can find a Name
that's in the type namespace) and _then_ reifies it.
-}</span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteMethod"><span class="hs-identifier hs-type">promoteMethod</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span> </span><span class="hs-comment">-- InstanceSigs for methods</span><span>
</span><span id="line-422"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>                    </span><span class="hs-comment">-- ^ instantiations for class tyvars (Nothing for default decls)</span><span>
</span><span id="line-424"></span><span>                    </span><span class="hs-comment">--   See Note [Promoted class method kinds]</span><span>
</span><span id="line-425"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span>    </span><span class="hs-comment">-- method types</span><span>
</span><span id="line-426"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ULetDecRHS"><span class="hs-identifier hs-type">ULetDecRHS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ALetDecRHS"><span class="hs-identifier hs-type">ALetDecRHS</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span class="hs-special">)</span><span>
</span><span id="line-428"></span><span>                 </span><span class="hs-comment">-- returns (type instance, ALetDecRHS, promoted RHS)</span><span>
</span><span id="line-429"></span><span id="promoteMethod"><span class="annot"><span class="annottext">promoteMethod :: OMap Name DType
-&gt; Maybe (Map Name DType)
-&gt; OMap Name DType
-&gt; (Name, LetDecRHS Unannotated)
-&gt; PrM (DDec, ALetDecRHS, DType)
</span><a href="Data.Singletons.Promote.html#promoteMethod"><span class="hs-identifier hs-var hs-var">promoteMethod</span></a></span></span><span> </span><span id="local-6989586621681360892"><span class="annot"><span class="annottext">inst_sigs_map :: OMap Name DType
</span><a href="#local-6989586621681360892"><span class="hs-identifier hs-var">inst_sigs_map</span></a></span></span><span> </span><span id="local-6989586621681360891"><span class="annot"><span class="annottext">m_subst :: Maybe (Map Name DType)
</span><a href="#local-6989586621681360891"><span class="hs-identifier hs-var">m_subst</span></a></span></span><span> </span><span id="local-6989586621681360890"><span class="annot"><span class="annottext">orig_sigs_map :: OMap Name DType
</span><a href="#local-6989586621681360890"><span class="hs-identifier hs-var">orig_sigs_map</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681360889"><span class="annot"><span class="annottext">meth_name :: Name
</span><a href="#local-6989586621681360889"><span class="hs-identifier hs-var">meth_name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360888"><span class="annot"><span class="annottext">meth_rhs :: LetDecRHS Unannotated
</span><a href="#local-6989586621681360888"><span class="hs-identifier hs-var">meth_rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-430"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360887"><span class="annot"><span class="annottext">meth_arg_kis :: DCxt
</span><a href="#local-6989586621681360887"><span class="hs-identifier hs-var">meth_arg_kis</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360886"><span class="annot"><span class="annottext">meth_res_ki :: DType
</span><a href="#local-6989586621681360886"><span class="hs-identifier hs-var">meth_res_ki</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM (DCxt, DType)
</span><a href="#local-6989586621681360885"><span class="hs-identifier hs-var">lookup_meth_ty</span></a></span><span>
</span><span id="line-431"></span><span>  </span><span id="local-6989586621681360884"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360884"><span class="hs-identifier hs-var">meth_arg_tvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; PrM Name) -&gt; DCxt -&gt; PrM [Name]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrM Name -&gt; DType -&gt; PrM Name
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(PrM Name -&gt; DType -&gt; PrM Name) -&gt; PrM Name -&gt; DType -&gt; PrM Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; PrM Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="hs-string">&quot;a&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360887"><span class="hs-identifier hs-var">meth_arg_kis</span></a></span><span>
</span><span id="line-432"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360883"><span class="annot"><span class="annottext">helperNameBase :: String
</span><a href="#local-6989586621681360883"><span class="hs-identifier hs-var hs-var">helperNameBase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
</span><span class="hs-identifier hs-var">nameBase</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360881"><span class="hs-identifier hs-var">proName</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-433"></span><span>                         </span><span id="local-6989586621681360880"><span class="annot"><span class="annottext">first :: Char
</span><a href="#local-6989586621681360880"><span class="hs-identifier hs-var">first</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Bool
</span><a href="Data.Singletons.Util.html#isHsLetter"><span class="hs-identifier hs-var">isHsLetter</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621681360880"><span class="hs-identifier hs-var">first</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-string">&quot;TFHelper&quot;</span></span><span>
</span><span id="line-434"></span><span>                         </span><span id="local-6989586621681360877"><span class="annot"><span class="annottext">alpha :: String
</span><a href="#local-6989586621681360877"><span class="hs-identifier hs-var">alpha</span></a></span></span><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681360877"><span class="hs-identifier hs-var">alpha</span></a></span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span>      </span><span class="hs-comment">-- family_args are the type variables in a promoted class's</span><span>
</span><span id="line-437"></span><span>      </span><span class="hs-comment">-- associated type family instance (or default implementation), e.g.,</span><span>
</span><span id="line-438"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-439"></span><span>      </span><span class="hs-comment">--   class C k where</span><span>
</span><span id="line-440"></span><span>      </span><span class="hs-comment">--     type T (a :: k) (b :: Bool)</span><span>
</span><span id="line-441"></span><span>      </span><span class="hs-comment">--     type T a b = THelper1 a b        -- family_args = [a, b]</span><span>
</span><span id="line-442"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-443"></span><span>      </span><span class="hs-comment">--   instance C Bool where</span><span>
</span><span id="line-444"></span><span>      </span><span class="hs-comment">--     type T a b = THelper2 a b        -- family_args = [a, b]</span><span>
</span><span id="line-445"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-446"></span><span>      </span><span class="hs-comment">-- We could annotate these variables with explicit kinds, but it's not</span><span>
</span><span id="line-447"></span><span>      </span><span class="hs-comment">-- strictly necessary, as kind inference can figure them out just as well.</span><span>
</span><span id="line-448"></span><span>      </span><span id="local-6989586621681360876"><span class="annot"><span class="annottext">family_args :: DCxt
</span><a href="#local-6989586621681360876"><span class="hs-identifier hs-var hs-var">family_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; DCxt
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360884"><span class="hs-identifier hs-var">meth_arg_tvs</span></a></span><span>
</span><span id="line-449"></span><span>  </span><span id="local-6989586621681360875"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360875"><span class="hs-identifier hs-var">helperName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrM Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">newUniqueName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681360883"><span class="hs-identifier hs-var">helperNameBase</span></a></span><span>
</span><span id="line-450"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360873"><span class="annot"><span class="annottext">proHelperName :: Name
</span><a href="#local-6989586621681360873"><span class="hs-identifier hs-var hs-var">proHelperName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#promoteValNameLhs"><span class="hs-identifier hs-var">promoteValNameLhs</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360875"><span class="hs-identifier hs-var">helperName</span></a></span><span>
</span><span id="line-451"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360872"><span class="annot"><span class="annottext">eqns :: [DTySynEqn]
</span><a href="#local-6989586621681360872"><span class="hs-identifier hs-var">eqns</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360871"><span class="annot"><span class="annottext">_defuns :: [DDec]
</span><a href="#local-6989586621681360871"><span class="hs-identifier hs-var">_defuns</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360870"><span class="annot"><span class="annottext">ann_rhs :: ALetDecRHS
</span><a href="#local-6989586621681360870"><span class="hs-identifier hs-var">ann_rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-452"></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (DCxt, DType)
-&gt; OMap Name DType
-&gt; OMap Name Fixity
-&gt; (String, String)
-&gt; Name
-&gt; LetDecRHS Unannotated
-&gt; PrM
     ((Name, [DTyVarBndr], Maybe DType, [DTySynEqn]), [DDec],
      ALetDecRHS)
</span><a href="Data.Singletons.Promote.html#promoteLetDecRHS"><span class="hs-identifier hs-var">promoteLetDecRHS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DCxt, DType) -&gt; Maybe (DCxt, DType)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360887"><span class="hs-identifier hs-var">meth_arg_kis</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360886"><span class="hs-identifier hs-var">meth_res_ki</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OMap Name DType
forall k v. OMap k v
</span><span class="hs-identifier hs-var">OMap.empty</span></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity
forall k v. OMap k v
</span><span class="hs-identifier hs-var">OMap.empty</span></span><span>
</span><span id="line-453"></span><span>                        </span><span class="annot"><span class="annottext">(String, String)
</span><a href="Data.Singletons.Util.html#noPrefix"><span class="hs-identifier hs-var">noPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360875"><span class="hs-identifier hs-var">helperName</span></a></span><span> </span><span class="annot"><span class="annottext">LetDecRHS Unannotated
</span><a href="#local-6989586621681360888"><span class="hs-identifier hs-var">meth_rhs</span></a></span><span>
</span><span id="line-454"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360868"><span class="annot"><span class="annottext">tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681360868"><span class="hs-identifier hs-var hs-var">tvbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DType -&gt; DTyVarBndr) -&gt; [Name] -&gt; DCxt -&gt; [DTyVarBndr]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType -&gt; DTyVarBndr
</span><span class="hs-identifier hs-var">DKindedTV</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360884"><span class="hs-identifier hs-var">meth_arg_tvs</span></a></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360887"><span class="hs-identifier hs-var">meth_arg_kis</span></a></span><span>
</span><span id="line-455"></span><span>  </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DTypeFamilyHead -&gt; [DTySynEqn] -&gt; DDec
</span><span class="hs-identifier hs-var">DClosedTypeFamilyD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
-&gt; [DTyVarBndr]
-&gt; DFamilyResultSig
-&gt; Maybe InjectivityAnn
-&gt; DTypeFamilyHead
</span><span class="hs-identifier hs-var">DTypeFamilyHead</span></span><span>
</span><span id="line-456"></span><span>                                  </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360873"><span class="hs-identifier hs-var">proHelperName</span></a></span><span>
</span><span id="line-457"></span><span>                                  </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360868"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-458"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DFamilyResultSig
</span><span class="hs-identifier hs-var">DKindSig</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360886"><span class="hs-identifier hs-var">meth_res_ki</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-459"></span><span>                                  </span><span class="annot"><span class="annottext">Maybe InjectivityAnn
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-460"></span><span>                               </span><span class="annot"><span class="annottext">[DTySynEqn]
</span><a href="#local-6989586621681360872"><span class="hs-identifier hs-var">eqns</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-461"></span><span>  </span><span class="annot"><span class="annottext">PrM [DDec] -&gt; PrM ()
forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; m [DDec] -&gt; m ()
</span><a href="Data.Singletons.Promote.Monad.html#emitDecsM"><span class="hs-identifier hs-var">emitDecsM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Maybe Fixity -&gt; [DTyVarBndr] -&gt; Maybe DType -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#defunctionalize"><span class="hs-identifier hs-var">defunctionalize</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360873"><span class="hs-identifier hs-var">proHelperName</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Fixity
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360868"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360886"><span class="hs-identifier hs-var">meth_res_ki</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span>  </span><span class="annot"><span class="annottext">(DDec, ALetDecRHS, DType) -&gt; PrM (DDec, ALetDecRHS, DType)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DTySynEqn -&gt; DDec
</span><span class="hs-identifier hs-var">DTySynInstD</span></span><span>
</span><span id="line-463"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe [DTyVarBndr] -&gt; DType -&gt; DType -&gt; DTySynEqn
</span><span class="hs-identifier hs-var">DTySynEqn</span></span><span> </span><span class="annot"><span class="annottext">Maybe [DTyVarBndr]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-464"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DCxt -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360881"><span class="hs-identifier hs-var">proName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360876"><span class="hs-identifier hs-var">family_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-465"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DCxt -&gt; DType
</span><a href="Data.Singletons.Names.html#foldApply"><span class="hs-identifier hs-var">foldApply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360875"><span class="hs-identifier hs-var">helperName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; DCxt
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360884"><span class="hs-identifier hs-var">meth_arg_tvs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-466"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ALetDecRHS
</span><a href="#local-6989586621681360870"><span class="hs-identifier hs-var">ann_rhs</span></a></span><span>
</span><span id="line-467"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Int -&gt; Name
</span><a href="Data.Singletons.Names.html#promoteTySym"><span class="hs-identifier hs-var">promoteTySym</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360875"><span class="hs-identifier hs-var">helperName</span></a></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-469"></span><span>    </span><span id="local-6989586621681360881"><span class="annot"><span class="annottext">proName :: Name
</span><a href="#local-6989586621681360881"><span class="hs-identifier hs-var hs-var">proName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#promoteValNameLhs"><span class="hs-identifier hs-var">promoteValNameLhs</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360889"><span class="hs-identifier hs-var">meth_name</span></a></span><span>
</span><span id="line-470"></span><span>
</span><span id="line-471"></span><span>    </span><span class="annot"><a href="#local-6989586621681360885"><span class="hs-identifier hs-type">lookup_meth_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">)</span><span>
</span><span id="line-472"></span><span>    </span><span id="local-6989586621681360885"><span class="annot"><span class="annottext">lookup_meth_ty :: PrM (DCxt, DType)
</span><a href="#local-6989586621681360885"><span class="hs-identifier hs-var hs-var">lookup_meth_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-473"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; OMap Name DType -&gt; Maybe DType
forall k v. Ord k =&gt; k -&gt; OMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360889"><span class="hs-identifier hs-var">meth_name</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681360892"><span class="hs-identifier hs-var">inst_sigs_map</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-474"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681360860"><span class="annot"><span class="annottext">ty :: DType
</span><a href="#local-6989586621681360860"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-475"></span><span>          </span><span class="hs-comment">-- We have an InstanceSig. These are easy: no substitution for clas</span><span>
</span><span id="line-476"></span><span>          </span><span class="hs-comment">-- variables is required at all!</span><span>
</span><span id="line-477"></span><span>          </span><span class="annot"><span class="annottext">DType -&gt; PrM (DCxt, DType)
forall (m :: * -&gt; *). MonadFail m =&gt; DType -&gt; m (DCxt, DType)
</span><a href="Data.Singletons.Promote.Type.html#promoteUnraveled"><span class="hs-identifier hs-var">promoteUnraveled</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360860"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-478"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-479"></span><span>          </span><span class="hs-comment">-- We don't have an InstanceSig, so we must compute the kind to use</span><span>
</span><span id="line-480"></span><span>          </span><span class="hs-comment">-- ourselves (possibly substituting for class variables below).</span><span>
</span><span id="line-481"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621681360859"><span class="annot"><span class="annottext">arg_kis :: DCxt
</span><a href="#local-6989586621681360859"><span class="hs-identifier hs-var">arg_kis</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360858"><span class="annot"><span class="annottext">res_ki :: DType
</span><a href="#local-6989586621681360858"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-482"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; OMap Name DType -&gt; Maybe DType
forall k v. Ord k =&gt; k -&gt; OMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360889"><span class="hs-identifier hs-var">meth_name</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681360890"><span class="hs-identifier hs-var">orig_sigs_map</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-483"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-484"></span><span>                </span><span id="local-6989586621681360857"><span class="annot"><span class="annottext">Maybe DInfo
</span><a href="#local-6989586621681360857"><span class="hs-identifier hs-var">mb_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; PrM (Maybe DInfo)
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe DInfo)
</span><a href="Data.Singletons.Util.html#dsReifyTypeNameInfo"><span class="hs-identifier hs-var">dsReifyTypeNameInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360881"><span class="hs-identifier hs-var">proName</span></a></span><span>
</span><span id="line-485"></span><span>                           </span><span class="hs-comment">-- See Note [Using dsReifyTypeNameInfo when promoting instances]</span><span>
</span><span id="line-486"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe DInfo
</span><a href="#local-6989586621681360857"><span class="hs-identifier hs-var">mb_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-487"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTyConI</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DOpenTypeFamilyD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTypeFamilyHead</span></span><span> </span><span class="hs-identifier">_</span><span> </span><span id="local-6989586621681360856"><span class="annot"><span class="annottext">tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681360856"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span id="local-6989586621681360855"><span class="annot"><span class="annottext">mb_res_ki :: DFamilyResultSig
</span><a href="#local-6989586621681360855"><span class="hs-identifier hs-var">mb_res_ki</span></a></span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><span id="line-488"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360854"><span class="annot"><span class="annottext">arg_kis :: DCxt
</span><a href="#local-6989586621681360854"><span class="hs-identifier hs-var hs-var">arg_kis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; DType) -&gt; [DTyVarBndr] -&gt; DCxt
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DType -&gt; DType
</span><a href="#local-6989586621681360853"><span class="hs-identifier hs-var">default_to_star</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe DType -&gt; DType)
-&gt; (DTyVarBndr -&gt; Maybe DType) -&gt; DTyVarBndr -&gt; DType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; Maybe DType
</span><a href="Data.Singletons.Util.html#extractTvbKind"><span class="hs-identifier hs-var">extractTvbKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360856"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-489"></span><span>                           </span><span id="local-6989586621681360852"><span class="annot"><span class="annottext">res_ki :: DType
</span><a href="#local-6989586621681360852"><span class="hs-identifier hs-var hs-var">res_ki</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DType -&gt; DType
</span><a href="#local-6989586621681360853"><span class="hs-identifier hs-var">default_to_star</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DFamilyResultSig -&gt; Maybe DType
</span><a href="Data.Singletons.Util.html#resultSigToMaybeKind"><span class="hs-identifier hs-var">resultSigToMaybeKind</span></a></span><span> </span><span class="annot"><span class="annottext">DFamilyResultSig
</span><a href="#local-6989586621681360855"><span class="hs-identifier hs-var">mb_res_ki</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-490"></span><span>                        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(DCxt, DType) -&gt; PrM (DCxt, DType)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360854"><span class="hs-identifier hs-var">arg_kis</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360852"><span class="hs-identifier hs-var">res_ki</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-491"></span><span>                  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrM (DCxt, DType)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; PrM (DCxt, DType)) -&gt; String -&gt; PrM (DCxt, DType)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Cannot find type annotation for &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360881"><span class="hs-identifier hs-var">proName</span></a></span><span>
</span><span id="line-492"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681360850"><span class="annot"><span class="annottext">ty :: DType
</span><a href="#local-6989586621681360850"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DType -&gt; PrM (DCxt, DType)
forall (m :: * -&gt; *). MonadFail m =&gt; DType -&gt; m (DCxt, DType)
</span><a href="Data.Singletons.Promote.Type.html#promoteUnraveled"><span class="hs-identifier hs-var">promoteUnraveled</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360850"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-493"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- If we're dealing with an associated type family instance, substitute</span><span>
</span><span id="line-494"></span><span>              </span><span class="hs-comment">-- in the kind of the instance for better kind information in the RHS</span><span>
</span><span id="line-495"></span><span>              </span><span class="hs-comment">-- helper function. If we're dealing with a default family implementation</span><span>
</span><span id="line-496"></span><span>              </span><span class="hs-comment">-- (m_subst = Nothing), there's no need for a substitution.</span><span>
</span><span id="line-497"></span><span>              </span><span class="hs-comment">-- See Note [Promoted class method kinds]</span><span>
</span><span id="line-498"></span><span>              </span><span id="local-6989586621681360849"><span class="annot"><span class="annottext">do_subst :: DType -&gt; DType
</span><a href="#local-6989586621681360849"><span class="hs-identifier hs-var hs-var">do_subst</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; DType)
-&gt; (Map Name DType -&gt; DType -&gt; DType)
-&gt; Maybe (Map Name DType)
-&gt; DType
-&gt; DType
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">Map Name DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Util.html#substKind"><span class="hs-identifier hs-var">substKind</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Map Name DType)
</span><a href="#local-6989586621681360891"><span class="hs-identifier hs-var">m_subst</span></a></span><span>
</span><span id="line-499"></span><span>              </span><span id="local-6989586621681360845"><span class="annot"><span class="annottext">meth_arg_kis' :: DCxt
</span><a href="#local-6989586621681360845"><span class="hs-identifier hs-var hs-var">meth_arg_kis'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; DType) -&gt; DCxt -&gt; DCxt
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType
</span><a href="#local-6989586621681360849"><span class="hs-identifier hs-var">do_subst</span></a></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360859"><span class="hs-identifier hs-var">arg_kis</span></a></span><span>
</span><span id="line-500"></span><span>              </span><span id="local-6989586621681360844"><span class="annot"><span class="annottext">meth_res_ki' :: DType
</span><a href="#local-6989586621681360844"><span class="hs-identifier hs-var hs-var">meth_res_ki'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType
</span><a href="#local-6989586621681360849"><span class="hs-identifier hs-var">do_subst</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360858"><span class="hs-identifier hs-var">res_ki</span></a></span><span>
</span><span id="line-501"></span><span>          </span><span class="annot"><span class="annottext">(DCxt, DType) -&gt; PrM (DCxt, DType)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360845"><span class="hs-identifier hs-var">meth_arg_kis'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360844"><span class="hs-identifier hs-var">meth_res_ki'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-502"></span><span>
</span><span id="line-503"></span><span>    </span><span id="local-6989586621681360853"><span class="annot"><span class="annottext">default_to_star :: Maybe DType -&gt; DType
</span><a href="#local-6989586621681360853"><span class="hs-identifier hs-var hs-var">default_to_star</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier hs-var">typeKindName</span></span><span>
</span><span id="line-504"></span><span>    </span><span class="annot"><a href="#local-6989586621681360853"><span class="hs-identifier hs-var">default_to_star</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681360842"><span class="annot"><span class="annottext">k :: DType
</span><a href="#local-6989586621681360842"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360842"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-505"></span><span>
</span><span id="line-506"></span><span class="hs-comment">{-
Note [Promoted class method kinds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this example of a type class (and instance):

  class C a where
    m :: a -&gt; Bool -&gt; Bool
    m _ x = x

  instance C [a] where
    m l _ = null l

The promoted version of these declarations would be:

  class PC a where
    type M (x :: a) (y :: Bool) (z :: Bool)
    type M x y z = MHelper1 x y z

  instance PC [a] where
    type M x y z = MHelper2 x y z

  type family MHelper1 (x :: a)   (y :: Bool) (z :: Bool) where ...
  type family MHelper2 (x :: [a]) (y :: Bool) (z :: Bool) where ...

Getting the kind signature for MHelper1 (the promoted default implementation of
M) is quite simple, as it corresponds exactly to the kind of M. We might even
choose to make that the kind of MHelper2, but then it would be overly general
(and more difficult to find in -ddump-splices output). For this reason, we
substitute in the kinds of the instance itself to determine the kinds of
promoted method implementations like MHelper2.
-}</span><span>
</span><span id="line-537"></span><span>
</span><span id="line-538"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteLetDecEnv"><span class="hs-identifier hs-type">promoteLetDecEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ULetDecEnv"><span class="hs-identifier hs-type">ULetDecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ALetDecEnv"><span class="hs-identifier hs-type">ALetDecEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-539"></span><span id="promoteLetDecEnv"><span class="annot"><span class="annottext">promoteLetDecEnv :: (String, String)
-&gt; LetDecEnv Unannotated -&gt; PrM ([DDec], ALetDecEnv)
</span><a href="Data.Singletons.Promote.html#promoteLetDecEnv"><span class="hs-identifier hs-var hs-var">promoteLetDecEnv</span></a></span></span><span> </span><span id="local-6989586621681360840"><span class="annot"><span class="annottext">prefixes :: (String, String)
</span><a href="#local-6989586621681360840"><span class="hs-identifier hs-var">prefixes</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-type">LetDecEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lde_defns :: forall (ann :: AnnotationFlag).
LetDecEnv ann -&gt; OMap Name (LetDecRHS ann)
</span><a href="Data.Singletons.Syntax.html#lde_defns"><span class="hs-identifier hs-var">lde_defns</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360839"><span class="annot"><span class="annottext">OMap Name (LetDecRHS Unannotated)
</span><a href="#local-6989586621681360839"><span class="hs-identifier hs-var">value_env</span></a></span></span><span>
</span><span id="line-540"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_types :: forall (ann :: AnnotationFlag). LetDecEnv ann -&gt; OMap Name DType
</span><a href="Data.Singletons.Syntax.html#lde_types"><span class="hs-identifier hs-var">lde_types</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360838"><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681360838"><span class="hs-identifier hs-var">type_env</span></a></span></span><span>
</span><span id="line-541"></span><span>                                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_infix :: forall (ann :: AnnotationFlag). LetDecEnv ann -&gt; OMap Name Fixity
</span><a href="Data.Singletons.Syntax.html#lde_infix"><span class="hs-identifier hs-var">lde_infix</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360837"><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621681360837"><span class="hs-identifier hs-var">fix_env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-542"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360836"><span class="annot"><span class="annottext">infix_decls :: [DDec]
</span><a href="#local-6989586621681360836"><span class="hs-identifier hs-var hs-var">infix_decls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe DDec] -&gt; [DDec]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">([Maybe DDec] -&gt; [DDec]) -&gt; [Maybe DDec] -&gt; [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Name, Fixity) -&gt; Maybe DDec) -&gt; [(Name, Fixity)] -&gt; [Maybe DDec]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; Fixity -&gt; Maybe DDec) -&gt; (Name, Fixity) -&gt; Maybe DDec
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Fixity -&gt; Maybe DDec
</span><a href="Data.Singletons.Promote.html#promoteInfixDecl"><span class="hs-identifier hs-var">promoteInfixDecl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-543"></span><span>                              </span><span class="annot"><span class="annottext">([(Name, Fixity)] -&gt; [Maybe DDec])
-&gt; [(Name, Fixity)] -&gt; [Maybe DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity -&gt; [(Name, Fixity)]
forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621681360837"><span class="hs-identifier hs-var">fix_env</span></a></span><span>
</span><span id="line-544"></span><span>
</span><span id="line-545"></span><span>    </span><span class="hs-comment">-- promote all the declarations, producing annotated declarations</span><span>
</span><span id="line-546"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681360835"><span class="annot"><span class="annottext">names :: [Name]
</span><a href="#local-6989586621681360835"><span class="hs-identifier hs-var">names</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360834"><span class="annot"><span class="annottext">rhss :: [LetDecRHS Unannotated]
</span><a href="#local-6989586621681360834"><span class="hs-identifier hs-var">rhss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, LetDecRHS Unannotated)]
-&gt; ([Name], [LetDecRHS Unannotated])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Name, LetDecRHS Unannotated)]
 -&gt; ([Name], [LetDecRHS Unannotated]))
-&gt; [(Name, LetDecRHS Unannotated)]
-&gt; ([Name], [LetDecRHS Unannotated])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OMap Name (LetDecRHS Unannotated)
-&gt; [(Name, LetDecRHS Unannotated)]
forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name (LetDecRHS Unannotated)
</span><a href="#local-6989586621681360839"><span class="hs-identifier hs-var">value_env</span></a></span><span>
</span><span id="line-547"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360832"><span class="annot"><span class="annottext">payloads :: [(Name, [DTyVarBndr], Maybe DType, [DTySynEqn])]
</span><a href="#local-6989586621681360832"><span class="hs-identifier hs-var">payloads</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360831"><span class="annot"><span class="annottext">defun_decss :: [[DDec]]
</span><a href="#local-6989586621681360831"><span class="hs-identifier hs-var">defun_decss</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360830"><span class="annot"><span class="annottext">ann_rhss :: [ALetDecRHS]
</span><a href="#local-6989586621681360830"><span class="hs-identifier hs-var">ann_rhss</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-548"></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([((Name, [DTyVarBndr], Maybe DType, [DTySynEqn]), [DDec],
   ALetDecRHS)]
 -&gt; ([(Name, [DTyVarBndr], Maybe DType, [DTySynEqn])], [[DDec]],
     [ALetDecRHS]))
-&gt; PrM
     [((Name, [DTyVarBndr], Maybe DType, [DTySynEqn]), [DDec],
       ALetDecRHS)]
-&gt; PrM
     ([(Name, [DTyVarBndr], Maybe DType, [DTySynEqn])], [[DDec]],
      [ALetDecRHS])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[((Name, [DTyVarBndr], Maybe DType, [DTySynEqn]), [DDec],
  ALetDecRHS)]
-&gt; ([(Name, [DTyVarBndr], Maybe DType, [DTySynEqn])], [[DDec]],
    [ALetDecRHS])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">(PrM
   [((Name, [DTyVarBndr], Maybe DType, [DTySynEqn]), [DDec],
     ALetDecRHS)]
 -&gt; PrM
      ([(Name, [DTyVarBndr], Maybe DType, [DTySynEqn])], [[DDec]],
       [ALetDecRHS]))
-&gt; PrM
     [((Name, [DTyVarBndr], Maybe DType, [DTySynEqn]), [DDec],
       ALetDecRHS)]
-&gt; PrM
     ([(Name, [DTyVarBndr], Maybe DType, [DTySynEqn])], [[DDec]],
      [ALetDecRHS])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Name
 -&gt; LetDecRHS Unannotated
 -&gt; PrM
      ((Name, [DTyVarBndr], Maybe DType, [DTySynEqn]), [DDec],
       ALetDecRHS))
-&gt; [Name]
-&gt; [LetDecRHS Unannotated]
-&gt; PrM
     [((Name, [DTyVarBndr], Maybe DType, [DTySynEqn]), [DDec],
       ALetDecRHS)]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (DCxt, DType)
-&gt; OMap Name DType
-&gt; OMap Name Fixity
-&gt; (String, String)
-&gt; Name
-&gt; LetDecRHS Unannotated
-&gt; PrM
     ((Name, [DTyVarBndr], Maybe DType, [DTySynEqn]), [DDec],
      ALetDecRHS)
</span><a href="Data.Singletons.Promote.html#promoteLetDecRHS"><span class="hs-identifier hs-var">promoteLetDecRHS</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DCxt, DType)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681360838"><span class="hs-identifier hs-var">type_env</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621681360837"><span class="hs-identifier hs-var">fix_env</span></a></span><span> </span><span class="annot"><span class="annottext">(String, String)
</span><a href="#local-6989586621681360840"><span class="hs-identifier hs-var">prefixes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360835"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">[LetDecRHS Unannotated]
</span><a href="#local-6989586621681360834"><span class="hs-identifier hs-var">rhss</span></a></span><span>
</span><span id="line-549"></span><span>
</span><span id="line-550"></span><span>  </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="annot"><span class="annottext">([DDec] -&gt; PrM ()) -&gt; [DDec] -&gt; PrM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[[DDec]] -&gt; [DDec]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[DDec]]
</span><a href="#local-6989586621681360831"><span class="hs-identifier hs-var">defun_decss</span></a></span><span>
</span><span id="line-551"></span><span>  </span><span id="local-6989586621681360826"><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681360826"><span class="hs-identifier hs-var">bound_kvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM (OSet Name)
</span><a href="Data.Singletons.Promote.Monad.html#allBoundKindVars"><span class="hs-identifier hs-var">allBoundKindVars</span></a></span><span>
</span><span id="line-552"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360824"><span class="annot"><span class="annottext">decs :: [DDec]
</span><a href="#local-6989586621681360824"><span class="hs-identifier hs-var hs-var">decs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Name, [DTyVarBndr], Maybe DType, [DTySynEqn]) -&gt; DDec)
-&gt; [(Name, [DTyVarBndr], Maybe DType, [DTySynEqn])] -&gt; [DDec]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, [DTyVarBndr], Maybe DType, [DTySynEqn]) -&gt; DDec
</span><a href="#local-6989586621681360823"><span class="hs-identifier hs-var">payload_to_dec</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, [DTyVarBndr], Maybe DType, [DTySynEqn])]
</span><a href="#local-6989586621681360832"><span class="hs-identifier hs-var">payloads</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [DDec] -&gt; [DDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681360836"><span class="hs-identifier hs-var">infix_decls</span></a></span><span>
</span><span id="line-553"></span><span>
</span><span id="line-554"></span><span>    </span><span class="hs-comment">-- build the ALetDecEnv</span><span>
</span><span id="line-555"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360822"><span class="annot"><span class="annottext">let_dec_env' :: ALetDecEnv
</span><a href="#local-6989586621681360822"><span class="hs-identifier hs-var hs-var">let_dec_env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LetDecEnv :: forall (ann :: AnnotationFlag).
OMap Name (LetDecRHS ann)
-&gt; OMap Name DType
-&gt; OMap Name Fixity
-&gt; IfAnn ann (OMap Name DType) ()
-&gt; IfAnn ann (OMap Name (OSet Name)) ()
-&gt; LetDecEnv ann
</span><a href="Data.Singletons.Syntax.html#LetDecEnv"><span class="hs-identifier hs-type hs-type">LetDecEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lde_defns :: OMap Name ALetDecRHS
</span><a href="Data.Singletons.Syntax.html#lde_defns"><span class="hs-identifier hs-var">lde_defns</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, ALetDecRHS)] -&gt; OMap Name ALetDecRHS
forall k v. Ord k =&gt; [(k, v)] -&gt; OMap k v
</span><span class="hs-identifier hs-var">OMap.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(Name, ALetDecRHS)] -&gt; OMap Name ALetDecRHS)
-&gt; [(Name, ALetDecRHS)] -&gt; OMap Name ALetDecRHS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [ALetDecRHS] -&gt; [(Name, ALetDecRHS)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360835"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">[ALetDecRHS]
</span><a href="#local-6989586621681360830"><span class="hs-identifier hs-var">ann_rhss</span></a></span><span>
</span><span id="line-556"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_types :: OMap Name DType
</span><a href="Data.Singletons.Syntax.html#lde_types"><span class="hs-identifier hs-var">lde_types</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681360838"><span class="hs-identifier hs-var">type_env</span></a></span><span>
</span><span id="line-557"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_infix :: OMap Name Fixity
</span><a href="Data.Singletons.Syntax.html#lde_infix"><span class="hs-identifier hs-var">lde_infix</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621681360837"><span class="hs-identifier hs-var">fix_env</span></a></span><span>
</span><span id="line-558"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_proms :: IfAnn Annotated (OMap Name DType) ()
</span><a href="Data.Singletons.Syntax.html#lde_proms"><span class="hs-identifier hs-var">lde_proms</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IfAnn Annotated (OMap Name DType) ()
forall k v. OMap k v
</span><span class="hs-identifier hs-var">OMap.empty</span></span><span>  </span><span class="hs-comment">-- filled in promoteLetDecs</span><span>
</span><span id="line-559"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_bound_kvs :: IfAnn Annotated (OMap Name (OSet Name)) ()
</span><a href="Data.Singletons.Syntax.html#lde_bound_kvs"><span class="hs-identifier hs-var">lde_bound_kvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, OSet Name)] -&gt; IfAnn Annotated (OMap Name (OSet Name)) ()
forall k v. Ord k =&gt; [(k, v)] -&gt; OMap k v
</span><span class="hs-identifier hs-var">OMap.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(Name, OSet Name)] -&gt; IfAnn Annotated (OMap Name (OSet Name)) ())
-&gt; [(Name, OSet Name)]
-&gt; IfAnn Annotated (OMap Name (OSet Name)) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; (Name, OSet Name)) -&gt; [Name] -&gt; [(Name, OSet Name)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681360826"><span class="hs-identifier hs-var">bound_kvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360835"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-560"></span><span>
</span><span id="line-561"></span><span>  </span><span class="annot"><span class="annottext">([DDec], ALetDecEnv) -&gt; PrM ([DDec], ALetDecEnv)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681360824"><span class="hs-identifier hs-var">decs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ALetDecEnv
</span><a href="#local-6989586621681360822"><span class="hs-identifier hs-var">let_dec_env'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-562"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-563"></span><span>    </span><span id="local-6989586621681360823"><span class="annot"><span class="annottext">payload_to_dec :: (Name, [DTyVarBndr], Maybe DType, [DTySynEqn]) -&gt; DDec
</span><a href="#local-6989586621681360823"><span class="hs-identifier hs-var hs-var">payload_to_dec</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681360820"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681360820"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360819"><span class="annot"><span class="annottext">tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681360819"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360818"><span class="annot"><span class="annottext">m_ki :: Maybe DType
</span><a href="#local-6989586621681360818"><span class="hs-identifier hs-var">m_ki</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360817"><span class="annot"><span class="annottext">eqns :: [DTySynEqn]
</span><a href="#local-6989586621681360817"><span class="hs-identifier hs-var">eqns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DTypeFamilyHead -&gt; [DTySynEqn] -&gt; DDec
</span><span class="hs-identifier hs-var">DClosedTypeFamilyD</span></span><span>
</span><span id="line-564"></span><span>                                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
-&gt; [DTyVarBndr]
-&gt; DFamilyResultSig
-&gt; Maybe InjectivityAnn
-&gt; DTypeFamilyHead
</span><span class="hs-identifier hs-var">DTypeFamilyHead</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360820"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360819"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">DFamilyResultSig
</span><a href="#local-6989586621681360816"><span class="hs-identifier hs-var">sig</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe InjectivityAnn
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-565"></span><span>                                                </span><span class="annot"><span class="annottext">[DTySynEqn]
</span><a href="#local-6989586621681360817"><span class="hs-identifier hs-var">eqns</span></a></span><span>
</span><span id="line-566"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-567"></span><span>        </span><span id="local-6989586621681360816"><span class="annot"><span class="annottext">sig :: DFamilyResultSig
</span><a href="#local-6989586621681360816"><span class="hs-identifier hs-var hs-var">sig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DFamilyResultSig
-&gt; (DType -&gt; DFamilyResultSig) -&gt; Maybe DType -&gt; DFamilyResultSig
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">DFamilyResultSig
</span><span class="hs-identifier hs-var">DNoSig</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DFamilyResultSig
</span><span class="hs-identifier hs-var">DKindSig</span></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681360818"><span class="hs-identifier hs-var">m_ki</span></a></span><span>
</span><span id="line-568"></span><span>
</span><span id="line-569"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteInfixDecl"><span class="hs-identifier hs-type">promoteInfixDecl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Fixity</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span>
</span><span id="line-570"></span><span id="promoteInfixDecl"><span class="annot"><span class="annottext">promoteInfixDecl :: Name -&gt; Fixity -&gt; Maybe DDec
</span><a href="Data.Singletons.Promote.html#promoteInfixDecl"><span class="hs-identifier hs-var hs-var">promoteInfixDecl</span></a></span></span><span> </span><span id="local-6989586621681360814"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681360814"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681360813"><span class="annot"><span class="annottext">fixity :: Fixity
</span><a href="#local-6989586621681360813"><span class="hs-identifier hs-var">fixity</span></a></span></span><span>
</span><span id="line-571"></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
</span><span class="hs-identifier hs-var">nameBase</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360814"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
</span><span class="hs-identifier hs-var">nameBase</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360812"><span class="hs-identifier hs-var">promoted_name</span></a></span><span>
</span><span id="line-572"></span><span>   </span><span class="hs-comment">-- If a name and its promoted counterpart are the same (modulo module</span><span>
</span><span id="line-573"></span><span>   </span><span class="hs-comment">-- prefixes), then there's no need to promote a fixity declaration for</span><span>
</span><span id="line-574"></span><span>   </span><span class="hs-comment">-- that name, since the existing fixity declaration will cover both</span><span>
</span><span id="line-575"></span><span>   </span><span class="hs-comment">-- the term- and type-level versions of that name. Names that fall into this</span><span>
</span><span id="line-576"></span><span>   </span><span class="hs-comment">-- category include data constructor names and infix names.</span><span>
</span><span id="line-577"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DDec
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-578"></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-579"></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DDec -&gt; Maybe DDec
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(DDec -&gt; Maybe DDec) -&gt; DDec -&gt; Maybe DDec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DLetDec -&gt; DDec
</span><span class="hs-identifier hs-var">DLetDec</span></span><span> </span><span class="annot"><span class="annottext">(DLetDec -&gt; DDec) -&gt; DLetDec -&gt; DDec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fixity -&gt; Name -&gt; DLetDec
</span><span class="hs-identifier hs-var">DInfixD</span></span><span> </span><span class="annot"><span class="annottext">Fixity
</span><a href="#local-6989586621681360813"><span class="hs-identifier hs-var">fixity</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360812"><span class="hs-identifier hs-var">promoted_name</span></a></span><span>
</span><span id="line-580"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-581"></span><span>  </span><span id="local-6989586621681360812"><span class="annot"><span class="annottext">promoted_name :: Name
</span><a href="#local-6989586621681360812"><span class="hs-identifier hs-var hs-var">promoted_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Names.html#promoteValNameLhs"><span class="hs-identifier hs-var">promoteValNameLhs</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360814"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-582"></span><span>
</span><span id="line-583"></span><span class="hs-comment">-- This function is used both to promote class method defaults and normal</span><span>
</span><span id="line-584"></span><span class="hs-comment">-- let bindings. Thus, it can't quite do all the work locally and returns</span><span>
</span><span id="line-585"></span><span class="hs-comment">-- an intermediate structure. Perhaps a better design is available.</span><span>
</span><span id="line-586"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteLetDecRHS"><span class="hs-identifier hs-type">promoteLetDecRHS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- the promoted type of the RHS (if known)</span><span>
</span><span id="line-587"></span><span>                                            </span><span class="hs-comment">-- needed to fix #136</span><span>
</span><span id="line-588"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span>      </span><span class="hs-comment">-- local type env't</span><span>
</span><span id="line-589"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Fixity</span></span><span>     </span><span class="hs-comment">-- local fixity env't</span><span>
</span><span id="line-590"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- let-binding prefixes</span><span>
</span><span id="line-591"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span>                 </span><span class="hs-comment">-- name of the thing being promoted</span><span>
</span><span id="line-592"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ULetDecRHS"><span class="hs-identifier hs-type">ULetDecRHS</span></a></span><span>           </span><span class="hs-comment">-- body of the thing</span><span>
</span><span id="line-593"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTySynEqn</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- &quot;type family&quot;</span><span>
</span><span id="line-594"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- defunctionalization</span><span>
</span><span id="line-595"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ALetDecRHS"><span class="hs-identifier hs-type">ALetDecRHS</span></a></span><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- annotated RHS</span><span>
</span><span id="line-596"></span><span id="promoteLetDecRHS"><span class="annot"><span class="annottext">promoteLetDecRHS :: Maybe (DCxt, DType)
-&gt; OMap Name DType
-&gt; OMap Name Fixity
-&gt; (String, String)
-&gt; Name
-&gt; LetDecRHS Unannotated
-&gt; PrM
     ((Name, [DTyVarBndr], Maybe DType, [DTySynEqn]), [DDec],
      ALetDecRHS)
</span><a href="Data.Singletons.Promote.html#promoteLetDecRHS"><span class="hs-identifier hs-var hs-var">promoteLetDecRHS</span></a></span></span><span> </span><span id="local-6989586621681360809"><span class="annot"><span class="annottext">m_rhs_ki :: Maybe (DCxt, DType)
</span><a href="#local-6989586621681360809"><span class="hs-identifier hs-var">m_rhs_ki</span></a></span></span><span> </span><span id="local-6989586621681360808"><span class="annot"><span class="annottext">type_env :: OMap Name DType
</span><a href="#local-6989586621681360808"><span class="hs-identifier hs-var">type_env</span></a></span></span><span> </span><span id="local-6989586621681360807"><span class="annot"><span class="annottext">fix_env :: OMap Name Fixity
</span><a href="#local-6989586621681360807"><span class="hs-identifier hs-var">fix_env</span></a></span></span><span> </span><span id="local-6989586621681360806"><span class="annot"><span class="annottext">prefixes :: (String, String)
</span><a href="#local-6989586621681360806"><span class="hs-identifier hs-var">prefixes</span></a></span></span><span> </span><span id="local-6989586621681360805"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681360805"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#UValue"><span class="hs-identifier hs-type">UValue</span></a></span><span> </span><span id="local-6989586621681360803"><span class="annot"><a href="#local-6989586621681360803"><span class="hs-identifier hs-var">exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-597"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360802"><span class="annot"><span class="annottext">res_kind :: Maybe DType
</span><a href="#local-6989586621681360802"><span class="hs-identifier hs-var">res_kind</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360801"><span class="annot"><span class="annottext">num_arrows :: Int
</span><a href="#local-6989586621681360801"><span class="hs-identifier hs-var">num_arrows</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-598"></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (DCxt, DType)
</span><a href="#local-6989586621681360809"><span class="hs-identifier hs-var">m_rhs_ki</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-599"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681360800"><span class="annot"><span class="annottext">arg_kis :: DCxt
</span><a href="#local-6989586621681360800"><span class="hs-identifier hs-var">arg_kis</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360799"><span class="annot"><span class="annottext">res_ki :: DType
</span><a href="#local-6989586621681360799"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe DType, Int) -&gt; PrM (Maybe DType, Int)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DCxt -&gt; DType
</span><a href="Data.Singletons.Promote.Defun.html#ravelTyFun"><span class="hs-identifier hs-var">ravelTyFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360800"><span class="hs-identifier hs-var">arg_kis</span></a></span><span> </span><span class="annot"><span class="annottext">DCxt -&gt; DCxt -&gt; DCxt
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360799"><span class="hs-identifier hs-var">res_ki</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-600"></span><span>                                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DCxt -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360800"><span class="hs-identifier hs-var">arg_kis</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-601"></span><span>         </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681360797"><span class="annot"><span class="annottext">ty :: DType
</span><a href="#local-6989586621681360797"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; OMap Name DType -&gt; Maybe DType
forall k v. Ord k =&gt; k -&gt; OMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360805"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681360808"><span class="hs-identifier hs-var">type_env</span></a></span><span>
</span><span id="line-602"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621681360796"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360796"><span class="hs-identifier hs-var">ki</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DType -&gt; PrM DType
forall (m :: * -&gt; *). MonadFail m =&gt; DType -&gt; m DType
</span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360797"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-603"></span><span>                 </span><span class="annot"><span class="annottext">(Maybe DType, Int) -&gt; PrM (Maybe DType, Int)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360796"><span class="hs-identifier hs-var">ki</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; Int
</span><a href="Data.Singletons.Util.html#countArgs"><span class="hs-identifier hs-var">countArgs</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360797"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-604"></span><span>           </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-605"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe DType, Int) -&gt; PrM (Maybe DType, Int)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-606"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360801"><span class="hs-identifier hs-var">num_arrows</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-607"></span><span>    </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-608"></span><span>      </span><span id="local-6989586621681360794"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360794"><span class="hs-identifier hs-var">all_locals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM [Name]
forall (m :: * -&gt; *). MonadReader PrEnv m =&gt; m [Name]
</span><a href="Data.Singletons.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a></span><span>
</span><span id="line-609"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360793"><span class="annot"><span class="annottext">lde_kvs_to_bind :: OSet Name
</span><a href="#local-6989586621681360793"><span class="hs-identifier hs-var hs-var">lde_kvs_to_bind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; OSet Name) -&gt; Maybe DType -&gt; OSet Name
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; OSet Name
</span><span class="hs-identifier hs-var">fvDType</span></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681360802"><span class="hs-identifier hs-var">res_kind</span></a></span><span>
</span><span id="line-610"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621681360792"><span class="annot"><span class="annottext">exp' :: DType
</span><a href="#local-6989586621681360792"><span class="hs-identifier hs-var">exp'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360791"><span class="annot"><span class="annottext">ann_exp :: ADExp
</span><a href="#local-6989586621681360791"><span class="hs-identifier hs-var">ann_exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OSet Name -&gt; PrM (DType, ADExp) -&gt; PrM (DType, ADExp)
forall a. OSet Name -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681360793"><span class="hs-identifier hs-var">lde_kvs_to_bind</span></a></span><span> </span><span class="annot"><span class="annottext">(PrM (DType, ADExp) -&gt; PrM (DType, ADExp))
-&gt; PrM (DType, ADExp) -&gt; PrM (DType, ADExp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681360803"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-611"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360789"><span class="annot"><span class="annottext">proName :: Name
</span><a href="#local-6989586621681360789"><span class="hs-identifier hs-var hs-var">proName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String, String) -&gt; Name -&gt; Name
</span><a href="Data.Singletons.Names.html#promoteValNameLhsPrefix"><span class="hs-identifier hs-var">promoteValNameLhsPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">(String, String)
</span><a href="#local-6989586621681360806"><span class="hs-identifier hs-var">prefixes</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360805"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-612"></span><span>          </span><span id="local-6989586621681360788"><span class="annot"><span class="annottext">m_fixity :: Maybe Fixity
</span><a href="#local-6989586621681360788"><span class="hs-identifier hs-var hs-var">m_fixity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; OMap Name Fixity -&gt; Maybe Fixity
forall k v. Ord k =&gt; k -&gt; OMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360805"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621681360807"><span class="hs-identifier hs-var">fix_env</span></a></span><span>
</span><span id="line-613"></span><span>          </span><span id="local-6989586621681360787"><span class="annot"><span class="annottext">tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681360787"><span class="hs-identifier hs-var hs-var">tvbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DTyVarBndr) -&gt; [Name] -&gt; [DTyVarBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DTyVarBndr
</span><span class="hs-identifier hs-var">DPlainTV</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360794"><span class="hs-identifier hs-var">all_locals</span></a></span><span>
</span><span id="line-614"></span><span>      </span><span id="local-6989586621681360785"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681360785"><span class="hs-identifier hs-var">defuns</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Fixity -&gt; [DTyVarBndr] -&gt; Maybe DType -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#defunctionalize"><span class="hs-identifier hs-var">defunctionalize</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360789"><span class="hs-identifier hs-var">proName</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Fixity
</span><a href="#local-6989586621681360788"><span class="hs-identifier hs-var">m_fixity</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360787"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681360802"><span class="hs-identifier hs-var">res_kind</span></a></span><span>
</span><span id="line-615"></span><span>      </span><span class="annot"><span class="annottext">((Name, [DTyVarBndr], Maybe DType, [DTySynEqn]), [DDec],
 ALetDecRHS)
-&gt; PrM
     ((Name, [DTyVarBndr], Maybe DType, [DTySynEqn]), [DDec],
      ALetDecRHS)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360789"><span class="hs-identifier hs-var">proName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360787"><span class="hs-identifier hs-var">tvbs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681360802"><span class="hs-identifier hs-var">res_kind</span></a></span><span>
</span><span id="line-616"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Maybe [DTyVarBndr] -&gt; DType -&gt; DType -&gt; DTySynEqn
</span><span class="hs-identifier hs-var">DTySynEqn</span></span><span> </span><span class="annot"><span class="annottext">Maybe [DTyVarBndr]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DCxt -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360789"><span class="hs-identifier hs-var">proName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DCxt -&gt; DType) -&gt; DCxt -&gt; DType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; DCxt
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360794"><span class="hs-identifier hs-var">all_locals</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360792"><span class="hs-identifier hs-var">exp'</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-617"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681360785"><span class="hs-identifier hs-var">defuns</span></a></span><span>
</span><span id="line-618"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; Int -&gt; ADExp -&gt; ALetDecRHS
</span><a href="Data.Singletons.Syntax.html#AValue"><span class="hs-identifier hs-var">AValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DCxt -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360789"><span class="hs-identifier hs-var">proName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; DCxt
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360794"><span class="hs-identifier hs-var">all_locals</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-619"></span><span>                      </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360801"><span class="hs-identifier hs-var">num_arrows</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681360791"><span class="hs-identifier hs-var">ann_exp</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-620"></span><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-621"></span><span>      </span><span id="local-6989586621681360783"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360783"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; PrM Name -&gt; PrM [Name]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360801"><span class="hs-identifier hs-var">num_arrows</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; PrM Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">newUniqueName</span></span><span> </span><span class="annot"><span class="hs-string">&quot;a&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-622"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360781"><span class="annot"><span class="annottext">pats :: [DPat]
</span><a href="#local-6989586621681360781"><span class="hs-identifier hs-var hs-var">pats</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DPat) -&gt; [Name] -&gt; [DPat]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DPat
</span><span class="hs-identifier hs-var">DVarP</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360783"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-623"></span><span>          </span><span id="local-6989586621681360779"><span class="annot"><span class="annottext">newArgs :: [DExp]
</span><a href="#local-6989586621681360779"><span class="hs-identifier hs-var hs-var">newArgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DExp) -&gt; [Name] -&gt; [DExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360783"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-624"></span><span>      </span><span class="annot"><span class="annottext">Maybe (DCxt, DType)
-&gt; OMap Name DType
-&gt; OMap Name Fixity
-&gt; (String, String)
-&gt; Name
-&gt; LetDecRHS Unannotated
-&gt; PrM
     ((Name, [DTyVarBndr], Maybe DType, [DTySynEqn]), [DDec],
      ALetDecRHS)
</span><a href="Data.Singletons.Promote.html#promoteLetDecRHS"><span class="hs-identifier hs-var">promoteLetDecRHS</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DCxt, DType)
</span><a href="#local-6989586621681360809"><span class="hs-identifier hs-var">m_rhs_ki</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681360808"><span class="hs-identifier hs-var">type_env</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621681360807"><span class="hs-identifier hs-var">fix_env</span></a></span><span> </span><span class="annot"><span class="annottext">(String, String)
</span><a href="#local-6989586621681360806"><span class="hs-identifier hs-var">prefixes</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360805"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-625"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DClause] -&gt; LetDecRHS Unannotated
</span><a href="Data.Singletons.Syntax.html#UFunction"><span class="hs-identifier hs-var">UFunction</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[DPat] -&gt; DExp -&gt; DClause
</span><span class="hs-identifier hs-var">DClause</span></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621681360781"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DExp -&gt; [DExp] -&gt; DExp
</span><a href="Data.Singletons.Util.html#foldExp"><span class="hs-identifier hs-var">foldExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681360803"><span class="hs-identifier hs-var">exp</span></a></span><span> </span><span class="annot"><span class="annottext">[DExp]
</span><a href="#local-6989586621681360779"><span class="hs-identifier hs-var">newArgs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-626"></span><span>
</span><span id="line-627"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteLetDecRHS"><span class="hs-identifier hs-var">promoteLetDecRHS</span></a></span><span> </span><span id="local-6989586621681360774"><span class="annot"><span class="annottext">m_rhs_ki :: Maybe (DCxt, DType)
</span><a href="#local-6989586621681360774"><span class="hs-identifier hs-var">m_rhs_ki</span></a></span></span><span> </span><span id="local-6989586621681360773"><span class="annot"><span class="annottext">type_env :: OMap Name DType
</span><a href="#local-6989586621681360773"><span class="hs-identifier hs-var">type_env</span></a></span></span><span> </span><span id="local-6989586621681360772"><span class="annot"><span class="annottext">fix_env :: OMap Name Fixity
</span><a href="#local-6989586621681360772"><span class="hs-identifier hs-var">fix_env</span></a></span></span><span> </span><span id="local-6989586621681360771"><span class="annot"><span class="annottext">prefixes :: (String, String)
</span><a href="#local-6989586621681360771"><span class="hs-identifier hs-var">prefixes</span></a></span></span><span> </span><span id="local-6989586621681360770"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681360770"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#UFunction"><span class="hs-identifier hs-type">UFunction</span></a></span><span> </span><span id="local-6989586621681360769"><span class="annot"><a href="#local-6989586621681360769"><span class="hs-identifier hs-var">clauses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-628"></span><span>  </span><span id="local-6989586621681360768"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360768"><span class="hs-identifier hs-var">numArgs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DClause] -&gt; PrM Int
forall (m :: * -&gt; *). MonadFail m =&gt; [DClause] -&gt; m Int
</span><a href="#local-6989586621681360767"><span class="hs-identifier hs-var">count_args</span></a></span><span> </span><span class="annot"><span class="annottext">[DClause]
</span><a href="#local-6989586621681360769"><span class="hs-identifier hs-var">clauses</span></a></span><span>
</span><span id="line-629"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360766"><span class="annot"><span class="annottext">m_argKs :: [Maybe DType]
</span><a href="#local-6989586621681360766"><span class="hs-identifier hs-var">m_argKs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360765"><span class="annot"><span class="annottext">m_resK :: Maybe DType
</span><a href="#local-6989586621681360765"><span class="hs-identifier hs-var">m_resK</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360764"><span class="annot"><span class="annottext">ty_num_args :: Int
</span><a href="#local-6989586621681360764"><span class="hs-identifier hs-var">ty_num_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (DCxt, DType)
</span><a href="#local-6989586621681360774"><span class="hs-identifier hs-var">m_rhs_ki</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-630"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681360763"><span class="annot"><span class="annottext">arg_kis :: DCxt
</span><a href="#local-6989586621681360763"><span class="hs-identifier hs-var">arg_kis</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360762"><span class="annot"><span class="annottext">res_ki :: DType
</span><a href="#local-6989586621681360762"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">([Maybe DType], Maybe DType, Int)
-&gt; PrM ([Maybe DType], Maybe DType, Int)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DType -&gt; Maybe DType) -&gt; DCxt -&gt; [Maybe DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360763"><span class="hs-identifier hs-var">arg_kis</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360762"><span class="hs-identifier hs-var">res_ki</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DCxt -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360763"><span class="hs-identifier hs-var">arg_kis</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-631"></span><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681360761"><span class="annot"><span class="annottext">ty :: DType
</span><a href="#local-6989586621681360761"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; OMap Name DType -&gt; Maybe DType
forall k v. Ord k =&gt; k -&gt; OMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360770"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621681360773"><span class="hs-identifier hs-var">type_env</span></a></span><span>
</span><span id="line-632"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-633"></span><span>      </span><span class="hs-comment">-- promoteType turns arrows into TyFun. So, we unravel first to</span><span>
</span><span id="line-634"></span><span>      </span><span class="hs-comment">-- avoid this behavior. Note the use of ravelTyFun in resultK</span><span>
</span><span id="line-635"></span><span>      </span><span class="hs-comment">-- to make the return kind work out</span><span>
</span><span id="line-636"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621681360760"><span class="annot"><span class="annottext">argKs :: DCxt
</span><a href="#local-6989586621681360760"><span class="hs-identifier hs-var">argKs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360759"><span class="annot"><span class="annottext">resultK :: DType
</span><a href="#local-6989586621681360759"><span class="hs-identifier hs-var">resultK</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DType -&gt; PrM (DCxt, DType)
forall (m :: * -&gt; *). MonadFail m =&gt; DType -&gt; m (DCxt, DType)
</span><a href="Data.Singletons.Promote.Type.html#promoteUnraveled"><span class="hs-identifier hs-var">promoteUnraveled</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360761"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-637"></span><span>      </span><span class="hs-comment">-- invariant: countArgs ty == length argKs</span><span>
</span><span id="line-638"></span><span>      </span><span class="annot"><span class="annottext">([Maybe DType], Maybe DType, Int)
-&gt; PrM ([Maybe DType], Maybe DType, Int)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DType -&gt; Maybe DType) -&gt; DCxt -&gt; [Maybe DType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360760"><span class="hs-identifier hs-var">argKs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360759"><span class="hs-identifier hs-var">resultK</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DCxt -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360760"><span class="hs-identifier hs-var">argKs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-639"></span><span>
</span><span id="line-640"></span><span>      </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-641"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">([Maybe DType], Maybe DType, Int)
-&gt; PrM ([Maybe DType], Maybe DType, Int)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe DType -&gt; [Maybe DType]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360768"><span class="hs-identifier hs-var">numArgs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe DType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360768"><span class="hs-identifier hs-var">numArgs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-642"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360757"><span class="annot"><span class="annottext">proName :: Name
</span><a href="#local-6989586621681360757"><span class="hs-identifier hs-var hs-var">proName</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String, String) -&gt; Name -&gt; Name
</span><a href="Data.Singletons.Names.html#promoteValNameLhsPrefix"><span class="hs-identifier hs-var">promoteValNameLhsPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">(String, String)
</span><a href="#local-6989586621681360771"><span class="hs-identifier hs-var">prefixes</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360770"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-643"></span><span>      </span><span id="local-6989586621681360756"><span class="annot"><span class="annottext">m_fixity :: Maybe Fixity
</span><a href="#local-6989586621681360756"><span class="hs-identifier hs-var hs-var">m_fixity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; OMap Name Fixity -&gt; Maybe Fixity
forall k v. Ord k =&gt; k -&gt; OMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360770"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621681360772"><span class="hs-identifier hs-var">fix_env</span></a></span><span>
</span><span id="line-644"></span><span>  </span><span id="local-6989586621681360755"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360755"><span class="hs-identifier hs-var">all_locals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM [Name]
forall (m :: * -&gt; *). MonadReader PrEnv m =&gt; m [Name]
</span><a href="Data.Singletons.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a></span><span>
</span><span id="line-645"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360754"><span class="annot"><span class="annottext">local_tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681360754"><span class="hs-identifier hs-var hs-var">local_tvbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DTyVarBndr) -&gt; [Name] -&gt; [DTyVarBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DTyVarBndr
</span><span class="hs-identifier hs-var">DPlainTV</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360755"><span class="hs-identifier hs-var">all_locals</span></a></span><span>
</span><span id="line-646"></span><span>  </span><span id="local-6989586621681360753"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360753"><span class="hs-identifier hs-var">tyvarNames</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Maybe DType -&gt; PrM Name) -&gt; [Maybe DType] -&gt; PrM [Name]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrM Name -&gt; Maybe DType -&gt; PrM Name
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(PrM Name -&gt; Maybe DType -&gt; PrM Name)
-&gt; PrM Name -&gt; Maybe DType -&gt; PrM Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; PrM Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="hs-string">&quot;a&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Maybe DType]
</span><a href="#local-6989586621681360766"><span class="hs-identifier hs-var">m_argKs</span></a></span><span>
</span><span id="line-647"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360752"><span class="annot"><span class="annottext">args :: [DTyVarBndr]
</span><a href="#local-6989586621681360752"><span class="hs-identifier hs-var hs-var">args</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Maybe DType -&gt; DTyVarBndr)
-&gt; [Name] -&gt; [Maybe DType] -&gt; [DTyVarBndr]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe DType -&gt; DTyVarBndr
</span><a href="Data.Singletons.Util.html#inferMaybeKindTV"><span class="hs-identifier hs-var">inferMaybeKindTV</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360753"><span class="hs-identifier hs-var">tyvarNames</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe DType]
</span><a href="#local-6989586621681360766"><span class="hs-identifier hs-var">m_argKs</span></a></span><span>
</span><span id="line-648"></span><span>      </span><span id="local-6989586621681360750"><span class="annot"><span class="annottext">all_args :: [DTyVarBndr]
</span><a href="#local-6989586621681360750"><span class="hs-identifier hs-var hs-var">all_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360754"><span class="hs-identifier hs-var">local_tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; [DTyVarBndr] -&gt; [DTyVarBndr]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360752"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-649"></span><span>  </span><span id="local-6989586621681360749"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681360749"><span class="hs-identifier hs-var">defun_decs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Fixity -&gt; [DTyVarBndr] -&gt; Maybe DType -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#defunctionalize"><span class="hs-identifier hs-var">defunctionalize</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360757"><span class="hs-identifier hs-var">proName</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Fixity
</span><a href="#local-6989586621681360756"><span class="hs-identifier hs-var">m_fixity</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360750"><span class="hs-identifier hs-var">all_args</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681360765"><span class="hs-identifier hs-var">m_resK</span></a></span><span>
</span><span id="line-650"></span><span>  </span><span id="local-6989586621681360748"><span class="annot"><span class="annottext">[DClause]
</span><a href="#local-6989586621681360748"><span class="hs-identifier hs-var">expClauses</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DClause -&gt; PrM DClause) -&gt; [DClause] -&gt; PrM [DClause]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; DClause -&gt; PrM DClause
</span><a href="#local-6989586621681360747"><span class="hs-identifier hs-var">etaContractOrExpand</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360764"><span class="hs-identifier hs-var">ty_num_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360768"><span class="hs-identifier hs-var">numArgs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DClause]
</span><a href="#local-6989586621681360769"><span class="hs-identifier hs-var">clauses</span></a></span><span>
</span><span id="line-651"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360746"><span class="annot"><span class="annottext">lde_kvs_to_bind :: OSet Name
</span><a href="#local-6989586621681360746"><span class="hs-identifier hs-var hs-var">lde_kvs_to_bind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe DType -&gt; OSet Name) -&gt; [Maybe DType] -&gt; OSet Name
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DType -&gt; OSet Name) -&gt; Maybe DType -&gt; OSet Name
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; OSet Name
</span><span class="hs-identifier hs-var">fvDType</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Maybe DType]
</span><a href="#local-6989586621681360766"><span class="hs-identifier hs-var">m_argKs</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name -&gt; OSet Name -&gt; OSet Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(DType -&gt; OSet Name) -&gt; Maybe DType -&gt; OSet Name
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; OSet Name
</span><span class="hs-identifier hs-var">fvDType</span></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681360765"><span class="hs-identifier hs-var">m_resK</span></a></span><span>
</span><span id="line-652"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360745"><span class="annot"><span class="annottext">eqns :: [DTySynEqn]
</span><a href="#local-6989586621681360745"><span class="hs-identifier hs-var">eqns</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360744"><span class="annot"><span class="annottext">ann_clauses :: [ADClause]
</span><a href="#local-6989586621681360744"><span class="hs-identifier hs-var">ann_clauses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OSet Name
-&gt; PrM ([DTySynEqn], [ADClause]) -&gt; PrM ([DTySynEqn], [ADClause])
forall a. OSet Name -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681360746"><span class="hs-identifier hs-var">lde_kvs_to_bind</span></a></span><span> </span><span class="annot"><span class="annottext">(PrM ([DTySynEqn], [ADClause]) -&gt; PrM ([DTySynEqn], [ADClause]))
-&gt; PrM ([DTySynEqn], [ADClause]) -&gt; PrM ([DTySynEqn], [ADClause])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-653"></span><span>                         </span><span class="annot"><span class="annottext">(DClause -&gt; PrM (DTySynEqn, ADClause))
-&gt; [DClause] -&gt; PrM ([DTySynEqn], [ADClause])
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; m (b, c)) -&gt; [a] -&gt; m ([b], [c])
</span><span class="hs-identifier hs-var">mapAndUnzipM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DClause -&gt; PrM (DTySynEqn, ADClause)
</span><a href="Data.Singletons.Promote.html#promoteClause"><span class="hs-identifier hs-var">promoteClause</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360757"><span class="hs-identifier hs-var">proName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DClause]
</span><a href="#local-6989586621681360748"><span class="hs-identifier hs-var">expClauses</span></a></span><span>
</span><span id="line-654"></span><span>  </span><span id="local-6989586621681360741"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360741"><span class="hs-identifier hs-var">prom_fun</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; PrM DType
</span><a href="Data.Singletons.Promote.Monad.html#lookupVarE"><span class="hs-identifier hs-var">lookupVarE</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360770"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-655"></span><span>  </span><span class="annot"><span class="annottext">((Name, [DTyVarBndr], Maybe DType, [DTySynEqn]), [DDec],
 ALetDecRHS)
-&gt; PrM
     ((Name, [DTyVarBndr], Maybe DType, [DTySynEqn]), [DDec],
      ALetDecRHS)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360757"><span class="hs-identifier hs-var">proName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360750"><span class="hs-identifier hs-var">all_args</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681360765"><span class="hs-identifier hs-var">m_resK</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DTySynEqn]
</span><a href="#local-6989586621681360745"><span class="hs-identifier hs-var">eqns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-656"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681360749"><span class="hs-identifier hs-var">defun_decs</span></a></span><span>
</span><span id="line-657"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; Int -&gt; [ADClause] -&gt; ALetDecRHS
</span><a href="Data.Singletons.Syntax.html#AFunction"><span class="hs-identifier hs-var">AFunction</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360741"><span class="hs-identifier hs-var">prom_fun</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360764"><span class="hs-identifier hs-var">ty_num_args</span></a></span><span> </span><span class="annot"><span class="annottext">[ADClause]
</span><a href="#local-6989586621681360744"><span class="hs-identifier hs-var">ann_clauses</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-658"></span><span>
</span><span id="line-659"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-660"></span><span>    </span><span class="annot"><a href="#local-6989586621681360747"><span class="hs-identifier hs-type">etaContractOrExpand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DClause</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DClause</span></span><span>
</span><span id="line-661"></span><span>    </span><span id="local-6989586621681360747"><span class="annot"><span class="annottext">etaContractOrExpand :: Int -&gt; Int -&gt; DClause -&gt; PrM DClause
</span><a href="#local-6989586621681360747"><span class="hs-identifier hs-var hs-var">etaContractOrExpand</span></a></span></span><span> </span><span id="local-6989586621681360738"><span class="annot"><span class="annottext">ty_num_args :: Int
</span><a href="#local-6989586621681360738"><span class="hs-identifier hs-var">ty_num_args</span></a></span></span><span> </span><span id="local-6989586621681360737"><span class="annot"><span class="annottext">clause_num_args :: Int
</span><a href="#local-6989586621681360737"><span class="hs-identifier hs-var">clause_num_args</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DClause</span></span><span> </span><span id="local-6989586621681360736"><span class="annot"><span class="annottext">pats :: [DPat]
</span><a href="#local-6989586621681360736"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span id="local-6989586621681360735"><span class="annot"><span class="annottext">exp :: DExp
</span><a href="#local-6989586621681360735"><span class="hs-identifier hs-var">exp</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-662"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360734"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Eta-expand</span><span>
</span><span id="line-663"></span><span>          </span><span id="local-6989586621681360733"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360733"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; PrM Name -&gt; PrM [Name]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360734"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; PrM Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">newUniqueName</span></span><span> </span><span class="annot"><span class="hs-string">&quot;a&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-664"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360732"><span class="annot"><span class="annottext">newPats :: [DPat]
</span><a href="#local-6989586621681360732"><span class="hs-identifier hs-var hs-var">newPats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DPat) -&gt; [Name] -&gt; [DPat]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DPat
</span><span class="hs-identifier hs-var">DVarP</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360733"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-665"></span><span>              </span><span id="local-6989586621681360731"><span class="annot"><span class="annottext">newArgs :: [DExp]
</span><a href="#local-6989586621681360731"><span class="hs-identifier hs-var hs-var">newArgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DExp) -&gt; [Name] -&gt; [DExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360733"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-666"></span><span>          </span><span class="annot"><span class="annottext">DClause -&gt; PrM DClause
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DClause -&gt; PrM DClause) -&gt; DClause -&gt; PrM DClause
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DPat] -&gt; DExp -&gt; DClause
</span><span class="hs-identifier hs-var">DClause</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621681360736"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="annot"><span class="annottext">[DPat] -&gt; [DPat] -&gt; [DPat]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621681360732"><span class="hs-identifier hs-var">newPats</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DExp -&gt; [DExp] -&gt; DExp
</span><a href="Data.Singletons.Util.html#foldExp"><span class="hs-identifier hs-var">foldExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681360735"><span class="hs-identifier hs-var">exp</span></a></span><span> </span><span class="annot"><span class="annottext">[DExp]
</span><a href="#local-6989586621681360731"><span class="hs-identifier hs-var">newArgs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-667"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Eta-contract</span><span>
</span><span id="line-668"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681360730"><span class="annot"><span class="annottext">clausePats :: [DPat]
</span><a href="#local-6989586621681360730"><span class="hs-identifier hs-var">clausePats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360729"><span class="annot"><span class="annottext">lamPats :: [DPat]
</span><a href="#local-6989586621681360729"><span class="hs-identifier hs-var">lamPats</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [DPat] -&gt; ([DPat], [DPat])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360738"><span class="hs-identifier hs-var">ty_num_args</span></a></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621681360736"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-669"></span><span>          </span><span id="local-6989586621681360727"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681360727"><span class="hs-identifier hs-var">lamExp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DPat] -&gt; DExp -&gt; PrM DExp
forall (q :: * -&gt; *). DsMonad q =&gt; [DPat] -&gt; DExp -&gt; q DExp
</span><span class="hs-identifier hs-var">mkDLamEFromDPats</span></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621681360729"><span class="hs-identifier hs-var">lamPats</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681360735"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-670"></span><span>          </span><span class="annot"><span class="annottext">DClause -&gt; PrM DClause
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DClause -&gt; PrM DClause) -&gt; DClause -&gt; PrM DClause
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DPat] -&gt; DExp -&gt; DClause
</span><span class="hs-identifier hs-var">DClause</span></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621681360730"><span class="hs-identifier hs-var">clausePats</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681360727"><span class="hs-identifier hs-var">lamExp</span></a></span><span>
</span><span id="line-671"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-672"></span><span>        </span><span id="local-6989586621681360734"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621681360734"><span class="hs-identifier hs-var hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360738"><span class="hs-identifier hs-var">ty_num_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360737"><span class="hs-identifier hs-var">clause_num_args</span></a></span><span>
</span><span id="line-673"></span><span>
</span><span id="line-674"></span><span>    </span><span id="local-6989586621681360767"><span class="annot"><span class="annottext">count_args :: [DClause] -&gt; m Int
</span><a href="#local-6989586621681360767"><span class="hs-identifier hs-var hs-var">count_args</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DClause</span></span><span> </span><span id="local-6989586621681360725"><span class="annot"><span class="annottext">pats :: [DPat]
</span><a href="#local-6989586621681360725"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; m Int) -&gt; Int -&gt; m Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DPat] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621681360725"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-675"></span><span>    </span><span class="annot"><a href="#local-6989586621681360767"><span class="hs-identifier hs-var">count_args</span></a></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; m Int
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m Int) -&gt; String -&gt; m Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Impossible! A function without clauses.&quot;</span></span><span>
</span><span id="line-676"></span><span>
</span><span id="line-677"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteClause"><span class="hs-identifier hs-type">promoteClause</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DClause</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTySynEqn</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ADClause"><span class="hs-identifier hs-type">ADClause</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-678"></span><span id="promoteClause"><span class="annot"><span class="annottext">promoteClause :: Name -&gt; DClause -&gt; PrM (DTySynEqn, ADClause)
</span><a href="Data.Singletons.Promote.html#promoteClause"><span class="hs-identifier hs-var hs-var">promoteClause</span></a></span></span><span> </span><span id="local-6989586621681360724"><span class="annot"><span class="annottext">proName :: Name
</span><a href="#local-6989586621681360724"><span class="hs-identifier hs-var">proName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DClause</span></span><span> </span><span id="local-6989586621681360723"><span class="annot"><span class="annottext">pats :: [DPat]
</span><a href="#local-6989586621681360723"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span id="local-6989586621681360722"><span class="annot"><span class="annottext">exp :: DExp
</span><a href="#local-6989586621681360722"><span class="hs-identifier hs-var">exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-679"></span><span>  </span><span class="hs-comment">-- promoting the patterns creates variable bindings. These are passed</span><span>
</span><span id="line-680"></span><span>  </span><span class="hs-comment">-- to the function promoted the RHS</span><span>
</span><span id="line-681"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621681360721"><span class="annot"><span class="annottext">types :: DCxt
</span><a href="#local-6989586621681360721"><span class="hs-identifier hs-var">types</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360720"><span class="annot"><span class="annottext">pats' :: [ADPat]
</span><a href="#local-6989586621681360720"><span class="hs-identifier hs-var">pats'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360719"><span class="annot"><span class="annottext">prom_pat_infos :: PromDPatInfos
</span><a href="#local-6989586621681360719"><span class="hs-identifier hs-var">prom_pat_infos</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">QWithAux PromDPatInfos PrM (DCxt, [ADPat])
-&gt; PrM ((DCxt, [ADPat]), PromDPatInfos)
forall m (q :: * -&gt; *) a. QWithAux m q a -&gt; q (a, m)
</span><a href="Data.Singletons.Util.html#evalForPair"><span class="hs-identifier hs-var">evalForPair</span></a></span><span> </span><span class="annot"><span class="annottext">(QWithAux PromDPatInfos PrM (DCxt, [ADPat])
 -&gt; PrM ((DCxt, [ADPat]), PromDPatInfos))
-&gt; QWithAux PromDPatInfos PrM (DCxt, [ADPat])
-&gt; PrM ((DCxt, [ADPat]), PromDPatInfos)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DPat -&gt; QWithAux PromDPatInfos PrM (DType, ADPat))
-&gt; [DPat] -&gt; QWithAux PromDPatInfos PrM (DCxt, [ADPat])
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; m (b, c)) -&gt; [a] -&gt; m ([b], [c])
</span><span class="hs-identifier hs-var">mapAndUnzipM</span></span><span> </span><span class="annot"><span class="annottext">DPat -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
</span><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621681360723"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-682"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-type">PromDPatInfos</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">prom_dpat_vars :: PromDPatInfos -&gt; VarPromotions
</span><a href="Data.Singletons.Syntax.html#prom_dpat_vars"><span class="hs-identifier hs-var">prom_dpat_vars</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360714"><span class="annot"><span class="annottext">VarPromotions
</span><a href="#local-6989586621681360714"><span class="hs-identifier hs-var">new_vars</span></a></span></span><span>
</span><span id="line-683"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">prom_dpat_sig_kvs :: PromDPatInfos -&gt; OSet Name
</span><a href="Data.Singletons.Syntax.html#prom_dpat_sig_kvs"><span class="hs-identifier hs-var">prom_dpat_sig_kvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360712"><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681360712"><span class="hs-identifier hs-var">sig_kvs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PromDPatInfos
</span><a href="#local-6989586621681360719"><span class="hs-identifier hs-var">prom_pat_infos</span></a></span><span>
</span><span id="line-684"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360711"><span class="annot"><span class="annottext">ty :: DType
</span><a href="#local-6989586621681360711"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360710"><span class="annot"><span class="annottext">ann_exp :: ADExp
</span><a href="#local-6989586621681360710"><span class="hs-identifier hs-var">ann_exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OSet Name -&gt; PrM (DType, ADExp) -&gt; PrM (DType, ADExp)
forall a. OSet Name -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681360712"><span class="hs-identifier hs-var">sig_kvs</span></a></span><span> </span><span class="annot"><span class="annottext">(PrM (DType, ADExp) -&gt; PrM (DType, ADExp))
-&gt; PrM (DType, ADExp) -&gt; PrM (DType, ADExp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-685"></span><span>                   </span><span class="annot"><span class="annottext">VarPromotions -&gt; PrM (DType, ADExp) -&gt; PrM (DType, ADExp)
forall a. VarPromotions -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.Promote.Monad.html#lambdaBind"><span class="hs-identifier hs-var">lambdaBind</span></a></span><span> </span><span class="annot"><span class="annottext">VarPromotions
</span><a href="#local-6989586621681360714"><span class="hs-identifier hs-var">new_vars</span></a></span><span> </span><span class="annot"><span class="annottext">(PrM (DType, ADExp) -&gt; PrM (DType, ADExp))
-&gt; PrM (DType, ADExp) -&gt; PrM (DType, ADExp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-686"></span><span>                   </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681360722"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-687"></span><span>  </span><span id="local-6989586621681360708"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360708"><span class="hs-identifier hs-var">all_locals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM [Name]
forall (m :: * -&gt; *). MonadReader PrEnv m =&gt; m [Name]
</span><a href="Data.Singletons.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a></span><span>   </span><span class="hs-comment">-- these are bound *outside* of this clause</span><span>
</span><span id="line-688"></span><span>  </span><span class="annot"><span class="annottext">(DTySynEqn, ADClause) -&gt; PrM (DTySynEqn, ADClause)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe [DTyVarBndr] -&gt; DType -&gt; DType -&gt; DTySynEqn
</span><span class="hs-identifier hs-var">DTySynEqn</span></span><span> </span><span class="annot"><span class="annottext">Maybe [DTyVarBndr]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DCxt -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360724"><span class="hs-identifier hs-var">proName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DCxt -&gt; DType) -&gt; DCxt -&gt; DType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; DCxt
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360708"><span class="hs-identifier hs-var">all_locals</span></a></span><span> </span><span class="annot"><span class="annottext">DCxt -&gt; DCxt -&gt; DCxt
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360721"><span class="hs-identifier hs-var">types</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360711"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-689"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarPromotions -&gt; [ADPat] -&gt; ADExp -&gt; ADClause
</span><a href="Data.Singletons.Syntax.html#ADClause"><span class="hs-identifier hs-var">ADClause</span></a></span><span> </span><span class="annot"><span class="annottext">VarPromotions
</span><a href="#local-6989586621681360714"><span class="hs-identifier hs-var">new_vars</span></a></span><span> </span><span class="annot"><span class="annottext">[ADPat]
</span><a href="#local-6989586621681360720"><span class="hs-identifier hs-var">pats'</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681360710"><span class="hs-identifier hs-var">ann_exp</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-690"></span><span>
</span><span id="line-691"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteMatch"><span class="hs-identifier hs-type">promoteMatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DMatch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTySynEqn</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ADMatch"><span class="hs-identifier hs-type">ADMatch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-692"></span><span id="promoteMatch"><span class="annot"><span class="annottext">promoteMatch :: Name -&gt; DMatch -&gt; PrM (DTySynEqn, ADMatch)
</span><a href="Data.Singletons.Promote.html#promoteMatch"><span class="hs-identifier hs-var hs-var">promoteMatch</span></a></span></span><span> </span><span id="local-6989586621681360705"><span class="annot"><span class="annottext">caseTFName :: Name
</span><a href="#local-6989586621681360705"><span class="hs-identifier hs-var">caseTFName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DMatch</span></span><span> </span><span id="local-6989586621681360703"><span class="annot"><span class="annottext">pat :: DPat
</span><a href="#local-6989586621681360703"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621681360702"><span class="annot"><span class="annottext">exp :: DExp
</span><a href="#local-6989586621681360702"><span class="hs-identifier hs-var">exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-693"></span><span>  </span><span class="hs-comment">-- promoting the patterns creates variable bindings. These are passed</span><span>
</span><span id="line-694"></span><span>  </span><span class="hs-comment">-- to the function promoted the RHS</span><span>
</span><span id="line-695"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621681360701"><span class="annot"><span class="annottext">ty :: DType
</span><a href="#local-6989586621681360701"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360700"><span class="annot"><span class="annottext">pat' :: ADPat
</span><a href="#local-6989586621681360700"><span class="hs-identifier hs-var">pat'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360699"><span class="annot"><span class="annottext">prom_pat_infos :: PromDPatInfos
</span><a href="#local-6989586621681360699"><span class="hs-identifier hs-var">prom_pat_infos</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">QWithAux PromDPatInfos PrM (DType, ADPat)
-&gt; PrM ((DType, ADPat), PromDPatInfos)
forall m (q :: * -&gt; *) a. QWithAux m q a -&gt; q (a, m)
</span><a href="Data.Singletons.Util.html#evalForPair"><span class="hs-identifier hs-var">evalForPair</span></a></span><span> </span><span class="annot"><span class="annottext">(QWithAux PromDPatInfos PrM (DType, ADPat)
 -&gt; PrM ((DType, ADPat), PromDPatInfos))
-&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
-&gt; PrM ((DType, ADPat), PromDPatInfos)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DPat -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
</span><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621681360703"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-696"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-type">PromDPatInfos</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">prom_dpat_vars :: PromDPatInfos -&gt; VarPromotions
</span><a href="Data.Singletons.Syntax.html#prom_dpat_vars"><span class="hs-identifier hs-var">prom_dpat_vars</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360698"><span class="annot"><span class="annottext">VarPromotions
</span><a href="#local-6989586621681360698"><span class="hs-identifier hs-var">new_vars</span></a></span></span><span>
</span><span id="line-697"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">prom_dpat_sig_kvs :: PromDPatInfos -&gt; OSet Name
</span><a href="Data.Singletons.Syntax.html#prom_dpat_sig_kvs"><span class="hs-identifier hs-var">prom_dpat_sig_kvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360697"><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681360697"><span class="hs-identifier hs-var">sig_kvs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PromDPatInfos
</span><a href="#local-6989586621681360699"><span class="hs-identifier hs-var">prom_pat_infos</span></a></span><span>
</span><span id="line-698"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360696"><span class="annot"><span class="annottext">rhs :: DType
</span><a href="#local-6989586621681360696"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360695"><span class="annot"><span class="annottext">ann_exp :: ADExp
</span><a href="#local-6989586621681360695"><span class="hs-identifier hs-var">ann_exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OSet Name -&gt; PrM (DType, ADExp) -&gt; PrM (DType, ADExp)
forall a. OSet Name -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621681360697"><span class="hs-identifier hs-var">sig_kvs</span></a></span><span> </span><span class="annot"><span class="annottext">(PrM (DType, ADExp) -&gt; PrM (DType, ADExp))
-&gt; PrM (DType, ADExp) -&gt; PrM (DType, ADExp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-699"></span><span>                    </span><span class="annot"><span class="annottext">VarPromotions -&gt; PrM (DType, ADExp) -&gt; PrM (DType, ADExp)
forall a. VarPromotions -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.Promote.Monad.html#lambdaBind"><span class="hs-identifier hs-var">lambdaBind</span></a></span><span> </span><span class="annot"><span class="annottext">VarPromotions
</span><a href="#local-6989586621681360698"><span class="hs-identifier hs-var">new_vars</span></a></span><span> </span><span class="annot"><span class="annottext">(PrM (DType, ADExp) -&gt; PrM (DType, ADExp))
-&gt; PrM (DType, ADExp) -&gt; PrM (DType, ADExp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-700"></span><span>                    </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681360702"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-701"></span><span>  </span><span id="local-6989586621681360694"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360694"><span class="hs-identifier hs-var">all_locals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM [Name]
forall (m :: * -&gt; *). MonadReader PrEnv m =&gt; m [Name]
</span><a href="Data.Singletons.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a></span><span>
</span><span id="line-702"></span><span>  </span><span class="annot"><span class="annottext">(DTySynEqn, ADMatch) -&gt; PrM (DTySynEqn, ADMatch)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">((DTySynEqn, ADMatch) -&gt; PrM (DTySynEqn, ADMatch))
-&gt; (DTySynEqn, ADMatch) -&gt; PrM (DTySynEqn, ADMatch)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe [DTyVarBndr] -&gt; DType -&gt; DType -&gt; DTySynEqn
</span><span class="hs-identifier hs-var">DTySynEqn</span></span><span> </span><span class="annot"><span class="annottext">Maybe [DTyVarBndr]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-703"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DCxt -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360705"><span class="hs-identifier hs-var">caseTFName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DCxt -&gt; DType) -&gt; DCxt -&gt; DType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; DCxt
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360694"><span class="hs-identifier hs-var">all_locals</span></a></span><span> </span><span class="annot"><span class="annottext">DCxt -&gt; DCxt -&gt; DCxt
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360701"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-704"></span><span>                       </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360696"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-705"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarPromotions -&gt; ADPat -&gt; ADExp -&gt; ADMatch
</span><a href="Data.Singletons.Syntax.html#ADMatch"><span class="hs-identifier hs-var">ADMatch</span></a></span><span> </span><span class="annot"><span class="annottext">VarPromotions
</span><a href="#local-6989586621681360698"><span class="hs-identifier hs-var">new_vars</span></a></span><span> </span><span class="annot"><span class="annottext">ADPat
</span><a href="#local-6989586621681360700"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681360695"><span class="hs-identifier hs-var">ann_exp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-706"></span><span>
</span><span id="line-707"></span><span class="hs-comment">-- promotes a term pattern into a type pattern, accumulating bound variable names</span><span>
</span><span id="line-708"></span><span class="annot"><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-type">promotePat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DPat</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Util.html#QWithAux"><span class="hs-identifier hs-type">QWithAux</span></a></span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-type">PromDPatInfos</span></a></span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ADPat"><span class="hs-identifier hs-type">ADPat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-709"></span><span id="promotePat"><span class="annot"><span class="annottext">promotePat :: DPat -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
</span><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var hs-var">promotePat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DLitP</span></span><span> </span><span id="local-6989586621681360691"><span class="annot"><span class="annottext">lit :: Lit
</span><a href="#local-6989586621681360691"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span> </span><span class="annot"><span class="annottext">Lit -&gt; ADPat
</span><a href="Data.Singletons.Syntax.html#ADLitP"><span class="hs-identifier hs-var">ADLitP</span></a></span><span> </span><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621681360691"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; (DType, ADPat))
-&gt; QWithAux PromDPatInfos PrM DType
-&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Lit -&gt; QWithAux PromDPatInfos PrM DType
forall (m :: * -&gt; *). MonadFail m =&gt; Lit -&gt; m DType
</span><a href="Data.Singletons.Promote.html#promoteLitPat"><span class="hs-identifier hs-var">promoteLitPat</span></a></span><span> </span><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621681360691"><span class="hs-identifier hs-var">lit</span></a></span><span>
</span><span id="line-710"></span><span class="annot"><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DVarP</span></span><span> </span><span id="local-6989586621681360687"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681360687"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-711"></span><span>      </span><span class="hs-comment">-- term vars can be symbols... type vars can't!</span><span>
</span><span id="line-712"></span><span>  </span><span id="local-6989586621681360686"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360686"><span class="hs-identifier hs-var">tyName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; QWithAux PromDPatInfos PrM Name
forall (q :: * -&gt; *). Quasi q =&gt; Name -&gt; q Name
</span><a href="Data.Singletons.Names.html#mkTyName"><span class="hs-identifier hs-var">mkTyName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360687"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-713"></span><span>  </span><span class="annot"><span class="annottext">PromDPatInfos -&gt; QWithAux PromDPatInfos PrM ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">(PromDPatInfos -&gt; QWithAux PromDPatInfos PrM ())
-&gt; PromDPatInfos -&gt; QWithAux PromDPatInfos PrM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarPromotions -&gt; OSet Name -&gt; PromDPatInfos
</span><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-var">PromDPatInfos</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360687"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360686"><span class="hs-identifier hs-var">tyName</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">OSet Name
forall a. OSet a
</span><span class="hs-identifier hs-var">OSet.empty</span></span><span>
</span><span id="line-714"></span><span>  </span><span class="annot"><span class="annottext">(DType, ADPat) -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360686"><span class="hs-identifier hs-var">tyName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name -&gt; ADPat
</span><a href="Data.Singletons.Syntax.html#ADVarP"><span class="hs-identifier hs-var">ADVarP</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360687"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-715"></span><span class="annot"><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DConP</span></span><span> </span><span id="local-6989586621681360680"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681360680"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681360679"><span class="annot"><span class="annottext">pats :: [DPat]
</span><a href="#local-6989586621681360679"><span class="hs-identifier hs-var">pats</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-716"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360678"><span class="annot"><span class="annottext">types :: DCxt
</span><a href="#local-6989586621681360678"><span class="hs-identifier hs-var">types</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360677"><span class="annot"><span class="annottext">pats' :: [ADPat]
</span><a href="#local-6989586621681360677"><span class="hs-identifier hs-var">pats'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DPat -&gt; QWithAux PromDPatInfos PrM (DType, ADPat))
-&gt; [DPat] -&gt; QWithAux PromDPatInfos PrM (DCxt, [ADPat])
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; m (b, c)) -&gt; [a] -&gt; m ([b], [c])
</span><span class="hs-identifier hs-var">mapAndUnzipM</span></span><span> </span><span class="annot"><span class="annottext">DPat -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
</span><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621681360679"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-717"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360676"><span class="annot"><span class="annottext">name' :: Name
</span><a href="#local-6989586621681360676"><span class="hs-identifier hs-var hs-var">name'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="#local-6989586621681360675"><span class="hs-identifier hs-var">unboxed_tuple_to_tuple</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360680"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-718"></span><span>  </span><span class="annot"><span class="annottext">(DType, ADPat) -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DCxt -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360676"><span class="hs-identifier hs-var">name'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681360678"><span class="hs-identifier hs-var">types</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [ADPat] -&gt; ADPat
</span><a href="Data.Singletons.Syntax.html#ADConP"><span class="hs-identifier hs-var">ADConP</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360680"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[ADPat]
</span><a href="#local-6989586621681360677"><span class="hs-identifier hs-var">pats'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-719"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-720"></span><span>    </span><span id="local-6989586621681360675"><span class="annot"><span class="annottext">unboxed_tuple_to_tuple :: Name -&gt; Name
</span><a href="#local-6989586621681360675"><span class="hs-identifier hs-var hs-var">unboxed_tuple_to_tuple</span></a></span></span><span> </span><span id="local-6989586621681360673"><span class="annot"><span class="annottext">n :: Name
</span><a href="#local-6989586621681360673"><span class="hs-identifier hs-var">n</span></a></span></span><span>
</span><span id="line-721"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681360672"><span class="annot"><span class="annottext">deg :: Int
</span><a href="#local-6989586621681360672"><span class="hs-identifier hs-var">deg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Int
</span><span class="hs-identifier hs-var">unboxedTupleNameDegree_maybe</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360673"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Name
</span><span class="hs-identifier hs-var">tupleDataName</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360672"><span class="hs-identifier hs-var">deg</span></a></span><span>
</span><span id="line-722"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360673"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-723"></span><span class="annot"><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTildeP</span></span><span> </span><span id="local-6989586621681360668"><span class="annot"><span class="annottext">pat :: DPat
</span><a href="#local-6989586621681360668"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-724"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; QWithAux PromDPatInfos PrM ()
forall (q :: * -&gt; *). Quasi q =&gt; String -&gt; q ()
</span><a href="Data.Singletons.Util.html#qReportWarning"><span class="hs-identifier hs-var">qReportWarning</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Lazy pattern converted into regular pattern in promotion&quot;</span></span><span>
</span><span id="line-725"></span><span>  </span><span class="annot"><span class="annottext">(ADPat -&gt; ADPat) -&gt; (DType, ADPat) -&gt; (DType, ADPat)
forall (a :: * -&gt; * -&gt; *) b c d.
Arrow a =&gt;
a b c -&gt; a (d, b) (d, c)
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">ADPat -&gt; ADPat
</span><a href="Data.Singletons.Syntax.html#ADTildeP"><span class="hs-identifier hs-var">ADTildeP</span></a></span><span> </span><span class="annot"><span class="annottext">((DType, ADPat) -&gt; (DType, ADPat))
-&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
-&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">DPat -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
</span><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621681360668"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-726"></span><span class="annot"><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DBangP</span></span><span> </span><span id="local-6989586621681360664"><span class="annot"><span class="annottext">pat :: DPat
</span><a href="#local-6989586621681360664"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-727"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; QWithAux PromDPatInfos PrM ()
forall (q :: * -&gt; *). Quasi q =&gt; String -&gt; q ()
</span><a href="Data.Singletons.Util.html#qReportWarning"><span class="hs-identifier hs-var">qReportWarning</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Strict pattern converted into regular pattern in promotion&quot;</span></span><span>
</span><span id="line-728"></span><span>  </span><span class="annot"><span class="annottext">(ADPat -&gt; ADPat) -&gt; (DType, ADPat) -&gt; (DType, ADPat)
forall (a :: * -&gt; * -&gt; *) b c d.
Arrow a =&gt;
a b c -&gt; a (d, b) (d, c)
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">ADPat -&gt; ADPat
</span><a href="Data.Singletons.Syntax.html#ADBangP"><span class="hs-identifier hs-var">ADBangP</span></a></span><span> </span><span class="annot"><span class="annottext">((DType, ADPat) -&gt; (DType, ADPat))
-&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
-&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">DPat -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
</span><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621681360664"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-729"></span><span class="annot"><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DSigP</span></span><span> </span><span id="local-6989586621681360661"><span class="annot"><span class="annottext">pat :: DPat
</span><a href="#local-6989586621681360661"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621681360660"><span class="annot"><span class="annottext">ty :: DType
</span><a href="#local-6989586621681360660"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-730"></span><span>  </span><span class="hs-comment">-- We must maintain the invariant that any promoted pattern signature must</span><span>
</span><span id="line-731"></span><span>  </span><span class="hs-comment">-- not have any wildcards in the underlying pattern.</span><span>
</span><span id="line-732"></span><span>  </span><span class="hs-comment">-- See Note [Singling pattern signatures].</span><span>
</span><span id="line-733"></span><span>  </span><span id="local-6989586621681360659"><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621681360659"><span class="hs-identifier hs-var">wildless_pat</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DPat -&gt; QWithAux PromDPatInfos PrM DPat
forall (q :: * -&gt; *). DsMonad q =&gt; DPat -&gt; q DPat
</span><span class="hs-identifier hs-var">removeWilds</span></span><span> </span><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621681360661"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-734"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360657"><span class="annot"><span class="annottext">promoted :: DType
</span><a href="#local-6989586621681360657"><span class="hs-identifier hs-var">promoted</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360656"><span class="annot"><span class="annottext">pat' :: ADPat
</span><a href="#local-6989586621681360656"><span class="hs-identifier hs-var">pat'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DPat -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
</span><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621681360659"><span class="hs-identifier hs-var">wildless_pat</span></a></span><span>
</span><span id="line-735"></span><span>  </span><span id="local-6989586621681360655"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360655"><span class="hs-identifier hs-var">ki</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DType -&gt; QWithAux PromDPatInfos PrM DType
forall (m :: * -&gt; *). MonadFail m =&gt; DType -&gt; m DType
</span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360660"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-736"></span><span>  </span><span class="annot"><span class="annottext">PromDPatInfos -&gt; QWithAux PromDPatInfos PrM ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">(PromDPatInfos -&gt; QWithAux PromDPatInfos PrM ())
-&gt; PromDPatInfos -&gt; QWithAux PromDPatInfos PrM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarPromotions -&gt; OSet Name -&gt; PromDPatInfos
</span><a href="Data.Singletons.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-var">PromDPatInfos</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; OSet Name
</span><span class="hs-identifier hs-var">fvDType</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360655"><span class="hs-identifier hs-var">ki</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-737"></span><span>  </span><span class="annot"><span class="annottext">(DType, ADPat) -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-identifier hs-var">DSigT</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360657"><span class="hs-identifier hs-var">promoted</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360655"><span class="hs-identifier hs-var">ki</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; ADPat -&gt; DType -&gt; ADPat
</span><a href="Data.Singletons.Syntax.html#ADSigP"><span class="hs-identifier hs-var">ADSigP</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360657"><span class="hs-identifier hs-var">promoted</span></a></span><span> </span><span class="annot"><span class="annottext">ADPat
</span><a href="#local-6989586621681360656"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360655"><span class="hs-identifier hs-var">ki</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-738"></span><span class="annot"><a href="Data.Singletons.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DWildP</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DType, ADPat) -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><span class="hs-identifier hs-var">DWildCardT</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ADPat
</span><a href="Data.Singletons.Syntax.html#ADWildP"><span class="hs-identifier hs-var">ADWildP</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-739"></span><span>
</span><span id="line-740"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-type">promoteExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DExp</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#ADExp"><span class="hs-identifier hs-type">ADExp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-741"></span><span id="promoteExp"><span class="annot"><span class="annottext">promoteExp :: DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var hs-var">promoteExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DVarE</span></span><span> </span><span id="local-6989586621681360649"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681360649"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; (DType, ADExp)) -&gt; PrM DType -&gt; PrM (DType, ADExp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; ADExp
</span><a href="Data.Singletons.Syntax.html#ADVarE"><span class="hs-identifier hs-var">ADVarE</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360649"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PrM DType -&gt; PrM (DType, ADExp))
-&gt; PrM DType -&gt; PrM (DType, ADExp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; PrM DType
</span><a href="Data.Singletons.Promote.Monad.html#lookupVarE"><span class="hs-identifier hs-var">lookupVarE</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360649"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-742"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DConE</span></span><span> </span><span id="local-6989586621681360646"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621681360646"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DType, ADExp) -&gt; PrM (DType, ADExp)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">((DType, ADExp) -&gt; PrM (DType, ADExp))
-&gt; (DType, ADExp) -&gt; PrM (DType, ADExp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><a href="Data.Singletons.Names.html#promoteValRhs"><span class="hs-identifier hs-var">promoteValRhs</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360646"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name -&gt; ADExp
</span><a href="Data.Singletons.Syntax.html#ADConE"><span class="hs-identifier hs-var">ADConE</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360646"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-743"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DLitE</span></span><span> </span><span id="local-6989586621681360643"><span class="annot"><span class="annottext">lit :: Lit
</span><a href="#local-6989586621681360643"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; (DType, ADExp)) -&gt; PrM DType -&gt; PrM (DType, ADExp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span> </span><span class="annot"><span class="annottext">Lit -&gt; ADExp
</span><a href="Data.Singletons.Syntax.html#ADLitE"><span class="hs-identifier hs-var">ADLitE</span></a></span><span> </span><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621681360643"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PrM DType -&gt; PrM (DType, ADExp))
-&gt; PrM DType -&gt; PrM (DType, ADExp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lit -&gt; PrM DType
forall (q :: * -&gt; *). Quasi q =&gt; Lit -&gt; q DType
</span><a href="Data.Singletons.Promote.html#promoteLitExp"><span class="hs-identifier hs-var">promoteLitExp</span></a></span><span> </span><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621681360643"><span class="hs-identifier hs-var">lit</span></a></span><span>
</span><span id="line-744"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DAppE</span></span><span> </span><span id="local-6989586621681360639"><span class="annot"><span class="annottext">exp1 :: DExp
</span><a href="#local-6989586621681360639"><span class="hs-identifier hs-var">exp1</span></a></span></span><span> </span><span id="local-6989586621681360638"><span class="annot"><span class="annottext">exp2 :: DExp
</span><a href="#local-6989586621681360638"><span class="hs-identifier hs-var">exp2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-745"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360637"><span class="annot"><span class="annottext">exp1' :: DType
</span><a href="#local-6989586621681360637"><span class="hs-identifier hs-var">exp1'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360636"><span class="annot"><span class="annottext">ann_exp1 :: ADExp
</span><a href="#local-6989586621681360636"><span class="hs-identifier hs-var">ann_exp1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681360639"><span class="hs-identifier hs-var">exp1</span></a></span><span>
</span><span id="line-746"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360635"><span class="annot"><span class="annottext">exp2' :: DType
</span><a href="#local-6989586621681360635"><span class="hs-identifier hs-var">exp2'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360634"><span class="annot"><span class="annottext">ann_exp2 :: ADExp
</span><a href="#local-6989586621681360634"><span class="hs-identifier hs-var">ann_exp2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681360638"><span class="hs-identifier hs-var">exp2</span></a></span><span>
</span><span id="line-747"></span><span>  </span><span class="annot"><span class="annottext">(DType, ADExp) -&gt; PrM (DType, ADExp)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Names.html#apply"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360637"><span class="hs-identifier hs-var">exp1'</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360635"><span class="hs-identifier hs-var">exp2'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ADExp -&gt; ADExp -&gt; ADExp
</span><a href="Data.Singletons.Syntax.html#ADAppE"><span class="hs-identifier hs-var">ADAppE</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681360636"><span class="hs-identifier hs-var">ann_exp1</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681360634"><span class="hs-identifier hs-var">ann_exp2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-748"></span><span class="hs-comment">-- Until we get visible kind applications, this is the best we can do.</span><span>
</span><span id="line-749"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DAppTypeE</span></span><span> </span><span id="local-6989586621681360630"><span class="annot"><span class="annottext">exp :: DExp
</span><a href="#local-6989586621681360630"><span class="hs-identifier hs-var">exp</span></a></span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-750"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; PrM ()
forall (q :: * -&gt; *). Quasi q =&gt; String -&gt; q ()
</span><a href="Data.Singletons.Util.html#qReportWarning"><span class="hs-identifier hs-var">qReportWarning</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Visible type applications are ignored by `singletons`.&quot;</span></span><span>
</span><span id="line-751"></span><span>  </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681360630"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-752"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DLamE</span></span><span> </span><span id="local-6989586621681360628"><span class="annot"><span class="annottext">names :: [Name]
</span><a href="#local-6989586621681360628"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span id="local-6989586621681360627"><span class="annot"><span class="annottext">exp :: DExp
</span><a href="#local-6989586621681360627"><span class="hs-identifier hs-var">exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-753"></span><span>  </span><span id="local-6989586621681360626"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360626"><span class="hs-identifier hs-var">lambdaName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrM Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">newUniqueName</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Lambda&quot;</span></span><span>
</span><span id="line-754"></span><span>  </span><span id="local-6989586621681360625"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360625"><span class="hs-identifier hs-var">tyNames</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; PrM Name) -&gt; [Name] -&gt; PrM [Name]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; PrM Name
forall (q :: * -&gt; *). Quasi q =&gt; Name -&gt; q Name
</span><a href="Data.Singletons.Names.html#mkTyName"><span class="hs-identifier hs-var">mkTyName</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360628"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-755"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360624"><span class="annot"><span class="annottext">var_proms :: VarPromotions
</span><a href="#local-6989586621681360624"><span class="hs-identifier hs-var hs-var">var_proms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name] -&gt; VarPromotions
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360628"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360625"><span class="hs-identifier hs-var">tyNames</span></a></span><span>
</span><span id="line-756"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360623"><span class="annot"><span class="annottext">rhs :: DType
</span><a href="#local-6989586621681360623"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360622"><span class="annot"><span class="annottext">ann_exp :: ADExp
</span><a href="#local-6989586621681360622"><span class="hs-identifier hs-var">ann_exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VarPromotions -&gt; PrM (DType, ADExp) -&gt; PrM (DType, ADExp)
forall a. VarPromotions -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.Promote.Monad.html#lambdaBind"><span class="hs-identifier hs-var">lambdaBind</span></a></span><span> </span><span class="annot"><span class="annottext">VarPromotions
</span><a href="#local-6989586621681360624"><span class="hs-identifier hs-var">var_proms</span></a></span><span> </span><span class="annot"><span class="annottext">(PrM (DType, ADExp) -&gt; PrM (DType, ADExp))
-&gt; PrM (DType, ADExp) -&gt; PrM (DType, ADExp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681360627"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-757"></span><span>  </span><span id="local-6989586621681360621"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360621"><span class="hs-identifier hs-var">tyFamLamTypes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; PrM Name) -&gt; [Name] -&gt; PrM [Name]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrM Name -&gt; Name -&gt; PrM Name
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(PrM Name -&gt; Name -&gt; PrM Name) -&gt; PrM Name -&gt; Name -&gt; PrM Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; PrM Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="hs-string">&quot;t&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360628"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-758"></span><span>  </span><span id="local-6989586621681360620"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360620"><span class="hs-identifier hs-var">all_locals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM [Name]
forall (m :: * -&gt; *). MonadReader PrEnv m =&gt; m [Name]
</span><a href="Data.Singletons.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a></span><span>
</span><span id="line-759"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360619"><span class="annot"><span class="annottext">all_args :: [Name]
</span><a href="#local-6989586621681360619"><span class="hs-identifier hs-var hs-var">all_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360620"><span class="hs-identifier hs-var">all_locals</span></a></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name] -&gt; [Name]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360621"><span class="hs-identifier hs-var">tyFamLamTypes</span></a></span><span>
</span><span id="line-760"></span><span>      </span><span id="local-6989586621681360618"><span class="annot"><span class="annottext">tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681360618"><span class="hs-identifier hs-var hs-var">tvbs</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DTyVarBndr) -&gt; [Name] -&gt; [DTyVarBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DTyVarBndr
</span><span class="hs-identifier hs-var">DPlainTV</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360619"><span class="hs-identifier hs-var">all_args</span></a></span><span>
</span><span id="line-761"></span><span>  </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DTypeFamilyHead -&gt; [DTySynEqn] -&gt; DDec
</span><span class="hs-identifier hs-var">DClosedTypeFamilyD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
-&gt; [DTyVarBndr]
-&gt; DFamilyResultSig
-&gt; Maybe InjectivityAnn
-&gt; DTypeFamilyHead
</span><span class="hs-identifier hs-var">DTypeFamilyHead</span></span><span>
</span><span id="line-762"></span><span>                                 </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360626"><span class="hs-identifier hs-var">lambdaName</span></a></span><span>
</span><span id="line-763"></span><span>                                 </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360618"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-764"></span><span>                                 </span><span class="annot"><span class="annottext">DFamilyResultSig
</span><span class="hs-identifier hs-var">DNoSig</span></span><span>
</span><span id="line-765"></span><span>                                 </span><span class="annot"><span class="annottext">Maybe InjectivityAnn
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-766"></span><span>                               </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Maybe [DTyVarBndr] -&gt; DType -&gt; DType -&gt; DTySynEqn
</span><span class="hs-identifier hs-var">DTySynEqn</span></span><span> </span><span class="annot"><span class="annottext">Maybe [DTyVarBndr]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-767"></span><span>                                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DCxt -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360626"><span class="hs-identifier hs-var">lambdaName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DCxt -&gt; DType) -&gt; DCxt -&gt; DType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-768"></span><span>                                           </span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; DCxt
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360620"><span class="hs-identifier hs-var">all_locals</span></a></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name] -&gt; [Name]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360625"><span class="hs-identifier hs-var">tyNames</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-769"></span><span>                                          </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360623"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-770"></span><span>  </span><span class="annot"><span class="annottext">PrM [DDec] -&gt; PrM ()
forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; m [DDec] -&gt; m ()
</span><a href="Data.Singletons.Promote.Monad.html#emitDecsM"><span class="hs-identifier hs-var">emitDecsM</span></a></span><span> </span><span class="annot"><span class="annottext">(PrM [DDec] -&gt; PrM ()) -&gt; PrM [DDec] -&gt; PrM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Fixity -&gt; [DTyVarBndr] -&gt; Maybe DType -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#defunctionalize"><span class="hs-identifier hs-var">defunctionalize</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360626"><span class="hs-identifier hs-var">lambdaName</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Fixity
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360618"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-771"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360617"><span class="annot"><span class="annottext">promLambda :: DType
</span><a href="#local-6989586621681360617"><span class="hs-identifier hs-var hs-var">promLambda</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; DType -&gt; DType) -&gt; DType -&gt; DCxt -&gt; DType
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Names.html#apply"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Int -&gt; Name
</span><a href="Data.Singletons.Names.html#promoteTySym"><span class="hs-identifier hs-var">promoteTySym</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360626"><span class="hs-identifier hs-var">lambdaName</span></a></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-772"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; DCxt
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360620"><span class="hs-identifier hs-var">all_locals</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-773"></span><span>  </span><span class="annot"><span class="annottext">(DType, ADExp) -&gt; PrM (DType, ADExp)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360617"><span class="hs-identifier hs-var">promLambda</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; DType -&gt; [Name] -&gt; ADExp -&gt; ADExp
</span><a href="Data.Singletons.Syntax.html#ADLamE"><span class="hs-identifier hs-var">ADLamE</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360625"><span class="hs-identifier hs-var">tyNames</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360617"><span class="hs-identifier hs-var">promLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360628"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681360622"><span class="hs-identifier hs-var">ann_exp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-774"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DCaseE</span></span><span> </span><span id="local-6989586621681360613"><span class="annot"><span class="annottext">exp :: DExp
</span><a href="#local-6989586621681360613"><span class="hs-identifier hs-var">exp</span></a></span></span><span> </span><span id="local-6989586621681360612"><span class="annot"><span class="annottext">matches :: [DMatch]
</span><a href="#local-6989586621681360612"><span class="hs-identifier hs-var">matches</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-775"></span><span>  </span><span id="local-6989586621681360611"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360611"><span class="hs-identifier hs-var">caseTFName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrM Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">newUniqueName</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Case&quot;</span></span><span>
</span><span id="line-776"></span><span>  </span><span id="local-6989586621681360610"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360610"><span class="hs-identifier hs-var">all_locals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM [Name]
forall (m :: * -&gt; *). MonadReader PrEnv m =&gt; m [Name]
</span><a href="Data.Singletons.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a></span><span>
</span><span id="line-777"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360609"><span class="annot"><span class="annottext">prom_case :: DType
</span><a href="#local-6989586621681360609"><span class="hs-identifier hs-var hs-var">prom_case</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; DCxt -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360611"><span class="hs-identifier hs-var">caseTFName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; DCxt
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360610"><span class="hs-identifier hs-var">all_locals</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-778"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360608"><span class="annot"><span class="annottext">exp' :: DType
</span><a href="#local-6989586621681360608"><span class="hs-identifier hs-var">exp'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360607"><span class="annot"><span class="annottext">ann_exp :: ADExp
</span><a href="#local-6989586621681360607"><span class="hs-identifier hs-var">ann_exp</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681360613"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-779"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360606"><span class="annot"><span class="annottext">eqns :: [DTySynEqn]
</span><a href="#local-6989586621681360606"><span class="hs-identifier hs-var">eqns</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360605"><span class="annot"><span class="annottext">ann_matches :: [ADMatch]
</span><a href="#local-6989586621681360605"><span class="hs-identifier hs-var">ann_matches</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DMatch -&gt; PrM (DTySynEqn, ADMatch))
-&gt; [DMatch] -&gt; PrM ([DTySynEqn], [ADMatch])
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; m (b, c)) -&gt; [a] -&gt; m ([b], [c])
</span><span class="hs-identifier hs-var">mapAndUnzipM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DMatch -&gt; PrM (DTySynEqn, ADMatch)
</span><a href="Data.Singletons.Promote.html#promoteMatch"><span class="hs-identifier hs-var">promoteMatch</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360611"><span class="hs-identifier hs-var">caseTFName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DMatch]
</span><a href="#local-6989586621681360612"><span class="hs-identifier hs-var">matches</span></a></span><span>
</span><span id="line-780"></span><span>  </span><span id="local-6989586621681360604"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360604"><span class="hs-identifier hs-var">tyvarName</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrM Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="hs-string">&quot;t&quot;</span></span><span>
</span><span id="line-781"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360603"><span class="annot"><span class="annottext">all_args :: [Name]
</span><a href="#local-6989586621681360603"><span class="hs-identifier hs-var hs-var">all_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360610"><span class="hs-identifier hs-var">all_locals</span></a></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name] -&gt; [Name]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360604"><span class="hs-identifier hs-var">tyvarName</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-782"></span><span>      </span><span id="local-6989586621681360602"><span class="annot"><span class="annottext">tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681360602"><span class="hs-identifier hs-var hs-var">tvbs</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DTyVarBndr) -&gt; [Name] -&gt; [DTyVarBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DTyVarBndr
</span><span class="hs-identifier hs-var">DPlainTV</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681360603"><span class="hs-identifier hs-var">all_args</span></a></span><span>
</span><span id="line-783"></span><span>  </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DTypeFamilyHead -&gt; [DTySynEqn] -&gt; DDec
</span><span class="hs-identifier hs-var">DClosedTypeFamilyD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
-&gt; [DTyVarBndr]
-&gt; DFamilyResultSig
-&gt; Maybe InjectivityAnn
-&gt; DTypeFamilyHead
</span><span class="hs-identifier hs-var">DTypeFamilyHead</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681360611"><span class="hs-identifier hs-var">caseTFName</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681360602"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">DFamilyResultSig
</span><span class="hs-identifier hs-var">DNoSig</span></span><span> </span><span class="annot"><span class="annottext">Maybe InjectivityAnn
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTySynEqn]
</span><a href="#local-6989586621681360606"><span class="hs-identifier hs-var">eqns</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-784"></span><span>    </span><span class="hs-comment">-- See Note [Annotate case return type] in Single</span><span>
</span><span id="line-785"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360601"><span class="annot"><span class="annottext">applied_case :: DType
</span><a href="#local-6989586621681360601"><span class="hs-identifier hs-var hs-var">applied_case</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360609"><span class="hs-identifier hs-var">prom_case</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360608"><span class="hs-identifier hs-var">exp'</span></a></span><span>
</span><span id="line-786"></span><span>  </span><span class="annot"><span class="annottext">(DType, ADExp) -&gt; PrM (DType, ADExp)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360601"><span class="hs-identifier hs-var">applied_case</span></a></span><span>
</span><span id="line-787"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ADExp -&gt; [ADMatch] -&gt; DType -&gt; ADExp
</span><a href="Data.Singletons.Syntax.html#ADCaseE"><span class="hs-identifier hs-var">ADCaseE</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681360607"><span class="hs-identifier hs-var">ann_exp</span></a></span><span> </span><span class="annot"><span class="annottext">[ADMatch]
</span><a href="#local-6989586621681360605"><span class="hs-identifier hs-var">ann_matches</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360601"><span class="hs-identifier hs-var">applied_case</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-788"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DLetE</span></span><span> </span><span id="local-6989586621681360597"><span class="annot"><span class="annottext">decs :: [DLetDec]
</span><a href="#local-6989586621681360597"><span class="hs-identifier hs-var">decs</span></a></span></span><span> </span><span id="local-6989586621681360596"><span class="annot"><span class="annottext">exp :: DExp
</span><a href="#local-6989586621681360596"><span class="hs-identifier hs-var">exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-789"></span><span>  </span><span id="local-6989586621681360595"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360595"><span class="hs-identifier hs-var">unique</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM Int
forall (q :: * -&gt; *). DsMonad q =&gt; q Int
</span><a href="Data.Singletons.Util.html#qNewUnique"><span class="hs-identifier hs-var">qNewUnique</span></a></span><span>
</span><span id="line-790"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360593"><span class="annot"><span class="annottext">letPrefixes :: (String, String)
</span><a href="#local-6989586621681360593"><span class="hs-identifier hs-var hs-var">letPrefixes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Int -&gt; (String, String)
</span><a href="Data.Singletons.Util.html#uniquePrefixes"><span class="hs-identifier hs-var">uniquePrefixes</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Let&quot;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;&lt;&lt;&lt;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681360595"><span class="hs-identifier hs-var">unique</span></a></span><span>
</span><span id="line-791"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360591"><span class="annot"><span class="annottext">binds :: [LetBind]
</span><a href="#local-6989586621681360591"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360590"><span class="annot"><span class="annottext">ann_env :: ALetDecEnv
</span><a href="#local-6989586621681360590"><span class="hs-identifier hs-var">ann_env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(String, String) -&gt; [DLetDec] -&gt; PrM ([LetBind], ALetDecEnv)
</span><a href="Data.Singletons.Promote.html#promoteLetDecs"><span class="hs-identifier hs-var">promoteLetDecs</span></a></span><span> </span><span class="annot"><span class="annottext">(String, String)
</span><a href="#local-6989586621681360593"><span class="hs-identifier hs-var">letPrefixes</span></a></span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621681360597"><span class="hs-identifier hs-var">decs</span></a></span><span>
</span><span id="line-792"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360589"><span class="annot"><span class="annottext">exp' :: DType
</span><a href="#local-6989586621681360589"><span class="hs-identifier hs-var">exp'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360588"><span class="annot"><span class="annottext">ann_exp :: ADExp
</span><a href="#local-6989586621681360588"><span class="hs-identifier hs-var">ann_exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LetBind] -&gt; PrM (DType, ADExp) -&gt; PrM (DType, ADExp)
forall a. [LetBind] -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.Promote.Monad.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">[LetBind]
</span><a href="#local-6989586621681360591"><span class="hs-identifier hs-var">binds</span></a></span><span> </span><span class="annot"><span class="annottext">(PrM (DType, ADExp) -&gt; PrM (DType, ADExp))
-&gt; PrM (DType, ADExp) -&gt; PrM (DType, ADExp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681360596"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-793"></span><span>  </span><span class="annot"><span class="annottext">(DType, ADExp) -&gt; PrM (DType, ADExp)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360589"><span class="hs-identifier hs-var">exp'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ALetDecEnv -&gt; ADExp -&gt; ADExp
</span><a href="Data.Singletons.Syntax.html#ADLetE"><span class="hs-identifier hs-var">ADLetE</span></a></span><span> </span><span class="annot"><span class="annottext">ALetDecEnv
</span><a href="#local-6989586621681360590"><span class="hs-identifier hs-var">ann_env</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681360588"><span class="hs-identifier hs-var">ann_exp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-794"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DSigE</span></span><span> </span><span id="local-6989586621681360585"><span class="annot"><span class="annottext">exp :: DExp
</span><a href="#local-6989586621681360585"><span class="hs-identifier hs-var">exp</span></a></span></span><span> </span><span id="local-6989586621681360584"><span class="annot"><span class="annottext">ty :: DType
</span><a href="#local-6989586621681360584"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-795"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681360583"><span class="annot"><span class="annottext">exp' :: DType
</span><a href="#local-6989586621681360583"><span class="hs-identifier hs-var">exp'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681360582"><span class="annot"><span class="annottext">ann_exp :: ADExp
</span><a href="#local-6989586621681360582"><span class="hs-identifier hs-var">ann_exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681360585"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-796"></span><span>  </span><span id="local-6989586621681360581"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360581"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DType -&gt; PrM DType
forall (m :: * -&gt; *). MonadFail m =&gt; DType -&gt; m DType
</span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360584"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-797"></span><span>  </span><span class="annot"><span class="annottext">(DType, ADExp) -&gt; PrM (DType, ADExp)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-identifier hs-var">DSigT</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360583"><span class="hs-identifier hs-var">exp'</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360581"><span class="hs-identifier hs-var">ty'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; ADExp -&gt; DType -&gt; ADExp
</span><a href="Data.Singletons.Syntax.html#ADSigE"><span class="hs-identifier hs-var">ADSigE</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360583"><span class="hs-identifier hs-var">exp'</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621681360582"><span class="hs-identifier hs-var">ann_exp</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360581"><span class="hs-identifier hs-var">ty'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-798"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span id="local-6989586621681360579"><span class="annot"><span class="annottext">e :: DExp
</span><a href="#local-6989586621681360579"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DStaticE</span></span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrM (DType, ADExp)
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;Static expressions cannot be promoted: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">DExp -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621681360579"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-799"></span><span>
</span><span id="line-800"></span><span id="local-6989586621681361183"><span class="annot"><a href="Data.Singletons.Promote.html#promoteLitExp"><span class="hs-identifier hs-type">promoteLitExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Quasi</span></span><span> </span><span class="annot"><a href="#local-6989586621681361183"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Lit</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361183"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span></span><span>
</span><span id="line-801"></span><span id="promoteLitExp"><span class="annot"><span class="annottext">promoteLitExp :: Lit -&gt; q DType
</span><a href="Data.Singletons.Promote.html#promoteLitExp"><span class="hs-identifier hs-var hs-var">promoteLitExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IntegerL</span></span><span> </span><span id="local-6989586621681360576"><span class="annot"><span class="annottext">n :: Integer
</span><a href="#local-6989586621681360576"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-802"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681360576"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; q DType
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DType -&gt; q DType) -&gt; DType -&gt; q DType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#tyFromIntegerName"><span class="hs-identifier hs-var">tyFromIntegerName</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; DType
</span><span class="hs-identifier hs-var">DLitT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; TyLit
</span><span class="hs-identifier hs-var">NumTyLit</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681360576"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-803"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; q DType
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DType -&gt; q DType) -&gt; DType -&gt; q DType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#tyNegateName"><span class="hs-identifier hs-var">tyNegateName</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span>
</span><span id="line-804"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#tyFromIntegerName"><span class="hs-identifier hs-var">tyFromIntegerName</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; DType
</span><span class="hs-identifier hs-var">DLitT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; TyLit
</span><span class="hs-identifier hs-var">NumTyLit</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681360576"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-805"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteLitExp"><span class="hs-identifier hs-var">promoteLitExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StringL</span></span><span> </span><span id="local-6989586621681360570"><span class="annot"><span class="annottext">str :: String
</span><a href="#local-6989586621681360570"><span class="hs-identifier hs-var">str</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-806"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681360569"><span class="annot"><span class="annottext">prom_str_lit :: DType
</span><a href="#local-6989586621681360569"><span class="hs-identifier hs-var hs-var">prom_str_lit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; DType
</span><span class="hs-identifier hs-var">DLitT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; TyLit
</span><span class="hs-identifier hs-var">StrTyLit</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681360570"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-807"></span><span>  </span><span id="local-6989586621681360567"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681360567"><span class="hs-identifier hs-var">os_enabled</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Extension -&gt; q Bool
forall (m :: * -&gt; *). Quasi m =&gt; Extension -&gt; m Bool
</span><span class="hs-identifier hs-var">qIsExtEnabled</span></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.OverloadedStrings</span></span><span>
</span><span id="line-808"></span><span>  </span><span class="annot"><span class="annottext">DType -&gt; q DType
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DType -&gt; q DType) -&gt; DType -&gt; q DType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681360567"><span class="hs-identifier hs-var">os_enabled</span></a></span><span>
</span><span id="line-809"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#tyFromStringName"><span class="hs-identifier hs-var">tyFromStringName</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360569"><span class="hs-identifier hs-var">prom_str_lit</span></a></span><span>
</span><span id="line-810"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360569"><span class="hs-identifier hs-var">prom_str_lit</span></a></span><span>
</span><span id="line-811"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteLitExp"><span class="hs-identifier hs-var">promoteLitExp</span></a></span><span> </span><span id="local-6989586621681360563"><span class="annot"><span class="annottext">lit :: Lit
</span><a href="#local-6989586621681360563"><span class="hs-identifier hs-var">lit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-812"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; q DType
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;Only string and natural number literals can be promoted: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Lit -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621681360563"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-813"></span><span>
</span><span id="line-814"></span><span id="local-6989586621681361195"><span class="annot"><a href="Data.Singletons.Promote.html#promoteLitPat"><span class="hs-identifier hs-type">promoteLitPat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadFail</span></span><span> </span><span class="annot"><a href="#local-6989586621681361195"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Lit</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681361195"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span></span><span>
</span><span id="line-815"></span><span id="promoteLitPat"><span class="annot"><span class="annottext">promoteLitPat :: Lit -&gt; m DType
</span><a href="Data.Singletons.Promote.html#promoteLitPat"><span class="hs-identifier hs-var hs-var">promoteLitPat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IntegerL</span></span><span> </span><span id="local-6989586621681360562"><span class="annot"><span class="annottext">n :: Integer
</span><a href="#local-6989586621681360562"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-816"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681360562"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; m DType
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DType -&gt; m DType) -&gt; DType -&gt; m DType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyLit -&gt; DType
</span><span class="hs-identifier hs-var">DLitT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; TyLit
</span><span class="hs-identifier hs-var">NumTyLit</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681360562"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-817"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-818"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; m DType
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m DType) -&gt; String -&gt; m DType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Negative literal patterns are not allowed,\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-819"></span><span>           </span><span class="annot"><span class="hs-string">&quot;because literal patterns are promoted to natural numbers.&quot;</span></span><span>
</span><span id="line-820"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteLitPat"><span class="hs-identifier hs-var">promoteLitPat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StringL</span></span><span> </span><span id="local-6989586621681360561"><span class="annot"><span class="annottext">str :: String
</span><a href="#local-6989586621681360561"><span class="hs-identifier hs-var">str</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; m DType
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DType -&gt; m DType) -&gt; DType -&gt; m DType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; DType
</span><span class="hs-identifier hs-var">DLitT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; TyLit
</span><span class="hs-identifier hs-var">StrTyLit</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681360561"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-821"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteLitPat"><span class="hs-identifier hs-var">promoteLitPat</span></a></span><span> </span><span id="local-6989586621681360560"><span class="annot"><span class="annottext">lit :: Lit
</span><a href="#local-6989586621681360560"><span class="hs-identifier hs-var">lit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-822"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; m DType
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;Only string and natural number literals can be promoted: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Lit -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621681360560"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-823"></span><span>
</span><span id="line-824"></span><span class="hs-comment">-- See Note [DerivedDecl]</span><span>
</span><span id="line-825"></span><span class="annot"><a href="Data.Singletons.Promote.html#promoteDerivedEqDec"><span class="hs-identifier hs-type">promoteDerivedEqDec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#DerivedEqDecl"><span class="hs-identifier hs-type">DerivedEqDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-826"></span><span id="promoteDerivedEqDec"><span class="annot"><span class="annottext">promoteDerivedEqDec :: DerivedEqDecl -&gt; PrM ()
</span><a href="Data.Singletons.Promote.html#promoteDerivedEqDec"><span class="hs-identifier hs-var hs-var">promoteDerivedEqDec</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#DerivedDecl"><span class="hs-identifier hs-type">DerivedDecl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ded_type :: forall (cls :: * -&gt; Constraint). DerivedDecl cls -&gt; DType
</span><a href="Data.Singletons.Syntax.html#ded_type"><span class="hs-identifier hs-var">ded_type</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681360557"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360557"><span class="hs-identifier hs-var">ty</span></a></span></span><span>
</span><span id="line-827"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ded_decl :: forall (cls :: * -&gt; Constraint). DerivedDecl cls -&gt; DataDecl
</span><a href="Data.Singletons.Syntax.html#ded_decl"><span class="hs-identifier hs-var">ded_decl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span id="local-6989586621681360555"><span class="annot"><span class="annottext">cons :: [DCon]
</span><a href="#local-6989586621681360555"><span class="hs-identifier hs-var">cons</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-828"></span><span>  </span><span id="local-6989586621681360554"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360554"><span class="hs-identifier hs-var">kind</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DType -&gt; PrM DType
forall (m :: * -&gt; *). MonadFail m =&gt; DType -&gt; m DType
</span><a href="Data.Singletons.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360557"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-829"></span><span>  </span><span id="local-6989586621681360553"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681360553"><span class="hs-identifier hs-var">inst_decs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DCon] -&gt; PrM [DDec]
forall (q :: * -&gt; *). Quasi q =&gt; DType -&gt; [DCon] -&gt; q [DDec]
</span><a href="Data.Singletons.Promote.Eq.html#mkEqTypeInstance"><span class="hs-identifier hs-var">mkEqTypeInstance</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681360554"><span class="hs-identifier hs-var">kind</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681360555"><span class="hs-identifier hs-var">cons</span></a></span><span>
</span><span id="line-830"></span><span>  </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681360553"><span class="hs-identifier hs-var">inst_decs</span></a></span><span>
</span><span id="line-831"></span></pre></body></html>